# 📱 WeChat Simulation (Modular Edition) - V71.8

**作者**：正則技術員 (Regular Technician)  
**版本**：V71.8 (記憶體修復 / 模塊化版)

這是一個專為酒館 AI (SillyTavern) 設計的微信模擬器腳本。它能將 AI 輸出的特定文本格式，實時渲染成可交互的微信手機界面。此版本採用 **MVC 模塊化架構**，支持 **AI 串流打字 (Streaming)**，並具備 **防閃爍、自動摺疊源代碼、多聊天室分流** 等高級功能。

-----

## 📂 檔案結構

為了方便維護與客製化，本腳本拆分為三個模塊：

1.  **`wx_theme.js` (外觀)**：負責 CSS 樣式、配色、動畫。想改皮膚、夜間模式改這裡。
2.  **`wx_view.js` (視圖)**：負責 HTML 結構。想新增「轉帳卡片」、「地圖氣泡」改這裡。
3.  **`wx_core.js` (核心)**：負責邏輯運算、隊列管理、DOM 操作。**請勿隨意修改。**

-----

## ⚙️ 安裝指南 (重要！)

由於模塊之間存在依賴關係，**請務必按照以下順序加載腳本**，否則會報錯：

1.  先加載：`wx_theme.js`
2.  次加載：`wx_view.js`
3.  後加載：`wx_core.js`

*(如果您使用 SillyTavern 的 Quick Reply 或 Scripts 功能，請確保文件名排序或加載列表順序正確)*

-----

## 📝 使用方法 (Prompt 指南)

請在您的 Prompt / World Info / 角色卡中，指示 AI 輸出以下格式。

### 1\. 基礎格式

所有微信內容必須包含在 `[wx_os]` 與 `[/wx_os]` 標籤之間。

```text
[wx_os]
[Chat: 黎昂]
[Time] 12:00
[You] 餓了
[黎昂] (( 2"
[黎昂] 叫哥。誰是你爸，我有那麼老嗎？
[/wx_os]
```

### 2\. 特殊功能標籤

支援在對話中插入特殊組件：

  * **發送者定義**：
      * `[You]` 或 `[Me]`：自己發出的消息（綠色氣泡）。
      * `[角色名]`：對方發出的消息（白色氣泡）。
  * **圖片**：`[Img: 圖片網址]`
  * **語音**：`[Voice: 語音內容文字]` (會自動計算秒數)
  * **紅包**：`[RedPacket: 恭喜發財]`
  * **表情**：`[Sticker]`

-----

## 🛠️ 客製化指南 (給開發者)

### 我想修改氣泡顏色

打開 **`wx_theme.js`**，找到 CSS 中的：

```css
/* 我方氣泡 (綠) */
.wx-msg-row.me .wx-bubble-content { background: #95ec69; ... }
```

修改顏色代碼即可。

### 我想增加新的功能 (例如：轉帳)

打開 **`wx_view.js`**，在 `processModules` 函數中添加新的正則替換規則：

```javascript
// 範例：添加轉帳功能
html = html.replace(/\[\s*轉帳\s*[:：]?\s*(\d+).*?\]/gi, 
    `<div class="my-transfer-card">轉帳金額：$1</div>`
);
```

-----

## ❓ 常見問題 (FAQ)

**Q: 為什麼畫面一片白，沒有手機出現？**
A: 請檢查瀏覽器控制台 (F12)。如果出現 `WX_THEME is not defined`，代表加載順序錯了。請確保 `wx_theme.js` 和 `wx_view.js` 在 `wx_core.js` 之前加載。

**Q: 為什麼 AI 打字時，源代碼會顯示出來？**
A: 這是 V71.5+ 的「穩定鎖」機制。為了防止畫面閃爍，AI 打字時會顯示原始碼，等打字結束後 (約 0.8 秒無變動)，系統會自動將其摺疊收納。

**Q: 我切換了聊天室，但舊消息還在彈？**
A: 請確認您使用的是 **V71.8** 版本。此版本修復了計數器記憶問題，切換聊天室會自動清空隊列。

-----

**© 2025 Regular Technician**