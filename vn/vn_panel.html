<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–è¦ºå°èªªé¢æ¿ (æ‰‹æ©Ÿç‰ˆ)</title>
    <link rel="stylesheet" href="vn_style.css">
    <link rel="stylesheet" href="vn_landing_style.css">
    <link rel="stylesheet" href="calltype-style.css">
    <link rel="stylesheet" href="chattype-style.css">
    <link rel="stylesheet" href="echotype-style.css">
    <link rel="stylesheet" href="livestreamtype-style.css">
    <link rel="stylesheet" href="material-settings-style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <style>
        /* æ‰‹æœºç‰ˆç®€åŒ–æ ·å¼ */

        /* ç¾åŒ–æŒ‰é’®æ ·å¼ */
        .command-button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .command-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .command-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .command-button:active {
            transform: translateY(0) scale(0.98);
        }

        .command-button svg {
            width: 16px;
            height: 16px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        /* ç¾åŒ–ç»§ç»­å‰§æƒ…æŒ‰é’®åŒºåŸŸ */
        .continue-story-actions-bar {
            position: fixed;
            left: 50%;
            top: 45%;
            transform: translate(-50%, -50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
            align-items: center;
            padding: 30px;


        }

        /* ç¾åŒ–ç»§ç»­å‰§æƒ…æŒ‰é’® - é»‘é‡‘é…è‰² */
        .continue-story-button {
            background: linear-gradient(135deg, #1b1b1b, #100f0e) !important;
            color: #ffffff !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            padding: 15px 30px !important;
            border-radius: 15px !important;
            border: 2px solid #83681f !important;
            box-shadow: 0 6px 20px rgba(131, 104, 31, 0.4) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            overflow: hidden !important;
            min-width: 200px !important;
            text-align: center !important;
        }

        .continue-story-button:hover {
            background: linear-gradient(135deg, #100f0e, #1b1b1b) !important;
            transform: translateY(-3px) scale(1.05) !important;
            box-shadow: 0 12px 30px rgba(131, 104, 31, 0.6) !important;
        }

        .continue-story-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(131, 104, 31, 0.3), transparent);
            transition: left 0.6s;
        }

        .continue-story-button:hover::before {
            left: 100%;
        }

        /* ç¾åŒ–ç”¨æˆ·è¾“å…¥æŒ‰é’® */
        .continue-story-actions-bar .command-button {
            background: linear-gradient(135deg, #8e44ad, #9b59b6) !important;
            color: white !important;
            font-size: 14px !important;
            padding: 12px 25px !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            min-width: 200px !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .continue-story-actions-bar .command-button:hover {
            background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
            transform: translateY(-2px) scale(1.03) !important;
            box-shadow: 0 6px 20px rgba(142, 68, 173, 0.6) !important;
        }

        /* ç¾åŒ–å†å²å‰§æƒ…æŒ‰é’® - é»‘é‡‘é…è‰² */
        .continue-story-actions-bar .history-button {
            background: linear-gradient(135deg, #1b1b1b, #100f0e) !important;
            color: white !important;
            font-size: 14px !important;
            padding: 12px 25px !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 15px rgba(131, 104, 31, 0.4) !important;
            border: 1px solid #83681f !important;
            min-width: 200px !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .continue-story-actions-bar .history-button:hover {
            background: linear-gradient(135deg, #100f0e, #1b1b1b) !important;
            transform: translateY(-2px) scale(1.03) !important;
            box-shadow: 0 6px 20px rgba(131, 104, 31, 0.6) !important;
        }

        /* æ­·å²åŠ‡æƒ…é¸æ“‡çª—å£æ¨£å¼ */
        #vnHistoryChoiceModalMain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            border-radius: 40px;
            align-items: center;
            z-index: 1000001; /* æ¯” actions bar çš„ z-index: 10001 æ›´é«˜ */
        }

        #vnHistoryChoiceModalMain.modal-active {
            display: flex;
        }

        #vnHistoryChoiceModalMain .vn-history-choice-container {
            width: 85%;
            max-width: 600px;
            background: linear-gradient(135deg, #1b1b1b, #100f0e);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            color: #ffffff;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1000002; /* ç¡®ä¿å®¹å™¨ä¹Ÿæœ‰è¶³å¤Ÿé«˜çš„ z-index */
            border: 2px solid #83681f;
        }

        #vnHistoryChoiceModalMain .vn-history-choice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #83681f;
        }

        #vnHistoryChoiceModalMain .vn-history-choice-title {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }

        #vnHistoryChoiceModalMain .close-vn-history-choice {
            width: 35px;
            height: 35px;
            background-color: rgba(131, 104, 31, 0.2);
            border: 2px solid #83681f;
            border-radius: 50%;
            font-size: 20px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #vnHistoryChoiceModalMain .close-vn-history-choice:hover {
            background-color: rgba(131, 104, 31, 0.4);
            transform: scale(1.1);
        }

        #vnHistoryChoiceModalMain .vn-history-choice-content {
            overflow-y: auto;
            max-height: calc(80vh - 100px);
            padding-right: 10px;
        }

        #vnHistoryChoiceModalMain .history-choice-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #vnHistoryChoiceModalMain .history-choice-list li {
            margin-bottom: 12px;
        }

        #vnHistoryChoiceModalMain .history-choice-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, rgba(131, 104, 31, 0.1), rgba(131, 104, 31, 0.05));
            border: 2px solid rgba(131, 104, 31, 0.3);
            border-radius: 10px;
            color: #ffffff;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        #vnHistoryChoiceModalMain .history-choice-button:hover {
            background: linear-gradient(135deg, rgba(131, 104, 31, 0.2), rgba(131, 104, 31, 0.1));
            border-color: #83681f;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(131, 104, 31, 0.4);
        }

        #vnHistoryChoiceModalMain .history-item-id {
            font-weight: bold;
            margin-right: 10px;
            color: #8B4513;
            font-size: 16px;
        }

        #vnHistoryChoiceModalMain .history-item-preview {
            opacity: 0.8;
            line-height: 1.4;
        }

        /* ç¾åŒ–é€‰æ‹©æŒ‰é’® */
        .choice-button {
            background: linear-gradient(135deg, #3498db, #2980b9) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 12px !important;
            padding: 12px 20px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            text-align: center !important;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .choice-button:hover {
            background: linear-gradient(135deg, #2980b9, #21618c) !important;
            transform: translateY(-2px) scale(1.02) !important;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.5) !important;
        }

        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .choice-button:hover::before {
            left: 100%;
        }

        /* ç¾åŒ–å¯åŠ¨é¡µé¢æŒ‰é’® */
        .vn-landing-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            text-decoration: none;
            min-height: 60px;
        }

        .vn-landing-btn.primary {
            background: linear-gradient(135deg, #060607 0%, #2e2e2e 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(213, 158, 28, 0.3);
            border: 2px solid rgba(154, 112, 5, 0.911);
        }

        .vn-landing-btn.secondary {
            background: linear-gradient(135deg, #060607 0%, #2e2e2e 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(213, 158, 28, 0.3);
            border: 2px solid rgba(154, 112, 5, 0.911);
        }

        .vn-landing-btn:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .vn-landing-btn.primary:hover {
            background: linear-gradient(135deg, #060607 0%, #2e2e2e 100%);
            box-shadow: 0 10px 30px rgba(67, 56, 36, 0.5);
        }

        .vn-landing-btn.secondary:hover {
            background: linear-gradient(135deg, #060607 0%, #2e2e2e 100%);
            box-shadow: 0 10px 30px rgba(67, 56, 36, 0.5);
        }

        .btn-icon {
            font-size: 20px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .btn-text {
            position: relative;
            z-index: 2;
        }

        .btn-shine {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(164, 105, 21, 0.3), transparent);
            transition: left 0.6s;
        }

        .vn-landing-btn:hover .btn-shine {
            left: 100%;
        }

        .vn-landing-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* ç®€åŒ–çš„loadingåŠ¨ç”»æ ·å¼ */
        .dialog-loading-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border-radius: inherit;
        }

        .dialog-loading-container.active {
            opacity: 1;
            visibility: visible;
        }

        .dialog-loading-text {
            color: #fff;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            line-height: 1.4;
            max-width: 300px;
        }

        .dialog-loading-gif {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        /* æ‰‹æœºç‰ˆèƒŒæ™¯å›¾ç‰‡URLæ˜¾ç¤º */
        .mobile-background-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 6px 10px;
            border-radius: 40px;
            font-size: 10px;
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 250px;
            word-break: break-all;
        }

        .mobile-background-info.show {
            opacity: 0.8;
        }

        /* æ‰‹æœºç‰ˆè®¾ç½®æ ·å¼ç®€åŒ– */
        .mobile-settings-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .mobile-settings-title {
            color: var(--text-color-light);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .mobile-setting-item {
            margin-bottom: 10px;
            font-size: 12px;
        }

        .mobile-setting-label {
            color: var(--text-color-light);
            margin-bottom: 5px;
            display: block;
        }

        .mobile-setting-description {
            color: var(--text-color-muted);
            font-size: 11px;
            margin-top: 5px;
            line-height: 1.3;
        }

        /* æ‰‹æœºç‰ˆä¼˜åŒ–ï¼šç®€åŒ–æŒ‰é’® */
        .mobile-simple-button {
            padding: 6px 12px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .mobile-simple-button:hover {
            background-color: #357abd;
            transform: translateY(-1px);
        }

        .mobile-simple-button.secondary {
            background-color: #6c757d;
        }

        .mobile-simple-button.secondary:hover {
            background-color: #545b62;
        }

        /* ç¾åŒ–æ¨¡æ€çª—å£æ ·å¼ */
        .modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.6);
        }

        .command-input-container,
        .user-input-container {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            max-width: 90vw;
            width: 500px;
        }

        .command-input-header,
        .user-input-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .command-input-title,
        .user-input-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .close-command-input,
        .close-user-input {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-command-input:hover,
        .close-user-input:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .command-input-content,
        .user-input-content {
            padding: 25px;
        }



        /* æŒ‡ä»¤ç±»å‹é€‰æ‹©å™¨å®¹å™¨æ ·å¼ */
        .command-type-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .command-type-selector select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
            flex: 1;
            min-width: 0; /* é˜²æ­¢æº¢å‡º */
        }

        .command-type-selector select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* æ·»åŠ æŒ‡ä»¤ç±»å‹æŒ‰é’®æ ·å¼ */
        .add-command-type-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            font-weight: 600;
            flex-shrink: 0; /* é˜²æ­¢æ”¶ç¼© */
        }

        .add-command-type-button:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .add-command-type-button:active {
            transform: scale(0.95);
        }

        /* ä¿®å¤ä¸‹æ‹‰é€‰é¡¹çš„æ ·å¼é—®é¢˜ */
        .command-type-selector select option {
            background: #2c3e50;
            color: white;
            padding: 8px;
            border: none;
        }

        .command-type-selector select option:hover {
            background: #3498db;
            color: white;
        }

        .command-type-selector select option:checked {
            background: #667eea;
            color: white;
        }

        #commandInputTextarea,
        #userInputTextarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            padding: 15px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 120px;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s;
        }

        #commandInputTextarea:focus,
        #userInputTextarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .command-input-buttons,
        .user-input-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .command-input-button,
        .user-input-button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .command-input-button:first-child,
        .user-input-button:first-child {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .command-input-button:first-child:hover,
        .user-input-button:first-child:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .command-input-button:last-child,
        .user-input-button:last-child {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .command-input-button:last-child:hover,
        .user-input-button:last-child:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }


        /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ - ä¸completionæ ·å¼ç›¸ä¼¼ä½†ç±»åä¸åŒ */
.simple-chat-system-message {
    text-align: center;
    padding: 10px;
    color: #888;
    font-style: italic;
    margin: 8px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}


/* éŸ³é »æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£æ¨£å¼ */
.audio-tag-container {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(20px);
    max-width: 90vw;
    width: 500px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.audio-tag-header {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 20px;
    border-radius: 20px 20px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.audio-tag-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
}

.close-audio-tag {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-audio-tag:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.audio-tag-content {
    padding: 25px;
    flex: 1;
    overflow-y: auto;
}

.audio-preview-section {
    margin-bottom: 20px;
}

.audio-preview-container {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.audio-info {
    color: white;
}

.audio-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 5px;
}

.audio-url {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    word-break: break-all;
}

.audio-tag-footer {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding: 20px 25px;
    background: rgba(255, 255, 255, 0.05);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.audio-tag-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.audio-tag-btn.cancel {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.audio-tag-btn.cancel:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.audio-tag-btn.confirm {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
}

.audio-tag-btn.confirm:hover {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6);
}

.audio-tag-btn.confirm:disabled {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

    </style>
</head>
<body>
    <!-- æ‰‹æœºç‰ˆèƒŒæ™¯ä¿¡æ¯æ˜¾ç¤º -->
    <div class="mobile-background-info" id="mobileBackgroundInfo">
        èƒŒæ™¯: æœªçŸ¥
    </div>

    <!-- VNä¸»å¯åŠ¨ç•Œé¢ -->
    <div class="vn-landing-container active" id="vnLandingContainer">
        <div class="vn-landing-content">
            <div class="vn-landing-logo">
                <img src="https://files.catbox.moe/qndoqu.png" alt="åŠ‡æƒ…" style="width: 60px; height: 60px; object-fit: contain;">
            </div>
            <h1 class="vn-landing-title">æ™‚ç©ºé©›ç«™</h1>
            <p class="vn-landing-subtitle">é¸æ“‡æ‚¨è¦é€²è¡Œçš„æ“ä½œ</p>
            <div class="vn-landing-buttons">
                <button class="vn-landing-btn primary" id="startStoryBtn">

                    <span class="btn-text">è¸å…¥æ•…äº‹</span>
                    <span class="btn-shine"></span>
                </button>
                <button class="vn-landing-btn secondary" id="showHistoryBtn">

                    <span class="btn-text">æ™‚å…‰å›æº¯</span>
                    <span class="btn-shine"></span>
                </button>
                <button class="vn-landing-btn secondary" id="materialSettingsBtn">

                    <span class="btn-text">åå¥½è¨­ç½®</span>
                    <span class="btn-shine"></span>
                </button>
            </div>
        </div>
        
        <!-- æ­·å²åŠ‡æƒ…é¸æ“‡æ¨¡æ…‹çª—å£ - ç§»åˆ°å•Ÿå‹•ç•Œé¢å±¤ç´š -->
        <div class="modal" id="vnHistoryChoiceModal">
            <div class="vn-history-choice-container">
                <div class="vn-history-choice-header">
                    <div class="vn-history-choice-title">é¸æ“‡è¦æŸ¥çœ‹çš„åŠ‡æƒ…</div>
                    <button class="close-vn-history-choice">&times;</button>
                </div>
                <div class="vn-history-choice-content">
                </div>
            </div>
        </div>
    </div>

    <!-- VNä¸»å†…å®¹å®¹å™¨ -->
    <div class="vn-main-container" id="vnMainContainer">
        <!-- å…¨å±LoadingåŠ¨ç”»å®¹å™¨ -->
        <div id="fullscreen-loading-overlay" class="fullscreen-loading-overlay">
            <div class="fullscreen-loading-content">
                <img src="loading.gif" alt="Loading..." class="fullscreen-loading-gif">
                <div class="fullscreen-loading-text">AI æ€è€ƒä¸­...</div>
            </div>
        </div>
        
        <div id="chat-notification" class="chat-notification">
            <span id="chat-notification-text">æ–°è¨Šæ¯æç¤º</span>
            <audio id="chat-notification-sound" src="http://127.0.0.1:8000/sounds/notify.mp3" preload="auto"></audio>
        </div>

        <div class="outer-container">
            <div class="game-container">
                <div class="top-nav">
                    <div class="stats-container">
                        <div class="char-data-panel collapsed">
                            <div class="char-data-header">
                                <span>è§’è‰²é—œä¿‚</span>
                            </div>
                            <div class="char-data-content" id="char-data-content">
                            </div>
                        </div>
                    </div>
                     
                    <div class="menu-buttons-container">
                        <div class="menu-button back-to-landing-button" title="è¿”å›ä¸»é " id="backToLandingBtn">
                            <img src="https://files.catbox.moe/7ml3kn.png" alt="è¿”å›" class="menu-icon">
                        </div>
                        <div class="menu-button settings-button" title="è¨­å®š">
                            <img src="https://files.catbox.moe/o07f3f.png" alt="è¨­ç½®" class="menu-icon">
                        </div>
                        <div class="menu-button mailbox-button" title="è¨˜æ†¶ä¿¡ç®±">
                            <img src="https://files.catbox.moe/7eaesr.png" alt="è¨˜æ†¶éƒµç®±" class="menu-icon">
                        </div>
                        <div class="menu-button history-button" title="æ­·å²å°è©±">
                            <img src="https://files.catbox.moe/y3k778.png" alt="æ­·å²åŠ‡æƒ…" class="menu-icon">
                        </div>
                    </div>
                </div>

                <div class="characters-container">
                    <div class="character-center">
                    </div>
                </div>
                
                <div class="choices-container"></div>
                <div class="dialog-container">
                    <div class="name-tag">è§’è‰²å</div>
                    <div class="dialog-box" data-dialogue-type="character">
                        <div class="dialog-content">
                            <span class="dialog-text">é€™è£¡æ˜¯è§’è‰²çš„å°è©±å…§å®¹...</span>
                            <span class="typewriter-cursor"></span>
                            <span class="text-indicator"></span>
                        </div>
                        <div class="dialog-progress">
                            <span id="current-dialogue">1</span>/<span id="total-dialogues">1</span>
                        </div>
                    </div>
                </div>
                
                <div class="command-button-container">
                    <button id="command-button" class="command-button" title="ç”¨æˆ¶è¼¸å…¥">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                        </svg>
                        ğŸ’¬ ç”¨æˆ¶è¼¸å…¥
                    </button>
                </div>    
                
                <div id="inline-chat-container" class="inline-chat-container">
                    <div class="inline-chat-header">
                        <div class="inline-chat-title">èŠå¤©</div>
                        <button class="close-inline-chat" id="close-inline-chat">&times;</button>
                    </div>
                    <iframe id="inline-chat-iframe" class="inline-chat-iframe" src="about:blank"></iframe>
                </div>
                
                <!-- æ­·å²åŠ‡æƒ…é¸æ“‡æ¨¡æ…‹çª—å£ - åœ¨VNä¸»å®¹å™¨ä¸­ä¹Ÿæ·»åŠ ä¸€ä»½ -->
                <div class="modal" id="vnHistoryChoiceModalMain">
                    <div class="vn-history-choice-container">
                        <div class="vn-history-choice-header">
                            <div class="vn-history-choice-title">é¸æ“‡è¦æŸ¥çœ‹çš„åŠ‡æƒ…</div>
                            <button class="close-vn-history-choice">&times;</button>
                        </div>
                        <div class="vn-history-choice-content">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®°å¿†ä¿¡ç®±æ¨¡æ€çª—å£ -->
    <div class="modal" id="mailModal">
        <div class="mailbox-container">
            <div class="mailbox-header">
                <div class="mailbox-title">è¨˜æ†¶ä¿¡ç®±</div>
                <button class="close-mailbox">&times;</button>
            </div>
            <div class="mail-list">
                <!-- é‚®ä»¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                <!-- back æŒ‰é’®åªåœ¨æŸ¥çœ‹å…·ä½“é‚®ä»¶å†…å®¹æ—¶åŠ¨æ€åˆ›å»º -->
            </div>
        </div>
    </div>
    
    <!-- ç”¨æˆ·è¾“å…¥æ¨¡æ€çª—å£ -->
    <div class="modal" id="userInputModal">
        <div class="user-input-container">
            <div class="user-input-header">
                <div class="user-input-title">è«‹è¼¸å…¥ä½ çš„é¸æ“‡</div>
                <button class="close-user-input">&times;</button>
            </div>
            <div class="user-input-content">
                <textarea id="userInputTextarea" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„é¸æ“‡..."></textarea>
                <div class="user-input-buttons">
                    <button id="cancelUserInput" class="user-input-button">å–æ¶ˆ</button>
                    <button id="submitUserInput" class="user-input-button">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŒ‡ä»¤æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="commandInputModal">
        <div class="command-input-container">
            <div class="command-input-header">
                <div class="command-input-title">ğŸ’¬ ç”¨æˆ¶è¼¸å…¥</div>
                <div class="command-type-selector">
                    <select id="commandTypeSelect">
                        <option value="è§’è‰²çŸ¯æ­£">è§’è‰²çŸ¯æ­£</option>
                        <option value="åŠ‡æƒ…çŸ¯æ­£">åŠ‡æƒ…çŸ¯æ­£</option>
                    </select>
                    <button id="addCommandType" class="add-command-type-button" title="æ·»åŠ æŒ‡ä»¤é¡å‹">+</button>
                </div>
                <button class="close-command-input">&times;</button>
            </div>
            <div class="command-input-content">
                <textarea id="commandInputTextarea" placeholder="åœ¨æ­¤è¼¸å…¥ç”¨æˆ¶æŒ‡ä»¤..."></textarea>
                <div class="command-input-buttons">
                    <button id="cancelCommandInput" class="command-input-button">å–æ¶ˆ</button>
                    <button id="submitCommandInput" class="command-input-button">ğŸ’¬ ç™¼é€è¼¸å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æŒ‡ä»¤ç±»å‹æ¨¡æ€çª—å£ -->
    <div class="modal" id="addCommandTypeModal">
        <div class="add-command-type-container">
            <div class="add-command-type-header">
                <div class="add-command-type-title">æ·»åŠ æŒ‡ä»¤é¡å‹</div>
                <button class="close-add-command-type">&times;</button>
            </div>
            <div class="add-command-type-content">
                <input type="text" id="newCommandTypeInput" placeholder="è¼¸å…¥æ–°çš„æŒ‡ä»¤é¡å‹åç¨±..." maxlength="20">
                <div class="add-command-type-buttons">
                    <button id="cancelAddCommandType" class="add-command-type-button">å–æ¶ˆ</button>
                    <button id="confirmAddCommandType" class="add-command-type-button">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šæ¨¡æ…‹çª—å£ï¼ˆæ‰‹æœºç‰ˆç®€åŒ–ï¼‰ -->
    <div class="modal" id="settingsModal">
        <div class="settings-container">
            <div class="settings-header">
                <div class="settings-title">è¨­å®š (æ‰‹æ©Ÿç‰ˆ)</div>
                <button class="close-settings">&times;</button>
            </div>
            <div class="settings-content">
                <!-- åŸºç¡€è®¾ç½® -->
                <div class="setting-item">
                    <label for="typeSpeedSlider">æ‰“å­—é€Ÿåº¦</label>
                    <input type="range" id="typeSpeedSlider" min="10" max="100" value="30" step="5">
                    <span id="typeSpeedValue">30</span>ms
                </div>
                
                <div class="setting-item">
                    <label for="bgmVolumeSlider">BGMéŸ³é‡</label>
                    <input type="range" id="bgmVolumeSlider" min="0" max="100" value="70" step="5">
                    <span id="bgmVolumeValue">70</span>%
                </div>

                <!-- BGMæ§åˆ¶ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸµ BGMæ§åˆ¶</h4>
                    <div class="mobile-setting-item">
                        <button id="resetBgmButton" class="mobile-simple-button">é‡ç½®BGM</button>
                        <div class="mobile-setting-description">è‹¥BGMæ’­æ”¾ç•°å¸¸(å¦‚é‡ç–Š)ï¼Œå¯å˜—è©¦æ­¤åŠŸèƒ½ã€‚</div>
                    </div>
                </div>

                <!-- æ‰‹æœºç‰ˆèƒŒæ™¯ç³»ç»Ÿè¯´æ˜ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸï¸ èƒŒæ™¯åœ–ç‰‡ç³»çµ± (æ‰‹æ©Ÿç‰ˆ)</h4>
                    
                    <div class="mobile-setting-item">
                        <div class="mobile-setting-label">åœ–ç‰‡ä¾†æº</div>
                        <div class="mobile-setting-description">
                            æ‰‹æ©Ÿç‰ˆä½¿ç”¨å›ºå®šURLæ¨¡å¼ç²å–èƒŒæ™¯åœ–ç‰‡ï¼š<br>
                            <code>https://nancywang3641.github.io/sound-files/location_img/{è¨­æ–½åç¨±}.jpeg</code><br>
                            è‹¥åœ–ç‰‡ä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­èƒŒæ™¯ã€‚
                        </div>
                    </div>
                    
                    <div class="mobile-setting-item">
                        <button id="showCurrentBackground" class="mobile-simple-button">é¡¯ç¤ºç•¶å‰èƒŒæ™¯</button>
                        <div class="mobile-setting-description">é¡¯ç¤ºç•¶å‰ä½¿ç”¨çš„èƒŒæ™¯åœ–ç‰‡URL</div>
                    </div>
                    
                    <div class="mobile-setting-item">
                        <button id="testDefaultBackground" class="mobile-simple-button secondary">æ¸¬è©¦é è¨­èƒŒæ™¯</button>
                        <div class="mobile-setting-description">è¼‰å…¥ä¸¦æ¸¬è©¦é è¨­èƒŒæ™¯åœ–ç‰‡</div>
                    </div>
                </div>

                <!-- ç”¨æˆ·è¾“å…¥ç®¡ç† -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸ’¬ ç”¨æˆ¶è¼¸å…¥ç®¡ç†</h4>
                    
                    <div class="mobile-setting-item">
                        <button id="showSavedCommandTypes" class="mobile-simple-button">æŸ¥çœ‹å·²ä¿å­˜çš„æŒ‡ä»¤é¡å‹</button>
                        <div class="mobile-setting-description">é¡¯ç¤ºç•¶å‰ä¿å­˜çš„è‡ªå®šç¾©æŒ‡ä»¤é¡å‹</div>
                    </div>
                    
                    <div class="mobile-setting-item">
                        <button id="clearCommandTypes" class="mobile-simple-button secondary">æ¸…é™¤è‡ªå®šç¾©æŒ‡ä»¤é¡å‹</button>
                        <div class="mobile-setting-description">åˆªé™¤æ‰€æœ‰è‡ªå®šç¾©æŒ‡ä»¤é¡å‹ï¼Œæ¢å¾©ç‚ºé»˜èªè¨­ç½®</div>
                    </div>
                </div>

                <!-- è°ƒè¯•åŠŸèƒ½ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸ› ï¸ èª¿è©¦åŠŸèƒ½</h4>
                    
                    <div class="mobile-setting-item">
                        <button id="testTransition" class="mobile-simple-button">æ¸¬è©¦Transitionéå ´</button>
                        <div class="mobile-setting-description">æ¸¬è©¦éå ´å‹•ç•«æ•ˆæœ</div>
                    </div>
                    
                    <div class="mobile-setting-item">
                        <button id="showDebugInfo" class="mobile-simple-button secondary">é¡¯ç¤ºèª¿è©¦ä¿¡æ¯</button>
                        <div class="mobile-setting-description">åœ¨æ§åˆ¶å°é¡¯ç¤ºç•¶å‰ç‹€æ…‹ä¿¡æ¯</div>
                    </div>
                </div>
                
                <!-- å¿«æ·é”®è¯´æ˜ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">âŒ¨ï¸ å¿«æ·éµèªªæ˜</h4>
                    <div class="mobile-setting-description" style="line-height: 1.8;">
                        <strong>é»æ“Šå°è©±æ¡†ï¼š</strong>æ¨é€²å°è©±<br>
                        <strong>C éµï¼š</strong>å¼·åˆ¶é¡¯ç¤ºé¸é …ï¼ˆèª¿è©¦ç”¨ï¼‰<br>
                        <strong>D éµï¼š</strong>é¡¯ç¤ºèª¿è©¦ä¿¡æ¯ï¼ˆæ§åˆ¶å°ï¼‰<br>
                        <strong>R éµï¼š</strong>é‡ç½®è§’è‰²é—œä¿‚é¢æ¿ç‚ºæ‘ºç–Šç‹€æ…‹<br>
                        <strong>/ éµï¼š</strong>å¿«é€Ÿæ‰“é–‹ç”¨æˆ¶è¼¸å…¥<br>
                        <strong>B éµï¼š</strong>é¡¯ç¤ºBGMç‹€æ…‹<br>
                        <strong>L éµï¼š</strong>æ¸¬è©¦Loadingå‹•ç•«<br>
                        <strong>G éµï¼š</strong>æ¸¬è©¦èƒŒæ™¯åœ–ç‰‡åŠŸèƒ½<br>
                        <strong>ESC éµï¼š</strong>é—œé–‰æ¨¡æ…‹çª—å£
                    </div>
                </div>

                <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸ“± ç‰ˆæœ¬ä¿¡æ¯</h4>
                    <div class="mobile-setting-description">
                        <strong>VNé¢æ¿ï¼š</strong>v21.1-mobile<br>
                        <strong>ç‰¹æ€§ï¼š</strong>æ‰‹æ©Ÿç‰ˆç°¡åŒ–ï¼Œç„¡åœ–ç‰‡ç”Ÿæˆ<br>
                        <strong>èƒŒæ™¯ï¼š</strong>å›ºå®šURLæ¨¡å¼<br>
                        <strong>éŸ³é »ï¼š</strong>GitHub CDNè³‡æº
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç´ æè¨­ç½®æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="materialSettingsModal">
        <div class="material-settings-container">
            <div class="material-settings-header">
                <div class="material-settings-title">
                    ğŸ¨ ç´ æè¨­ç½®
                    <span id="current-mode-badge" class="mode-badge">
                        ğŸŒ URLæ¨¡å¼
                    </span>
                </div>
                <button class="close-material-settings" id="closeMaterialSettings">&times;</button>
            </div>
            <div class="material-settings-content">
                <!-- å…¨å±€åˆ‡æ›æ¨™ç±¤ -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸŒ å…¨å±€åˆ‡æ›</h3>
                    <div class="form-group">
                        <label>é¸æ“‡æ‰€æœ‰ç´ æé¡åˆ¥çš„ä¾†æºæ¨¡å¼</label>
                        <div class="source-mode-selector">
                            <button type="button" class="source-mode-btn active" data-mode="url" id="urlModeBtn">
                                <span class="mode-icon">ğŸŒ</span>
                                <span class="mode-text">URLè³‡æ–™å¤¾</span>
                            </button>
                            <button type="button" class="source-mode-btn" data-mode="upload" id="uploadModeBtn">
                                <span class="mode-icon">ğŸ“¤</span>
                                <span class="mode-text">ä¸Šå‚³ç´ æ</span>
                            </button>
                        </div>
                        <div class="form-help">é¸æ“‡æ‰€æœ‰ç´ æé¡åˆ¥ï¼ˆç«‹ç¹ªã€è²¼åœ–ã€é ­åƒç­‰ï¼‰çš„ä¾†æºæ¨¡å¼ã€‚URLæ¨¡å¼å¾ç¶²çµ¡ç²å–ï¼Œä¸Šå‚³æ¨¡å¼ä½¿ç”¨æœ¬åœ°å­˜å„²çš„åœ–ç‰‡ã€‚</div>
                    </div>
                </div>
                <!-- é è¨­è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ­ é è¨­è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="portrait-base-url">é è¨­åŸºç¤URL</label>
                        <input type="url" id="portrait-base-url" placeholder="https://nancywang3641.github.io/sound-files/char_presets/" value="https://nancywang3641.github.io/sound-files/char_presets/">
                        <div class="form-help">è§’è‰²é è¨­åœ–ç‰‡å°‡è‡ªå‹•å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{è§’è‰²å}_presets.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="portrait-format">é è¨­æ ¼å¼</label>
                        <input type="text" id="portrait-format" placeholder="_presets.png" value="_presets.png">
                        <div class="form-help">è¼¸å…¥é è¨­æ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œä¾‹å¦‚ï¼š_presets.pngã€_portrait.pngã€_char.png ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³é è¨­åœ–ç‰‡</label>
                        <div class="upload-area" id="portrait-upload-area">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">ä¸Šå‚³é è¨­åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="portrait-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="portrait-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="portrait-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µé è¨­åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="portrait-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="portrait-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="portrait-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>é è¨­æ¸¬è©¦</label>
                        <div class="portrait-test-container">
                            <input type="text" id="test-character-name" placeholder="è¼¸å…¥è§’è‰²åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-portrait-btn" class="test-portrait-btn">æ¸¬è©¦é è¨­</button>
                            <div id="portrait-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- BGMè¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸµ BGMè¨­ç½®</h3>
                    
                    <div class="form-group">
                        <label for="bgm-base-url">BGMåŸºç¤URL</label>
                        <input type="url" id="bgm-base-url" placeholder="https://nancywang3641.github.io/sound-files/bgm/" value="https://nancywang3641.github.io/sound-files/bgm/">
                        <div class="form-help">BGMéŸ³æ¨‚å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{bgmåç¨±}.mp3</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="bgm-format">BGMæ ¼å¼</label>
                        <input type="text" id="bgm-format" placeholder=".mp3" value=".mp3">
                        <div class="form-help">BGMæ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.mp3ã€.wavã€.ogg ç­‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label>BGMæ¸¬è©¦</label>
                        <div class="bgm-test-container">
                            <input type="text" id="test-bgm-name" placeholder="è¼¸å…¥BGMåç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-bgm-btn" class="test-portrait-btn">æ¸¬è©¦BGM</button>
                            <div id="bgm-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- éŸ³æ•ˆè¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ”Š éŸ³æ•ˆè¨­ç½®</h3>
                    
                    <div class="form-group">
                        <label for="sound-effect-base-url">éŸ³æ•ˆåŸºç¤URL</label>
                        <input type="url" id="sound-effect-base-url" placeholder="https://nancywang3641.github.io/sound-files/sound_effect/" value="https://nancywang3641.github.io/sound-files/sound_effect/">
                        <div class="form-help">éŸ³æ•ˆå°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{éŸ³æ•ˆåç¨±}.mp3</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="sound-effect-format">éŸ³æ•ˆæ ¼å¼</label>
                        <input type="text" id="sound-effect-format" placeholder=".mp3" value=".mp3">
                        <div class="form-help">éŸ³æ•ˆæ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.mp3ã€.wavã€.ogg ç­‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label>éŸ³æ•ˆæ¸¬è©¦</label>
                        <div class="sound-effect-test-container">
                            <input type="text" id="test-sound-effect-name" placeholder="è¼¸å…¥éŸ³æ•ˆåç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-sound-effect-btn" class="test-portrait-btn">æ¸¬è©¦éŸ³æ•ˆ</button>
                            <div id="sound-effect-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- è§’è‰²åœ–ç‰‡è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ‘¤ è§’è‰²åœ–ç‰‡è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="character-img-base-url">è§’è‰²åœ–ç‰‡åŸºç¤URL</label>
                        <input type="url" id="character-img-base-url" placeholder="https://nancywang3641.github.io/sound-files/char_img/" value="https://nancywang3641.github.io/sound-files/char_img/">
                        <div class="form-help">è§’è‰²åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{è§’è‰²å}_{è¡¨æƒ…}.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="character-img-format">è§’è‰²åœ–ç‰‡æ ¼å¼</label>
                        <input type="text" id="character-img-format" placeholder=".png" value=".png">
                        <div class="form-help">è§’è‰²åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.pngã€.jpgã€.jpeg ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³è§’è‰²åœ–ç‰‡</label>
                        <div class="upload-area" id="character-img-upload-area">
                            <div class="upload-icon">ğŸ‘¤</div>
                            <div class="upload-text">ä¸Šå‚³è§’è‰²åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="character-img-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="character-img-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="character-img-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µè§’è‰²åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="character-img-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="character-img-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="character-img-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>è§’è‰²åœ–ç‰‡æ¸¬è©¦</label>
                        <div class="character-img-test-container">
                            <input type="text" id="test-character-img-name" placeholder="è¼¸å…¥è§’è‰²åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <input type="text" id="test-character-img-emotion" placeholder="è¼¸å…¥è¡¨æƒ…åç¨±(å¦‚: happy, sad)" style="margin-bottom: 10px;">
                            <button type="button" id="test-character-img-btn" class="test-portrait-btn">æ¸¬è©¦è§’è‰²åœ–ç‰‡</button>
                            <div id="character-img-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- èƒŒæ™¯åœ–ç‰‡è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ–¼ï¸ èƒŒæ™¯åœ–ç‰‡è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="background-base-url">èƒŒæ™¯åœ–ç‰‡åŸºç¤URL</label>
                        <input type="url" id="background-base-url" placeholder="https://nancywang3641.github.io/sound-files/location_img/" value="https://nancywang3641.github.io/sound-files/location_img/">
                        <div class="form-help">èƒŒæ™¯åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{åœ°é»å}.jpeg</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="background-fallback-url">èƒŒæ™¯åœ–ç‰‡é è¨­URL</label>
                        <input type="url" id="background-fallback-url" placeholder="https://nancywang3641.github.io/sound-files/location_img/default.jpeg" value="https://nancywang3641.github.io/sound-files/location_img/default.jpeg">
                        <div class="form-help">ç•¶æ‰¾ä¸åˆ°æŒ‡å®šèƒŒæ™¯åœ–ç‰‡æ™‚ä½¿ç”¨çš„é è¨­åœ–ç‰‡</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="background-format">èƒŒæ™¯åœ–ç‰‡æ ¼å¼</label>
                        <input type="text" id="background-format" placeholder=".jpeg" value=".jpeg">
                        <div class="form-help">èƒŒæ™¯åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.jpegã€.jpgã€.png ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡</label>
                        <div class="upload-area" id="background-upload-area">
                            <div class="upload-icon">ğŸ–¼ï¸</div>
                            <div class="upload-text">ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="background-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="background-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="background-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µèƒŒæ™¯åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="background-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="background-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="background-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>èƒŒæ™¯åœ–ç‰‡æ¸¬è©¦</label>
                        <div class="background-test-container">
                            <input type="text" id="test-background-name" placeholder="è¼¸å…¥åœ°é»åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-background-btn" class="test-portrait-btn">æ¸¬è©¦èƒŒæ™¯åœ–ç‰‡</button>
                            <div id="background-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- èƒŒæ™¯APIè¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ¨ èƒŒæ™¯APIè¨­ç½®</h3>
                    
                    <div class="form-group">
                        <label for="background-api-enabled">å•Ÿç”¨AIèƒŒæ™¯ç”Ÿæˆ</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="background-api-enabled" checked>
                            <label for="background-api-enabled" class="toggle-label"></label>
                        </div>
                        <div class="form-help">å•Ÿç”¨å¾Œï¼Œç•¶AIè¼¸å‡º[Scene|...]æ¨™ç±¤æ™‚æœƒè‡ªå‹•ç”ŸæˆèƒŒæ™¯åœ–ç‰‡</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="background-model-select">ç”Ÿåœ–æ¨¡å‹</label>
                        <select id="background-model-select" class="form-select">
                            <option value="">-- ä¸ä½¿ç”¨åœ–åƒç”Ÿæˆ --</option>
                            <option value="pollinations-flux" selected>ğŸŒŸ FLUX - æ¨è–¦æ¨¡å‹ï¼Œç”Ÿæˆé€Ÿåº¦å¿«ï¼Œå“è³ªå„ªç§€</option>
                            <option value="pollinations-kontext">ğŸŒŸ Kontext - é©åˆè¤‡é›œå ´æ™¯å’Œç´°ç¯€è±å¯Œçš„åœ–åƒ</option>
                            <option value="pollinations-turbo">ğŸŒŸ Turbo - è¶…å¿«é€Ÿç”Ÿæˆï¼Œé©åˆå¿«é€Ÿæ¸¬è©¦å’Œè¿­ä»£</option>
                        </select>
                        <div class="form-help">é¸æ“‡ç”¨æ–¼ç”ŸæˆèƒŒæ™¯åœ–ç‰‡çš„AIæ¨¡å‹</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="background-size-select">åœ–ç‰‡å°ºå¯¸</label>
                        <select id="background-size-select" class="form-select">
                            <option value="1024x1024" selected>1024x1024 (æ­£æ–¹å½¢)</option>
                            <option value="1024x768">1024x768 (æ©«å‘)</option>
                            <option value="768x1024">768x1024 (ç¸±å‘)</option>
                            <option value="1280x720">1280x720 (å¯¬å±)</option>
                            <option value="720x1280">720x1280 (æ‰‹æ©Ÿ)</option>
                        </select>
                        <div class="form-help">é¸æ“‡ç”ŸæˆèƒŒæ™¯åœ–ç‰‡çš„å°ºå¯¸</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="background-quality-select">åœ–ç‰‡å“è³ª</label>
                        <select id="background-quality-select" class="form-select">
                            <option value="standard" selected>æ¨™æº–å“è³ª</option>
                            <option value="high">é«˜å“è³ª</option>
                            <option value="ultra">è¶…é«˜å“è³ª</option>
                        </select>
                        <div class="form-help">é¸æ“‡ç”ŸæˆèƒŒæ™¯åœ–ç‰‡çš„å“è³ªç­‰ç´š</div>
                    </div>
                    
                    <div class="form-group">
                        <label>èƒŒæ™¯ç”Ÿæˆæ¸¬è©¦</label>
                        <div class="background-api-test-container">
                            <input type="text" id="test-background-prompt" placeholder="è¼¸å…¥åœ–ç‰‡æè¿°é€²è¡Œæ¸¬è©¦ (å¦‚: night, abandoned industrial edge, ruined factory wall)" style="margin-bottom: 10px;">
                            <button type="button" id="test-background-api-btn" class="test-portrait-btn">æ¸¬è©¦èƒŒæ™¯ç”Ÿæˆ</button>
                            <div id="background-api-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ç”Ÿæˆæ­·å²</label>
                        <div class="background-history-container">
                            <button type="button" id="view-background-history-btn" class="test-portrait-btn">æŸ¥çœ‹æ­·å²</button>
                            <button type="button" id="clear-background-history-btn" class="test-portrait-btn" style="margin-left: 10px;">æ¸…é™¤æ­·å²</button>
                            <div id="background-history-list" class="background-history-list" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Area GIFè¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ¬ Area GIFè¨­ç½®</h3>
                    
                    <div class="form-group">
                        <label for="area-gif-base-url">Area GIFåŸºç¤URL</label>
                        <input type="url" id="area-gif-base-url" placeholder="https://nancywang3641.github.io/sound-files/Area_img/" value="https://nancywang3641.github.io/sound-files/Area_img/">
                        <div class="form-help">Areaéå ´å‹•ç•«å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{å€åŸŸå}.gif</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="area-gif-format">Area GIFæ ¼å¼</label>
                        <input type="text" id="area-gif-format" placeholder=".gif" value=".gif">
                        <div class="form-help">Areaéå ´å‹•ç•«æ–‡ä»¶çš„æ ¼å¼ï¼Œé€šå¸¸ç‚ºï¼š.gif</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>Area GIFæ¸¬è©¦</label>
                        <div class="area-gif-test-container">
                            <input type="text" id="test-area-gif-name" placeholder="è¼¸å…¥å€åŸŸåç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-area-gif-btn" class="test-portrait-btn">æ¸¬è©¦Area GIF</button>
                            <div id="area-gif-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- è²¼åœ–è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ˜Š è²¼åœ–è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="sticker-base-url">è²¼åœ–åŸºç¤URL</label>
                        <input type="url" id="sticker-base-url" placeholder="https://nancywang3641.github.io/sound-files/sticker/" value="https://nancywang3641.github.io/sound-files/sticker/">
                        <div class="form-help">è²¼åœ–å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{è²¼åœ–å}.jpg</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="sticker-default-url">è²¼åœ–é è¨­URL</label>
                        <input type="url" id="sticker-default-url" placeholder="https://nancywang3641.github.io/sound-files/sticker/default.jpg" value="https://nancywang3641.github.io/sound-files/sticker/default.jpg">
                        <div class="form-help">ç•¶æ‰¾ä¸åˆ°æŒ‡å®šè²¼åœ–æ™‚ä½¿ç”¨çš„é è¨­è²¼åœ–</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="sticker-format">è²¼åœ–æ ¼å¼</label>
                        <input type="text" id="sticker-format" placeholder=".jpg" value=".jpg">
                        <div class="form-help">è²¼åœ–æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.jpgã€.pngã€.gif ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³è²¼åœ–</label>
                        <div class="upload-area" id="sticker-upload-area">
                            <div class="upload-icon">ğŸ˜Š</div>
                            <div class="upload-text">ä¸Šå‚³è²¼åœ–</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="sticker-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="sticker-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="sticker-image-list">
                            <!-- ä¸Šå‚³çš„è²¼åœ–å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µè²¼åœ–</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="sticker-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="sticker-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="sticker-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>è²¼åœ–æ¸¬è©¦</label>
                        <div class="sticker-test-container">
                            <input type="text" id="test-sticker-name" placeholder="è¼¸å…¥è²¼åœ–åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-sticker-btn" class="test-portrait-btn">æ¸¬è©¦è²¼åœ–</button>
                            <div id="sticker-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ç‰©å“åœ–ç‰‡è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ ç‰©å“åœ–ç‰‡è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="item-img-base-url">ç‰©å“åœ–ç‰‡åŸºç¤URL</label>
                        <input type="url" id="item-img-base-url" placeholder="https://nancywang3641.github.io/sound-files/item_img/" value="https://nancywang3641.github.io/sound-files/item_img/">
                        <div class="form-help">ç‰©å“åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{ç‰©å“åç¨±}.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="item-img-format">ç‰©å“åœ–ç‰‡æ ¼å¼</label>
                        <input type="text" id="item-img-format" placeholder=".png" value=".png">
                        <div class="form-help">ç‰©å“åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.pngã€.jpgã€.jpeg ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³ç‰©å“åœ–ç‰‡</label>
                        <div class="upload-area" id="item-img-upload-area">
                            <div class="upload-icon">ğŸ</div>
                            <div class="upload-text">ä¸Šå‚³ç‰©å“åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="item-img-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="item-img-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="item-img-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µç‰©å“åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="item-img-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="item-img-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="item-img-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>ç‰©å“åœ–ç‰‡æ¸¬è©¦</label>
                        <div class="item-img-test-container">
                            <input type="text" id="test-item-img-name" placeholder="è¼¸å…¥ç‰©å“åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <div style="font-size: 11px; color: var(--text-color-muted); margin-bottom: 10px;">
                                å°‡ç”Ÿæˆ: {ç‰©å“åç¨±}.png æ ¼å¼çš„URL
                            </div>
                            <button type="button" id="test-item-img-btn" class="test-portrait-btn">æ¸¬è©¦ç‰©å“åœ–ç‰‡</button>
                            <div id="item-img-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ç‰©å“é¡å‹è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ“¦ ç‰©å“é¡å‹è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="item-type-base-url">ç‰©å“é¡å‹åŸºç¤URL</label>
                        <input type="url" id="item-type-base-url" placeholder="https://nancywang3641.github.io/sound-files/item_type/" value="https://nancywang3641.github.io/sound-files/item_type/">
                        <div class="form-help">ç‰©å“é¡å‹åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{é¡å‹}.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="item-type-format">ç‰©å“é¡å‹æ ¼å¼</label>
                        <input type="text" id="item-type-format" placeholder=".png" value=".png">
                        <div class="form-help">ç‰©å“é¡å‹åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.pngã€.jpgã€.jpeg ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³ç‰©å“é¡å‹åœ–ç‰‡</label>
                        <div class="upload-area" id="item-type-upload-area">
                            <div class="upload-icon">ğŸ“¦</div>
                            <div class="upload-text">ä¸Šå‚³ç‰©å“é¡å‹åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="item-type-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="item-type-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="item-type-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µç‰©å“é¡å‹åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="item-type-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="item-type-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="item-type-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>ç‰©å“é¡å‹æ¸¬è©¦</label>
                        <div class="item-type-test-container">
                            <input type="text" id="test-item-type-name" placeholder="è¼¸å…¥ç‰©å“é¡å‹åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-item-type-btn" class="test-portrait-btn">æ¸¬è©¦ç‰©å“é¡å‹</button>
                            <div id="item-type-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="material-settings-actions">
                <button class="settings-btn confirm" id="saveMaterialSettings">ä¿å­˜</button>
            </div>
        </div>
    </div>


    <!-- éŸ³é »æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£ -->
<div class="modal" id="audioTagModal">
    <div class="audio-tag-container">
        <div class="audio-tag-header">
            <div class="audio-tag-title">ğŸµ éŸ³é »æ¨™ç±¤è¨­ç½®</div>
            <button class="close-audio-tag" id="closeAudioTag">&times;</button>
        </div>
        
        <div class="audio-tag-content">
            <div class="audio-preview-section">
                <div class="audio-preview-container">
                    <div class="audio-info">
                        <div class="audio-name" id="audioTagFileName">æœªé¸æ“‡éŸ³é »</div>
                        <div class="audio-url" id="audioTagFileUrl">URLæœªè¨­ç½®</div>
                    </div>
                </div>
            </div>
            
            <div class="tag-input-section">
                <div class="form-group">
                    <label>éŸ³é »åˆ†é¡</label>
                    <div class="category-display" id="audioCategoryDisplay">BGMéŸ³æ¨‚</div>
                    <input type="hidden" id="audioTagCategory" value="bgm">
                </div>
                
                <div class="form-group">
                    <label for="audioTagLabel">æ¨™ç±¤åç¨±</label>
                    <input type="text" id="audioTagLabel" class="tag-label-input" placeholder="ä¾‹å¦‚ï¼šæˆ°é¬¥BGMã€å‹åˆ©éŸ³æ•ˆç­‰">
                    <div class="tag-help-text" id="audioTagHelpText">è¼¸å…¥éŸ³é »åç¨±ï¼Œç”¨æ–¼VNé¢æ¿è­˜åˆ¥å’Œæ’­æ”¾</div>
                </div>
            </div>
            
            <div class="tag-preview-section">
                <div class="tag-preview-title">é è¦½å‘½å</div>
                <div class="tag-preview-result" id="audioTagPreviewResult">æœªè¨­ç½®æ¨™ç±¤</div>
            </div>
        </div>
        
        <div class="audio-tag-footer">
            <button class="audio-tag-btn cancel" id="cancelAudioTag">å–æ¶ˆ</button>
            <button class="audio-tag-btn confirm" id="confirmAudioTag" disabled>ç¢ºèªä¿å­˜</button>
        </div>
    </div>
</div>


    <!-- æ­·å²å°è©±æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="historyModal">
        <div class="history-container">
            <div class="history-header">
                <div class="history-title">æ­·å²å°è©±</div>
                <button class="close-history">&times;</button>
            </div>
            <div class="history-content">
            </div>
        </div>
    </div>
    
    <!-- EventonåŠ‡æƒ…æ¨¡æ…‹çª—å£å·²ç§»å‹•åˆ°å•Ÿå‹•ç•Œé¢å±¤ç´š -->
    
    <!-- CalltypeåŠ‡æƒ…æ¨¡æ…‹çª—å£ -->
    <div class="vn-modal" id="callDialog">
        <div class="call-dialog-container">
            <div class="call-single-background"></div>

            <div id="incoming-call-interface" class="incoming-call-interface" style="display: none;">
                <div class="incoming-call-header">
                    <div class="incoming-call-status">æ¥ç”µ</div>
                </div>
                
                <div class="incoming-call-content">
                    <div class="incoming-caller-info">
                        <div class="incoming-caller-avatar-container">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNlNWU3ZWIiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzY2NzM4NyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMlpNMTIgNUMyMC4xMyA1IDI3IDExLjg3IDI3IDIwSDE3VjEzSDExVjIwSDFDMSAxMS44NyA3Ljg3IDUgMTYgNUgxMloiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="Caller" class="incoming-caller-avatar">
                        </div>
                        <div class="incoming-caller-name">æœªçŸ¥æ¥ç”µ</div>
                        <div class="incoming-call-subtitle">æ­£åœ¨å‘¼å«...</div>
                    </div>
                </div>
                
                <div class="incoming-call-actions">
                    <button id="decline-call-button" class="call-action-btn decline-btn">
                        <svg class="call-action-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12,9C10.89,9 10,8.1 10,7C10,5.89 10.89,5 12,5C13.11,5 14,5.89 14,7C14,8.1 13.11,9 12,9M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2Z"/>
                        </svg>
                        <span>æ‹’ç»</span>
                    </button>
                    
                    <button id="answer-call-button" class="call-action-btn answer-btn">
                        <svg class="call-action-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/>
                        </svg>
                        <span>æ¥å¬</span>
                    </button>
                </div>
            </div>

            <div id="call-content-interface" class="call-content-interface" style="display: none;">
                <div class="call-dialog-header">
                    <span class="call-time-indicator">00:00</span>
                </div>

                <div class="call-dialog-content">
                    <div class="call-phone-style-character">
                        <div class="other-character-image-container">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNlNWU3ZWIiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzY2NzM4NyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMlpNMTIgNUMyMC4xMyA1IDI3IDExLjg3IDI3IDIwSDE3VjEzSDExVjIwSDFDMSAxMS44NyA3Ljg3IDUgMTYgNUgxMloiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="Other Character" class="other-character-image">
                        </div>
                        <div class="other-character-name">è§’è‰²å</div>
                    </div>

                    <div class="call-messages">
                    </div>
                </div>

                <div class="call-dialog-footer">
                    <button class="call-action-button">
                        <svg class="call-action-button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" /></svg>
                    </button>
                     <button class="call-action-button">
                        <svg class="call-action-button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4C7,4 2.73,7.11 1,11.5C2.73,15.89 7,19 12,19S21.27,15.89 23,11.5C21.27,7.11 17,4 12,4M12,16.5A4.5,4.5 0 0,1 7.5,12A4.5,4.5 0 0,1 12,7.5A4.5,4.5 0 0,1 16.5,12A4.5,4.5 0 0,1 12,16.5M12,9.5A2.5,2.5 0 0,0 9.5,12A2.5,2.5 0 0,0 12,14.5A2.5,2.5 0 0,0 14.5,12A2.5,2.5 0 0,0 12,9.5Z" /></svg>
                    </button>
                    <button id="end-call-dialog">
                        <svg class="call-action-button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M13.07,12.38L14.5,13.81C15.03,13.56 15.5,13.21 16,12.78L17.42,14.2C16.63,15 15.72,15.65 14.75,16.08L15.9,17.23C16.89,16.63 17.78,15.89 18.54,15.08L20,16.54C18.25,18.29 16.04,19.5 13.5,19.5C11.53,19.5 9.68,18.91 8.1,17.9L9.25,16.75C10.5,17.5 11.95,18 13.5,18C15.05,18 16.45,17.45 17.58,16.58L16.16,15.16C15.45,15.58 14.63,15.89 13.76,16.05L12.38,13.07M12,3C16.97,3 21,7.03 21,12C21,14.08 20.3,16 19.13,17.5L17.7,16.07C18.4,14.9 18.81,13.5 18.81,12C18.81,8.19 15.81,5.19 12,5.19C10.5,5.19 9.1,5.6 7.93,6.3L6.5,4.87C8.04,3.71 9.92,3 12,3M4.93,4.93L3.5,6.36L6.5,9.36C6.1,10.15 5.81,11.04 5.81,12C5.81,12.11 5.82,12.21 5.82,12.32L3.77,10.27C3.28,10.77 3,11.36 3,12A9,9 0 0,0 12,21C12.64,21 13.23,20.72 13.73,20.23L17.64,24.14L19.07,22.71L4.93,4.93Z" /></svg>
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Livestreamæ¨¡æ…‹çª—å£ -->
    <div class="vn-modal" id="livestreamDialog">
        <div class="livestream-dialog-container">
            <div class="livestream-dialog-header">
                <div class="livestream-info">
                    <span class="livestream-name" id="ls-stream-name">ç›´æ’­é–“åç¨±</span>
                    <span class="livestream-status"><span class="livestream-status-dot"></span><span id="ls-stream-status">ç›´æ’­ä¸­</span></span>
                </div>
                <div class="livestream-stats">
                    <span class="livestream-viewers" id="ls-viewers"><i class="fa fa-eye"></i> <span id="ls-viewers-count">0</span></span>
                    <span class="livestream-gifts" id="ls-gifts"><i class="fa fa-gift"></i> <span id="ls-gifts-count">0</span></span>
                </div>
                <button class="close-livestream-dialog">&times;</button>
            </div>
            <div class="livestream-dialog-content">
                <div class="livestream-background"></div>
                
                <div class="livestream-main">
                    <div class="livestream-character">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNlNWU3ZWIiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzY2NzM4NyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMlpNMTIgNUMyMC4xMyA1IDI3IDExLjg3IDI3IDIwSDE3VjEzSDExVjIwSDFDMSAxMS44NyA3Ljg3IDUgMTYgNUgxMloiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="Streamer" class="streamer-image" id="streamer-image">
                        <div class="streamer-name" id="streamer-name">ä¸»æ’­å</div>
                    </div>
                    
                    <div class="livestream-dialog-box">
                        <div class="livestream-dialog-text" id="livestream-dialog-text"></div>
                    </div>
                </div>
                
                <div class="livestream-chat">
                    <div class="livestream-chat-header">
                        <span>ç›´æ’­èŠå¤©å®¤</span>
                    </div>
                    <div class="livestream-chat-messages" id="livestream-chat-messages">
                    </div>
                    <div class="livestream-gift-ranking">
                        <div class="gift-ranking-header">ç¦®ç‰©æ’è¡Œæ¦œ</div>
                        <div class="gift-ranking-list" id="gift-ranking-list">
                        </div>
                    </div>
                </div>
            </div>
            <div class="livestream-dialog-footer">
                <button class="livestream-end-button" id="end-livestream-dialog">é›¢é–‹ç›´æ’­é–“</button>
            </div>
        </div>
    </div>
    
    <!-- EchoåŠ‡æƒ…æ¨¡æ…‹çª—å£ -->
    <div class="vn-modal" id="echoModal">
        <div class="echo-dialog-container">
            <div class="echo-dialog-content" id="echoDialogContent">
                <!-- ğŸ”¥ æ–°å¢ï¼šEchoå•Ÿå‹•é é¢ï¼ˆå³æ»‘è§£é–æ•ˆæœï¼‰ -->
                <div class="echo-startup-screen" id="echoStartupScreen">
                    <div class="echo-startup-content">
                        <div class="echo-startup-icon">ğŸ“±</div>
                        <div class="echo-startup-title">Echo ç¤¾äº¤åª’é«”</div>
                        <div class="echo-startup-subtitle">å³æ»‘è§£é–é€²å…¥ç¤¾äº¤ä¸–ç•Œ</div>
                        <div class="echo-startup-hint">â†’ å‘å³æ»‘å‹•é–‹å•Ÿ</div>
                    </div>
                    <div class="echo-startup-slider">
                        <div class="echo-startup-slider-track">
                            <div class="echo-startup-slider-thumb" id="echoStartupSliderThumb">
                                <span class="echo-startup-slider-arrow">â†’</span>
                            </div>
                        </div>
                    </div>
                </div>

                <iframe id="echo-iframe" class="echo-iframe" src="about:blank" style="display: none;"></iframe>
            </div>
        </div>
        
        <!-- ğŸ”¥ ä¿®æ­£ï¼šå°‡footerç§»åˆ°iframeå®¹å™¨å¤–é¢ -->
        <div class="echo-dialog-footer" id="echoDialogFooter" style="display: none;">
            <button class="echo-close-button" id="close-echo-button">é—œé–‰Echo</button>
        </div>
    </div>

    <!-- Itemç‰©å“å±•ç¤ºæ¨¡æ…‹çª—å£ -->
<div class="vn-modal" id="itemModal">
    <div class="item-dialog-container">
        <button class="close-item-dialog" id="close-item-dialog">&times;</button>

        <div class="item-dialog-content">
            <div class="item-image-container">
                <img id="item-image" class="item-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNlNWU3ZWIiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzY2NzM4NyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMlpNMTIgNUMyMC4xMyA1IDI3IDExLjg3IDI3IDIwSDE3VjEzSDExVjIwSDFDMSAxMS44NyA3Ljg3IDUgMTYgNUgxMloiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="ç‰©å“åœ–ç‰‡">
            </div>
            
            <div class="item-info">
                <h3 id="item-name" class="item-name">ç‰©å“åç¨±</h3>
                <p id="item-description" class="item-description">ç‰©å“æè¿°</p>
            </div>
        </div>
        
        <div class="item-dialog-footer">
            <button class="item-close-button" id="close-item-button">ç¢ºèª</button>
        </div>
    </div>
</div>
    
    <!-- ChatåŠ‡æƒ…æ¨¡æ…‹çª—å£ - iPhoneé¢¨æ ¼ -->
    <div id="simple-chat-modal" class="simple-chat-modal">
        <div class="simple-chat-container">
            <div class="simple-chat-header">
                <button id="continue-chat-story" class="continue-chat-button">è·³éä¸¦ç¹¼çºŒ</button>
                <div id="simple-chat-modal-title">èŠå¤©çª—å£</div>
                <button id="close-simple-chat" class="close-simple-chat" title="è¿”å›"></button>
            </div>
            <div id="simple-chat-messages" class="simple-chat-messages">
                <div class="simple-chat-loading">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="iphone-home-indicator"></div>
            <div class="dynamic-island-sensor"></div>
        </div>
    </div>

        <!-- åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£ -->
        <div class="modal" id="imageTagModal">
            <div class="image-tag-container">
                <div class="image-tag-header">
                    <div class="image-tag-title">ğŸ“ åœ–ç‰‡æ¨™ç±¤è¨­ç½®</div>
                    <button class="close-image-tag" id="closeImageTag">&times;</button>
                </div>
                
                <div class="image-tag-content">
                    <div class="image-preview-section">
                        <div class="image-preview-container">
                            <img id="imageTagPreview" class="image-tag-preview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNlNWU3ZWIiLz4KPHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzY2NzM4NyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMlpNMTIgNUMyMC4xMyA1IDI3IDExLjg3IDI3IDIwSDE3VjEzSDExVjIwSDFDMSAxMS44NyA3Ljg3IDUgMTYgNUgxMloiLz4KPC9zdmc+Cjwvc3ZnPgo=" alt="åœ–ç‰‡é è¦½">
                        </div>
                        <div class="image-info">
                            <div class="image-name" id="imageTagFileName">æœªé¸æ“‡åœ–ç‰‡</div>
                            <div class="image-size" id="imageTagFileSize">0 KB</div>
                        </div>
                    </div>
                    
                    <div class="tag-input-section">
                        <div class="form-group" id="categoryDisplayGroup">
                            <label>ç´ æåˆ†é¡</label>
                            <div class="category-display" id="categoryDisplay">è§’è‰²ç«‹ç¹ªï¼ˆé è¨­ï¼‰</div>
                            <input type="hidden" id="imageTagCategory" value="portrait">
                        </div>
                        
                        <div class="form-group">
                            <label for="imageTagLabel">æ¨™ç±¤åç¨±</label>
                            <input type="text" id="imageTagLabel" class="tag-label-input" placeholder="ä¾‹å¦‚ï¼šå°ç±³ã€happyã€å­¸æ ¡ç­‰">
                            <div class="tag-help-text" id="tagHelpText">è¼¸å…¥è§’è‰²åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_presets.png</div>
                        </div>
                        
                        <div class="form-group" id="emotionTagGroup" style="display: none;">
                            <label for="imageTagEmotion">è¡¨æƒ…æ¨™ç±¤</label>
                            <input type="text" id="imageTagEmotion" class="tag-emotion-input" placeholder="ä¾‹å¦‚ï¼šhappyã€sadã€angryç­‰">
                            <div class="tag-help-text">è¼¸å…¥è¡¨æƒ…åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_è¡¨æƒ….png</div>
                        </div>
                    </div>
                    
                    <div class="tag-preview-section">
                        <div class="tag-preview-title">é è¦½å‘½å</div>
                        <div class="tag-preview-result" id="tagPreviewResult">æœªè¨­ç½®æ¨™ç±¤</div>
                    </div>
                </div>
                
                <div class="image-tag-footer">
                    <button class="image-tag-btn cancel" id="cancelImageTag">å–æ¶ˆ</button>
                    <button class="image-tag-btn confirm" id="confirmImageTag" disabled>ç¢ºèªä¸Šå‚³</button>
                </div>
            </div>
        </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // å…¨å±€Markdownè™•ç†å‡½æ•¸
        window.processMarkdown = function(text) {
            if (!text) return '';
            
            if (typeof text !== 'string') {
                return String(text);
            }
            
            try {
                if (typeof marked === 'undefined') {
                    console.error('Markdownè™•ç†éŒ¯èª¤: markedåº«æœªåŠ è¼‰');
                    return text;
                }
                
                const html = marked.parse(text, {
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    mangle: false,
                    sanitize: false
                });
                
                return html.replace(/^<p>(.+)<\/p>$/s, '$1');
            } catch (e) {
                console.error('Markdownè™•ç†éŒ¯èª¤:', e);
                return text;
            }
        };

        // æ‰‹æœºç‰ˆèƒŒæ™¯ä¿¡æ¯æ˜¾ç¤º
        function showMobileBackgroundInfo(location, url) {
            const info = document.getElementById('mobileBackgroundInfo');
            if (info) {
                info.textContent = `èƒŒæ™¯: ${location} (${url})`;
                info.classList.add('show');
                setTimeout(() => {
                    info.classList.remove('show');
                }, 5000);
            }
        }

        // æ‰‹æœºç‰ˆè®¾ç½®æŒ‰é’®åŠŸèƒ½
        $(document).ready(function() {
            // æ˜¾ç¤ºå½“å‰èƒŒæ™¯
            $('#showCurrentBackground').click(function() {
                const vnData = window.VNCoreAPI?.vnData;
                const currentLocation = vnData?.sceneInfo?.location || 'æœªçŸ¥';
                const backgroundUrl = window.VNCoreAPI?.generateBackgroundUrl ? 
                    window.VNCoreAPI.generateBackgroundUrl(currentLocation) : 
                    'https://nancywang3641.github.io/sound-files/location_img/default.jpeg';
                
                showMobileBackgroundInfo(currentLocation, backgroundUrl);
                // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç•¶å‰èƒŒæ™¯:', { location: currentLocation, url: backgroundUrl });
            });

            // æµ‹è¯•é»˜è®¤èƒŒæ™¯
            $('#testDefaultBackground').click(function() {
                const defaultUrl = 'https://nancywang3641.github.io/sound-files/location_img/default.jpeg';
                if (window.VNCoreAPI?.applyBackgroundImage) {
                    window.VNCoreAPI.applyBackgroundImage(defaultUrl);
                    showMobileBackgroundInfo('é è¨­èƒŒæ™¯', defaultUrl);
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²è¼‰å…¥é è¨­èƒŒæ™¯');
                }
            });

            // æµ‹è¯•Transitionè¿‡åœº
            $('#testTransition').click(function() {
                if (window.VNFeatures?.showTransition) {
                    window.VNFeatures.showTransition('é€™æ˜¯æ‰‹æ©Ÿç‰ˆTransitionæ¸¬è©¦\néå ´æ•ˆæœæ­£å¸¸é‹ä½œ', () => {
                        // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] Transitionæ¸¬è©¦å®Œæˆ');
                    });
                }
            });

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            $('#showDebugInfo').click(function() {
                const vnData = window.VNCoreAPI?.vnData;
                const backgroundState = window.VNCoreAPI?.backgroundImageState;
                
                 console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ èª¿è©¦ä¿¡æ¯]', {
                    ç‰ˆæœ¬: '21.1-mobile',
                    ç•¶å‰å ´æ™¯: vnData?.sceneInfo?.location || 'æœªçŸ¥',
                    èƒŒæ™¯ç‹€æ…‹: backgroundState,
                    å°è©±ç´¢å¼•: window.VNCoreAPI?.currentDialogueIndex || 0,
                    ç¸½å°è©±æ•¸: vnData?.dialogues?.length || 0,
                    è§’è‰²æ•¸æ“š: vnData?.charData,
                    ç”¨æˆ¶æ•¸æ“š: vnData?.userData
                });
                
                alert('èª¿è©¦ä¿¡æ¯å·²è¼¸å‡ºåˆ°æ§åˆ¶å° (F12æŸ¥çœ‹)');
            });

            // æŸ¥çœ‹å·²ä¿å­˜çš„æŒ‡ä»¤ç±»å‹
            $('#showSavedCommandTypes').click(function() {
                if (window.VNFeatures?.commandSystemState) {
                    const state = window.VNFeatures.commandSystemState;
                    const defaultTypes = ['è§’è‰²çŸ¯æ­£', 'åŠ‡æƒ…çŸ¯æ­£'];
                    const customTypes = state.commandTypes.filter(type => !defaultTypes.includes(type));
                    
                    let message = 'ğŸ·ï¸ é»˜èªæŒ‡ä»¤é¡å‹ï¼š\n' + defaultTypes.join('ã€') + '\n\n';
                    
                    if (customTypes.length > 0) {
                        message += 'ğŸ’¬ è‡ªå®šç¾©æŒ‡ä»¤é¡å‹ï¼š\n' + customTypes.join('ã€');
                    } else {
                        message += 'ğŸ’¬ æš«ç„¡è‡ªå®šç¾©æŒ‡ä»¤é¡å‹';
                    }
                    
                    alert(message);
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æŒ‡ä»¤é¡å‹ç‹€æ…‹:', state);
                } else {
                    alert('ç„¡æ³•ç²å–æŒ‡ä»¤é¡å‹ä¿¡æ¯');
                }
            });

            // æ¸…é™¤è‡ªå®šä¹‰æŒ‡ä»¤ç±»å‹
            $('#clearCommandTypes').click(function() {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è‡ªå®šç¾©æŒ‡ä»¤é¡å‹å—ï¼Ÿ\né€™å°‡æ¢å¾©ç‚ºé»˜èªè¨­ç½®ï¼ˆè§’è‰²çŸ¯æ­£ã€åŠ‡æƒ…çŸ¯æ­£ï¼‰ã€‚')) {
                    if (window.VNFeatures?.clearCommandTypesStorage) {
                        window.VNFeatures.clearCommandTypesStorage();
                        
                        // é‡ç½®æŒ‡ä»¤ç±»å‹æ•°ç»„
                        if (window.VNFeatures?.commandSystemState) {
                            // è¿™é‡Œéœ€è¦ç›´æ¥è®¿é—®å†…éƒ¨çŠ¶æ€
                            try {
                                // é€šè¿‡æ§åˆ¶å°æ‰§è¡Œé‡ç½®
                                // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é‡ç½®æŒ‡ä»¤é¡å‹åˆ°é»˜èªå€¼');
                                
                                alert('âœ… è‡ªå®šç¾©æŒ‡ä»¤é¡å‹å·²æ¸…é™¤ï¼\nè«‹é‡æ–°æ•´ç†é é¢ä»¥å®Œå…¨é‡ç½®ã€‚');
                                
                                // å¯é€‰ï¼šè‡ªåŠ¨åˆ·æ–°é¡µé¢
                                if (confirm('æ˜¯å¦ç«‹å³é‡æ–°æ•´ç†é é¢ï¼Ÿ')) {
                                    location.reload();
                                }
                            } catch (error) {
                                console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é‡ç½®æŒ‡ä»¤é¡å‹å¤±æ•—:', error);
                                alert('é‡ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ‰‹å‹•é‡æ–°æ•´ç†é é¢ã€‚');
                            }
                        }
                    } else {
                        alert('æ¸…é™¤åŠŸèƒ½ä¸å¯ç”¨');
                    }
                }
            });
        });
    </script>
    
    <!-- ä¸»åŠŸèƒ½ -->    
    <script src="vntype-core-base.js"></script>        <!-- å¿…é¡»ç¬¬ä¸€ä¸ª -->
    <script src="vntype-character-scene.js"></script>   <!-- è§’è‰²åœºæ™¯åŠŸèƒ½ -->
    <script src="vntype-ui-dialogue.js"></script>       <!-- å¯¹è¯UIåŠŸèƒ½ -->
    <script src="material-window.js"></script>          <!-- ç´ æç®¡ç†åŠŸèƒ½ -->
    <script src="material-settings-clean.js"></script>  <!-- ç´ æè¨­ç½®ç®¡ç† (æ¸…ç†ç‰ˆ) -->
    <script src="vn_background_generator.js"></script>  <!-- èƒŒæ™¯åœ–ç‰‡ç”Ÿæˆå™¨ -->

            <script src="vntype-features-audio.js"></script>    <!-- éŸ³é¢‘åŠŸèƒ½ -->
            <script src="vntype-features-special.js"></script>  <!-- ç‰¹æ®ŠåŠŸèƒ½ -->


    <!-- TPYEåŠŸèƒ½ -->
    <script src="chattype-listeners.js"></script>
    <script src="calltype-listeners.js"></script>
    <script src="livestreamtype-listeners.js"></script>



    <script>
        // èƒŒæ™¯åœ–ç‰‡æ›´æ–°æ¶ˆæ¯ç›£è½å™¨
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'background-image-update') {
                // console.log('[VNé¢æ¿] æ¥æ”¶åˆ°èƒŒæ™¯åœ–ç‰‡æ›´æ–°:', event.data);
                
                const { imageUrl, facilityName, timestamp } = event.data;
                
                // æ›´æ–°èƒŒæ™¯åœ–ç‰‡
                if (imageUrl) {
                    updateVNBackgroundImage(imageUrl, facilityName);
                }
            }
        });
        
        // æ›´æ–°VNèƒŒæ™¯åœ–ç‰‡
        function updateVNBackgroundImage(imageUrl, facilityName) {
            try {
                // æŸ¥æ‰¾èƒŒæ™¯åœ–ç‰‡å…ƒç´ 
                const backgroundElement = document.querySelector('.vn-background-image');
                if (backgroundElement) {
                    // æ·»åŠ æ·¡å…¥æ•ˆæœ
                    backgroundElement.style.opacity = '0';
                    backgroundElement.style.transition = 'opacity 0.5s ease-in-out';
                    
                    setTimeout(() => {
                        backgroundElement.src = imageUrl;
                        backgroundElement.style.opacity = '1';
                        
                        // æ·»åŠ è¨­æ–½åç¨±æç¤º
                        if (facilityName) {
                            showFacilityNotification(facilityName);
                        }
                        
                        // console.log('[VNé¢æ¿] èƒŒæ™¯åœ–ç‰‡å·²æ›´æ–°:', imageUrl);
                    }, 250);
                } else {
                    console.warn('[VNé¢æ¿] æœªæ‰¾åˆ°èƒŒæ™¯åœ–ç‰‡å…ƒç´ ');
                }
            } catch (error) {
                console.error('[VNé¢æ¿] æ›´æ–°èƒŒæ™¯åœ–ç‰‡å¤±æ•—:', error);
            }
        }
        
        // é¡¯ç¤ºè¨­æ–½åç¨±é€šçŸ¥
        function showFacilityNotification(facilityName) {
            try {
                // å‰µå»ºé€šçŸ¥å…ƒç´ 
                const notification = document.createElement('div');
                notification.className = 'facility-notification';
                notification.textContent = `ğŸ“ ${facilityName}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: bold;
                    z-index: 10000;
                    animation: fadeInOut 3s ease-in-out;
                `;
                
                // æ·»åŠ å‹•ç•«æ¨£å¼
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                        20% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(notification);
                
                // 3ç§’å¾Œç§»é™¤é€šçŸ¥
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('[VNé¢æ¿] é¡¯ç¤ºè¨­æ–½é€šçŸ¥å¤±æ•—:', error);
            }
        }
        
        // VNä¸»å¯åŠ¨ç•Œé¢æ§åˆ¶é€»è¾‘ - æ‰‹æœºç‰ˆ
        document.addEventListener('DOMContentLoaded', function() {
            const vnLandingContainer = document.getElementById('vnLandingContainer');
            const vnMainContainer = document.getElementById('vnMainContainer');
            const startStoryBtn = document.getElementById('startStoryBtn');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const backToLandingBtn = document.getElementById('backToLandingBtn');

            // åˆå§‹çŠ¶æ€ï¼šæ˜¾ç¤ºå¯åŠ¨ç•Œé¢
            if (vnLandingContainer) vnLandingContainer.classList.add('active');
            if (vnMainContainer) vnMainContainer.classList.remove('active');
            
            // ğŸš€ åˆå§‹åŒ–æ™‚é€šçŸ¥çˆ¶çª—å£ï¼šVNé¢æ¿åœ¨å•Ÿå‹•é é¢ï¼Œé¡¯ç¤ºiframeé—œé–‰éµ
            setTimeout(() => {
                notifyParentWindowChange(false);
            }, 100);

            // ğŸš€ æ·»åŠ é é¢å¯è¦‹æ€§æª¢æ¸¬ï¼Œç•¶iframeé‡æ–°å¯è¦‹æ™‚é‡æ–°ç™¼é€ç‹€æ…‹
            let isInStoryMode = false;
            
            // æª¢æ¸¬é é¢æ˜¯å¦å¯è¦‹
            function handleVisibilityChange() {
                if (!document.hidden) {
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢é‡æ–°å¯è¦‹ï¼Œæª¢æ¸¬ç•¶å‰ç‹€æ…‹ä¸¦é‡æ–°ç™¼é€é€šçŸ¥');
                    // æª¢æ¸¬ç•¶å‰ç‹€æ…‹ä¸¦é‡æ–°ç™¼é€é€šçŸ¥
                    const currentState = detectCurrentVNState();
                    isInStoryMode = currentState.isInStoryMode;
                    notifyParentWindowChange(isInStoryMode);
                }
            }
            
            // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // ç›£è½çª—å£ç„¦é»è®ŠåŒ–
            window.addEventListener('focus', function() {
                // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] çª—å£ç²å¾—ç„¦é»ï¼Œæª¢æ¸¬ç•¶å‰ç‹€æ…‹ä¸¦é‡æ–°ç™¼é€é€šçŸ¥');
                const currentState = detectCurrentVNState();
                isInStoryMode = currentState.isInStoryMode;
                notifyParentWindowChange(isInStoryMode);
            });
            
            // ğŸš€ ç›£è½é é¢å¸è¼‰äº‹ä»¶ï¼Œç•¶iframeè¢«é—œé–‰æ™‚åœæ­¢BGM
            window.addEventListener('beforeunload', function() {
                // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢å³å°‡å¸è¼‰ï¼Œåœæ­¢æ‰€æœ‰éŸ³æ•ˆå’ŒBGM');
                
                // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
                if (window.VNFeatures?.stopAllSounds) {
                    window.VNFeatures.stopAllSounds();
                }
                
                // å¼·åˆ¶åœæ­¢BGM - ä½¿ç”¨æ­£ç¢ºçš„å‡½æ•¸å
                if (window.VNFeatures?.forceStopBGM) {
                    window.VNFeatures.forceStopBGM();
                } else if (window.VNFeatures?.forceStopCurrentBGM) {
                    window.VNFeatures.forceStopCurrentBGM();
                }
                
                // é€šçŸ¥çˆ¶çª—å£VNé¢æ¿å³å°‡é—œé–‰
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'VN_PANEL_CLOSING',
                            source: 'VN_PANEL',
                            timestamp: Date.now()
                        }, '*');
                        // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²é€šçŸ¥çˆ¶çª—å£VNé¢æ¿å³å°‡é—œé–‰');
                    }
                } catch (error) {
                    console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é€šçŸ¥çˆ¶çª—å£å¤±æ•—:', error);
                }
            });
            
            // ğŸš€ ç›£è½é é¢éš±è—äº‹ä»¶ï¼Œç•¶iframeè¢«éš±è—æ™‚ä¹Ÿåœæ­¢BGM
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢è¢«éš±è—ï¼Œåœæ­¢BGM');
                    
                    // åœæ­¢BGMä½†ä¸åœæ­¢éŸ³æ•ˆï¼ˆå› ç‚ºå¯èƒ½åªæ˜¯åˆ‡æ›æ¨™ç±¤é ï¼‰
                    if (window.VNFeatures?.forceStopBGM) {
                        window.VNFeatures.forceStopBGM();
                    } else if (window.VNFeatures?.forceStopCurrentBGM) {
                        window.VNFeatures.forceStopCurrentBGM();
                    }
                }
            });

            // "å¼€å§‹å‰§æƒ…"æŒ‰é’®
            if (startStoryBtn) {
                startStoryBtn.addEventListener('click', async function() {
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç‚¹å‡»å¼€å§‹å‰§æƒ…æŒ‰é’®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    try {
                        // ä½¿ç”¨å®˜æ–¹API
                        if (window.top?.TavernHelper?.triggerSlash) {
                            // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ä½¿ç”¨å®˜æ–¹APIæ‰§è¡Œtriggerå‘½ä»¤');
                            
                            if (window.VNFeatures?.showLoadingAnimation) {
                                window.VNFeatures.showLoadingAnimation();
                            }
                            
                            // ç«‹å³é€šçŸ¥çˆ¶çª—å£å±•é–‹iframeå°ºå¯¸
                            notifyParentIframeResize('story');
                            showVNMainContainer();
                            await window.top.TavernHelper.triggerSlash('/send è¸å…¥æ•…äº‹');
                            // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] triggerå‘½ä»¤å·²å‘é€');
                            
                        } else {
                            // å¤‡ç”¨æ–¹æ³•
                            console.warn('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å®˜æ–¹APIä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•');
                            const stInput = window.parent.document.querySelector('#send_textarea');
                            const sendButton = window.parent.document.querySelector('#send_but');
                            
                            if (stInput && sendButton) {
                                if (window.VNFeatures?.showLoadingAnimation) {
                                    window.VNFeatures.showLoadingAnimation();
                                }
                                
                                // ç«‹å³é€šçŸ¥çˆ¶çª—å£å±•é–‹iframeå°ºå¯¸
                                notifyParentIframeResize('story');
                                showVNMainContainer();
                                stInput.value = '/send è¸å…¥æ•…äº‹';
                                stInput.dispatchEvent(new Event('input', { bubbles: true }));
                                setTimeout(() => sendButton.click(), 100);
                                // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] triggerå‘½ä»¤å·²é€šè¿‡å¤‡ç”¨æ–¹æ³•å‘é€');
                            } else {
                                console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æ— æ³•æ‰¾åˆ°èŠå¤©è¾“å…¥æ¡†æˆ–å‘é€æŒ‰é’®');
                                alert('æ— æ³•å¯åŠ¨å‰§æƒ…ï¼Œè¯·æ£€æŸ¥èŠå¤©ç•Œé¢æ˜¯å¦æ­£å¸¸ã€‚');
                            }
                        }
                    } catch (error) {
                        console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æ‰§è¡Œtriggerå‘½ä»¤æ—¶å‡ºé”™:', error);
                        alert('å¯åŠ¨å‰§æƒ…æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚');
                        
                        if (window.VNFeatures?.hideLoadingAnimation) {
                            window.VNFeatures.hideLoadingAnimation();
                        }
                    }
                });
            }

            // "æŸ¥çœ‹å†å²å‰§æƒ…"æŒ‰é’®
            if (showHistoryBtn) {
                showHistoryBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç‚¹å‡»å¯åŠ¨é¡µé¢å†å²å‰§æƒ…æŒ‰é’®');
                    
                    // ğŸ†• ä½¿ç”¨æ­·å²çª—å£ç‹€æ…‹ç®¡ç†å™¨æª¢æŸ¥æ˜¯å¦å¯ä»¥ç™¼èµ·è«‹æ±‚
                    if (!window.VNHistoryWindowManager?.canRequestHistory()) {
                        console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æ­·å²è«‹æ±‚è¢«é˜»æ­¢ï¼Œç•¶å‰ç‹€æ…‹:', window.VNHistoryWindowManager?.getStatus());
                        return;
                    }
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // ğŸ†• é–‹å§‹æ­·å²è«‹æ±‚
                    const windowId = window.VNHistoryWindowManager.WINDOW_IDS.LANDING;
                    if (!window.VNHistoryWindowManager.startHistoryRequest(windowId)) {
                        console.warn('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç„¡æ³•é–‹å§‹æ­·å²è«‹æ±‚');
                        return;
                    }
                    
                    if (window.VNFeatures?.showLoadingAnimation) {
                        window.VNFeatures.showLoadingAnimation();
                    }
                    
                    // ä½¿ç”¨VNCoreçš„å†å²è¯·æ±‚æ–¹æ³•
                    if (window.VNCore?.requestVNHistory) {
                        console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ä½¿ç”¨VNCoreè¯·æ±‚å†å²');
                        window.VNCore.requestVNHistory();
                    } else {
                        console.warn('[VNé¢æ¿-æ‰‹æœºç‰ˆ] VNCoreä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•');
                        try {
                            window.parent.postMessage({ 
                                type: 'VN_FETCH_HISTORY_LIST',
                                source: 'VN_PANEL_MOBILE_HISTORY_BUTTON',
                                timestamp: Date.now()
                            }, '*');
                            console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²é€šè¿‡postMessageå‘é€å†å²è¯·æ±‚');
                        } catch (error) {
                            console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å‘é€å†å²è¯·æ±‚æ—¶å‡ºé”™:', error);
                            if (window.VNFeatures?.hideLoadingAnimation) {
                                window.VNFeatures.hideLoadingAnimation();
                            }
                            // ğŸ†• é‡ç½®è«‹æ±‚ç‹€æ…‹
                            window.VNHistoryWindowManager?.completeHistoryRequest();
                            alert('è·å–å†å²è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    }
                    
                    // è®¾ç½®è¶…æ—¶å¤„ç†
                    setTimeout(() => {
                        if (window.VNFeatures?.hideLoadingAnimation) {
                            window.VNFeatures.hideLoadingAnimation();
                        }
                        // ğŸ†• é‡ç½®è«‹æ±‚ç‹€æ…‹
                        window.VNHistoryWindowManager?.completeHistoryRequest();
                        console.warn('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å†å²è¯·æ±‚å¯èƒ½è¶…æ—¶');
                    }, 8000);
                });
            }

            // "è¿”å›ä¸»é¡µ"æŒ‰é’®
            if (backToLandingBtn) {
                backToLandingBtn.addEventListener('click', function() {
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç‚¹å‡»è¿”å›ä¸»é¡µæŒ‰é’®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // æ¸…ç†åŠ‡æƒ…ç‹€æ…‹ - åœæ­¢æ‰€æœ‰éŸ³æ•ˆå’ŒBGM
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æ¸…ç†åŠ‡æƒ…ç‹€æ…‹ï¼šåœæ­¢éŸ³æ•ˆå’ŒBGM');
                    if (window.VNFeatures?.stopAllSounds) {
                        window.VNFeatures.stopAllSounds();
                    }
                    if (window.VNFeatures?.forceStopBGM) {
                        window.VNFeatures.forceStopBGM();
                    }
                    
                    // æ¸…ç†åŠ‡æƒ…æ•¸æ“šç‹€æ…‹
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æ¸…ç†VNæ•¸æ“šç‹€æ…‹');
                    
                    // é‡ç½®å°è©±ç´¢å¼•
                    if (window.VNCore) {
                        window.VNCore.currentDialogueIdx = 0;
                    }
                    
                    // æ¸…ç†è§’è‰²é¡¯ç¤º
                    const characterCenter = document.querySelector('.character-center');
                    if (characterCenter) {
                        characterCenter.innerHTML = '';
                    }
                    
                    // éš±è—å°è©±æ¡†
                    const dialogBox = document.querySelector('.dialog-box');
                    if (dialogBox) {
                        dialogBox.style.display = 'none';
                    }
                    
                    // éš±è—åç¨±æ¨™ç±¤
                    const nameTag = document.querySelector('.name-tag');
                    if (nameTag) {
                        nameTag.style.display = 'none';
                    }
                    
                    // æ¸…ç†é¸æ“‡æŒ‰éˆ•
                    const choicesContainer = document.querySelector('.choices-container');
                    if (choicesContainer) {
                        choicesContainer.innerHTML = '';
                    }
                    
                    // ç«‹å³é€šçŸ¥çˆ¶çª—å£ç¸®å°iframeå°ºå¯¸
                    notifyParentIframeResize('landing');
                    showVNLandingContainer();
                });
            }

            // æ˜¾ç¤ºVNä¸»å®¹å™¨
            function showVNMainContainer() {
                if (vnLandingContainer) vnLandingContainer.classList.remove('active');
                if (vnMainContainer) vnMainContainer.classList.add('active');
                console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²åˆ‡æ¢åˆ°VNä¸»ç•Œé¢');
                
                // ğŸ”¥ æ–°å¢ï¼šå•Ÿç”¨VNè™•ç†å™¨
                try {
                    if (window.top && window.top.VNProcessor && typeof window.top.VNProcessor.enableVNProcessor === 'function') {
                        window.top.VNProcessor.enableVNProcessor();
                        console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âœ… å·²å•Ÿç”¨VNè™•ç†å™¨');
                    } else {
                        console.warn('[VNé¢æ¿-æ‰‹æœºç‰ˆ] VNè™•ç†å™¨ä¸å¯ç”¨æˆ–enableVNProcessorå‡½æ•¸ä¸å­˜åœ¨');
                    }
                } catch (error) {
                    console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å•Ÿç”¨VNè™•ç†å™¨å¤±æ•—:', error);
                }
                
                // ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥çˆ¶çª—å£åœæ­¢éŸ³æ¨‚
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'VN_STOP_MAIN_MUSIC',
                            source: 'VN_PANEL',
                            timestamp: Date.now()
                        }, '*');
                        // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²é€šçŸ¥çˆ¶çª—å£åœæ­¢éŸ³æ¨‚');
                    }
                } catch (error) {
                    console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é€šçŸ¥çˆ¶çª—å£åœæ­¢éŸ³æ¨‚å¤±æ•—:', error);
                }
                
                // ğŸš€ æ›´æ–°ç‹€æ…‹ä¸¦é€šçŸ¥çˆ¶çª—å£ï¼šVNé¢æ¿å·²é€²å…¥åŠ‡æƒ…é é¢ï¼Œéš±è—iframeé—œé–‰éµ
                isInStoryMode = true;
                notifyParentWindowChange(true);
            }

            // æ˜¾ç¤ºVNå¯åŠ¨å®¹å™¨
            function showVNLandingContainer() {
                if (vnMainContainer) vnMainContainer.classList.remove('active');
                if (vnLandingContainer) vnLandingContainer.classList.add('active');
                console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²è¿”å›å¯åŠ¨ç•Œé¢');
                
                // ğŸ”¥ æ–°å¢ï¼šç¦ç”¨VNè™•ç†å™¨
                try {
                    if (window.top && window.top.VNProcessor && typeof window.top.VNProcessor.disableVNProcessor === 'function') {
                        window.top.VNProcessor.disableVNProcessor();
                        console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âŒ å·²ç¦ç”¨VNè™•ç†å™¨');
                    } else {
                        console.warn('[VNé¢æ¿-æ‰‹æœºç‰ˆ] VNè™•ç†å™¨ä¸å¯ç”¨æˆ–disableVNProcessorå‡½æ•¸ä¸å­˜åœ¨');
                    }
                } catch (error) {
                    console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç¦ç”¨VNè™•ç†å™¨å¤±æ•—:', error);
                }
                
                // ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥çˆ¶çª—å£æ¢å¾©éŸ³æ¨‚
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'VN_RESUME_MAIN_MUSIC',
                            source: 'VN_PANEL_LANDING',
                            timestamp: Date.now()
                        }, '*');
                        // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²é€šçŸ¥çˆ¶çª—å£æ¢å¾©éŸ³æ¨‚');
                    }
                } catch (error) {
                    console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é€šçŸ¥çˆ¶çª—å£æ¢å¾©éŸ³æ¨‚å¤±æ•—:', error);
                }
                
                // ğŸš€ æ›´æ–°ç‹€æ…‹ä¸¦é€šçŸ¥çˆ¶çª—å£ï¼šVNé¢æ¿å·²è¿”å›å•Ÿå‹•é é¢ï¼Œé¡¯ç¤ºiframeé—œé–‰éµ
                isInStoryMode = false;
                notifyParentWindowChange(false);
            }
            
            // ğŸš€ æª¢æ¸¬ç•¶å‰VNé¢æ¿ç‹€æ…‹
            function detectCurrentVNState() {
                const state = {
                    isInStoryMode: false,
                    isInLandingPage: false,
                    isInContinueStoryMode: false,
                    hasDialogues: false,
                    hasChoices: false
                };
                
                // æª¢æ¸¬æ˜¯å¦åœ¨å•Ÿå‹•é é¢
                const vnLandingContainer = document.getElementById('vnLandingContainer');
                const vnMainContainer = document.getElementById('vnMainContainer');
                
                if (vnLandingContainer && vnLandingContainer.classList.contains('active')) {
                    state.isInLandingPage = true;
                    state.isInStoryMode = false;
                } else if (vnMainContainer && vnMainContainer.classList.contains('active')) {
                    state.isInLandingPage = false;
                    
                    // æª¢æ¸¬æ˜¯å¦åœ¨ç¹¼çºŒåŠ‡æƒ…æ¨¡å¼
                    const continueStoryButton = document.querySelector('.continue-story-button');
                    const continueStoryBackdrop = document.querySelector('.continue-story-backdrop');
                    const continueStoryActionsBar = document.querySelector('.continue-story-actions-bar');
                    
                    if (continueStoryButton || continueStoryBackdrop || continueStoryActionsBar) {
                        // ç«‹å³é€šçŸ¥çˆ¶çª—å£ç¸®å°iframeå°ºå¯¸
                        notifyParentIframeResize('continue');
                        state.isInContinueStoryMode = true;
                        state.isInStoryMode = false; // ç¹¼çºŒåŠ‡æƒ…æ¨¡å¼è¦–ç‚ºéåŠ‡æƒ…æ¨¡å¼ï¼Œéœ€è¦é¡¯ç¤ºé—œé–‰æŒ‰éˆ•
                    } else {
                        // æª¢æ¸¬æ˜¯å¦æœ‰å°è©±æ•¸æ“š
                        const hasDialogues = window.VNCoreAPI?.vnData?.dialogues && window.VNCoreAPI.vnData.dialogues.length > 0;
                        const hasChoices = window.VNCoreAPI?.vnData?.choices && window.VNCoreAPI.vnData.choices.length > 0;
                        
                        state.hasDialogues = hasDialogues;
                        state.hasChoices = hasChoices;
                        
                        // ğŸ”¥ ä¿®æ”¹ï¼šæª¢æ¸¬æ˜¯å¦åœ¨loadingç‹€æ…‹ï¼ˆAIæ€è€ƒä¸­ï¼‰
                        const isLoading = document.querySelector('#fullscreen-loading-overlay') || 
                                        document.querySelector('.fullscreen-loading-overlay') ||
                                        document.querySelector('.dialog-loading-container.active') ||
                                        document.querySelector('[class*="loading"]') ||
                                        document.querySelector('[class*="thinking"]') ||
                                        document.querySelector('[class*="AIæ€è€ƒ"]') ||
                                        document.querySelector('.simple-chat-loading');
                        
                        // å¦‚æœæœ‰å°è©±ä¸”æ²’æœ‰é¸æ“‡ï¼Œå¯èƒ½æ˜¯åœ¨åŠ‡æƒ…é€²è¡Œä¸­
                        if (hasDialogues && !hasChoices) {
                            const currentDialogueIndex = window.VNCoreAPI?.currentDialogueIndex || 0;
                            const totalDialogues = window.VNCoreAPI?.vnData?.dialogues?.length || 0;
                            
                            // å¦‚æœå°è©±é‚„æ²’å®Œæˆï¼Œå‰‡ç‚ºåŠ‡æƒ…æ¨¡å¼
                            if (currentDialogueIndex < totalDialogues) {
                                // ç«‹å³é€šçŸ¥çˆ¶çª—å£å±•é–‹iframeå°ºå¯¸
                                notifyParentIframeResize('story');
                                state.isInStoryMode = true;
                            } else {
                                // å°è©±å·²å®Œæˆï¼Œæ‡‰è©²æ˜¯ç¹¼çºŒåŠ‡æƒ…æ¨¡å¼
                                // ç«‹å³é€šçŸ¥çˆ¶çª—å£ç¸®å°iframeå°ºå¯¸
                                notifyParentIframeResize('continue');
                                state.isInContinueStoryMode = true;
                                state.isInStoryMode = false;
                            }
                        } else if (hasChoices) {
                            // æœ‰é¸æ“‡é¸é …ï¼Œè¦–ç‚ºéåŠ‡æƒ…æ¨¡å¼
                            state.isInStoryMode = false;
                        } else if (isLoading) {
                            // ğŸ”¥ æ–°å¢ï¼šå¦‚æœåœ¨loadingç‹€æ…‹ï¼Œè¦–ç‚ºåŠ‡æƒ…æ¨¡å¼ï¼ˆéœ€è¦è™•ç†AIè¼¸å‡ºï¼‰
                            console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æª¢æ¸¬åˆ°loadingç‹€æ…‹ï¼Œå•Ÿç”¨åŠ‡æƒ…æ¨¡å¼');
                            notifyParentIframeResize('story');
                            state.isInStoryMode = true;
                        } else {
                            // æ²’æœ‰å°è©±ä¹Ÿæ²’æœ‰é¸æ“‡ï¼Œå¯èƒ½æ˜¯åˆå§‹ç‹€æ…‹
                            state.isInStoryMode = false;
                        }
                    }
                }
                
                // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç‹€æ…‹æª¢æ¸¬çµæœ:', state);
                return state;
            }
            
            // ğŸš€ é€šçŸ¥çˆ¶çª—å£VNé¢æ¿çª—å£ç‹€æ…‹è®ŠåŒ–
            function notifyParentWindowChange(inStoryMode) {
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'VN_WINDOW_CHANGE',
                            inStoryMode: inStoryMode,
                            source: 'VN_PANEL',
                            timestamp: Date.now()
                        }, '*');
                        // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²é€šçŸ¥çˆ¶çª—å£çª—å£ç‹€æ…‹è®ŠåŒ–:', inStoryMode ? 'åŠ‡æƒ…æ¨¡å¼' : 'å•Ÿå‹•é é¢');
                    }
                } catch (error) {
                    console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é€šçŸ¥çˆ¶çª—å£å¤±æ•—:', error);
                }
            }
            
            // ğŸš€ é€šçŸ¥çˆ¶çª—å£VNé¢æ¿iframeå°ºå¯¸èª¿æ•´
            function notifyParentIframeResize(state) {
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'VN_IFRAME_RESIZE',
                            state: state,
                            source: 'VN_PANEL',
                            timestamp: Date.now()
                        }, '*');
                        // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²é€šçŸ¥çˆ¶çª—å£iframeå°ºå¯¸èª¿æ•´:', state);
                    }
                } catch (error) {
                    console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é€šçŸ¥çˆ¶çª—å£iframeå°ºå¯¸èª¿æ•´å¤±æ•—:', error);
                }
            }

            // ç›‘å¬æ¥è‡ªVNæ•°æ®çš„æ¶ˆæ¯ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»ç•Œé¢
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'VN_DATA') {
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æ”¶åˆ°VNæ•°æ®ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»ç•Œé¢');
                    // ç«‹å³é€šçŸ¥çˆ¶çª—å£å±•é–‹iframeå°ºå¯¸
                    notifyParentIframeResize('story');
                    showVNMainContainer();
                }
                
                // ğŸš€ è™•ç†é¢æ¿é‡æ–°æ¿€æ´»æ¶ˆæ¯
                if (event.data && event.data.type === 'VN_PANEL_REACTIVATE') {
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æ”¶åˆ°é¢æ¿é‡æ–°æ¿€æ´»æ¶ˆæ¯ï¼Œæª¢æ¸¬ç•¶å‰ç‹€æ…‹ä¸¦é‡æ–°ç™¼é€é€šçŸ¥');
                    
                    // ğŸš€ æª¢æ¸¬ç•¶å‰ç‹€æ…‹
                    const currentState = detectCurrentVNState();
                    // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] æª¢æ¸¬åˆ°ç•¶å‰ç‹€æ…‹:', currentState);
                    
                    // æ›´æ–°ç‹€æ…‹è®Šé‡
                    isInStoryMode = currentState.isInStoryMode;
                    
                    // é‡æ–°ç™¼é€ç•¶å‰ç‹€æ…‹é€šçŸ¥
                    notifyParentWindowChange(isInStoryMode);
                    
                    // æ ¹æ“šç•¶å‰ç‹€æ…‹é€šçŸ¥iframeå°ºå¯¸èª¿æ•´
                    if (currentState.isInStoryMode) {
                        notifyParentIframeResize('story');
                    } else if (currentState.isInContinueStoryMode) {
                        notifyParentIframeResize('continue');
                    } else {
                        notifyParentIframeResize('landing');
                    }
                }
            });

            // console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] VNä¸»å¯åŠ¨ç•Œé¢æ§åˆ¶é€»è¾‘å·²åˆå§‹åŒ– (æ‰‹æœºç‰ˆç®€åŒ–)');
            
            // åˆå§‹åŒ–æ™‚é€šçŸ¥çˆ¶çª—å£iframeå°ºå¯¸ç‚ºlandingç‹€æ…‹
            notifyParentIframeResize('landing');
            
            // ç¢ºä¿iframeå°ºå¯¸èª¿æ•´å‡½æ•¸ç«‹å³å¯ç”¨
            window.notifyParentIframeResize = notifyParentIframeResize;
            
            // ğŸ†• é é¢å¯è¦‹æ€§ç‹€æ…‹ç®¡ç†
            let lastKnownState = 'landing'; // è¨˜éŒ„æœ€å¾Œå·²çŸ¥çš„ç‹€æ…‹
            
            /**
             * æª¢æ¸¬ç•¶å‰VNé¢æ¿ç‹€æ…‹
             */
            function detectCurrentVNState() {
                const vnMainContainer = document.querySelector('#vnMainContainer');
                const continueStoryButton = document.querySelector('.continue-story-button');
                const actionsBar = document.querySelector('.continue-story-actions-bar');
                
                // æª¢æŸ¥æ˜¯å¦åœ¨åŠ‡æƒ…æ¨¡å¼
                if (vnMainContainer && vnMainContainer.classList.contains('active')) {
                    // æª¢æŸ¥æ˜¯å¦æœ‰å°è©±å…§å®¹
                    const dialogText = document.querySelector('.dialog-text');
                    const hasDialogContent = dialogText && dialogText.textContent && 
                        dialogText.textContent.trim() !== '' && 
                        dialogText.textContent !== 'é€™è£¡æ˜¯è§’è‰²çš„å°è©±å…§å®¹...';
                    
                    if (hasDialogContent) {
                        return { isInStoryMode: true, isInContinueStoryMode: false, state: 'story' };
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦åœ¨ç¹¼çºŒåŠ‡æƒ…æ¨¡å¼
                if (continueStoryButton && continueStoryButton.style.display !== 'none' && 
                    actionsBar && actionsBar.style.display !== 'none') {
                    return { isInStoryMode: false, isInContinueStoryMode: true, state: 'continue' };
                }
                
                // é»˜èªç‚ºå•Ÿå‹•é é¢
                return { isInStoryMode: false, isInContinueStoryMode: false, state: 'landing' };
            }
            
            /**
             * é é¢å¯è¦‹æ€§è®ŠåŒ–è™•ç†
             */
            function handleVisibilityChange() {
                if (!document.hidden) {
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢é‡æ–°å¯è¦‹ï¼Œæ¢å¾©iframeç‹€æ…‹');
                    
                    // æª¢æ¸¬ç•¶å‰ç‹€æ…‹
                    const currentState = detectCurrentVNState();
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç•¶å‰æª¢æ¸¬åˆ°çš„ç‹€æ…‹:', currentState);
                    
                    // æ›´æ–°æœ€å¾Œå·²çŸ¥ç‹€æ…‹
                    lastKnownState = currentState.state;
                    
                                                // ğŸ”¥ ä¿®æ”¹ï¼šæ ¹æ“šç‹€æ…‹æ›´æ–°VNè™•ç†å™¨
                            try {
                                if (window.top && window.top.VNProcessor) {
                                    if (currentState.isInStoryMode) {
                                        // åœ¨åŠ‡æƒ…æ¨¡å¼æ™‚å•Ÿç”¨VNè™•ç†å™¨
                                        if (typeof window.top.VNProcessor.enableVNProcessor === 'function') {
                                            window.top.VNProcessor.enableVNProcessor();
                                            console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âœ… é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼šå·²å•Ÿç”¨VNè™•ç†å™¨ï¼ˆåŠ‡æƒ…æ¨¡å¼ï¼‰');
                                        }
                                    } else if (currentState.isInLandingPage) {
                                        // åœ¨å•Ÿå‹•é é¢æ™‚ç¦ç”¨VNè™•ç†å™¨
                                        if (typeof window.top.VNProcessor.disableVNProcessor === 'function') {
                                            window.top.VNProcessor.disableVNProcessor();
                                            console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âŒ é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼šå·²ç¦ç”¨VNè™•ç†å™¨ï¼ˆå•Ÿå‹•é é¢ï¼‰');
                                        }
                                    }
                                    // å…¶ä»–æƒ…æ³ï¼ˆå¦‚ç¹¼çºŒåŠ‡æƒ…æ¨¡å¼ï¼‰ä¿æŒåŸæœ‰ç‹€æ…‹
                                }
                            } catch (error) {
                                console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚æ›´æ–°VNè™•ç†å™¨ç‹€æ…‹å¤±æ•—:', error);
                            }
                    
                    // é‡æ–°ç™¼é€ç‹€æ…‹é€šçŸ¥
                    notifyParentWindowChange(currentState.isInStoryMode);
                    
                    // æ ¹æ“šç‹€æ…‹é€šçŸ¥iframeå°ºå¯¸èª¿æ•´
                    notifyParentIframeResize(currentState.state);
                    
                    console.log(`[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²æ¢å¾©iframeç‹€æ…‹ç‚º: ${currentState.state}`);
                } else {
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢éš±è—ï¼Œè¨˜éŒ„ç•¶å‰ç‹€æ…‹');
                    const currentState = detectCurrentVNState();
                    lastKnownState = currentState.state;
                }
            }
            
            /**
             * çª—å£ç„¦é»è®ŠåŒ–è™•ç†
             */
            function handleFocusChange() {
                if (document.hasFocus()) {
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] çª—å£é‡æ–°ç²å¾—ç„¦é»ï¼Œæª¢æŸ¥ç‹€æ…‹');
                    
                    // å»¶é²ä¸€é»æ™‚é–“ç¢ºä¿DOMå®Œå…¨åŠ è¼‰
                    setTimeout(() => {
                        const currentState = detectCurrentVNState();
                        if (currentState.state !== lastKnownState) {
                            console.log(`[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç‹€æ…‹è®ŠåŒ–æª¢æ¸¬: ${lastKnownState} -> ${currentState.state}`);
                            lastKnownState = currentState.state;
                            
                            // ğŸ”¥ ä¿®æ”¹ï¼šæ ¹æ“šç‹€æ…‹è®ŠåŒ–æ›´æ–°VNè™•ç†å™¨
                            try {
                                if (window.top && window.top.VNProcessor) {
                                    if (currentState.isInStoryMode) {
                                        // åœ¨åŠ‡æƒ…æ¨¡å¼æ™‚å•Ÿç”¨VNè™•ç†å™¨
                                        if (typeof window.top.VNProcessor.enableVNProcessor === 'function') {
                                            window.top.VNProcessor.enableVNProcessor();
                                            console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âœ… ç„¦é»è®ŠåŒ–ï¼šå·²å•Ÿç”¨VNè™•ç†å™¨ï¼ˆåŠ‡æƒ…æ¨¡å¼ï¼‰');
                                        }
                                    } else if (currentState.isInLandingPage) {
                                        // åœ¨å•Ÿå‹•é é¢æ™‚ç¦ç”¨VNè™•ç†å™¨
                                        if (typeof window.top.VNProcessor.disableVNProcessor === 'function') {
                                            window.top.VNProcessor.disableVNProcessor();
                                            console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âŒ ç„¦é»è®ŠåŒ–ï¼šå·²ç¦ç”¨VNè™•ç†å™¨ï¼ˆå•Ÿå‹•é é¢ï¼‰');
                                        }
                                    }
                                    // å…¶ä»–æƒ…æ³ï¼ˆå¦‚ç¹¼çºŒåŠ‡æƒ…æ¨¡å¼ï¼‰ä¿æŒåŸæœ‰ç‹€æ…‹
                                }
                            } catch (error) {
                                console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç„¦é»è®ŠåŒ–æ™‚æ›´æ–°VNè™•ç†å™¨ç‹€æ…‹å¤±æ•—:', error);
                            }
                            
                            // é‡æ–°ç™¼é€ç‹€æ…‹é€šçŸ¥
                            notifyParentWindowChange(currentState.isInStoryMode);
                            notifyParentIframeResize(currentState.state);
                        }
                    }, 100);
                }
            }
            
            // ğŸ†• æ·»åŠ é é¢å¯è¦‹æ€§ç›£è½å™¨
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // ğŸ†• æ·»åŠ çª—å£ç„¦é»ç›£è½å™¨
            window.addEventListener('focus', handleFocusChange);
            window.addEventListener('blur', () => {
                console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] çª—å£å¤±å»ç„¦é»');
            });
            
            // ğŸ†• æ·»åŠ é é¢åŠ è¼‰å®Œæˆå¾Œçš„ç‹€æ…‹æª¢æŸ¥
            window.addEventListener('load', () => {
                console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢åŠ è¼‰å®Œæˆï¼Œæª¢æŸ¥åˆå§‹ç‹€æ…‹');
                
                                    // ğŸ”¥ ä¿®æ”¹ï¼šé é¢åˆå§‹åŒ–æ™‚ä¸å¼·åˆ¶ç¦ç”¨ï¼Œè®“VNè™•ç†å™¨ä¿æŒåŸä¾†çš„ç‹€æ…‹
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é é¢åˆå§‹åŒ–ï¼šä¿æŒVNè™•ç†å™¨åŸæœ‰ç‹€æ…‹');
                
                setTimeout(() => {
                    const currentState = detectCurrentVNState();
                    lastKnownState = currentState.state;
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] åˆå§‹ç‹€æ…‹:', currentState);
                    
                    // ğŸ”¥ ä¿®æ”¹ï¼šåªåœ¨åŠ‡æƒ…æ¨¡å¼æ™‚å•Ÿç”¨VNè™•ç†å™¨ï¼Œå•Ÿå‹•é é¢ä¿æŒç¦ç”¨
                    try {
                        if (window.top && window.top.VNProcessor) {
                            if (currentState.isInStoryMode) {
                                // åœ¨åŠ‡æƒ…æ¨¡å¼æ™‚å•Ÿç”¨VNè™•ç†å™¨
                                if (typeof window.top.VNProcessor.enableVNProcessor === 'function') {
                                    window.top.VNProcessor.enableVNProcessor();
                                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âœ… åˆå§‹ç‹€æ…‹ï¼šå·²å•Ÿç”¨VNè™•ç†å™¨ï¼ˆåŠ‡æƒ…æ¨¡å¼ï¼‰');
                                }
                            } else if (currentState.isInLandingPage) {
                                // åœ¨å•Ÿå‹•é é¢æ™‚ç¦ç”¨VNè™•ç†å™¨
                                if (typeof window.top.VNProcessor.disableVNProcessor === 'function') {
                                    window.top.VNProcessor.disableVNProcessor();
                                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] âŒ åˆå§‹ç‹€æ…‹ï¼šå·²ç¦ç”¨VNè™•ç†å™¨ï¼ˆå•Ÿå‹•é é¢ï¼‰');
                                }
                            }
                            // å…¶ä»–æƒ…æ³ï¼ˆå¦‚ç¹¼çºŒåŠ‡æƒ…æ¨¡å¼ï¼‰ä¿æŒåŸæœ‰ç‹€æ…‹
                        } else {
                            console.warn('[VNé¢æ¿-æ‰‹æœºç‰ˆ] VNè™•ç†å™¨ä¸å¯ç”¨');
                        }
                    } catch (error) {
                        console.error('[VNé¢æ¿-æ‰‹æœºç‰ˆ] è¨­ç½®åˆå§‹VNè™•ç†å™¨ç‹€æ…‹å¤±æ•—:', error);
                    }
                }, 500);
            });
            
            // ğŸ†• ç‚ºæ­·å²åŠ‡æƒ…çª—å£æ·»åŠ å®Œæ•´çš„äº‹ä»¶ç›£è½å™¨
            const vnHistoryChoiceModal = document.querySelector('#vnHistoryChoiceModal');
            const vnHistoryChoiceModalMain = document.querySelector('#vnHistoryChoiceModalMain');
            
            // å•Ÿå‹•é é¢çš„æ­·å²çª—å£é—œé–‰é‚è¼¯
            const closeVnHistoryChoice = vnHistoryChoiceModal?.querySelector('.close-vn-history-choice');
            if (closeVnHistoryChoice) {
                closeVnHistoryChoice.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é—œé–‰å•Ÿå‹•é é¢æ­·å²åŠ‡æƒ…é¸æ“‡çª—å£');
                    const windowId = window.VNHistoryWindowManager?.WINDOW_IDS.LANDING;
                    if (window.VNHistoryWindowManager?.closeHistoryWindow(windowId)) {
                        vnHistoryChoiceModal.classList.remove('modal-active');
                        vnHistoryChoiceModal.style.display = 'none';
                    }
                });
            }
            
            if (vnHistoryChoiceModal) {
                vnHistoryChoiceModal.addEventListener('click', function(e) {
                    if (e.target === vnHistoryChoiceModal) {
                        console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é»æ“ŠèƒŒæ™¯é—œé–‰å•Ÿå‹•é é¢æ­·å²åŠ‡æƒ…é¸æ“‡çª—å£');
                        const windowId = window.VNHistoryWindowManager?.WINDOW_IDS.LANDING;
                        if (window.VNHistoryWindowManager?.closeHistoryWindow(windowId)) {
                            vnHistoryChoiceModal.classList.remove('modal-active');
                            vnHistoryChoiceModal.style.display = 'none';
                        }
                    }
                });
            }
            
            // ä¸»å®¹å™¨çš„æ­·å²çª—å£é—œé–‰é‚è¼¯
            const closeVnHistoryChoiceMain = vnHistoryChoiceModalMain?.querySelector('.close-vn-history-choice');
            if (closeVnHistoryChoiceMain) {
                closeVnHistoryChoiceMain.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é—œé–‰ä¸»å®¹å™¨æ­·å²åŠ‡æƒ…é¸æ“‡çª—å£');
                    const windowId = window.VNHistoryWindowManager?.WINDOW_IDS.MAIN;
                    if (window.VNHistoryWindowManager?.closeHistoryWindow(windowId)) {
                        vnHistoryChoiceModalMain.classList.remove('modal-active');
                        vnHistoryChoiceModalMain.style.display = 'none';
                    }
                });
            }
            
            if (vnHistoryChoiceModalMain) {
                vnHistoryChoiceModalMain.addEventListener('click', function(e) {
                    if (e.target === vnHistoryChoiceModalMain) {
                        console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] é»æ“ŠèƒŒæ™¯é—œé–‰ä¸»å®¹å™¨æ­·å²åŠ‡æƒ…é¸æ“‡çª—å£');
                        const windowId = window.VNHistoryWindowManager?.WINDOW_IDS.MAIN;
                        if (window.VNHistoryWindowManager?.closeHistoryWindow(windowId)) {
                            vnHistoryChoiceModalMain.classList.remove('modal-active');
                            vnHistoryChoiceModalMain.style.display = 'none';
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>