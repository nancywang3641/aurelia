<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>手機聊天應用 - 整合功能版</title>
    <link rel="stylesheet" href="theme-style.css">
    <link rel="stylesheet" href="chat-style.css">
    <link rel="stylesheet" href="chat_user_features_style.css">
    <script src="icon-config.js"></script>
    <script src="group-member-manager.js"></script>
    <script src="member-manager.js"></script>
    <script src="private-chat-manager.js"></script>
    
    <style>
    /* iOS 安全区域和 100dvh 支持 */
    html, body { 
        height: 100%; 
        margin: 0;
        padding: 0;
    }
    
    /* 先用 100dvh，舊機型 fallback 用 JS 變數 */
    :root { 
        --app-vh: 100dvh; 
    }
    
    @supports not (height: 100dvh) {
        :root { 
            --app-vh: 100vh; 
        } /* 先給個值，等 JS 覆寫 */
    }

    /* 全屏容器使用 --app-vh */
    .screen {
        min-height: var(--app-vh);
        height: var(--app-vh);
        /* iOS 12–15 的救命繃帶 */
        height: -webkit-fill-available;
        overflow: hidden;
        padding-bottom: env(safe-area-inset-bottom);
        overscroll-behavior: contain;
    }
    
    /* 修复模态窗口高度 */
    #addStoryModal {
        height: var(--app-vh) !important;
    }
    
    .quick-actions-modal {
        height: var(--app-vh) !important;
    }
    </style>

<style>
/* 浮动助手样式 */
.floating-assistant {
    position: fixed;
    z-index: 99999;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    user-select: none;
}

.floating-button {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    border: 3px solid rgba(255, 255, 255, 0.2);
}

.floating-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
}

.floating-button:active {
    cursor: grabbing;
    transform: scale(0.95);
}

.floating-icon {
    font-size: 24px;
    color: white;
    pointer-events: none;
}

/* 快捷指令模态窗口 */
.quick-actions-modal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    z-index: 10000 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.quick-actions-modal.hidden {
    display: none !important;
}

.quick-actions-content {
    background: white !important;
    border-radius: 16px !important;
    width: 90% !important;
    max-width: 400px !important;
    max-height: 80vh !important;
    overflow-y: auto !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
}

.quick-actions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.quick-actions-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
}

.quick-actions-body {
    padding: 20px;
}

.quick-action-section {
    margin-bottom: 24px;
}

.quick-action-section h4 {
    margin: 0 0 12px 0;
    color: #555;
    font-size: 14px;
    font-weight: 600;
}

.quick-action-btn {
    display: block;
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 8px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
}

.ai-btn {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.ai-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
}

.group-btn {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #333;
}

.group-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(168, 237, 234, 0.3);
}

.story-btn {
    background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    color: white;
}

.story-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
}

.quick-groups-grid {
    display: grid;
    gap: 8px;
}

.hidden {
    display: none !important;
}

#addStoryModal.hidden { display: none !important; }
#addStoryModal {
    position: fixed !important;
    top: 0; left: 0; width: 100vw; height: var(--app-vh);
    background: #0005;
    z-index: 99999 !important;
    display: flex; align-items: center; justify-content: center;
}
#storyListSection .story-row:hover { background:#f0f0ff; }
</style>
</head>

<body>

    <div id="chatListScreen" class="screen">
        <div class="chat-header">
            <span class="back-button" style="visibility: hidden;">←</span>
            <h2 style="margin: 0; font-size: 20px;">聊天列表</h2>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="cursor: pointer; font-size: 24px;" onclick="showAddGroupMenu()">+</span>
                <span style="cursor: pointer; font-size: 20px;" onclick="window.manualCleanupIdMappings()" title="清理過期ID映射">🔁</span>
            </div>
            <div id="addGroupMenu" class="options-menu hidden" style="top: 60px; right: 15px;">
                <ul>
                    <li onclick="openAddGroupModal()">添加群組</li>
                    <li onclick="openAddPrivateChatModal()">創建私訊</li>
                    <li onclick="openAddStoryChatModal()">創建劇情聊天室</li>
                    <li onclick="openThemeSettingsModal()">主題樣式設置</li>
                </ul>
            </div>
            <div class="stream-indicator" id="streamIndicator">直播中</div>
        </div>
        <div class="chat-list-body">
            <div id="unifiedChatList" class="unified-chat-list"></div>
        </div>
    </div>

    <div id="chatDetailScreen" class="screen hidden">
        <!-- 私聊專用 header，預設隱藏，僅私聊顯示 -->
        <div id="privateChatHeader" class="private-chat-header" style="display:none;">
            <span class="back-button" onclick="showChatList()">←</span>
            <div class="private-header-avatar">
                <img id="privateHeaderAvatarImg" src="https://files.catbox.moe/ew2nex.png" alt="角色頭像" />
            </div>
            <div class="private-header-info">
                <div class="private-header-name" id="privateHeaderName">角色名稱</div>
                <div class="private-header-status"><span class="private-header-dot"></span> 在線</div>
            </div>
            <span class="private-header-heart" id="privateChatOptionsButton" onclick="toggleChatOptionsMenu()">&#9829;</span>
        </div>
        <!-- 原有 header，非私聊顯示 -->
        <div class="chat-header" id="defaultChatHeader">
            <span class="back-button" onclick="showChatList()">←</span>
            <h2 id="chatTitle" style="margin: 0; font-size: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">聊天室</h2>
            <span id="chatOptionsButton" style="cursor: pointer; font-size: 24px;" onclick="toggleChatOptionsMenu()">⋮</span>
            <div class="stream-indicator" id="detailStreamIndicator">直播中</div>
        </div>
        <div class="chat-body">
        </div>
        <div class="ai-chat-footer">
            <button id="addButton" class="add-button">+</button>
            <input type="text" id="userInput" placeholder="以「{{user}}」的身份發言...">
            <button id="choiceDropdownButton" class="choice-dropdown-button" style="margin-left: 6px; margin-right: 6px;">💡</button>
            <button id="sendButton">發送</button>
        </div>
        <div id="choiceDropdownMenu" class="choice-dropdown-menu hidden"></div>

        <div id="bottomFunctionPanel" class="bottom-function-panel hidden">
            <div class="function-panel-content">
    <div class="function-grid-container">
        <div class="function-grid">
    <!-- 🖼️ 照片功能 - 請替換 ICON_URL_PHOTO 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('photo')">
        <div class="function-icon">
            <img src="ICON_URL_PHOTO" alt="照片" class="function-icon-img">
            <span class="function-icon-fallback">📷</span>
        </div>
        <div class="function-label">照片</div>
    </div>
    
    <!-- ⏰ 時間功能 - 請替換 ICON_URL_TIME 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('time_adjustment')">
        <div class="function-icon">
            <img src="ICON_URL_TIME" alt="時間" class="function-icon-img">
            <span class="function-icon-fallback">⏰</span>
        </div>
        <div class="function-label">时间</div>
    </div>
    
    <!-- 📹 視訊通話功能 - 請替換 ICON_URL_VIDEO_CALL 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('video_call')">
        <div class="function-icon">
            <img src="ICON_URL_VIDEO_CALL" alt="視訊通話" class="function-icon-img">
            <span class="function-icon-fallback">📹</span>
        </div>
        <div class="function-label">視訊通話</div>
    </div>
    
    <!-- 📍 位置功能 - 請替換 ICON_URL_LOCATION 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('location')">
        <div class="function-icon">
            <img src="ICON_URL_LOCATION" alt="位置" class="function-icon-img">
            <span class="function-icon-fallback">📍</span>
        </div>
        <div class="function-label">位置</div>
    </div>
    
    <!-- 🧧 紅包功能 - 請替換 ICON_URL_RED_ENVELOPE 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('red_envelope')">
        <div class="function-icon">
            <img src="ICON_URL_RED_ENVELOPE" alt="紅包" class="function-icon-img">
            <span class="function-icon-fallback">🧧</span>
        </div>
        <div class="function-label">紅包</div>
    </div>
    
    <!-- 💰 轉賬功能 - 請替換 ICON_URL_TRANSFER 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('transfer')">
        <div class="function-icon">
            <img src="ICON_URL_TRANSFER" alt="轉賬" class="function-icon-img">
            <span class="function-icon-fallback">💰</span>
        </div>
        <div class="function-label">轉賬</div>
    </div>
    
    <!-- 🎤 語音輸入功能 - 請替換 ICON_URL_VOICE_INPUT 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('voice_input')">
        <div class="function-icon">
            <img src="ICON_URL_VOICE_INPUT" alt="語音輸入" class="function-icon-img">
            <span class="function-icon-fallback">🎤</span>
        </div>
        <div class="function-label">語音輸入</div>
    </div>
    
    <!-- 😊 表情包功能 - 請替換 ICON_URL_STICKER 為你的圖片URL -->
    <div class="function-item" onclick="selectFunction('sticker')">
        <div class="function-icon">
            <img src="ICON_URL_STICKER" alt="表情包" class="function-icon-img">
            <span class="function-icon-fallback">😊</span>
        </div>
        <div class="function-label">表情包</div>
    </div>
    
    <!-- 📖 劇情功能 - 請替換 ICON_URL_USER_STORY 為你的圖片URL -->
    <div class="function-item" onclick="selectFunctionWithModal('user_story')">
        <div class="function-icon">
            <img src="ICON_URL_USER_STORY" alt="劇情" class="function-icon-img">
            <span class="function-icon-fallback">📖</span>
        </div>
        <div class="function-label">劇情</div>
    </div>
    
    <!-- ⚙️ 系統功能 - 請替換 ICON_URL_SYSTEM_ACTION 為你的圖片URL -->
    <div class="function-item" onclick="selectFunctionWithModal('system_action')">
        <div class="function-icon">
            <img src="ICON_URL_SYSTEM_ACTION" alt="系統" class="function-icon-img">
            <span class="function-icon-fallback">⚙️</span>
        </div>
        <div class="function-label">系統</div>
    </div>
    
    <!-- ✉️ 信封功能 - 請替換 ICON_URL_LETTER 為你的圖片URL -->
    <div class="function-item" onclick="selectFunctionWithModal('letter')">
        <div class="function-icon">
            <img src="ICON_URL_LETTER" alt="信封" class="function-icon-img">
            <span class="function-icon-fallback">✉️</span>
        </div>
        <div class="function-label">信封</div>
    </div>
    

    
    <!-- 🎁 送禮功能 - 請替換 ICON_URL_GIFT 為你的圖片URL -->
    <div class="function-item" onclick="selectFunctionWithModal('gift')">
        <div class="function-icon">
            <img src="ICON_URL_GIFT" alt="送禮" class="function-icon-img">
            <span class="function-icon-fallback">🎁</span>
        </div>
        <div class="function-label">送禮</div>
    </div>
        </div>
    </div>
    <div class="pagination-dots"></div>
            </div>
        </div>
</div>
    
    <div class="debug-panel" style="display: none !important;"></div>

    <div id="chatOptionsMenu" class="options-menu hidden">
    <ul>
        <li onclick="openBackgroundModal()">設置背景</li>
        <li id="groupSettingsOption" onclick="openGroupSettingsModal()" style="display: none;">群聊設置</li>
        <li id="privateChatSettingsOption" onclick="openPrivateChatSettingsModal()" style="display: none;">私聊設置</li>
    </ul>
</div>

    <div id="backgroundSettingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>背景設置</h3>
                <span class="close-button" onclick="closeBackgroundModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label for="backgroundUrlInput" style="color: var(--modal-text-color); margin-bottom: 8px; display: block;">圖片 URL:</label>
                <input type="text" id="backgroundUrlInput" placeholder="請貼上圖片連結..." style="width: 100%; padding: 8px 12px; border: 2px solid #999; border-radius: 8px; box-sizing: border-box; font-size: 14px; background: white; color: #333;">
                
                <div style="margin-top: 20px; text-align: center;">
                    <div style="color: var(--modal-text-color); margin-bottom: 8px;">或</div>
                </div>
                
                <label for="backgroundImageUpload" style="color: var(--modal-text-color); margin-bottom: 8px; display: block;">上傳圖片:</label>
                <div class="background-upload-section">
                    <input type="file" id="backgroundImageUpload" accept="image/*" style="display: none;">
                    <button type="button" class="background-upload-btn" onclick="document.getElementById('backgroundImageUpload').click()">
                        <img id="backgroundImagePreview" src="https://files.catbox.moe/ew2nex.png" alt="背景預覽" class="background-image-preview">
                        <span class="background-upload-text">選擇圖片</span>
                    </button>
                </div>
                
                <div id="uploadedImagesList" style="margin-top: 15px; display: none;">
                    <label style="color: var(--modal-text-color); margin-bottom: 8px; display: block;">已上傳的圖片:</label>
                    <div id="uploadedImagesContainer" class="uploaded-images-container">
                        <!-- 已上傳的圖片將在這裡顯示 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirmBackgroundChange" onclick="applyBackgroundChange()" class="function-btn-confirm">確定</button>
            </div>
        </div>
    </div>

    <div id="addGroupModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>添加群組</h3>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <label for="groupNameInput" style="color: var(--modal-text-color);">群組名稱:</label>
                <input type="text" id="groupNameInput" placeholder="請輸入群組名稱..." maxlength="20">
                
                <label for="groupAvatarInput" style="margin-top: 15px; display: block; color: var(--modal-text-color);">群組頭像:</label>
                <div class="group-avatar-section">
                    <div class="group-avatar-upload">
                        <input type="file" id="groupAvatarInput" accept="image/*" style="display: none;">
                        <button type="button" class="group-avatar-btn" onclick="document.getElementById('groupAvatarInput').click()">
                            <img id="groupAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="群組頭像" class="group-avatar-preview">
                            <span class="group-avatar-text">上傳群組頭像</span>
                        </button>
                    </div>
                </div>
                
                <label for="adminNameInput" style="color: var(--modal-text-color);">群組創建者 (你):</label>
                <div class="admin-input-container">
                    <input type="text" id="adminNameInput" placeholder="請輸入你的名稱..." maxlength="15">
                    <div class="admin-avatar-section">
                        <label for="adminAvatarInput" class="admin-avatar-label" style="color: var(--modal-text-color);">頭像:</label>
                        <div class="admin-avatar-upload">
                            <input type="file" id="adminAvatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="admin-avatar-btn" onclick="document.getElementById('adminAvatarInput').click()">
                                <img id="adminAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="你的頭像" class="admin-avatar-preview">
                                <span class="admin-avatar-text">更換頭像</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <label for="membersInput" style="margin-top: 15px; display: block; color: var(--modal-text-color);">群組成員 (其他人):</label>
                <div class="member-avatar-grid">
                    <div id="memberAvatarList" class="member-avatar-list">
                        <!-- 成員頭像將在這裡動態顯示 -->
                    </div>
                    <button type="button" class="add-member-avatar-btn" onclick="openMemberManager()">
                        <span class="add-icon">+</span>
                        <span class="add-text">添加成員</span>
                    </button>
                </div>

                <div style="margin-top: 15px;">
                <label for="groupDateInput" style="color: var(--modal-text-color);">初始日期:</label>
                <input type="date" id="groupDateInput" style="width: 100%; padding: 8px; box-sizing: border-box;">

                <label for="groupTimeInput" style="margin-top: 10px; display: block; color: var(--modal-text-color);">初始時間:</label>
                <input type="time" id="groupTimeInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="saveAsPresetCheckbox" style="margin-right: 8px;">
                        <span style="font-size: 14px; color: var(--modal-text-color);">保存為預設聊天室（下次打開面板時自動顯示）</span>
                    </label>
                </div>
                
                <div style="margin-top: 10px; font-size: 12px; color: var(--modal-secondary-text-color);">
                    提示：群組創建者（你）會自動加入群組，成員列表中的是其他參與者。創建後AI會自動為這個群組生成聊天內容。
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddGroupModal()" class="function-btn-cancel">取消</button>
                <button id="confirmAddGroup" onclick="createNewGroup()" class="function-btn-confirm">創建群組</button>
            </div>
        </div>
    </div>

    <!-- 🆕 簡化的成員添加窗口 -->
    <div id="memberManagerModal" class="modal-overlay hidden">
        <div class="modal-content member-add-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>👤 添加群組成員</h3>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="member-form">
                    <div class="form-row">
                        <label for="memberNameInput" style="color: var(--modal-text-color);">成員名稱:</label>
                        <input type="text" id="memberNameInput" placeholder="請輸入成員名稱..." maxlength="20">
                    </div>
                    <div class="form-row">
                        <label for="memberDisplayNameInput" style="color: var(--modal-text-color);">顯示名稱 (可選):</label>
                        <input type="text" id="memberDisplayNameInput" placeholder="留空則使用成員名稱" maxlength="20">
                    </div>
                    <div class="form-row">
                        <label for="memberAvatarInput" style="color: var(--modal-text-color);">頭像:</label>
                        <div class="avatar-upload-container">
                            <input type="file" id="memberAvatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="avatar-upload-btn" onclick="document.getElementById('memberAvatarInput').click()">
                                <span id="avatarPreviewText">選擇圖片</span>
                                <img id="avatarPreview" src="" alt="" style="display: none; width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="addMemberAndClose()" class="function-btn-confirm">添加成員</button>
                <button onclick="closeMemberManager()" class="function-btn-cancel">取消</button>
            </div>
        </div>
    </div>

    <div id="addPrivateChatModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>創建私訊</h3>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <label for="yourNameInput" style="color: var(--modal-text-color);">你的名稱:</label>
                <div class="user-input-container">
                    <input type="text" id="yourNameInput" placeholder="請輸入你的名稱..." maxlength="15">
                    <div class="user-avatar-section">
                        <label for="userAvatarInput" class="user-avatar-label" style="color: var(--modal-text-color);">你的頭像:</label>
                        <div class="user-avatar-upload">
                            <input type="file" id="userAvatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="user-avatar-btn" onclick="document.getElementById('userAvatarInput').click()">
                                <img id="userAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="你的頭像" class="user-avatar-preview">
                                <span class="user-avatar-text">更換頭像</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <label for="otherPersonNameInput" style="margin-top: 15px; display: block; color: var(--modal-text-color);">對方名稱:</label>
                <div class="character-input-container">
                    <input type="text" id="otherPersonNameInput" placeholder="請輸入對方的角色名稱..." maxlength="15">
                    <div class="character-avatar-section">
                        <label for="characterAvatarInput" class="character-avatar-label" style="color: var(--modal-text-color);">角色頭像:</label>
                        <div class="character-avatar-upload">
                            <input type="file" id="characterAvatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="character-avatar-btn" onclick="document.getElementById('characterAvatarInput').click()">
                                <img id="characterAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="角色頭像" class="character-avatar-preview">
                                <span class="character-avatar-text">更換頭像</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <label for="privateChatDateInput" style="color: var(--modal-text-color);">初始日期:</label>
                    <input type="date" id="privateChatDateInput" style="width: 100%; padding: 8px; box-sizing: border-box;">

                    <label for="privateChatTimeInput" style="margin-top: 10px; display: block; color: var(--modal-text-color);">初始時間:</label>
                    <input type="time" id="privateChatTimeInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="savePrivateAsPresetCheckbox" style="margin-right: 8px;">
                        <span style="font-size: 14px; color: var(--modal-text-color);">保存為預設聊天室（下次打開面板時自動顯示）</span>
                    </label>
                </div>
                
                <div style="margin-top: 10px; font-size: 12px; color: var(--modal-secondary-text-color);">
                    提示：創建後AI會自動為這個私訊生成對話內容
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddPrivateChatModal()" class="function-btn-cancel">取消</button>
                <button id="confirmAddPrivateChat" onclick="createNewPrivateChat()" class="function-btn-confirm">創建私訊</button>
            </div>
        </div>
    </div>

    <div id="addStoryChatModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>創建劇情聊天室</h3>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <label for="storyNameInput" style="color: var(--modal-text-color);">劇情標題:</label>
                <input type="text" id="storyNameInput" placeholder="請輸入劇情標題..." maxlength="30">
                
                <label for="storyDescriptionInput" style="color: var(--modal-text-color);">劇情描述:</label>
                <textarea id="storyDescriptionInput" placeholder="請簡述劇情背景或設定..." maxlength="200" style="width: 100%; padding: 8px; box-sizing: border-box; height: 80px; resize: vertical;"></textarea>

                <div style="margin-top: 15px;">
                    <label for="storyChatDateInput" style="color: var(--modal-text-color);">劇情開始日期:</label>
                    <input type="date" id="storyChatDateInput" style="width: 100%; padding: 8px; box-sizing: border-box;">

                    <label for="storyChatTimeInput" style="margin-top: 10px; display: block; color: var(--modal-text-color);">劇情開始時間:</label>
                    <input type="time" id="storyChatTimeInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="saveStoryAsPresetCheckbox" style="margin-right: 8px;">
                        <span style="font-size: 14px; color: var(--modal-text-color);">保存為預設聊天室（下次打開面板時自動顯示）</span>
                    </label>
                </div>
                
                <div style="margin-top: 10px; font-size: 12px; color: var(--modal-secondary-text-color);">
                    💡 提示：劇情聊天室專門用來展示劇情發展、場景描述和系統消息，AI會自動將劇情內容發送到這裡
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddStoryChatModal()" class="function-btn-cancel">取消</button>
                <button id="confirmAddStoryChat" onclick="createNewStoryChat()" class="function-btn-confirm">創建劇情聊天室</button>
            </div>
        </div>
    </div>


    <div id="groupSettingsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>群聊設置</h3>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <label for="groupSettingsNameInput">群組名稱:</label>
                <input type="text" id="groupSettingsNameInput" placeholder="請輸入群組名稱..." maxlength="20">
                
                <label for="groupSettingsGroupAvatarInput" style="margin-top: 15px; display: block;">群組頭像:</label>
                <div class="group-avatar-section">
                    <div class="group-avatar-upload">
                        <input type="file" id="groupSettingsGroupAvatarInput" accept="image/*" style="display: none;">
                        <button type="button" class="group-avatar-btn" onclick="document.getElementById('groupSettingsGroupAvatarInput').click()">
                            <img id="groupSettingsGroupAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="群組頭像" class="group-avatar-preview">
                            <span class="group-avatar-text">更換群組頭像</span>
                        </button>
                    </div>
                </div>
                
                <label for="groupSettingsAdminInput">群組創建者 (你):</label>
                <div class="admin-input-container">
                    <input type="text" id="groupSettingsAdminInput" placeholder="請輸入你的名稱..." maxlength="15">
                    <div class="admin-avatar-section">
                        <label for="groupSettingsAdminAvatarInput" class="admin-avatar-label">頭像:</label>
                        <div class="admin-avatar-upload">
                            <input type="file" id="groupSettingsAdminAvatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="admin-avatar-btn" onclick="document.getElementById('groupSettingsAdminAvatarInput').click()">
                                <img id="groupSettingsAdminAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="你的頭像" class="admin-avatar-preview">
                                <span class="admin-avatar-text">更換頭像</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <label for="groupSettingsMembersInput" style="margin-top: 15px; display: block;">群組成員 (其他人):</label>
                <div class="member-avatar-grid">
                    <div id="groupSettingsMemberAvatarList" class="member-avatar-list">
                        <!-- 成員頭像將在這裡動態顯示 -->
                    </div>
                    <button type="button" class="add-member-avatar-btn" onclick="openGroupSettingsMemberManager()">
                        <span class="add-icon">+</span>
                        <span class="add-text">添加成員</span>
                    </button>
                </div>

                <div style="margin-top: 15px;">
                <label for="groupSettingsDateInput">初始日期:</label>
                <input type="date" id="groupSettingsDateInput" style="width: 100%; padding: 8px; box-sizing: border-box;">

                <label for="groupSettingsTimeInput" style="margin-top: 10px; display: block;">初始時間:</label>
                <input type="time" id="groupSettingsTimeInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
                </div>
                
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    提示：修改設置後會立即生效，但不會影響已發送的消息。
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeGroupSettingsModal()" class="function-btn-cancel">取消</button>
                <button id="confirmGroupSettings" onclick="applyGroupSettings()" class="function-btn-confirm">保存設置</button>
            </div>
        </div>
    </div>

    <!-- 🆕 私聊設置模態窗口 -->
    <div id="privateChatSettingsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>私聊設置</h3>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <label for="privateChatSettingsNameInput">聊天名稱:</label>
                <input type="text" id="privateChatSettingsNameInput" placeholder="請輸入聊天名稱..." maxlength="20">
                
                <label for="privateChatSettingsUserInput">你的名稱:</label>
                <div class="user-input-container">
                    <input type="text" id="privateChatSettingsUserInput" placeholder="請輸入你的名稱..." maxlength="15">
                    <div class="user-avatar-section">
                        <label for="privateChatSettingsUserAvatarInput" class="user-avatar-label">你的頭像:</label>
                        <div class="user-avatar-upload">
                            <input type="file" id="privateChatSettingsUserAvatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="user-avatar-btn" onclick="document.getElementById('privateChatSettingsUserAvatarInput').click()">
                                <img id="privateChatSettingsUserAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="你的頭像" class="user-avatar-preview">
                                <span class="user-avatar-text">更換頭像</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <label for="privateChatSettingsCharacterInput" style="margin-top: 15px; display: block;">對方名稱:</label>
                <div class="character-input-container">
                    <input type="text" id="privateChatSettingsCharacterInput" placeholder="請輸入對方的角色名稱..." maxlength="15">
                    <div class="character-avatar-section">
                        <label for="privateChatSettingsCharacterAvatarInput" class="character-avatar-label">角色頭像:</label>
                        <div class="character-avatar-upload">
                            <input type="file" id="privateChatSettingsCharacterAvatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="character-avatar-btn" onclick="document.getElementById('privateChatSettingsCharacterAvatarInput').click()">
                                <img id="privateChatSettingsCharacterAvatarPreview" src="https://files.catbox.moe/ew2nex.png" alt="角色頭像" class="character-avatar-preview">
                                <span class="character-avatar-text">更換頭像</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                <label for="privateChatSettingsDateInput">初始日期:</label>
                <input type="date" id="privateChatSettingsDateInput" style="width: 100%; padding: 8px; box-sizing: border-box;">

                <label for="privateChatSettingsTimeInput" style="margin-top: 10px; display: block;">初始時間:</label>
                <input type="time" id="privateChatSettingsTimeInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
                </div>
                
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    提示：修改設置後會立即生效，但不會影響已發送的消息。
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closePrivateChatSettingsModal()" class="function-btn-cancel">取消</button>
                <button id="confirmPrivateChatSettings" onclick="applyPrivateChatSettings()" class="function-btn-confirm">保存設置</button>
            </div>
        </div>
    </div>

<div id="systemActionModal" class="function-modal hidden">
    <div class="function-modal-content">
        <div class="function-modal-header">
            <h3>⚙️ 系統指令</h3>
            <span class="function-modal-close" onclick="closeFunctionModal('systemActionModal')">&times;</span>
        </div>
        <div class="function-modal-body">
            <label for="systemActionSelect">選擇動作:</label>
            <select id="systemActionSelect" style="width: 100%; padding: 8px; margin-bottom: 15px;">
                <option value="add">添加成員</option>
                <option value="kick">移除成員</option>
                <option value="mute">成員禁言 (小黑屋)</option>
                <option value="block">拉黑成員</option>
                <option value="broadcast">發送廣播</option>
                <option value="leave">離開群組</option>
                <option value="disband">解散群組</option>
            </select>

            <label for="systemActionOperator">操作者:</label>
            <input type="text" id="systemActionOperator" placeholder="執行此操作的角色名稱">

            <label for="systemActionTarget">目標角色:</label>
            <input type="text" id="systemActionTarget" placeholder="例如：陳思芳 (廣播時可留空)">

            <label for="systemActionValue">附加參數:</label>
            <input type="text" id="systemActionValue" placeholder="例如：1h 或 廣播內容">
        </div>
        <div class="function-modal-footer">
            <button onclick="closeFunctionModal('systemActionModal')" class="function-btn-cancel">取消</button>
            <button onclick="confirmSystemAction()" class="function-btn-confirm">執行指令</button>
        </div>
    </div>
</div>


<!-- 🎁 送禮模態窗口 -->
<div id="giftModal" class="function-modal hidden">
    <div class="function-modal-content">
        <div class="function-modal-header">
            <h3>🎁 送禮物</h3>
            <span class="function-modal-close" onclick="closeFunctionModal('giftModal')">&times;</span>
        </div>
        <div class="function-modal-body">
            <label for="giftRecipient">送給:</label>
            <select id="giftRecipient" style="width: 100%; padding: 8px; margin-bottom: 15px;">
                <option value="">選擇接收者...</option>
                <!-- 動態填充選項 -->
            </select>

            <label for="giftName">禮物名稱:</label>
            <input type="text" id="giftName" placeholder="例如: 一束玫瑰花" maxlength="50">

            <label for="giftDescription">禮物描述:</label>
            <textarea id="giftDescription" placeholder="例如: 希望這束花能帶給你快樂..." rows="3" maxlength="200"></textarea>

            <label for="giftValue">禮物價值 (元):</label>
            <input type="number" id="giftValue" placeholder="例如: 99" min="0" step="0.01">
        </div>
        <div class="function-modal-footer">
            <button onclick="closeFunctionModal('giftModal')" class="function-btn-cancel">取消</button>
            <button onclick="confirmGift()" class="function-btn-confirm">送出禮物</button>
        </div>
    </div>
</div>

<div id="deleteConfirmModal" class="delete-confirm-modal hidden">
    <div class="delete-confirm-content">
        <div class="delete-confirm-title">删除聊天室</div>
        <div class="delete-confirm-message">
            确定要删除聊天室<br>
            「<span id="deleteConfirmChatName" class="delete-confirm-chat-name"></span>」吗？
            <br><br>
            <small style="color: #999;">删除后无法恢复，但可以重新创建</small>
        </div>
        <div class="delete-confirm-buttons">
            <button class="delete-confirm-btn function-btn-cancel" onclick="cancelDeleteChat()">取消</button>
            <button class="delete-confirm-btn function-btn-confirm" onclick="confirmDeleteChat()">删除</button>
        </div>
    </div>
</div>

<!-- 可拖动的浮动快捷按钮 -->
<div id="floatingAssistant" class="floating-assistant">
    <div class="floating-button" id="floatingButton">
        <span class="floating-icon">⭐</span>
    </div>
</div>

<!-- 快捷指令模态窗口 -->
<div id="quickActionsModal" class="quick-actions-modal hidden">
    <div class="quick-actions-content">
        <div class="quick-actions-header">
            <h3>快捷指令</h3>
            <span class="close-button" onclick="closeQuickActions()">&times;</span>
        </div>
        <div class="quick-actions-body">
            <!-- AI启动按钮 -->
            <div class="quick-action-section">
                <h4>AI助手</h4>
                <button class="quick-action-btn ai-btn" onclick="triggerAI()">
                    🤖 启动AI
                </button>
                <button class="quick-action-btn story-btn" onclick="triggerStoryDevelopment()">
                    📖 沿生劇情
                </button>
            </div>

            <!-- 故事欄位 -->
            <div class="quick-action-section" id="storySection">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 18px;">
                    <h4 style="margin: 0;">故事欄位</h4>
                    <button id="addStoryBtn" class="quick-action-btn add-story-btn" style="padding: 4px 12px; font-size: 18px; background: #eee; color: #666; border-radius: 8px; margin-left: 10px;" onclick="openAddStoryModal()">＋</button>
                </div>
                <div id="storyList" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- === 新增故事 Modal === -->
<div id="addStoryModal" class="hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0005;z-index:9999;display:flex;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:24px 28px 18px 28px;border-radius:12px;min-width:320px;box-shadow:0 2px 12px #0002;">
    <div style="font-size:17px;font-weight:bold;margin-bottom:12px;">新增故事</div>
    <div style="margin-bottom:14px;">
      <label>內容：</label><br>
      <textarea id="storyContentInput" rows="4" style="width:100%;padding:5px 8px;margin-top:2px;"></textarea>
    </div>
    <div style="text-align:right;">
      <button onclick="closeAddStoryModal()" class="function-btn-cancel" style="margin-right:10px;">取消</button>
      <button onclick="addStoryToList()" class="function-btn-confirm">確定</button>
    </div>
  </div>
</div>

<!-- 劇情阅读窗口 -->
<div id="storyModal" class="story-modal hidden">
    <div class="story-modal-content">
        <div class="story-modal-header">
            <h3 id="storyTitle">劇情内容</h3>
            <span class="story-modal-close" onclick="closeStoryModal()">&times;</span>
        </div>
        <div class="story-modal-body">
            <div class="story-content-area">
                <div id="storyContent" class="story-text">
                    劇情内容将在这里显示...
                </div>
            </div>
        </div>
        <div class="story-modal-footer">
            <button id="storyPrevBtn" class="story-nav-btn" onclick="storyPrevPage()">
                <span>◀</span>
                <span>上一页</span>
            </button>
            <div id="storyPageInfo" class="story-page-info">1 / 1</div>
            <button id="storyNextBtn" class="story-nav-btn" onclick="storyNextPage()">
                <span>下一页</span>
                <span>▶</span>
            </button>
        </div>
    </div>
</div>

<!-- 快捷指令面板區域 ... -->
<div id="quickActionsPanel" class="hidden">
  <!-- 其他區塊 ... -->

  <!-- === 故事欄位區塊 === -->
  <div id="storyListSection" style="margin:18px 0 0 0;padding:12px 10px 10px 10px;background:#f8f8fc;border-radius:10px;box-shadow:0 1px 4px #0001;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <span style="font-weight:bold;font-size:15px;">故事欄位</span>
      <button onclick="openAddStoryModal()" style="background:#fff;border:1px solid #bbb;border-radius:6px;padding:2px 12px;font-size:15px;cursor:pointer;">＋</button>
    </div>
    <div id="storyList" style="margin-top:10px;"></div>
  </div>
</div>

<script src="chat-config.js"></script>
<script src="chat-core.js"></script>
<script src="chat-ui.js"></script>
<script src="chat-features.js"></script>
    <script src="transfer-timer.js"></script>
    <script src="chat-messages.js"></script>
    <script src="chat-edit-mode.js"></script>
<script src="chat_user_features.js"></script>
<script src="floating-assistant.js"></script>
<script src="theme-settings.js"></script>
</body>
</html>