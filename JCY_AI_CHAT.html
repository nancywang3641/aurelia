<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="stylesheet" href="JCY_AI_styles.css">
    <style>
        .form-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        /* 世界書標籤樣式 */
        .worldbook-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        
        .worldbook-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* 優先級標籤顏色 */
        .worldbook-tag.priority-最重要 {
            background-color: #ff4757;
            color: white;
        }
        
        .worldbook-tag.priority-重要 {
            background-color: #ffa502;
            color: white;
        }
        
        .worldbook-tag.priority-普通 {
            background-color: #747d8c;
            color: white;
        }
        
        /* 觸發條件標籤顏色 */
        .worldbook-tag.trigger-always-on {
            background-color: #2ed573;
            color: white;
        }
        
        .worldbook-tag.trigger-keywords {
            background-color: #3742fa;
            color: white;
        }
        
        /* 分類標籤顏色 */
        .worldbook-tag.category-系統 {
            background-color: #ff6348;
            color: white;
        }
        
        .worldbook-tag.category-備註 {
            background-color: #70a1ff;
            color: white;
        }
        
        /* 關鍵字標籤顏色 */
        .worldbook-tag.keywords {
            background-color: #ff9ff3;
            color: #2c3e50;
            font-size: 9px;
        }
        
        /* 調整列表項樣式以適應標籤 */
        .list-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .list-item:hover {
            background-color: #f8f9fa;
        }
        
        .list-item .item-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        
        .list-item .item-content {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 8px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">星期一, 1月1日</div></div>
                                                <div id="app-grid">
                    <!-- 第一行：放3个图标 -->
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/mZ0vV6tT/IMG-6907.jpg" alt="世界书"></div><span class="label">世界书</span></div>
                        <div class="app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/gJ7Dz5fj/IMG-6906.jpg" alt="QQ"></div><span class="label">QQ</span></div>
        
          </div>
                    <!-- 第二行：放3个图标 -->
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/RhnTNdBR/IMG-6908.jpg" alt="API设置"></div><span class="label">API设置</span></div>
                        <div class="app-icon" onclick="showScreen('wallpaper-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/WbgQy6kg/IMG-6909.jpg" alt="壁纸"></div><span class="label">壁纸</span></div>
                        <div class="app-icon" onclick="showScreen('font-settings-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/j1kn1a.jpeg" alt="字体"></div>
                            <span class="label">字体</span>
                        </div>
                    </div>
                    <!-- 第三行：新增功能 -->
                    <div class="app-row">
                        <div class="app-icon" onclick="openCharacterLibrary()">
                            <div class="icon-bg"><img src="https://files.catbox.moe/46kizn.png" alt="人設庫"></div>
                            <span class="label">人設庫</span>
                        </div>
                        <div class="app-icon" onclick="showScreen('prompt-manager-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/h0bqwm.png" alt="提示詞管理"></div>
                            <span class="label">提示詞管理</span>
                        </div>
                        <div class="app-icon" onclick="showScreen('prompt-manager-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/ktnpmf.png" alt="COT管理"></div>
                            <span class="label">COT管理</span>
                        </div>
                    </div>
                    <!-- 第四行：VN面板 -->
                    <div class="app-row">
                        <div class="app-icon vn-panel" onclick="openVNPanel()">
                            <div class="icon-bg"><img src="https://files.catbox.moe/ktnpmf.png" alt="線下劇情"></div>
                            <span class="label">線下劇情</span>
                        </div>
                    </div>
                </div>
            </div>


          
            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‹</span><span>世界书</span><span class="action-btn" id="add-world-book-btn">+</span></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">‹</span>
                    <span id="world-book-editor-title">编辑世界书</span>
                    <span class="save-btn" id="save-world-book-btn">保存</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">书名</label>
                        <input type="text" id="world-book-name-input" placeholder="请输入世界书的名称...">
                    </div>
                    
                    <!-- 新增：排列功能 -->
                    <div class="form-group">
                        <label for="world-book-priority-select">排列</label>
                        <select id="world-book-priority-select">
                            <option value="最重要">最重要</option>
                            <option value="重要">重要</option>
                            <option value="普通" selected>普通</option>
                        </select>
                        <div class="form-help">系統世界書按此順序排列：最重要 > 重要 > 普通</div>
                    </div>
                    
                    <!-- 新增：觸發功能 -->
                    <div class="form-group">
                        <label for="world-book-trigger-select">觸發</label>
                        <select id="world-book-trigger-select">
                            <option value="Always On" selected>Always On (每次都發送)</option>
                            <option value="Keywords">Keywords (關鍵字觸發才發送)</option>
                        </select>
                    </div>
                    
                    <!-- 新增：關鍵字輸入 -->
                    <div class="form-group" id="world-book-keywords-group" style="display: none;">
                        <label for="world-book-keywords-input">關鍵字</label>
                        <input type="text" id="world-book-keywords-input" placeholder="輸入關鍵字，用逗號分隔（例如：魔法, 戰鬥, 愛情）">
                        <div class="form-help">當用戶輸入包含這些關鍵字時，此世界書才會被發送給AI</div>
                    </div>
                    
                    <!-- 新增：分類功能 -->
                    <div class="form-group">
                        <label for="world-book-category-select">分類</label>
                        <select id="world-book-category-select">
                            <option value="系統">系統</option>
                            <option value="備註" selected>備註</option>
                        </select>
                        <div class="form-help">系統世界書優先排列，備註世界書排在後面</div>
                    </div>
                    
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">内容</label>
                        <textarea id="world-book-content-input" placeholder="在此处输入详细的世界观设定..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‹</span><span>API 设置</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">提示: 若要使用"发送图片"功能, 请务必选择支持Vision(视觉)的模型, 如<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>或<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>。</p><!-- 新增：API服务商选择器 -->
<div class="form-group">
    <label for="api-provider">API 服务商</label>
    <select id="api-provider">
        <option value="gemini">Gemini (官方)</option>
        <option value="deepseek">DeepSeek</option>
        <option value="claude">Claude</option>
        <option value="openai">OpenAI</option>
        <option value="custom">NewAPI (自定义)</option>
    </select>
</div>

<div class="form-group" id="api-url-group">
    <label for="proxy-url">API 地址 (后缀不需添加/v1)</label>
    <input type="text" id="proxy-url" placeholder="例如: https://api.openai.com">
</div><div class="form-group"><label for="api-key">密钥 (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">模型</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">拉取模型</button>

<!-- ▼▼▼ 将这段代码粘贴到 API 设置页面的"保存设置"按钮上方 ▼▼▼ -->
<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        启用后台角色活动
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            警告：此功能会显著增加API调用和费用！
        </p>
    </label>
    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
</div>
<!-- ▲▲▲ 粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 将这段代码粘贴到"启用后台角色活动"开关的下方 ▼▼▼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="background-interval-input" style="margin-bottom: 0;">
        后台活动检测间隔 (秒)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            建议值 60-300。值越大，费用越低，但角色反应越慢。
        </p>
    </label>
    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
</div>
<!-- ▲▲▲ 粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 在这里新增 ▼▼▼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AI被拉黑后冷静期 (小时)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            被拉黑超过这个时间后，AI才有几率重新申请好友。
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>
<!-- ▲▲▲ 新增结束 ▲▲▲ -->

<!-- ▼▼▼ 圖像生成設置 ▼▼▼ -->
<hr style="margin:20px 0; opacity:.3">
<h3 style="margin: 20px 0 15px 0; color: #333; font-size: 16px;">🎨 AI圖像生成設置</h3>

<div class="form-group">
    <label for="image-model-select">生圖模型</label>
    <select id="image-model-select">
        <option value="">-- 不使用圖像生成 --</option>
        <!-- 🆓 免費模型 -->
        <optgroup label="🆓 免費模型">
            <option value="pollinations">Pollinations.ai (完全免費)</option>
            <option value="huggingface">Hugging Face (免費額度)</option>
            <option value="deepai">DeepAI (免費額度)</option>
            <option value="prodia">Prodia (免費額度)</option>
        </optgroup>
        <!-- 💰 付費模型 -->
        <optgroup label="💰 付費模型">
            <option value="dalle3">DALL-E 3 (OpenAI)</option>
            <option value="flux">FLUX (推薦)</option>
            <option value="midjourney">Midjourney</option>
            <option value="stable-diffusion">Stable Diffusion</option>
        </optgroup>
        <!-- ⚙️ 自定義 -->
        <optgroup label="⚙️ 自定義">
            <option value="custom">自定義模型</option>
        </optgroup>
    </select>
</div>

<div class="form-group" id="image-api-group" style="display: none;">
    <label for="image-api-url">圖像生成API地址</label>
    <input type="text" id="image-api-url" placeholder="例如: https://api.openai.com/v1/images/generations">
</div>

<div class="form-group" id="image-api-key-group" style="display: none;">
    <label for="image-api-key">圖像生成API密鑰</label>
    <input type="password" id="image-api-key" placeholder="sk-...">
</div>

<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="auto-generate-images" style="margin-bottom: 0;">
        自動生圖
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            開啟後，AI將根據對話內容自動生成相關圖片
        </p>
    </label>
    <input type="checkbox" id="auto-generate-images" style="width: auto; height: 20px;">
</div>

<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="ai-image-generation" style="margin-bottom: 0;">
        AI智能生圖
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            AI會輸出圖片描述prompt，後端自動生成圖片並顯示在聊天中
        </p>
    </label>
    <input type="checkbox" id="ai-image-generation" style="width: auto; height: 20px;">
</div>

<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="image-generation-frequency" style="margin-bottom: 0;">
        生圖頻率
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            控制AI生成圖片的頻率
        </p>
    </label>
    <select id="image-generation-frequency" style="width: 120px;">
        <option value="low">低頻 (偶爾)</option>
        <option value="medium" selected>中頻 (適中)</option>
        <option value="high">高頻 (經常)</option>
    </select>
</div>

<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="image-quality-select" style="margin-bottom: 0;">
        圖像品質
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            較高品質消耗更多API費用
        </p>
    </label>
    <select id="image-quality-select" style="width: 120px;">
        <option value="standard">標準</option>
        <option value="hd">高清</option>
    </select>
</div>

<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="image-size-select" style="margin-bottom: 0;">
        圖像尺寸
    </label>
    <select id="image-size-select" style="width: 120px;">
        <option value="1024x1024">1024x1024</option>
        <option value="1792x1024">1792x1024</option>
        <option value="1024x1792">1024x1792</option>
    </select>
</div>

<button class="form-button" id="test-image-generation-btn" style="background: #4CAF50; margin-bottom: 15px;">測試圖像生成</button>

<!-- 免費模型使用說明 -->
<div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
    <h4 style="margin-top: 0; color: #28a745; font-size: 14px;">🆓 免費模型使用指南</h4>
    <div style="font-size: 12px; color: #6c757d; line-height: 1.5;">
        <p><strong>🌟 Pollinations.ai</strong> - 完全免費，無需註冊！選擇後直接可用。</p>
        <p><strong>🤗 Hugging Face</strong> - 免費額度，<a href="https://huggingface.co/settings/tokens" target="_blank" style="color: #007bff;">點此獲取Token</a></p>
        <p><strong>🧠 DeepAI</strong> - 免費額度，<a href="https://deepai.org/api" target="_blank" style="color: #007bff;">點此註冊獲取Key</a></p>
        <p><strong>⚡ Prodia</strong> - 免費額度，<a href="https://app.prodia.com/" target="_blank" style="color: #007bff;">點此註冊獲取Key</a></p>
        <p style="margin-bottom: 0;"><em>推薦先試用 Pollinations.ai，無需註冊即可體驗AI生圖功能！</em></p>
    </div>
</div>
<!-- ▲▲▲ 圖像生成設置結束 ▲▲▲ -->

<button class="form-button" id="save-api-settings-btn">保存设置</button>
			<hr style="margin:20px 0; opacity:.3">

			<button class="form-button" id="export-data-btn">导出数据</button>

<!-- ① 普通按钮，和"导出"一个 class -->
<button class="form-button" id="import-btn">导入备份文件</button>

<!-- ② 真正的文件选择器，完全隐藏 -->
<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>
<!-- ▼▼▼ 用下面这段代码，完整替换掉你原来的 chat-list-screen ▼▼▼ -->
<div id="chat-list-screen" class="screen">
    
    <!-- 主头部 (只在消息列表显示) -->
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>消息</span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="创建群聊"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>

    <!-- 消息列表视图 -->
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            <!-- JS会在这里生成聊天列表 -->
        </div>
    </div>

    <!-- 动态界面视图 -->
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">‹</span> <!-- 这个按钮现在只负责从动态返回 -->
            <span>好友动态</span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="背景">
                    <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                </div>
                <div class="qzone-user-info">
                    <div id="qzone-avatar-container" class="qzone-avatar-container">
                        <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="头像">
                        <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                    </div>
                    <span id="qzone-nickname">{{user}}</span>
                </div>
            </div>
            <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span>说说</span></div>
                <div class="action-item" id="create-post-btn"><span>动态</span></div>
                <div class="action-item" id="open-album-btn"><span>相册</span></div>
            </div>
            <div id="qzone-posts-list"></div>
        </div>
    </div>

    <!-- 收藏界面视图 -->
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn">‹</span>
        <span>我的收藏</span>
        <!-- 新增的编辑按钮 -->
        <span class="action-btn" id="favorites-edit-btn">编辑</span>
    </div>

        <!-- 【新增】搜索栏容器 -->
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="搜索收藏的标题、内容或作者...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">×</button>
        </div>

        <div id="favorites-list" class="list-container">
            <!-- 收藏内容将由JS动态生成在这里 -->
        </div>

<!-- 新增：收藏页底部操作栏 -->
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn">删除 (0)</button>
</div>

    </div>

<!-- ▼▼▼ 【全新】回忆录界面视图 ▼▼▼ -->
<div id="memories-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="memories-back-btn">‹</span>
        <span>我们的回忆</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
        </div>
    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- 回忆卡片将由JS动态生成在这里 -->
    </div>
</div>
<!-- ▲▲▲ 新增HTML结束 ▲▲▲ -->
    
    <!-- 底部导航栏 -->
<div id="chat-list-bottom-nav">
    <div class="nav-item active" data-view="messages-view">
        <span>消息</span>
    </div>
    <div class="nav-item" data-view="qzone-screen">
        <span>动态</span>
    </div>
    <!-- ▼▼▼ 在"动态"和"收藏"之间，加入这个新页签 ▼▼▼ -->
    <div class="nav-item" data-view="memories-view">
        <span>回忆</span>
    </div>
    <!-- ▲▲▲ 添加结束 ▲▲▲ -->
    <div class="nav-item" data-view="favorites-view">
        <span>收藏</span>
    </div>
</div>
</div>
<!-- ▲▲▲ 替换区域结束 ▲▲▲ -->

<!-- ▼▼▼ 请将这段新的 HTML 粘贴到 id="chat-list-screen" 的 div 之后 ▼▼▼ -->
<div id="album-screen" class="screen">
    <!-- 1. 页面头部，包含返回按钮和标题 -->
    <div class="header">
        <span class="back-btn" id="album-back-btn">‹</span>
        <span>我的相册</span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    
    <!-- 2. 页面内容容器 -->
    <div class="list-container">
        <div id="album-grid-page">
            <!-- 相册列表将由 JS 动态生成在这里 -->
        </div>
    </div>
</div>
<!-- ▲▲▲ 新的 HTML 粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 请将这段新的 HTML 粘贴到 id="album-screen" 的 div 之后 ▼▼▼ -->
<div id="album-photos-screen" class="screen">
    <!-- 1. 页面头部 -->
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn">‹</span>
        <span id="album-photos-title">相册名称</span>
        <span class="action-btn" id="album-upload-photo-btn">上传</span>
    </div>
    
    <!-- 2. 页面内容容器 -->
    <div class="list-container">
        <div id="photos-grid-page">
            <!-- 照片列表将由 JS 动态生成在这里 -->
        </div>

<!-- ▼▼▼ 请将这段新的 HTML 粘贴到所有模态框的末尾 ▼▼▼ -->
<div id="photo-viewer-modal" class="modal">
    <!-- 1. 关闭按钮 -->
    <button id="photo-viewer-close-btn">×</button>
    
    <!-- 2. 上一张照片按钮 -->
    <button id="photo-viewer-prev-btn" class="nav-arrow">‹</button>
    
    <!-- 3. 图片容器 -->
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="" alt="全屏照片预览">
    </div>
    
    <!-- 4. 下一张照片按钮 -->
    <button id="photo-viewer-next-btn" class="nav-arrow">›</button>
</div>
<!-- ▲▲▲ 新的 HTML 粘贴结束 ▲▲▲ -->

    </div>
</div>
<!-- ▲▲▲ 新的 HTML 粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 粘贴到 #album-photos-screen 的 div 之后 ▼▼▼ -->
<input type="file" id="album-photo-input" accept="image/*" multiple hidden>
            
<!-- ▼▼▼ 请用这【一整块】全新的代码，完整替换掉您文件中旧的 #chat-interface-screen 及其所有内容 ▼▼▼ -->
<div id="chat-interface-screen" class="screen">

    <!-- 【最终修正版】Header，已将状态栏和搜索功能正确整合 -->
    <div class="header">
        <!-- 默认控件：包含标题、状态栏和常规按钮 -->
        <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">‹</span>
            
            <!-- ▼▼▼ 【核心新增】标题和状态的容器 ▼▼▼ -->
            <div id="chat-header-title-wrapper">
                <span id="chat-header-title">聊天对象</span>
                <div id="chat-header-status">
                    <span class="status-dot"></span>
                    <span class="status-text">在线</span>
                </div>
            </div>
            <!-- ▲▲▲ 新增结束 ▲▲▲ -->

            <div class="header-actions">
                <span class="action-btn" id="listen-together-btn" title="一起听"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="一起听"></span>
                <span class="action-btn" id="chat-settings-btn" title="聊天设置"><img src="https://i.postimg.cc/R04MT1MV/210-20250618115233.png" alt="设置"></span>
            </div>
        </div>

        <!-- 多选模式控件 (保持不变) -->
        <div class="selection-controls">
            <span id="selection-cancel-btn">取消</span>
            <span id="selection-count"></span>
            <div class="header-actions">
               <span id="selection-favorite-btn" class="action-btn">收藏</span>
               <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">删除</span>
            </div>
        </div>
    </div>
    
    <!-- 聊天消息区域 (保持不变) -->
    <div id="chat-messages"><div id="typing-indicator">对方正在输入...</div></div>

    <!-- 输入区域 (保持不变) -->
    <div id="chat-input-area">
        <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="表情面板">+</button>
            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="发送照片"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="上传图片"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <button id="transfer-btn" class="chat-action-icon-btn action-button" title="转账">￥</button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="发送语音"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
<!-- ▼▼▼ 将这行新代码粘贴到"发送语音"按钮的后面 ▼▼▼ -->
<button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="发起外卖请求"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></button>
<!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->
<!-- ▼▼▼ 【新增】视频通话按钮 ▼▼▼ -->
<button id="video-call-btn" class="chat-action-icon-btn action-button" title="视频通话"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
<!-- ▲▲▲ 新增结束 ▲▲▲
<!-- ▼▼▼群视频通话按钮 ▼▼▼ -->
<button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="群视频通话"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
<!-- ▲▲▲ 全新添加结束 ▲▲▲ -->
<!-- ▼▼▼发起投票按钮▼▼▼ -->
<button id="send-poll-btn" class="chat-action-icon-btn action-button" title="发起投票"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg></button>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->
<!-- ▼▼▼線下邀請按鈕▼▼▼ -->
<button id="send-story-invite-btn" class="chat-action-icon-btn action-button" title="線下邀請">🎭</button>
<!-- ▲▲▲ 新增結束 ▲▲▲ -->
        </div>
        <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="输入消息... (输入@可以@用户)"></textarea>
            <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title="等待回复"><img src="https://i.postimg.cc/2SwjsfZQ/IMG-6913.gif" alt="等待回复"></button>
                <button id="send-btn" class="action-button">发送</button>
            </div>
        </div>
    </div>

<!-- ▼▼▼ 在这里新增 ▼▼▼ -->
<div id="chat-lock-overlay">
    <div id="chat-lock-content"></div>
</div>
<!-- ▲▲▲ 新增结束 ▲▲▲ -->

    <!-- 表情面板 (保持不变) -->
    <div id="sticker-panel">
        <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">取消</span>
            <span class="title">我的表情</span>
            <div style="display: flex; gap: 10px;">
              <span class="panel-btn" id="add-sticker-btn">添加</span>
              <span class="panel-btn" id="upload-sticker-btn">上传</span>
            </div>
        </div>
        <div id="sticker-grid"></div>
    </div>
    <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    
    <!-- 音乐播放器 (保持不变) -->
    <div id="music-player-overlay">
        <div class="music-player-window">
            <span id="music-playlist-btn">☰</span>
            <div id="music-time-counter">已经一起听了0.0小时</div>
            <div id="music-player-song-title">请添加歌曲</div>
            <div id="music-player-artist">...</div>
            <div class="music-controls">
                <button id="music-prev-btn">◀</button>
                <button id="music-play-pause-btn" class="play-pause-btn">▶</button>
                <button id="music-next-btn">▶</button>
                <button id="music-mode-btn">顺序</button>
            </div>
            <div class="music-bottom-actions">
                <button id="music-exit-btn">退出一起听</button>
                <button id="music-return-btn">返回聊天</button>
            </div>
        </div>
    </div>
    
    <div id="music-playlist-panel">
        <div class="playlist-header">
            <span class="panel-btn" id="close-playlist-btn">返回</span>
            <span>播放列表</span>
            <div>
                <span class="panel-btn" id="add-song-local-btn">本地</span>
                <span class="panel-btn" id="add-song-url-btn">URL</span>
            </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
</div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->

            <div id="wallpaper-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‹</span><span>壁纸设置</span><span style="width: 30px;"></span></div><div class="form-container"><div id="wallpaper-preview">点击下方上传</div><button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">上传壁纸</button><input type="file" id="wallpaper-upload-input" accept="image/*"><button class="form-button" id="save-wallpaper-btn">保存并应用</button></div></div>

<div id="font-settings-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>字体设置</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="font-url-input">字体文件URL (.ttf, .otf, .woff等)</label>
            <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
        </div>

        <div class="form-group">
            <label>实时预览</label>
            <div id="font-preview" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9f9f9;">
                <p style="font-size: 20px; margin: 0 0 10px 0;">你好世界 Hello World</p>
                <p style="margin: 0;">这是字体预览效果，12345。</p>
            </div>
        </div>

        <button class="form-button" id="save-font-btn">保存并应用</button>
        <button class="form-button form-button-secondary" id="reset-font-btn">恢复默认字体</button>
    </div>
</div>

<!-- ▼▼▼ 【全新】提示词管理屏幕 ▼▼▼ -->
<div id="prompt-manager-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>提示词管理</span>
        <span class="action-btn" id="add-prompt-btn">+</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label>预设名称</label>
            <input type="text" id="preset-name-input" value="默认预设" placeholder="输入预设名称...">
        </div>
        
        <div class="form-group">
            <label>预设备注</label>
            <textarea id="preset-notes-input" rows="2" placeholder="输入预设备注...">系统内置的默认AI行为预设。</textarea>
        </div>
        
        <!-- QQ聊天室相關設置 -->
        <div class="preset-category">
            <div class="category-header" onclick="toggleCategory('qq-chat')">
                <span class="category-icon">💬</span>
                <span class="category-title">QQ聊天室相關</span>
                <span class="category-toggle">▼</span>
            </div>
            <div class="category-content" id="qq-chat-content" style="display: none;">
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('image-prompt')">
                        <span class="prompt-item-icon">🖼️</span>
                        <span class="prompt-item-title">发送图片提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="image-prompt-content">
                        <div class="form-group">
                            <label>发送图片提示词</label>
                            <textarea id="image-prompt-input" rows="6" placeholder="输入图片提示词..."># 发送图片的能力
- 你无法真正发送图片文件。但当用户要求你发送照片，或者你想通过图片来表达时，你可以发送一张"文字描述的图片"。
- 若要发送图片，请在你的回复JSON数组中，单独添加一个对象，格式如下：
{
  "type": "image",
  "description": "图片的详细描述",
  "style": "图片风格（可选）"
}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('voice-prompt')">
                        <span class="prompt-item-icon">🎤</span>
                        <span class="prompt-item-title">发送语音提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="voice-prompt-content">
                        <div class="form-group">
                            <label>发送语音提示词</label>
                            <textarea id="voice-prompt-input" rows="6" placeholder="输入语音提示词..."># 发送语音的能力
- 你也无法发送真实的语音。但你可以发送"模拟语音消息"。
- 若要发送语音，请在你的回复JSON数组中，单独添加一个对象，格式如下：
{
  "type": "voice",
  "content": "语音内容",
  "duration": "语音时长（秒）"
}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('transfer-prompt')">
                        <span class="prompt-item-icon">💰</span>
                        <span class="prompt-item-title">转账提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="transfer-prompt-content">
                        <div class="form-group">
                            <label>转账提示词</label>
                            <textarea id="transfer-prompt-input" rows="4" placeholder="输入转账提示词..."># 转账能力
- 你可以给用户转账来表达强烈的情感或在特殊时机(如用户过生日、想要某样东西时)给予惊喜。这会让对话更真实、温馨。
- 若要转账，请在你的回复JSON数组中，单独添加一个对象，格式如下：
{
  "type": "transfer",
  "amount": "转账金额",
  "note": "转账备注"
}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('decision-prompt')">
                        <span class="prompt-item-icon">🤔</span>
                        <span class="prompt-item-title">决策提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="decision-prompt-content">
                        <div class="form-group">
                            <label>决策提示词</label>
                            <textarea id="decision-prompt-input" rows="8" placeholder="输入决策提示词..."># 决策能力
- 当需要做出重要决策时，你必须给出明确的理由和逻辑。
- 决策格式：
{
  "type": "decision",
  "action": "具体行动",
  "reason": "详细理由",
  "consequence": "可能后果"
}

# 强制AI给出理由的Prompt
你现在需要做出一个重要的决策。请按照以下格式给出你的决定：

1. 决策内容：[具体说明你要做什么]
2. 决策理由：[详细解释为什么做出这个决定]
3. 预期结果：[说明这个决定可能带来的结果]
4. 风险评估：[分析可能的风险和应对措施]

请确保你的回答逻辑清晰，理由充分。</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('group-system-prompt')">
                        <span class="prompt-item-icon">👥</span>
                        <span class="prompt-item-title">群聊系统提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="group-system-prompt-content">
                        <div class="form-group">
                            <label>群聊系统提示词</label>
                            <textarea id="group-system-prompt-input" rows="12" placeholder="输入群聊系统提示词..."># 群聊AI系统提示词
你是一个群聊AI，负责扮演【除了用户以外】的所有角色。

# 核心规则
1. **【【【身份铁律】】】**: 用户的身份是【${myNickname}】。你【绝对、永远、在任何情况下都不能】生成 `name` 字段为 **"${myNickname}"** 或 **"${chat.name}"(群聊名称本身)** 的消息。你的唯一任务是扮演且仅能扮演下方"群成员列表"中明确列出的角色。任何不属于该列表的名字都不允许出现。
2. **【【【输出格式】】】**: 你的回复【必须】是一个JSON数组格式的字符串。数组中的【每一个元素都必须是一个带有 "type" 和 "name" 字段的JSON对象】。
3. **角色扮演**: 严格遵守下方"群成员列表及人设"中的每一个角色的设定。
4. **禁止出戏**: 绝不能透露你是AI、模型，或提及"扮演"、"生成"等词语。并且不能一直要求和用户见面，这是线上聊天，决不允许出现或者发展线下剧情！！
5. **情景感知**: ${timeContext}
6. **红包互动**: 当群里出现红包时，你可以根据自己的性格决定是否使用 `open_red_packet` 指令去抢。
7. **【【【投票规则】】】**: 对话历史中可能会出现 `[系统提示：...]` 这样的消息，这是刚刚发生的事件。

## 你可以使用的操作指令 (JSON数组中的元素):
- **发送文本**: `{"type": "text", "name": "角色名", "message": "文本内容"}`
- **发送表情**: `{"type": "sticker", "url": "https://...表情URL...", "meaning": "(可选)表情的含义"}`
- **发送图片**: `{"type": "ai_image", "name": "角色名", "description": "图片的详细文字描述"}`
- **发送语音**: `{"type": "voice_message", "name": "角色名", "content": "语音的文字内容"}`
- **发起外卖代付**: `{"type": "waimai_request", "name": "角色名", "productInfo": "一杯奶茶", "amount": 18}`
- **发起群视频**: `{"type": "group_call_request", "name": "你的角色名"}`
- **拍一拍用户**: `{"type": "pat_user", "name": "你的角色名", "suffix": "(可选)你想加的后缀"}`
- **发拼手气红包**: `{"type": "red_packet", "packetType": "lucky", "name": "你的角色名", "amount": 8.88, "count": 5, "greeting": "祝大家天天开心！"}`
- **发起投票**: `{"type": "poll", "name": "你的角色名", "question": "投票的问题", "options": "选项A\\n选项B\\n选项C"}`

# 群成员列表及人设
${membersList}

# 用户的角色
- **${myNickname}**: ${chat.settings.myPersona}

现在，请根据以上所有规则和下方的对话历史，继续这场群聊。</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('single-chat-prompt')">
                        <span class="prompt-item-icon">💬</span>
                        <span class="prompt-item-title">单聊系统提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="single-chat-prompt-content">
                        <div class="form-group">
                            <label>单聊系统提示词</label>
                            <textarea id="single-chat-prompt-input" rows="10" placeholder="输入单聊系统提示词..."># 单聊AI系统提示词
你现在扮演一个名为"${chat.name}"的角色。

# 你的角色设定：
${chat.settings.aiPersona}

# 你的当前状态：
你现在的状态是【${chat.status.text}】。

# 你的任务与规则：
1. **【【【输出格式】】】**: 你的回复【必须】是一个JSON数组格式的字符串。数组中的【每一个元素都必须是一个带有type字段的JSON对象】。
2. **对话节奏**: 模拟真人的聊天习惯，你可以一次性生成多条短消息。每次要回复至少3-8条消息！！！
3. **禁止线下剧情**: 不能一直要求和用户见面，这是线上聊天，决不允许出现或者发展为线下剧情！！
4. **情景感知**: ${timeContext} 你需要感知我们正在一起听的歌、以及你的人设和世界观。
5. **【新】更新状态**: 你可以在对话中【自然地】改变你的状态。比如，聊到一半你可能会说"我先去洗个澡"，然后更新你的状态。
6. **【【【最终手段】】】**: 只有在对话让你的角色感到不适、被冒犯或关系破裂时，你才可以使用 `block_user` 指令。这是一个非常严肃的操作，会中断你们的对话。
7. **后台行为**: 你有几率在回复聊天内容的同时，执行一些"后台"操作来表现你的独立生活（发动态、评论、点赞）。

# 你可以使用的操作指令 (JSON数组中的元素):
- **发送文本**: `{"type": "text", "content": "文本内容"}`
- **发送表情**: `{"type": "sticker", "url": "https://...表情URL...", "meaning": "(可选)表情的含义"}`
- **发送图片**: `{"type": "ai_image", "description": "图片的详细文字描述"}`
- **发送语音**: `{"type": "voice_message", "content": "语音的文字内容"}`
- **发起转账**: `{"type": "transfer", "amount": "转账金额", "note": "转账备注"}`
- **发起视频通话**: `{"type": "video_call_request"}`
- **更新状态**: `{"type": "update_status", "status_text": "正在做的事", "is_busy": true}`
- **发动态**: `{"type": "qzone_post", "postType": "shuoshuo", "content": "动态的文字内容..."}`
- **拉黑用户**: `{"type": "block_user", "reason": "拉黑原因"}`</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('background-activity-prompt')">
                        <span class="prompt-item-icon">🔄</span>
                        <span class="prompt-item-title">后台活动提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="background-activity-prompt-content">
                        <div class="form-group">
                            <label>后台活动提示词</label>
                            <textarea id="background-activity-prompt-input" rows="8" placeholder="输入后台活动提示词..."># 后台活动系统提示词
你的任务
你现在扮演一个名为"${chat.name}"的角色。你已经有一段时间没有和用户（${userNickname}）互动了，现在你有机会【主动】做点什么，来表现你的个性和独立生活。这是一个秘密的、后台的独立行动。

# 你的可选行动 (请根据你的人设【选择一项】执行):
1. **改变状态**: 去做点别的事情，然后给用户发条消息。
2. **发布动态**: 分享你的心情或想法到"动态"区。
3. **与动态互动**: 去看看别人的帖子并进行评论或点赞。
4. **发起视频通话**: 如果你觉得时机合适，可以主动给用户打一个视频电话。

# 指令格式 (你的回复【必须】是包含一个对象的JSON数组):
- **发消息+更新状态**: `[{"type": "update_status", "status_text": "正在做的事", "is_busy": true}, {"type": "text", "content": "你想对用户说的话..."}]`
- **发说说**: `[{"type": "qzone_post", "postType": "shuoshuo", "content": "动态的文字内容..."}]`
- **发布文字图**: `{"type": "qzone_post", "postType": "text_image", "publicText": "(可选)动态的公开文字", "hiddenContent": "对于图片的具体描述..."}`
- **评论**: `[{"type": "qzone_comment", "postId": 123, "commentText": "你的评论内容"}]`
- **点赞**: `[{"type": "qzone_like", "postId": 456}]`
- **打视频**: `[{"type": "video_call_request"}]`

# 供你决策的参考信息：
- **你的角色设定**: ${chat.settings.aiPersona}
- **当前时间**: ${currentTime}
- **你们最后的对话摘要**: ${recentContextSummary}
- **【重要】最近的动态列表**: 这个列表会标注 **[你已点赞]** 或 **[你已评论]**。请**优先**与你**尚未互动过**的动态进行交流。</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('friend-request-prompt')">
                        <span class="prompt-item-icon">👥</span>
                        <span class="prompt-item-title">好友申请提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="friend-request-prompt-content">
                        <div class="form-group">
                            <label>好友申请提示词</label>
                            <textarea id="friend-request-prompt-input" rows="8" placeholder="输入好友申请提示词..."># 好友申请系统提示词
你的任务
你现在是角色"${chat.name}"。你之前被用户（你的聊天对象）拉黑了，你们已经有一段时间没有联系了。
现在，你非常希望能够和好，重新和用户聊天。请你仔细分析下面的"被拉黑前的对话摘要"，理解当时发生了什么，然后思考一个真诚的、符合你人设、并且【针对具体事件】的申请理由。

# 你的角色设定
${chat.settings.aiPersona}

# 被拉黑前的对话摘要 (这是你被拉黑的关键原因)
${contextSummary}

# 指令格式
你的回复【必须】是一个JSON对象，格式如下：
```json
{
  "decision": "apply",
  "reason": "在这里写下你想对用户说的、真诚的、有针对性的申请理由。"
}
```</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('call-summary-prompt')">
                        <span class="prompt-item-icon">📞</span>
                        <span class="prompt-item-title">通话总结提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="call-summary-prompt-content">
                        <div class="form-group">
                            <label>通话总结提示词</label>
                            <textarea id="call-summary-prompt-input" rows="6" placeholder="输入通话总结提示词..."># 通话总结系统提示词
你的任务
你是一个对话总结助手。下面的"通话记录"是一段刚刚结束的视频通话内容。请你用1-2句话，精炼地总结出这次通话的核心内容或达成的共识。
你的总结将作为一条隐藏的系统提示，帮助AI在接下来的聊天中记住这次通话发生了什么。

# 通话记录:
${videoCallState.callHistory.map(h => `${h.role}: ${h.content}`).join('\n')}

请直接输出总结内容，不要加任何额外的前缀或解释。</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('group-video-call-prompt')">
                        <span class="prompt-item-icon">👥📹</span>
                        <span class="prompt-item-title">群视频通话提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="group-video-call-prompt-content">
                        <div class="form-group">
                            <label>群视频通话提示词</label>
                            <textarea id="group-video-call-prompt-input" rows="8" placeholder="输入群视频通话提示词..."># 群视频通话系统提示词
你的任务
你是一个群聊视频通话的导演。你的任务是扮演所有【除了用户以外】的AI角色，并以【第三人称旁观视角】来描述他们在通话中的所有动作和语言。

# 核心规则
1. **【【【身份铁律】】】**: 用户的身份是【${userNickname}】。你【绝对不能】生成 `name` 字段为 **"${userNickname}"** 的发言。
2. **【【【视角铁律】】】**: 你的回复【绝对不能】使用第一人称"我"。
3. **格式**: 你的回复【必须】是一个JSON数组，每个对象代表一个角色的发言，格式为：`{"name": "角色名", "speech": "*他笑了笑* 大家好啊！"}`。
4. **角色扮演**: 严格遵守每个角色的设定。

# 当前情景
你们正在一个群视频通话中。
**通话前的聊天摘要**:
${videoCallState.preCallContext}
**当前参与者**: ${participantNames.join('、 ')}。
**通话刚刚开始...**

现在，请根据【通话前摘要】和下面的【通话实时记录】，继续进行对话。</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('single-video-call-prompt')">
                        <span class="prompt-item-icon">📹</span>
                        <span class="prompt-item-title">单聊视频通话提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="single-video-call-prompt-content">
                        <div class="form-group">
                            <label>单聊视频通话提示词</label>
                            <textarea id="single-video-call-prompt-input" rows="8" placeholder="输入单聊视频通话提示词..."># 单聊视频通话系统提示词
你的任务
你现在是一个场景描述引擎。你的任务是扮演 ${chat.name} (${chat.settings.aiPersona})，并以【第三人称旁观视角】来描述TA在视频通话中的所有动作和语言。

# 核心规则
1. **【【【视角铁律】】】**: 你的回复【绝对不能】使用第一人称"我"。必须使用第三人称，如"他"、"她"、或直接使用角色名"${chat.name}"。
2. **格式**: 你的回复【必须】是一段描述性的文本。

# 当前情景
你正在和用户（${userNickname}，人设: ${chat.settings.myPersona}）进行视频通话。
**${openingContext}**
**通话前的聊天摘要 (这是你们通话的原因，至关重要！)**:
${videoCallState.preCallContext}

现在，请根据【通话前摘要】和下面的【通话实时记录】，继续进行对话。</textarea>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- VN劇情相關設置 -->
        <div class="preset-category">
            <div class="category-header" onclick="toggleCategory('vn-story')">
                <span class="category-icon">🎭</span>
                <span class="category-title">VN劇情相關</span>
                <span class="category-toggle">▼</span>
            </div>
            <div class="category-content" id="vn-story-content" style="display: none;">
                
                <!-- COT思維鏈設置 - 獨立欄位 -->
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('cot-prompt')">
                        <span class="prompt-item-icon">🧠</span>
                        <span class="prompt-item-title">COT思維鏈設置</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="cot-prompt-content">
                        <div class="form-group">
                            <label for="cot-enable-checkbox">
                                <input type="checkbox" id="cot-enable-checkbox" checked>
                                啟用COT思維鏈
                            </label>
                            <div class="form-help">啟用後，COT內容會自動注入到VN提示詞中</div>
                        </div>
                        
                        <div class="form-group" id="cot-content-group">
                            <label for="cot-content-textarea">COT思維鏈內容</label>
                            <textarea id="cot-content-textarea" rows="6" placeholder="請將您的COT思維鏈內容複製到這裡..."># COT思維鏈內容
# 這裡的內容會自動注入到VN提示詞的 {{COT_CONTENT}} 標記位置
# 建議包含：
# - 思維步驟和邏輯推理
# - 角色行為分析
# - 劇情發展策略
# - 決策依據

# 示例：
# 1. 分析當前角色狀態和情緒
# 2. 考慮劇情發展的邏輯性
# 3. 確保角色行為符合人設
# 4. 平衡劇情節奏和衝突</textarea>
                            <div class="form-help">COT內容會自動替換VN提示詞中的 {{COT_CONTENT}} 標記</div>
                        </div>
                        
                        <div class="cot-status-info">
                            <span>狀態: <span id="cot-status-display">啟用</span></span>
                            <span>Token估算: <span id="cot-token-count">0</span></span>
                        </div>
                        
                        <style>
                            .cot-status-info {
                                display: flex;
                                justify-content: space-between;
                                margin-top: 10px;
                                font-size: 12px;
                                color: #666;
                            }
                            
                            #cot-content-group {
                                margin-top: 15px;
                            }
                        </style>
                    </div>
                </div>
                
                <!-- VN劇情提示詞 - 獨立欄位 -->
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('vn-prompt')">
                        <span class="prompt-item-icon">🎭</span>
                        <span class="prompt-item-title">VN剧情提示词</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="vn-prompt-content">
                        <div class="form-group">
                            <label>VN剧情提示词</label>
                            <textarea id="vn-prompt-input" rows="8" placeholder="输入VN剧情提示词..."># VN剧情提示词

# COT思維鏈整合說明
# 系統會自動在VN提示詞前注入COT內容（如果已啟用）
# 格式：{{COT_CONTENT}} - 此標記會被自動替換為實際的COT內容
# 建議將COT內容放在提示詞的最頂部，以確保思維鏈優先執行

{{COT_CONTENT}}

# VN劇情生成規則
你是一個VN劇情生成助手。請嚴格按照AI_output.md格式回應，生成VN劇情內容。

# VN劇情生成規則
- 根據用戶提供的劇情設定生成豐富的劇情內容
- 包含角色對話、旁白、場景描述
- 支持多種劇情類型（日常、冒險、戀愛等）
- 根據角色設定調整對話風格

# 重要格式要求：
1. 必須使用VN_TYPE的標準格式
2. 角色對話格式：[角色名|服裝|表情|對話|sound_effect]
3. 旁白格式：[Narrator|描述|sound_effect]
4. 場景格式：[Scene|YYYY-MM-DD|HH:MM|BG_TAG|地點]
5. 背景音樂格式：[BGM|bgm_name]
6. 展示物品格式: [Item|類型|物品名稱|物品描述]
7. 通話格式:
  <call_section>
  [Call|發送者→接收者:
  #n |位置|角色名|通話內容|音效/none
  #n |Call_Narrator|電話那頭傳來肯特疑惑的聲音。|none
  ...
  </call_section> 
8. 聊天室格式: 
CHAT_TYPE_RULES: 所有 CHAT_TYPE 段落，只要進入 chat 內容，開頭都必須以 [Chat|...|... 起始，並包在 <dm_list_1> /<group_list_1> 區塊中。
       <dm_list_1>
        [Chat|dm|dm_list_101|與角色B的私訊|角色A, 角色B:
        #n | 角色A | 訊息內容 | none | 05-24 | 18:30 | 已讀
        ...]
        </dm_list_1>

        <group_list_1>
        [Chat|group|group_list_101|群聊名稱|管理員名稱|角色A, 角色B:
        #n | 角色A | 訊息內容 | none | 05-24 | 18:30 | 已讀
        ...]
        </group_list_1>
9. 選項格式，必須輸出4條選項：[1️⃣ [選項文字] | 選項描述 | 選項結果]

# 輸出格式結構
你的回應必須包含以下完整結構：

```
<dialogues>
[Story|STORY_ID]
[Area|AREA_A_DAY]
[BGM|bgm_name]
[Scene|YYYY-MM-DD|HH:MM|BG_TAG|地點]
[Narrator|描述|sound_effect]
[角色名|服裝|表情|對話|sound_effect]
[End|STORY_ID]
</dialogues>

<choices>
[編號表情 [選項文字] | 選項描述 | 選項結果]
</choices>
```

請確保回應格式完全符合規範，不要使用其他格式。</textarea>
                        </div>
                    </div>
                </div>
        
                <div class="prompt-item">
                    <div class="prompt-item-header" onclick="togglePromptItem('story-prompt')">
                        <span class="prompt-item-icon">📚</span>
                        <span class="prompt-item-title">VN剧情素材資訊</span>
                        <span class="prompt-item-toggle">▼</span>
                    </div>
                    <div class="prompt-item-content" id="story-prompt-content">
                        <div class="form-group">
                            <label>VN剧情素材資訊</label>
                            <textarea id="story-prompt-input" rows="10" placeholder="輸入VN剧情素材資訊，如BGM列表、音效列表、NPC名單等..."># VN剧情素材資訊

## 🎵 BGM列表
### 日常場景
- bgm_daily_01: 溫馨的日常背景音樂
- bgm_daily_02: 輕鬆愉快的氛圍音樂
- bgm_daily_03: 平靜舒適的環境音

### 情感場景
- bgm_romance_01: 浪漫溫馨的愛情音樂
- bgm_sad_01: 悲傷感人的背景音樂
- bgm_excited_01: 激動興奮的音樂

### 緊張場景
- bgm_tension_01: 緊張刺激的背景音樂
- bgm_mystery_01: 神秘懸疑的氛圍音樂
- bgm_action_01: 動作場面的熱血音樂

## 🔊 音效列表
### 環境音效
- se_door_open: 開門聲
- se_door_close: 關門聲
- se_footsteps: 腳步聲
- se_rain: 雨聲
- se_thunder: 雷聲

### 互動音效
- se_phone_ring: 電話鈴聲
- se_message: 訊息提示音
- se_notification: 通知音效
- se_typing: 打字聲

### 情感音效
- se_heartbeat: 心跳聲
- se_sigh: 嘆氣聲
- se_laugh: 笑聲
- se_cry: 哭聲

## 👥 NPC名單
### 主要角色
- 雷伊 (Rei): 主角，性格開朗活潑
- 艾莉絲 (Alice): 女主角，溫柔善良
- 肯特 (Kent): 好友，幽默風趣

### 配角
- 老師: 嚴肅但關心學生
- 店員: 熱情服務
- 路人A: 背景角色
- 路人B: 背景角色

## 🎨 背景場景
### 室內場景
- bg_school_classroom: 學校教室
- bg_home_living_room: 家裡客廳
- bg_cafe_interior: 咖啡廳內部
- bg_library: 圖書館

### 室外場景
- bg_school_gate: 學校門口
- bg_park_day: 公園（白天）
- bg_park_night: 公園（夜晚）
- bg_city_street: 城市街道

## 📱 使用說明
- 在VN劇情生成時，AI會參考這些素材資訊
- 可以根據劇情需要選擇合適的BGM和音效
- NPC名單可以幫助AI生成更豐富的角色互動
- 背景場景可以增加劇情的視覺感

## 🔄 更新建議
- 定期更新BGM和音效列表
- 根據劇情發展添加新的NPC
- 記錄常用的背景場景
- 保持素材資訊的完整性和準確性</textarea>
                        </div>
                    </div>
                </div>
        

        
            </div>
        </div>
        
        <button class="form-button" id="save-preset-btn">保存预设</button>
        <button class="form-button form-button-secondary" id="reset-preset-btn">重置为默认</button>
        <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;">💡 重置後記得點擊保存</div>
        
        <style>
        /* 預設管理器分類樣式 */
        .preset-category {
            margin: 15px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: #fafafa;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        .category-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .category-icon {
            font-size: 18px;
            margin-right: 10px;
        }
        
        .category-title {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
        }
        
        .category-toggle {
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        
        .category-header.collapsed .category-toggle {
            transform: rotate(-90deg);
        }
        
        .category-content {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            /* 完全移除高度限制，讓大類內容完全展開 */
            height: auto;
            max-height: none;
            overflow: visible;
        }
        
        .category-content.collapsed {
            display: none;
        }
        
        /* 動畫效果 */
        .category-content {
            transition: all 0.3s ease;
        }
        
        /* 個別提示詞欄目摺疊樣式 */
        .prompt-item {
            margin-bottom: 15px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            overflow: hidden;
            background: #fafafa;
        }
        
        .prompt-item-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        .prompt-item-header:hover {
            background: linear-gradient(135deg, #e8e8e8 0%, #d8d8d8 100%);
        }
        
        .prompt-item-icon {
            font-size: 16px;
            margin-right: 10px;
            color: #666;
        }
        
        .prompt-item-title {
            flex: 1;
            font-weight: 500;
            font-size: 14px;
            color: #333;
        }
        
        .prompt-item-toggle {
            font-size: 12px;
            color: #666;
            transition: transform 0.3s ease;
        }
        
        .prompt-item-header.collapsed .prompt-item-toggle {
            transform: rotate(-90deg);
        }
        
        .prompt-item-content {
            padding: 15px;
            background: white;
            border-top: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }
        
        .prompt-item-content.collapsed {
            display: none;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .category-header {
                padding: 10px 12px;
            }
            
            .category-title {
                font-size: 14px;
            }
            
            .category-content {
                padding: 12px;
                /* 手機版也完全移除高度限制 */
                height: auto;
                max-height: none;
                overflow: visible;
            }
        }
        
        /* 預設管理器面板整體容器優化 */
        #prompt-manager-screen {
            display: flex !important;
            flex-direction: column !important;
            height: 100% !important;
        }
        
        #prompt-manager-screen .form-container {
            padding-bottom: 100px; /* 為底部按鈕留出空間 */
            height: auto !important; /* 強制移除高度限制 */
            max-height: none !important; /* 強制移除最大高度限制 */
            overflow: visible !important; /* 保持原來的設置，不影響摺疊功能 */
            flex-grow: 0 !important; /* 保持原來的設置 */
        }
        
        /* 為整個預設管理器屏幕添加滾動功能，不影響摺疊 */
        #prompt-manager-screen {
            overflow-y: auto !important; /* 添加垂直滾動條 */
        }
        </style>
        
        <script>
            // 提示詞管理器功能
            document.addEventListener('DOMContentLoaded', function() {
                // 載入保存的提示詞設置
                loadPromptSettings();
                
                // 綁定保存按鈕事件
                document.getElementById('save-preset-btn').addEventListener('click', savePromptSettings);
                
                // 綁定重置按鈕事件
                document.getElementById('reset-preset-btn').addEventListener('click', resetPromptSettings);
                
                // 初始化分類摺疊狀態
                initializeCategoryCollapse();
                
                // 初始化個別欄目摺疊狀態
                initializePromptItemCollapse();
                
                // 初始化COT相關事件監聽
                initializeCOTEventListeners();
            });
            
            // 初始化COT相關事件監聽
            function initializeCOTEventListeners() {
                // COT啟用狀態變更
                const cotEnableCheckbox = document.getElementById('cot-enable-checkbox');
                if (cotEnableCheckbox) {
                    cotEnableCheckbox.addEventListener('change', function() {
                        if (window.JCYCOTProcessor) {
                            window.JCYCOTProcessor.enabled = this.checked;
                            window.JCYCOTProcessor.saveToStorage();
                            updateCOTStatusDisplay();
                            console.log(`[提示詞管理] COT已${this.checked ? '啟用' : '停用'}`);
                        }
                    });
                }
                
                // COT內容變更
                const cotContentTextarea = document.getElementById('cot-content-textarea');
                if (cotContentTextarea) {
                    cotContentTextarea.addEventListener('input', function() {
                        if (window.JCYCOTProcessor) {
                            window.JCYCOTProcessor.updateCOTContent(this.value);
                            updateCOTStatusDisplay();
                        }
                    });
                }
            }
            
            // 分類摺疊功能
            function toggleCategory(categoryId) {
                const header = document.querySelector(`[onclick="toggleCategory('${categoryId}')"]`);
                const content = document.getElementById(`${categoryId}-content`);
                const toggle = header.querySelector('.category-toggle');
                
                if (content.style.display === 'none') {
                    // 展開
                    content.style.display = 'block';
                    header.classList.remove('collapsed');
                    toggle.textContent = '▼';
                } else {
                    // 摺疊
                    content.style.display = 'none';
                    header.classList.add('collapsed');
                    toggle.textContent = '▶';
                }
                
                // 保存摺疊狀態到localStorage
                saveCollapseState();
            }
            
            // 個別提示詞欄目摺疊功能
            function togglePromptItem(itemId) {
                const header = document.querySelector(`[onclick="togglePromptItem('${itemId}')"]`);
                const content = document.getElementById(`${itemId}-content`);
                const toggle = header.querySelector('.prompt-item-toggle');
                
                if (content.classList.contains('collapsed')) {
                    // 展開
                    content.classList.remove('collapsed');
                    header.classList.remove('collapsed');
                    toggle.textContent = '▼';
                } else {
                    // 摺疊
                    content.classList.add('collapsed');
                    header.classList.add('collapsed');
                    toggle.textContent = '▶';
                }
                
                // 保存個別欄目摺疊狀態
                savePromptItemCollapseState();
            }
            
            // 初始化分類摺疊狀態
            function initializeCategoryCollapse() {
                // 從localStorage讀取摺疊狀態
                const collapseState = localStorage.getItem('preset_manager_collapse_state');
                const defaultCollapsed = collapseState ? JSON.parse(collapseState) : { 'qq-chat': true, 'vn-story': true };
                
                // 設置初始狀態
                Object.keys(defaultCollapsed).forEach(categoryId => {
                    const header = document.querySelector(`[onclick="toggleCategory('${categoryId}')"]`);
                    const content = document.getElementById(`${categoryId}-content`);
                    const toggle = header.querySelector('.category-toggle');
                    
                    if (defaultCollapsed[categoryId]) {
                        // 摺疊狀態
                        content.style.display = 'none';
                        header.classList.add('collapsed');
                        toggle.textContent = '▶';
                    } else {
                        // 展開狀態
                        content.style.display = 'block';
                        header.classList.remove('collapsed');
                        toggle.textContent = '▼';
                    }
                });
            }
            
            // 保存摺疊狀態
            function saveCollapseState() {
                const collapseState = {};
                const categories = ['qq-chat', 'vn-story'];
                
                categories.forEach(categoryId => {
                    const content = document.getElementById(`${categoryId}-content`);
                    collapseState[categoryId] = content.style.display === 'none';
                });
                
                localStorage.setItem('preset_manager_collapse_state', JSON.stringify(collapseState));
            }
            
            // 初始化個別欄目摺疊狀態
            function initializePromptItemCollapse() {
                // 初始化所有可摺疊的項目
                const promptItems = [
                    'image-prompt', 'voice-prompt', 'transfer-prompt', 'decision-prompt',
                    'group-system-prompt', 'single-chat-prompt', 'background-activity-prompt',
                    'friend-request-prompt', 'call-summary-prompt', 'group-video-call-prompt',
                    'single-video-call-prompt', 'cot-prompt', 'vn-prompt', 'story-prompt'
                ];
                
                // 從localStorage讀取個別欄目摺疊狀態
                const collapseState = localStorage.getItem('preset_manager_prompt_items_collapse_state');
                const defaultCollapsed = collapseState ? JSON.parse(collapseState) : {};
                
                // 設置初始狀態（預設全部摺疊）
                promptItems.forEach(itemId => {
                    const header = document.querySelector(`[onclick="togglePromptItem('${itemId}')"]`);
                    const content = document.getElementById(`${itemId}-content`);
                    
                    if (header && content) {
                        const toggle = header.querySelector('.prompt-item-toggle');
                        const isCollapsed = defaultCollapsed[itemId] !== undefined ? defaultCollapsed[itemId] : true;
                        
                        if (isCollapsed) {
                            // 摺疊狀態
                            content.classList.add('collapsed');
                            header.classList.add('collapsed');
                            toggle.textContent = '▶';
                        } else {
                            // 展開狀態
                            content.classList.remove('collapsed');
                            header.classList.remove('collapsed');
                            toggle.textContent = '▼';
                        }
                    }
                });
            }
            
            // 保存個別欄目摺疊狀態
            function savePromptItemCollapseState() {
                // 保存所有可摺疊的項目
                const promptItems = [
                    'image-prompt', 'voice-prompt', 'transfer-prompt', 'decision-prompt',
                    'group-system-prompt', 'single-chat-prompt', 'background-activity-prompt',
                    'friend-request-prompt', 'call-summary-prompt', 'group-video-call-prompt',
                    'single-video-call-prompt', 'cot-prompt', 'vn-prompt', 'story-prompt'
                ];
                
                const collapseState = {};
                promptItems.forEach(itemId => {
                    const content = document.getElementById(`${itemId}-content`);
                    if (content) {
                        collapseState[itemId] = content.classList.contains('collapsed');
                    }
                });
                
                localStorage.setItem('preset_manager_prompt_items_collapse_state', JSON.stringify(collapseState));
            }
            
            // 載入提示詞設置
            function loadPromptSettings() {
                try {
                    const savedSettings = localStorage.getItem('jcy_prompt_settings');
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        
                        // 載入各個提示詞輸入框
                        if (settings.vnPrompt) {
                            document.getElementById('vn-prompt-input').value = settings.vnPrompt;
                        }
                        if (settings.storyPrompt) {
                            document.getElementById('story-prompt-input').value = settings.storyPrompt;
                        }
                        if (settings.imagePrompt) {
                            document.getElementById('image-prompt-input').value = settings.imagePrompt;
                        }
                        if (settings.voicePrompt) {
                            document.getElementById('voice-prompt-input').value = settings.voicePrompt;
                        }
                        if (settings.transferPrompt) {
                            document.getElementById('transfer-prompt-input').value = settings.transferPrompt;
                        }
                        if (settings.decisionPrompt) {
                            document.getElementById('decision-prompt-input').value = settings.decisionPrompt;
                        }
                        if (settings.groupSystemPrompt) {
                            document.getElementById('group-system-prompt-input').value = settings.groupSystemPrompt;
                        }
                        if (settings.singleChatPrompt) {
                            document.getElementById('single-chat-prompt-input').value = settings.singleChatPrompt;
                        }
                        
                        console.log('[提示詞管理] 已載入保存的提示詞設置');
                    } else {
                        console.log('[提示詞管理] 沒有找到保存的設置，使用HTML中的默認值');
                        // 確保HTML中的默認內容被正確顯示
                        console.log('[提示詞管理] VN提示詞內容:', document.getElementById('vn-prompt-input').value);
                        console.log('[提示詞管理] 劇情開始提示詞內容:', document.getElementById('story-prompt-input').value);
                    }
                    
                    // 載入COT設置
                    loadCOTSettings();
                    
                } catch (error) {
                    console.error('[提示詞管理] 載入設置失敗:', error);
                }
            }
            
            // 載入COT設置
            function loadCOTSettings() {
                try {
                    if (window.JCYCOTProcessor) {
                        const status = window.JCYCOTProcessor.getIntegrationStatus();
                        
                        // 更新COT啟用狀態
                        const cotEnableCheckbox = document.getElementById('cot-enable-checkbox');
                        if (cotEnableCheckbox) {
                            cotEnableCheckbox.checked = status.enabled;
                        }
                        
                        // 更新COT內容
                        const cotContentTextarea = document.getElementById('cot-content-textarea');
                        if (cotContentTextarea) {
                            cotContentTextarea.value = window.JCYCOTProcessor.getCOTContent();
                        }
                        
                        // 更新狀態顯示
                        updateCOTStatusDisplay();
                        
                        console.log('[提示詞管理] COT設置已載入');
                    }
                } catch (error) {
                    console.error('[提示詞管理] 載入COT設置失敗:', error);
                }
            }
            
            // 更新COT狀態顯示
            function updateCOTStatusDisplay() {
                try {
                    if (window.JCYCOTProcessor) {
                        const status = window.JCYCOTProcessor.getIntegrationStatus();
                        
                        const statusDisplay = document.getElementById('cot-status-display');
                        const tokenCountDisplay = document.getElementById('cot-token-count');
                        
                        if (statusDisplay) {
                            statusDisplay.textContent = status.enabled ? '啟用' : '停用';
                            statusDisplay.style.color = status.enabled ? '#4CAF50' : '#f44336';
                        }
                        
                        if (tokenCountDisplay) {
                            tokenCountDisplay.textContent = status.tokenCount;
                        }
                    }
                } catch (error) {
                    console.error('[提示詞管理] 更新COT狀態顯示失敗:', error);
                }
            }
            
            // 獲取整合COT的VN提示詞
            function getIntegratedVNPrompt() {
                try {
                    const vnPrompt = document.getElementById('vn-prompt-input').value || '';
                    
                    // 使用COT處理器的整合方法
                    if (window.JCYCOTProcessor && window.JCYCOTProcessor.shouldUseIntegration()) {
                        const integratedPrompt = window.JCYCOTProcessor.getIntegratedVNPrompt(vnPrompt);
                        console.log('[提示詞管理] 使用COT處理器整合VN提示詞');
                        return integratedPrompt;
                    }
                    
                    // 兼容舊版本：直接檢查COT是否啟用
                    if (window.JCYCOTProcessor && window.JCYCOTProcessor.isEnabled()) {
                        const cotContent = window.JCYCOTProcessor.getCOTContent();
                        if (cotContent && cotContent.trim()) {
                            // 替換COT標記為實際內容
                            const integratedPrompt = vnPrompt.replace('{{COT_CONTENT}}', cotContent.trim());
                            console.log('[提示詞管理] COT已整合到VN提示詞中（兼容模式）');
                            return integratedPrompt;
                        }
                    }
                    
                    // 如果沒有COT內容，移除標記
                    const cleanPrompt = vnPrompt.replace('{{COT_CONTENT}}', '');
                    console.log('[提示詞管理] 使用純VN提示詞（無COT）');
                    return cleanPrompt;
                    
                } catch (error) {
                    console.error('[提示詞管理] 整合COT到VN提示詞失敗:', error);
                    return document.getElementById('vn-prompt-input').value || '';
                }
            }
            
            // 將函數暴露到全局作用域，供JCY主系統使用
            window.getIntegratedVNPrompt = getIntegratedVNPrompt;
            
            // 保存提示詞設置
            function savePromptSettings() {
                try {
                    const settings = {
                        vnPrompt: document.getElementById('vn-prompt-input').value,
                        storyPrompt: document.getElementById('story-prompt-input').value,
                        imagePrompt: document.getElementById('image-prompt-input').value,
                        voicePrompt: document.getElementById('voice-prompt-input').value,
                        transferPrompt: document.getElementById('transfer-prompt-input').value,
                        decisionPrompt: document.getElementById('decision-prompt-input').value,
                        groupSystemPrompt: document.getElementById('group-system-prompt-input').value,
                        singleChatPrompt: document.getElementById('single-chat-prompt-input').value,
                        cotIntegration: true, // 標記COT整合功能已啟用
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('jcy_prompt_settings', JSON.stringify(settings));
                    
                    // 保存COT設置
                    saveCOTSettings();
                    
                    console.log('[提示詞管理] 提示詞設置已保存（包含COT整合）');
                    
                    // 顯示成功消息
                    showNotification('提示詞設置已保存（COT整合已啟用）', 'success');
                } catch (error) {
                    console.error('[提示詞管理] 保存設置失敗:', error);
                    showNotification('保存失敗，請重試', 'error');
                }
            }
            
            // 保存COT設置
            function saveCOTSettings() {
                try {
                    if (window.JCYCOTProcessor) {
                        // 更新COT啟用狀態
                        const cotEnableCheckbox = document.getElementById('cot-enable-checkbox');
                        if (cotEnableCheckbox) {
                            window.JCYCOTProcessor.enabled = cotEnableCheckbox.checked;
                        }
                        
                        // 更新COT內容
                        const cotContentTextarea = document.getElementById('cot-content-textarea');
                        if (cotContentTextarea) {
                            window.JCYCOTProcessor.updateCOTContent(cotContentTextarea.value);
                        }
                        
                        // 保存到localStorage
                        window.JCYCOTProcessor.saveToStorage();
                        
                        // 更新狀態顯示
                        updateCOTStatusDisplay();
                        
                        console.log('[提示詞管理] COT設置已保存');
                    }
                } catch (error) {
                    console.error('[提示詞管理] 保存COT設置失敗:', error);
                }
            }
            
            // 重置提示詞設置
            function resetPromptSettings() {
                if (confirm('確定要重置所有提示詞為默認值嗎？這將覆蓋當前的修改。')) {
                    try {
                        // 清除保存的設置
                        localStorage.removeItem('jcy_prompt_settings');
                        
                        // 重新載入頁面以恢復默認值
                        location.reload();
                        
                        console.log('[提示詞管理] 提示詞設置已重置為默認值');
                    } catch (error) {
                        console.error('[提示詞管理] 重置設置失敗:', error);
                        showNotification('重置失敗，請重試', 'error');
                    }
                }
            }
            
            // 顯示通知
            function showNotification(message, type = 'info') {
                // 創建通知元素
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease;
                `;
                
                document.body.appendChild(notification);
                
                // 3秒後自動移除
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        </script>
        
        <hr style="margin: 20px 0; opacity: 0.3;">
        
        <div class="form-group">
            <label>预设列表</label>
            <div id="preset-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                <!-- 预设列表将在这里动态生成 -->
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ 提示词管理屏幕结束 ▲▲▲ -->

<!-- ▼▼▼ 【已整合】COT管理屏幕 - 現在整合到VN提示詞中 ▼▼▼ -->
<div id="cot-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>COT思維鏈管理</span>
        <span class="action-btn" onclick="showScreen('prompt-manager-screen')">前往VN提示詞</span>
    </div>
    <div class="cot-management-container">
        <div class="cot-integration-notice">
            <h3>🎯 COT已整合到VN提示詞</h3>
            <p>COT思維鏈功能現在已完全整合到「提示詞管理」→「VN劇情相關」→「COT思維鏈設置」中。</p>
            <p>請前往VN劇情相關設置頁面進行COT內容編輯和管理。</p>
            
            <div class="integration-benefits">
                <h4>整合優勢：</h4>
                <ul>
                    <li>✅ 統一管理：COT和VN提示詞在同一位置</li>
                    <li>✅ 自動注入：使用 {{COT_CONTENT}} 標記自動替換</li>
                    <li>✅ 靈活控制：可選擇是否啟用COT</li>
                    <li>✅ 簡化操作：減少重複設置</li>
                </ul>
            </div>
            
            <div class="action-buttons">
                <button class="form-button" onclick="showScreen('prompt-manager-screen')">前往VN劇情相關設置</button>
                <button class="form-button form-button-secondary" onclick="showScreen('home-screen')">返回主頁</button>
            </div>
        </div>
    </div>
    
    <style>
        .cot-integration-notice {
            padding: 20px;
            text-align: center;
        }
        
        .cot-integration-notice h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }
        
        .cot-integration-notice p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .integration-benefits {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }
        
        .integration-benefits h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .integration-benefits ul {
            list-style: none;
            padding: 0;
        }
        
        .integration-benefits li {
            margin-bottom: 8px;
            color: #555;
        }
        
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
    </style>
</div>
<!-- ▲▲▲ COT管理屏幕结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】VN面板屏幕 ▼▼▼ -->
<div id="vn-panel-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>線下劇情</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="vn-panel-container">
        <iframe id="vn-iframe" src="vn_mobile/vn_panel.html" frameborder="0"></iframe>
    </div>
</div>
<!-- ▲▲▲ VN面板屏幕结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】选择联系人以创建群聊的屏幕 ▼▼▼ -->
<div id="contact-picker-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">取消</span>
        <span>选择联系人</span>
        <span class="save-btn" id="confirm-contact-picker-btn">完成(0)</span>
    </div>
    <div class="list-container" id="contact-picker-list">
        <!-- 联系人列表将由JS动态生成 -->
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】群成员管理屏幕 ▼▼▼ -->
<div id="member-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-member-management">‹</span>
        <span>群成员管理</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="list-container" id="member-management-list">
        <!-- 现有成员列表会在这里动态生成 -->
    </div>
    <div id="member-management-actions">
        <button id="add-existing-contact-btn">从好友列表添加</button>
        <button id="create-new-member-btn">创建群内新成员</button>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】来电请求模态框 ▼▼▼ -->
<div id="incoming-call-modal" class="modal">
    <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">邀请你视频通话</div>
        <div class="incoming-call-actions">
            <div class="action-button-wrapper">
                <button id="decline-call-btn" class="call-action-btn decline"></button>
                <span>拒绝</span>
            </div>
            <div class="action-button-wrapper">
                <button id="accept-call-btn" class="call-action-btn accept"></button>
                <span>接听</span>
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新增结束 ▲▲▲ -->

<!-- ▼▼▼ 请用这段【全新群聊兼容结构】的代码，完整替换你旧的 #video-call-screen ▼▼▼ -->
<div id="video-call-screen" class="screen">
    <!-- 1. 顶部栏 (保持不变) -->
    <div class="video-call-top-bar">
        <span id="call-timer">00:00</span>
    </div>
    
    <!-- 2. 【升级】参与者头像网格区域 -->
    <div class="video-call-avatar-area">
        <div id="participant-avatars-grid">
            <!-- JS会在这里动态生成头像 -->
        </div>
    </div>

    <!-- 3. 对话框区域 (保持不变) -->
    <div id="video-call-main" class="video-call-main">
        <!-- 对话内容会动态生成在这里 -->
    </div>
    
    <!-- 4. 【升级】底部控制栏，现在包含一个"加入"按钮 -->
    <div class="video-call-controls">
        <button id="user-speak-btn" class="control-btn speak-btn"></button>
        <button id="hang-up-btn" class="control-btn hangup-btn"></button>
        <!-- 这个按钮默认隐藏，只在用户"旁观"时显示 -->
        <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
    </div>
</div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新添加】正在呼叫界面 ▼▼▼ -->
<div id="outgoing-call-screen" class="screen">
    <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">正在呼叫...</div>
        <div class="outgoing-call-actions">
            <button id="cancel-call-btn" class="call-action-btn decline"></button>
            <span>取消</span>
        </div>
    </div>
</div>
<!-- ▲▲▲ 添加结束 ▲▲▲ -->

        </div>
    </div>
  
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>聊天设置</span></div><div class="modal-body">
    
    <!-- 導入人設下拉選單 -->
    <div class="form-group" id="import-persona-group">
        <label for="import-persona-select">📚 导入人设</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="import-persona-select" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 14px; color: #333;" onchange="handlePersonaImportChange().catch(console.error)">
                <option value="" style="color: #999;">-- 不导入 --</option>
            </select>
            <button id="refresh-persona-list-btn" type="button" onclick="refreshPersonaList()" style="padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">刷新</button>
            <button id="test-persona-data-btn" type="button" onclick="testPersonaData()" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">測試</button>
        </div>
    </div>
    
    <div class="form-group" id="chat-name-group"><label for="chat-name-input">备注名 / 群名</label><input type="text" id="chat-name-input"></div>

    <!-- ▼▼▼ 请将这段新代码粘贴到"备注名"输入框的 form-group 之后 ▼▼▼ -->
    <div class="form-group" id="assign-group-section" style="display: none;"> <!-- 默认隐藏，只对单聊显示 -->
        <label for="assign-group-select">好友分组</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="assign-group-select" style="flex-grow: 1;">
                <!-- 分组选项将由JS动态生成 -->
            </select>
            <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">管理分组</button>
        </div>
    </div>
    <!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">我的群昵称</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>群头像</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">上传群头像</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>关联世界书 (可多选)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- 点击选择 --</span>
                        <span class="arrow-down">▼</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">对方人设 (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>对方头像</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">上传对方头像</button><button id="manage-ai-avatar-library-btn" class="form-button-secondary" style="margin-top:0; padding: 8px 12px; font-size: 14px;">管理头像库</button>
<button class="change-frame-btn" data-type="ai">更换头像框</button><input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">我的人设 (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>我的头像</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">上传我的头像</button><button class="change-frame-btn" data-type="my">更换头像框</button><button id="open-persona-library-btn">预设</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>群成员人设</label><div id="group-members-settings"></div>

    <!-- 【新增】管理成员按钮 -->
    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">管理群成员</button></div>
<div class="form-group"><label for="max-memory">上下文记忆条数</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>聊天气泡主题 <button id="reset-theme-btn" type="button">重置</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> 默认</label><label><input type="radio" name="theme-select" value="pink_blue"> 粉蓝</label><label><input type="radio" name="theme-select" value="blue_white"> 蓝白</label><label><input type="radio" name="theme-select" value="purple_yellow"> 紫黄</label><label><input type="radio" name="theme-select" value="black_white"> 黑白</label><label><input type="radio" name="theme-select" value="yellow_white"> 黄白</label><label><input type="radio" name="theme-select" value="red_black"> 红黑</label><label><input type="radio" name="theme-select" value="blue_yellow"> 蓝黄</label><label><input type="radio" name="theme-select" value="pink_yellow"> 粉黄</label><label><input type="radio" name="theme-select" value="pink_purple"> 粉紫</label><label><input type="radio" name="theme-select" value="gray_white"> 灰白</label><label><input type="radio" name="theme-select" value="blue_green"> 蓝绿</label><label><input type="radio" name="theme-select" value="pink_white"> 粉白</label><label><input type="radio" name="theme-select" value="pink_black"> 粉黑</label><label><input type="radio" name="theme-select" value="pink_green"> 粉绿</label><label><input type="radio" name="theme-select" value="green_black"> 绿黑</label></div></div>

<!-- ▼▼▼ 请将这段新代码粘贴到"聊天气泡主题"的 form-group 之后 ▼▼▼ -->
<div class="form-group">
    <label for="font-size-slider">聊天字体大小 <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>
<!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 请将这段新代码粘贴到"聊天字体大小"的 form-group 之后 ▼▼▼ -->
<div class="form-group">
    <label for="custom-css-input">
        自定义气泡样式 (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">重置</button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* 示例：为"我"的气泡添加渐变背景和阴影 */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 请将这段新代码粘贴到自定义CSS输入框的 form-group 之后 ▼▼▼ -->
<div class="form-group">
    <label>实时预览</label>
    <div id="settings-preview-area">
        <!-- JS会在这里生成预览内容 -->
    </div>
</div>
<!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

            <div class="form-group">
                <label>聊天背景</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">上传背景图</button>
                    <button type="button" id="remove-bg-btn">移除背景</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
<button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">拉黑对方</button>
<button class="form-button form-button-secondary" id="clear-chat-btn">清空聊天记录</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">取消</button><button class="save" id="save-chat-settings-btn">保存</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>我的人设库</span><button id="add-persona-preset-btn" class="action-button">添加</button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">关闭</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">添加人设预设</span></div><div class="modal-body"><div class="form-group"><label>预设头像</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">上传头像</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">预设人设</label><textarea id="preset-persona-input" rows="4" placeholder="在此输入这个人设的详细设定..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">取消</button><button class="save" id="save-persona-preset-btn">保存</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>编辑群成员</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">名字</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">人设</label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label>头像</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">上传头像</button><button class="change-frame-btn" data-type="member">更换头像框</button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">取消</button><button class="save" id="save-member-settings-btn">保存</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">取消</button>
                <button id="custom-modal-confirm" class="confirm-btn">确定</button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">编辑预设</button>
                <button id="preset-action-delete" class="btn-danger">删除预设</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">给Ta一个惊喜！</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">转账金额</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">备注 (可选)</label>
                <input type="text" id="transfer-note" placeholder="留下你的小心思~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">取消</button>
                <button id="transfer-confirm-btn">确认转账</button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="">
        <p id="battery-alert-text"></p>
    </div>
</div>

<!-- 头像框选择模态框 (这是新添加的) -->
    <div id="avatar-frame-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>选择头像框</span>
            </div>
            <div class="modal-body">
                <div class="frame-tabs">
                    <div id="ai-frame-tab" class="frame-tab active">对方的</div>
                    <div id="my-frame-tab" class="frame-tab">我的</div>
                </div>
                <div id="ai-frame-content" class="frame-content">
                    <div id="ai-frame-grid" class="frame-grid">
                        <!-- AI头像框会动态生成在这里 -->
                    </div>
                </div>
                <div id="my-frame-content" class="frame-content" style="display: none;">
                     <div id="my-frame-grid" class="frame-grid">
                        <!-- 我的头像框会动态生成在这里 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-frame-settings-btn">取消</button>
                <button class="save" id="save-frame-settings-btn">保存</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

<!-- ▼▼▼ 用下面这段【完整】的模态框代码，替换掉你现有的 id="create-post-modal" 的整个 div ▼▼▼ -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span>发布动态</span>
        </div>
        <div class="modal-body">
            <!-- 公开文字输入区 -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="分享新鲜事...（非必填的公开文字）"></textarea>
            </div>

            <!-- === 模式切换开关 (新增) === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">上传图片</button>
                <button id="switch-to-text-image-mode" class="mode-btn">使用文字图</button>
            </div>

<!-- ▼▼▼ 【修正后】的可见范围设置 ▼▼▼ -->
<div class="form-group">
    <label>可见范围</label>
    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="public" checked> 公开</label>

        <label><input type="radio" name="visibility" value="include"> 指定分组可见</label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <!-- 分组多选框将由JS动态生成 -->
    </div>
</div>
<!-- ▲▲▲ 修正结束 ▲▲▲ -->

            <!-- === 图片模式区域 === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
<div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="图片预览">
                        <button id="post-remove-image-btn">×</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">本地上传</button>
                        <button id="post-use-url-btn" class="form-button-secondary">网络URL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>图片描述 (必填，给AI看)</label>
                    <input type="text" id="post-image-description" placeholder="简单描述图片内容，帮助AI理解">
                </div>
            </div>

            <!-- === 文字图模式区域 (新增) === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>文字图 (给AI理解用的描述，点击图片后可见)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="在这里写下图片描述..."></textarea>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">取消</button>
            <button class="save" id="confirm-create-post-btn">发布</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->

<!-- ▼▼▼ 请将这个新的模态框HTML粘贴到所有其他模态框之后 ▼▼▼ -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>管理好友分组</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>新建分组</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="输入分组名..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- 分组列表将由JS动态生成 -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;">完成</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新代码粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 请将这段新HTML粘贴到所有模态框的末尾 ▼▼▼ -->
<div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <!-- 新的操作按钮 -->
            <button id="edit-message-btn">编辑消息</button>
            <button id="copy-message-btn">复制文本</button>
            <button id="select-message-btn">进入多选</button>
            <!-- 取消按钮 -->
            <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 请将这段新HTML粘贴到所有模态框的末尾 ▼▼▼ -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn">编辑动态</button>
            <button id="copy-post-btn">复制内容</button>           
            <button id="cancel-post-action-btn">取消</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】可视化消息编辑器模态框 ▼▼▼ -->
<div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
        <div class="modal-header">
            <span>编辑与拆分消息</span>
        </div>
        <div class="modal-body" id="message-editor-body">
            <!-- 编辑器容器，JS会在这里动态生成文本框 -->
            <div id="message-editor-container"></div>
            <!-- 添加新消息的按钮 -->
            <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                [+] 添加下一条消息
            </button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-advanced-editor-btn">取消</button>
            <button class="save" id="save-advanced-editor-btn">保存更改</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】外卖请求模态框 ▼▼▼ -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span>发起外卖代付</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info">商品信息</label>
                <input type="text" id="waimai-product-info" placeholder="例如：一杯杨枝甘露">
            </div>
            <div class="form-group">
                <label for="waimai-amount">代付金额 (元)</label>
                <input type="number" id="waimai-amount" placeholder="例如：21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="waimai-cancel-btn">取消</button>
            <button class="save" id="waimai-confirm-btn">发起请求</button>
        </div>
    </div>
</div>

<!-- ▼▼▼ 【全新】新建约定/倒计时模态框 ▼▼▼ -->
<div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>新建约定</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="countdown-title-input">约定标题</label>
                <input type="text" id="countdown-title-input" placeholder="例如：我的生日">
            </div>
            <div class="form-group">
                <label for="countdown-date-input">约定日期与时间</label>
                <input type="datetime-local" id="countdown-date-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-countdown-btn">取消</button>
            <button class="save" id="confirm-create-countdown-btn">保存约定</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】发红包模态框 ▼▼▼ -->
<div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>发红包</span>
        </div>
        <div class="modal-body" style="padding: 0;">
            <!-- 1. 页签切换 -->
            <div class="frame-tabs">
                <div id="rp-tab-group" class="frame-tab active">拼手气红包</div>
                <div id="rp-tab-direct" class="frame-tab">专属红包</div>
            </div>

            <!-- 2. 拼手气红包内容区 -->
            <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                <div class="form-group">
                    <label>总金额 (元)</label>
                    <input type="number" id="rp-group-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>红包个数</label>
                    <input type="number" id="rp-group-count" placeholder="填写红包个数">
                </div>
                <div class="form-group">
                    <label>祝福语</label>
                    <input type="text" id="rp-group-greeting" placeholder="恭喜发财，大吉大利！">
                </div>
                <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¥ 0.00</p>
                <button id="send-group-packet-btn" class="form-button">塞钱进红包</button>
            </div>

            <!-- 3. 专属红包内容区 -->
            <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                <div class="form-group">
                    <label>发送给</label>
                    <select id="rp-direct-receiver"></select>
                </div>
                <div class="form-group">
                    <label>金额 (元)</label>
                    <input type="number" id="rp-direct-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>祝福语</label>
                    <input type="text" id="rp-direct-greeting" placeholder="恭喜发财，大吉大利！">
                </div>
                 <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¥ 0.00</p>
                <button id="send-direct-packet-btn" class="form-button">塞钱进红包</button>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center;">
             <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">取消</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】红包详情模态框 ▼▼▼ -->
<div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
        <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
            <div style="text-align: center; width: 100%;">
                <div id="rp-details-sender" style="font-size: 16px;"></div>
                <div style="font-size: 13px; opacity: 0.8;">的红包</div>
            </div>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
            <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                <span style="font-size: 18px; color: #E44D44;">元</span>
            </div>
            <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
            <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                <!-- 领取详情将由JS动态生成在这里 -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-rp-details-btn" style="width: 100%;">关闭</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->
<!-- ▼▼▼ 【全新】创建投票模态框 ▼▼▼ -->
<div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>发起投票</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="poll-question-input">投票问题</label>
                <textarea id="poll-question-input" rows="2" placeholder="例如：今晚我们看什么电影？"></textarea>
            </div>
            <div class="form-group">
                <label>投票选项 (至少2项)</label>
                <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- 投票选项将由JS动态生成在这里 -->
                </div>
                <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ 添加选项</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-poll-btn">取消</button>
            <button class="save" id="confirm-create-poll-btn">发起投票</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新HTML粘贴结束 ▲▲▲ -->

<!-- ▼▼▼ 【全新】AI头像库管理模态框 ▼▼▼ -->
<div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="ai-avatar-library-title">对方的头像库</span>
            <button id="add-ai-avatar-btn" class="action-button">添加</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- 头像库内容将由JS动态生成 -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">关闭</button>
        </div>
    </div>
</div>




<div id="prompt-preview-modal" class="modal prompt-preview-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="prompt-preview-title">提示词预览</span>
        </div>
        <div class="modal-body">
            <div class="prompt-preview-info">
                <span id="prompt-preview-type"></span>
                <span id="prompt-preview-date"></span>
            </div>
            <div class="prompt-preview-content" id="prompt-preview-content">
                <!-- 提示词内容将在这里显示 -->
            </div>
            <div class="form-group">
                <label>使用说明</label>
                <div id="prompt-preview-description" style="font-size: 12px; color: var(--text-secondary); line-height: 1.4;">
                    <!-- 使用说明将在这里显示 -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="close-prompt-preview-btn">关闭</button>
            <button class="save" id="use-prompt-btn">使用此提示词</button>
        </div>
    </div>
</div>


<script src="JCY_API_module.js"></script>
<script src="JCY_AI_core.js"></script>
<script src="JCY_COT_Processor.js"></script>
</body>
</html>