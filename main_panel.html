<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šç”¨é¢æ¿ - å¤šåŠŸèƒ½ç•Œé¢</title>
    <link rel="stylesheet" href="map/map-style.css">
    <script src="map_core.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="communication_manager.js"></script>

    <style>
        :root {
            --container-bg: #FFB6C1;
            --section-bg: rgba(255, 255, 255, 0.9);
            --text-color: #333333;
            --scrollbar-color: rgba(255, 105, 180, 0.6);
            --hover-bg-color: rgba(255, 255, 255, 0.1);
            --active-bg-color: rgba(255, 255, 255, 0.2);
            --border-color: rgba(255, 255, 255, 0.2);
            --background-image: none;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow: hidden;
            /* ğŸ†• æ–°å¢ï¼šé˜²æ­¢æ‰‹æ©Ÿç«¯å½ˆæ€§æ»¾å‹• */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        .phone-frame {
            width: min(375px, 95vw);
            height: min(712px, 95vh);
            background: #000;
            border-radius: 48px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 0 8px #222;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 8px;
            /* ç¢ºä¿åœ¨å°å±å¹•ä¸Šä¹Ÿèƒ½æ­£å¸¸é¡¯ç¤º */
            min-width: 320px;
            min-height: 500px;
        }



        .phone-homebar {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 6px;
            background: #bbb;
            border-radius: 6px;
            opacity: 0.7;
            z-index: 10;
        }

        .phone-container {
            width: 100%;
            height: 100%;
            border-radius: 40px;
            background: var(--container-bg);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* é˜²æ­¢iframeå°ºå¯¸è®ŠåŒ–å°è‡´çš„æŠ–å‹• */
            transform: translateZ(0);
            backface-visibility: hidden;
            /* ç¢ºä¿èƒŒæ™¯åœ–ç‰‡åœ¨å®¹å™¨é¡è‰²ä¸Šé¢ */
            z-index: 0;
            /* ğŸ†• æ–°å¢ï¼šé˜²æ­¢æ‰‹æ©Ÿç«¯å½ˆæ€§æ»¾å‹• */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }



        /* ç¢ºä¿å…§å®¹åœ¨èƒŒæ™¯åœ–ç‰‡ä¸Šé¢ */
        .swipe-container > * {
            position: relative;
            z-index: 1;
        }

        /* æ»‘åŠ¨å®¹å™¨ */
        .swipe-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: var(--container-bg);
            /* ğŸ†• æ–°å¢ï¼šé˜²æ­¢æ‰‹æ©Ÿç«¯å½ˆæ€§æ»¾å‹• */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        /* èƒŒæ™¯åœ–ç‰‡å±¤ï¼Œç¢ºä¿åœ¨å®¹å™¨é¡è‰²ä¸Šé¢ */
        .swipe-container.has-background {
            background: transparent !important;
        }

        .swipe-container.has-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--background-image, none);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 40px;
            z-index: -1;
            pointer-events: none;
            display: block;
            opacity: 1;
            /* èª¿è©¦ï¼šæ·»åŠ é‚Šæ¡†ä»¥ä¾¿æŸ¥çœ‹ */
            border: 2px solid #d3d1d1;
        }

        .swipe-wrapper {
            width: 300%;
            height: 100%;
            display: flex;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-33.33%);
            /* ğŸ†• æ–°å¢ï¼šé˜²æ­¢æ‰‹æ©Ÿç«¯å½ˆæ€§æ»¾å‹• */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        .swipe-slide {
            width: 33.33%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é¡µé¢æŒ‡ç¤ºå™¨ */
        .page-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .indicator-dot.active {
            background: rgba(255,255,255,0.9);
            transform: scale(1.2);
        }

        /* ğŸ†• æ–°å¢ï¼šæ‰‹æ©Ÿç«¯é˜²æ­¢å½ˆæ€§æ»¾å‹•çš„é¡å¤–è¨­ç½® */
        @media (max-width: 768px) {
            body {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* ğŸ†• ä¿®æ­£ï¼šç§»é™¤å¼·åˆ¶å›ºå®šä½ç½®ï¼Œä¿æŒåŸæœ‰å¸ƒå±€ */
                position: relative !important;
                width: 100vw !important;
                height: 100vh !important;
            }
            
            .phone-container {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* ğŸ†• ä¿®æ­£ï¼šç§»é™¤å¼·åˆ¶å›ºå®šä½ç½®ï¼Œä¿æŒåŸæœ‰å¸ƒå±€ */
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .swipe-container {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* ğŸ†• ä¿®æ­£ï¼šç§»é™¤å¼·åˆ¶å›ºå®šä½ç½®ï¼Œä¿æŒåŸæœ‰å¸ƒå±€ */
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .swipe-wrapper {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* ğŸ†• ä¿®æ­£ï¼šç§»é™¤transformè¦†è“‹ï¼Œä¿æŒæ»‘å‹•åŠŸèƒ½ */
                will-change: transform !important;
            }
            
            .swipe-slide {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* ğŸ†• ä¿®æ­£ï¼šç§»é™¤transformè¦†è“‹ï¼Œä¿æŒæ»‘å‹•åŠŸèƒ½ */
                will-change: transform !important;
            }
            
            /* ğŸ†• æ–°å¢ï¼šiframeé˜²è­· */
            iframe {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            
            /* ğŸ†• æ–°å¢ï¼šæ‰€æœ‰å­å…ƒç´ é˜²è­· */
            * {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            
            /* ğŸ†• æ–°å¢ï¼šç‰¹å®šå®¹å™¨é˜²è­· */
            .page-new, .page-one, .page-two {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            
            .new-page-content, .status-content, .map-content {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            

            
            .phone-frame {
                position: relative !important;
                overflow: visible !important;
            }
        }

        /* æ–°é¡µé¢æ ·å¼ */
        .page-new {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.3)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.25)"/><circle cx="70" cy="70" r="1" fill="rgba(255,255,255,0.2)"/></svg>') repeat;
        }

        .page-new::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(106,90,205,0.3) 0%, rgba(72,61,139,0.2) 100%);
            z-index: 1;
        }

        .new-page-content {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            z-index: 2;
            position: relative;
        }

        .new-page-container {
            background: var(--section-bg);
            backdrop-filter: blur(20px);
            border-radius: 40px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 500px;
        }

        .new-page-header {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .new-page-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #6a5acd, #483d8b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .new-page-subtitle {
            font-size: 12px;
            opacity: 0.8;
            color: var(--text-color);
        }

        .new-page-body {
            flex: 1;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            border: none;
            border-radius: 0;
            color: var(--text-color);
            font-size: 14px;
            opacity: 1;
            text-align: center;
            overflow: hidden;
        }

        /* ç¬¬ä¸€é¡µæ ·å¼ */
        .page-one {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.3)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.25)"/><circle cx="70" cy="70" r="1" fill="rgba(255,255,255,0.2)"/></svg>') repeat;
        }

        .page-one::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(106,90,205,0.3) 0%, rgba(72,61,139,0.2) 100%);
            z-index: 1;
        }

        .page-one-content {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            position: relative;
        }

        .page-one-placeholder {
            text-align: center;
            color: rgba(255,255,255,0.7);
        }

        .page-one-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-one-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }

        /* çŠ¶æ€é¡µé¢æ ·å¼ */
        .status-content {
            flex: 1;
            padding: 20px 15px 60px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 2;
            position: relative;
            overflow-y: auto;
        }

        /* è®¾ç½®èœå•æŒ‰é’® */
        .settings-menu-btn {
            position: absolute;
            top: 25px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: var(--section-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 50;
        }

        .settings-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .hamburger-icon .line {
            width: 18px;
            height: 2px;
            background: var(--text-color);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        /* æ¨¡æ€çª—å£åŸºç¡€æ ·å¼ */
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 15000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            border-radius: 0px;
            overflow: hidden;
        }

        /* éŸ³æ¨‚è¨­ç½®æ¨¡æ…‹çª—å£ç‰¹æ®Šæ¨£å¼ - é€æ˜èƒŒæ™¯ */
        #musicSettingsModal {
            background: transparent !important;
            backdrop-filter: none !important;
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }

        #musicSettingsModal.show {
            background: transparent !important;
            backdrop-filter: none !important;
        }

        /* éŸ³æ¨‚è¨­ç½®æ¨¡æ…‹çª—å£å‹•ç•«å„ªåŒ– */
        #musicSettingsModal .modal-content {
            transform: scale(0.7) translateY(30px) !important;
            opacity: 0 !important;
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }

        #musicSettingsModal.show .modal-content {
            transform: scale(1) translateY(0) !important;
            opacity: 1 !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25) !important;
        }

        /* æ¨™ç±¤é æ¨£å¼å„ªåŒ– */
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.7) !important;
            color: #333333 !important;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ–‡ä»¶ä¸Šå‚³å€åŸŸæ¨£å¼ */
        #uploadArea:hover {
            border-color: rgba(0, 0, 0, 0.5) !important;
            background: rgba(255, 255, 255, 0.7) !important;
        }

        #uploadArea.dragover {
            border-color: #4CAF50 !important;
            background: rgba(76, 175, 80, 0.1) !important;
        }


        .modal.show {
            display: flex;
            opacity: 1;
            border-radius: 40px;
        }

        .modal-content {
            background: transparent;
            backdrop-filter: none;
            border-radius: 24px;
            width: 100%;
            height: 100%;
            border: none;
            box-shadow: none;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .modal.show .modal-content {
            transform: scale(1);
            border-radius: 0;
        }

        .modal-header {
            background: rgba(255, 105, 180, 0.2);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-icon {
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .modal-placeholder {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            color: var(--text-color);
            font-size: 14px;
            opacity: 0.7;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        /* æ—¥ç¨‹è¡¨æ¨¡æ€æ¡†ç‰¹æ®Šæ ·å¼ */
        #scheduleModal {
            border-radius: 0 !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 15000 !important;
        }
        
        #scheduleModal .modal-content {
            transform: none !important;
            border-radius: 15px !important;
            width: 350px !important;
            max-width: 350px !important;
            height: auto !important;
            min-height: 200px !important;
            max-height: 400px !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            margin: 0 !important;
        }

        /* æµ®å‹•é—œé–‰æŒ‰éˆ• */
        .floating-close-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(231, 76, 60, 0.9);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .floating-close-btn:hover {
            background: rgba(231, 76, 60, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .settings-header {
            background: var(--section-bg);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-settings:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .settings-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 0 20px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: rgba(255, 105, 180, 0.3);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-tip {
            background: rgba(255, 107, 157, 0.1);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 107, 157, 0.3);
        }

        .setting-group {
            margin-bottom: 24px;
        }

        .setting-group label {
            display: block;
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .color-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: white;
        }

        .color-option.active {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #e55a5a;
            transform: translateY(-2px);
        }

        /* ä¸»é¢˜æŒ‰é’®æ ·å¼ */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .theme-btn {
            background: var(--section-bg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .theme-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 105, 180, 0.5);
        }

        .theme-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .theme-name {
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
        }

        /* è‡ªå®šä¹‰è¾“å…¥æ¡†æ ·å¼ */
        .custom-inputs {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
        }

        .input-group input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 13px;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .input-group input:focus {
            outline: none;
            border-color: rgba(255, 105, 180, 0.5);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.3);
        }

        .input-group input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group input:enabled {
            cursor: text;
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* èƒŒæ™¯è¨­ç½®æ¨£å¼ */
        .background-options {
            margin-top: 10px;
        }

        .background-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .background-tab {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .background-tab.active {
            background: rgba(255, 105, 180, 0.3);
            border-color: rgba(255, 105, 180, 0.5);
        }

        .background-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .background-content {
            margin-bottom: 15px;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area:hover {
            border-color: rgba(255, 105, 180, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .upload-text {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
        }

        .url-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .url-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 13px;
        }

        .url-input:focus {
            outline: none;
            border-color: rgba(255, 105, 180, 0.5);
        }

        .url-test-btn {
            background: rgba(255, 105, 180, 0.3);
            border: 1px solid rgba(255, 105, 180, 0.5);
            border-radius: 8px;
            padding: 10px 16px;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .url-test-btn:hover {
            background: rgba(255, 105, 180, 0.4);
        }

        /* é ­åƒè¨­ç½®æ¨£å¼ */
        .avatar-options {
            margin-top: 10px;
        }

        .avatar-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .avatar-tab {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-tab.active {
            background: rgba(255, 105, 180, 0.3);
            border-color: rgba(255, 105, 180, 0.5);
        }

        .avatar-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .avatar-content {
            margin-bottom: 15px;
        }

        .avatar-preview {
            margin-top: 15px;
            text-align: center;
        }

        .avatar-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 50%;
            border: 3px solid rgba(255, 105, 180, 0.3);
            margin-bottom: 10px;
        }

        .current-avatar {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .current-avatar-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .current-avatar-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-avatar-info span {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
        }

        /* éšŠå‹é ­åƒè¨­ç½®æ¨£å¼ */
        .teammate-avatar-options {
            margin-top: 10px;
        }

        .teammate-avatar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .teammate-avatar-title {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
        }

        .add-teammate-btn {
            background: rgba(255, 105, 180, 0.3);
            border: 1px solid rgba(255, 105, 180, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-teammate-btn:hover {
            background: rgba(255, 105, 180, 0.4);
        }

        .add-icon {
            font-size: 16px;
            font-weight: bold;
        }

        .teammate-avatar-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .no-teammates {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-align: center;
            padding: 20px;
        }

        .teammate-avatar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .teammate-avatar-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .teammate-avatar-info {
            flex: 1;
        }

        .teammate-avatar-name {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .teammate-avatar-tag {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
        }

        .teammate-avatar-actions {
            display: flex;
            gap: 5px;
        }

        .teammate-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: #ffffff;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .teammate-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .teammate-action-btn.delete {
            background: rgba(244, 67, 54, 0.3);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .teammate-action-btn.delete:hover {
            background: rgba(244, 67, 54, 0.4);
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(255, 105, 180, 0.5);
        }

        .teammate-avatar-upload {
            margin-top: 5px;
        }

        .teammate-avatar-preview {
            margin-top: 10px;
            text-align: center;
        }

        .teammate-avatar-preview img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 50%;
            border: 2px solid rgba(255, 105, 180, 0.3);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-save {
            background: rgba(76, 175, 80, 0.3);
            color: #ffffff;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .btn-save:hover {
            background: rgba(76, 175, 80, 0.4);
        }

        .url-test-btn:hover {
            background: rgba(255, 105, 180, 0.4);
        }

        .background-preview, .url-preview {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 15px;
        }

        .background-preview img, .url-preview img {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .preview-btn.apply-btn {
            background: rgba(76, 175, 80, 0.3);
            color: #ffffff;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .preview-btn.apply-btn:hover {
            background: rgba(76, 175, 80, 0.4);
        }

        .preview-btn.remove-btn {
            background: rgba(244, 67, 54, 0.3);
            color: #ffffff;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .preview-btn.remove-btn:hover {
            background: rgba(244, 67, 54, 0.4);
        }

        .current-background {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 15px;
        }

        .current-bg-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .current-bg-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-bg-info span {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
        }

        .remove-current-btn {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 6px;
            padding: 6px 12px;
            color: #ffffff;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-current-btn:hover {
            background: rgba(244, 67, 54, 0.4);
        }

        /* ç¡®ä¿è¾“å…¥æ¡†åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½å¯ä»¥äº¤äº’ */
        .settings-content .input-group input {
            pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            cursor: text !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 10000 !important;
        }

        /* ç¡®ä¿è®¾ç½®å†…å®¹åŒºåŸŸå¯ä»¥äº¤äº’ */
        .settings-content {
            pointer-events: auto !important;
        }

        /* ç¡®ä¿è¾“å…¥ç»„å¯ä»¥äº¤äº’ */
        .input-group {
            pointer-events: auto !important;
        }

        /* ç¡®ä¿è®¾ç½®é¢æ¿å†…å®¹å¯ä»¥äº¤äº’ */
        .settings-content {
            pointer-events: auto !important;
        }

        /* ç¡®ä¿è¾“å…¥ç»„å¯ä»¥äº¤äº’ */
        .input-group {
            pointer-events: auto !important;
        }

        .apply-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        /* é¡¶éƒ¨çŠ¶æ€å¡ç‰‡ */
        .top-status-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 50px;
        }

        /* åº•éƒ¨æ—¥ç¨‹è¡¨ */
        .bottom-schedule {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* ä¸»è§’ä¿¡æ¯åŒºåŸŸ */
        .custom-info-section {
            background: var(--section-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .custom-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .custom-title {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }

        /* æ—¥ç¨‹å›¾æ ‡ */
        .schedule-icon-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            z-index: 20;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .schedule-icon-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
        }

        .schedule-icon-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .main-custom-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .custom-avatar {
            position: relative;
            margin-bottom: 16px;
        }

        .custom-avatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid rgba(255, 105, 180, 0.8);
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.4);
            object-fit: cover;
            object-position: center;
        }

        .avatar-glow {
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff69b4, #ff1493, #ff69b4);
            opacity: 0.3;
            animation: avatarPulse 3s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.6; }
        }

        @keyframes musicRotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .custom-name {
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .custom-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .custom-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-btn.pending {
            background: linear-gradient(135deg, #ffd700, #ffa500);
            color: white;
        }

        .custom-btn.level {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        .custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .custom-action {
            color: var(--text-color);
            font-size: 12px;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 12px;
            border-left: 3px solid rgba(255, 105, 180, 0.8);
        }

        /* é˜Ÿå‹é€‰æ‹©åŒºåŸŸ */
        .teammates-section {
            margin-bottom: 8px;
        }

        .teammates-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .teammate-btn {
            background: var(--section-bg);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .teammate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }

        .teammate-btn:hover::before {
            left: 100%;
        }

        .teammate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 105, 180, 0.5);
        }

        /* ä¸åŒé˜Ÿå‹çš„é¢œè‰²æ ‡è¯† */
        .teammate-btn[data-teammate="A"] .teammate-label {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
        }

        .teammate-btn[data-teammate="B"] .teammate-label {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .teammate-btn[data-teammate="C"] .teammate-label {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .teammate-btn[data-teammate="D"] .teammate-label {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
        }

        .teammate-label {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 50%;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
        }

        .teammate-name {
            color: var(--text-color);
            font-size: 12px;
            font-weight: 500;
        }

        .status-card {
            background: var(--section-bg);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }

        .status-card:hover::before {
            left: 100%;
        }

        .schedule-card {
            cursor: pointer;
        }

        .schedule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
            color: var(--text-color);
        }

        .card-decoration {
            font-size: 16px;
            opacity: 0.8;
        }

        .datetime-info, .location-info {
            font-size: 13px;
            font-weight: 500;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
        }

        /* åˆ é™¤ä¸å†ä½¿ç”¨çš„æŠ˜å ç›¸å…³æ ·å¼ */
        /* .toggle-icon, .schedule-content, .schedule-content.expanded ç­‰æ ·å¼å·²ç§»é™¤ */

        .schedule-section {
            margin-bottom: 16px;
        }

        .schedule-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            color: #337690;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 2px;
            margin-right: 8px;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            padding: 6px 0;
        }

        .time-slot {
            color: #000000;
            font-size: 11px;
            font-weight: 500;
            min-width: 70px;
            background: rgba(255, 182, 193, 0.2);
            padding: 3px 6px;
            border-radius: 6px;
            text-align: center;
        }

        .activity {
            color: var(--text-color);
            font-size: 11px;
            flex: 1;
        }

        .status-tag {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 9px;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .status-tag.ongoing {
            background: rgba(255, 193, 7, 0.3);
            color: #804c03;
            border-color: rgba(255, 193, 7, 0.5);
        }

        .important-event {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .event-date {
            color: #621621;
            font-size: 10px;
            margin-bottom: 3px;
        }

        .event-title {
            color: var(--text-color);
            font-size: 11px;
            font-weight: 500;
        }

        .highlight {
            color: #ba2929;
            font-weight: 600;
        }

        /* é˜Ÿå‹ä¿¡æ¯å¼¹çª— */
        .teammate-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            border-radius: 40px;
            overflow: hidden;
        }

        .teammate-modal.show {
            display: flex;
            opacity: 1;
        }

        .teammate-modal-content {
            background: var(--section-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 90%;
            max-width: 320px;
            max-height: 80%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .teammate-modal.show .teammate-modal-content {
            transform: scale(1);
        }

        .teammate-modal-header {
            background: rgba(255, 105, 180, 0.2);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .teammate-avatar-small img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 105, 180, 0.8);
            object-fit: cover;
            object-position: center;
        }

        .teammate-modal-title {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .teammate-role {
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            line-height: 1.2;
        }

        .teammate-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .teammate-tag {
            background: rgba(255, 105, 180, 0.2);
            color: var(--text-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid rgba(255, 105, 180, 0.3);
        }

        .teammate-location {
            color: var(--text-color);
            font-size: 12px;
            opacity: 0.8;
        }

        .teammate-level {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .close-teammate-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-teammate-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .teammate-modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .teammate-info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-left: 12px;
            border-left: 3px solid rgba(255, 105, 180, 0.5);
        }

        .info-label {
            color: #87CEEB;
            font-size: 13px;
            font-weight: 600;
            min-width: 60px;
            margin-right: 12px;
        }

        .info-value {
            color: var(--text-color);
            font-size: 13px;
            line-height: 1.4;
            flex: 1;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .status-content::-webkit-scrollbar,
        .teammate-modal-body::-webkit-scrollbar,
        .modal-body::-webkit-scrollbar {
            width: 4px;
        }

        .status-content::-webkit-scrollbar-track,
        .teammate-modal-body::-webkit-scrollbar-track,
        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .status-content::-webkit-scrollbar-thumb,
        .teammate-modal-body::-webkit-scrollbar-thumb,
        .modal-body::-webkit-scrollbar-thumb {
            background: var(--scrollbar-color);
            border-radius: 2px;
        }

        .status-content::-webkit-scrollbar-thumb:hover,
        .teammate-modal-body::-webkit-scrollbar-thumb:hover,
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-color);
            opacity: 0.8;
        }

        /* ç¬¬äºŒé¡µæ ·å¼ */
        .page-two {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.3)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.25)"/><circle cx="70" cy="70" r="1" fill="rgba(255,255,255,0.2)"/></svg>') repeat;
        }

        .page-two::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(106,90,205,0.3) 0%, rgba(72,61,139,0.2) 100%);
            z-index: 1;
        }



        .header {
            padding: 25px 20px 10px;
            text-align: center;
            z-index: 2;
            position: relative;
        }

        .header-time {
            background: rgba(255,255,255,0.2);
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 13px;
            color: #fff;
            display: inline-block;
            margin-top: 25px;
            margin-bottom: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .app-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(255,107,107,0.3);
        }

        .app-subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
        }

        .nav-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 30px 40px;
            z-index: 2;
            position: relative;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 320px;
            grid-template-rows: repeat(3, 1fr);
        }



        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 110px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .nav-button:hover::before {
            left: 100%;
        }

        .nav-button:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border-color: rgba(255,107,107,0.5);
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(255,107,107,0.3);
        }

        .nav-icon svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        .nav-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .nav-description {
            font-size: 10px;
            color: #666;
            text-align: center;
            line-height: 1.3;
        }



















        .notification {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,107,107,0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(255,107,107,0.3);
        }

        .notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(10px);
        }



        @media (max-width: 400px) {
            .phone-frame {
                width: min(350px, 98vw);
                height: min(620px, 98vh);
                min-width: 280px;
                min-height: 450px;
            }
            
            .nav-button {
                height: 100px;
            }
            
            .nav-grid {
                gap: 10px;
            }



            .nav-container {
                padding: 10px 15px 25px;
            }
            
            .nav-icon {
                width: 36px;
                height: 36px;
            }
            
            .nav-icon svg {
                width: 20px;
                height: 20px;
            }

            .nav-label {
                font-size: 13px;
            }

            .nav-description {
                font-size: 9px;
            }

            .status-content {
                padding: 15px 12px 50px;
                gap: 12px;
            }

            .settings-menu-btn {
                top: 10px;
                left: 10px;
                width: 35px;
                height: 35px;
            }

            .hamburger-icon .line {
                width: 16px;
            }

            .settings-header {
                padding: 16px;
            }

            .settings-header h3 {
                font-size: 16px;
            }

            .settings-content {
                padding: 16px;
            }

            .settings-tip {
                padding: 8px 12px;
                font-size: 11px;
                margin-bottom: 16px;
            }

            .setting-group {
                margin-bottom: 20px;
            }

            .setting-group label {
                font-size: 13px;
                margin-bottom: 10px;
            }

            .color-option {
                width: 35px;
                height: 35px;
            }

            .color-options {
                gap: 10px;
            }

            .top-status-cards {
                gap: 6px;
            }

            .custom-info-section {
                padding: 16px;
            }

            .custom-title {
                font-size: 16px;
            }

            .custom-avatar img {
                width: 80px;
                height: 80px;
            }

            .custom-name {
                font-size: 14px;
            }

            .custom-action {
                font-size: 11px;
                padding: 10px;
            }
        }

        /* ğŸ”¥ æ–°å¢ï¼šé‡å°æ›´å°å±å¹•çš„å„ªåŒ– */
        @media (max-width: 360px) {
            .phone-frame {
                width: 98vw;
                height: 98vh;
                min-width: 260px;
                min-height: 400px;
                border-radius: 24px;
            }
            

            
            .phone-homebar {
                width: 100px;
                height: 4px;
                bottom: 12px;
            }
            
            .nav-container {
                padding: 8px 12px 20px;
            }
            
            .nav-button {
                height: 80px;
            }
            
            .nav-icon {
                width: 32px;
                height: 32px;
            }
            
            .nav-label {
                font-size: 12px;
            }
            
            .nav-description {
                font-size: 8px;
            }
        }
        
        /* éŸ³æ¨‚åˆ—è¡¨æ¨£å¼ */
        .music-item:hover {
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 215, 0, 0.3) !important;
        }
        
        .music-item .music-actions button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .music-item .music-actions button:active {
            transform: scale(0.98);
        }
        
        /* éŸ³æ¨‚é …ç›®é»æ“Šæ•ˆæœ */
        .music-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 215, 0, 0.3);
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a) !important;
        }
        
        .music-item:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* æ·»åŠ éŸ³æ¨‚æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
        .music-list-section h4 button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, #FFA500, #FF8C00) !important;
        }
        
        .music-list-section h4 button:active {
            transform: scale(0.95);
        }
        
        #musicList::-webkit-scrollbar {
            width: 6px;
        }
        
        #musicList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #musicList::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #musicList::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .music-add-btn:hover,
        .music-test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .music-add-btn:active,
        .music-test-btn:active {
            transform: translateY(0);
        }
        
        /* è¼¸å…¥æ¡†ç„¦é»æ•ˆæœ */
        #musicNameInput:focus,
        #musicUrlInput:focus,
        #addMusicNameInput:focus,
        #addMusicUrlInput:focus {
            outline: none;
            border-color: #FFD700 !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), inset 0 2px 5px rgba(0, 0, 0, 0.2) !important;
            background: rgba(0, 0, 0, 0.5) !important;
        }
        
        /* éŸ³æ¨‚åˆ—è¡¨æ»¾å‹•æ¢æ¨£å¼ */
        #musicList::-webkit-scrollbar {
            width: 8px;
        }
        
        #musicList::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        #musicList::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 4px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        #musicList::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
        }
    </style>
</head>
<body>
    <!-- æ—¥ç¨‹è¡¨æ¨¡æ€çª—å£ -->
    <div class="modal" id="scheduleModal" style="position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.5) !important; backdrop-filter: blur(10px) !important; z-index: 15000 !important; display: none !important; align-items: center !important; justify-content: center !important; opacity: 0 !important; transition: all 0.3s ease !important; border-radius: 0px !important; overflow: hidden !important;">
        <div class="modal-content" style="transform: none !important; border-radius: 15px !important; width: 350px !important; max-width: 350px !important; height: auto !important; min-height: 200px !important; max-height: 400px !important; background: rgba(255, 255, 255, 0.95) !important; backdrop-filter: blur(10px) !important; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important; position: relative !important; left: 0 !important; top: 0 !important; margin: auto !important;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff6b9d, #e55982) !important; color: white !important; border-radius: 15px 15px 0 0 !important; padding: 12px 15px !important;">
                <div class="modal-title" style="font-size: 16px !important; font-weight: bold !important; color: white !important;">
                    <span class="modal-icon">ğŸ“…</span>
                    æ—¥ç¨‹è¡¨
                </div>
                <button class="close-modal" onclick="closeModal('scheduleModal')" style="position: absolute !important; top: 10px !important; right: 10px !important; width: 30px !important; height: 30px !important; background: rgba(255, 255, 255, 0.2) !important; color: white !important; border: none !important; border-radius: 50% !important; display: flex !important; align-items: center !important; justify-content: center !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important;">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 15px !important; max-height: 300px !important; overflow-y: auto !important; background: white !important;">
                <div class="schedule-section" style="margin-bottom: 20px;">
                    <div class="section-title" style="font-size: 14px !important; font-weight: bold !important; color: #333 !important; margin-bottom: 10px !important; border-bottom: 2px solid #4CAF50 !important; padding-bottom: 5px !important;">ä»Šæ—¥å‰©ä½™è¡Œç¨‹:</div>
                    <div class="schedule-item" style="display: flex !important; align-items: center !important; margin-bottom: 12px !important; padding: 10px !important; background: rgba(76, 175, 80, 0.1) !important; border-radius: 8px !important; border-left: 4px solid #4CAF50 !important;">
                        <div class="time-slot" style="font-size: 12px !important; font-weight: bold !important; color: #4CAF50 !important; min-width: 80px !important; margin-right: 10px !important;">09:00-12:00</div>
                        <div class="activity" style="font-size: 13px !important; color: #333 !important; flex: 1 !important;">å…¨ä½“è§é¢ä¼š <span class="status-tag ongoing" style="font-size: 11px !important; padding: 2px 6px !important; border-radius: 10px !important; margin-left: 5px !important; background: #ff9800 !important; color: white !important;">ï¼ˆè¿›è¡Œä¸­ï¼‰</span></div>
                    </div>
                    <div class="schedule-item" style="display: flex !important; align-items: center !important; margin-bottom: 12px !important; padding: 10px !important; background: rgba(76, 175, 80, 0.1) !important; border-radius: 8px !important; border-left: 4px solid #4CAF50 !important;">
                        <div class="time-slot" style="font-size: 12px !important; font-weight: bold !important; color: #4CAF50 !important; min-width: 80px !important; margin-right: 10px !important;">14:00-17:00</div>
                        <div class="activity" style="font-size: 13px !important; color: #333 !important; flex: 1 !important;">å¯¼å¸ˆç¤ºèŒƒè¡¨æ¼”</div>
                    </div>
                    <div class="schedule-item" style="display: flex !important; align-items: center !important; margin-bottom: 12px !important; padding: 10px !important; background: rgba(76, 175, 80, 0.1) !important; border-radius: 8px !important; border-left: 4px solid #4CAF50 !important;">
                        <div class="time-slot" style="font-size: 12px !important; font-weight: bold !important; color: #4CAF50 !important; min-width: 80px !important; margin-right: 10px !important;">19:00-21:00</div>
                        <div class="activity" style="font-size: 13px !important; color: #333 !important; flex: 1 !important;">å…¬å¸ç»„æ’ç»ƒ</div>
                    </div>
                </div>

                <div class="schedule-section" style="margin-bottom: 20px;">
                    <div class="section-title" style="font-size: 14px !important; font-weight: bold !important; color: #333 !important; margin-bottom: 10px !important; border-bottom: 2px solid #4CAF50 !important; padding-bottom: 5px !important;">è¿‘æœŸé‡è¦å®‰æ’:</div>
                    <div class="important-event" style="background: rgba(255, 193, 7, 0.1) !important; border: 2px solid #ffc107 !important; border-radius: 10px !important; padding: 15px !important; margin-top: 10px !important;">
                        <div class="event-date" style="font-size: 12px !important; color: #ff9800 !important; font-weight: bold !important; margin-bottom: 5px !important;">2025å¹´6æœˆ11æ—¥</div>
                        <div class="event-title" style="font-size: 14px !important; color: #333 !important; font-weight: bold !important;">åˆè¯„çº§å½•åˆ¶ <span class="highlight" style="color: #ff9800 !important; font-weight: bold !important;">ï¼ˆå‡†å¤‡ä¸­ï¼‰</span> âœ¨</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="phone-frame">
        <div class="phone-container">
            <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
            <div class="music-control-btn" id="musicControlBtn" style="position: absolute; top: 20px; right: 20px; width: 45px; height: 45px; background: rgba(255, 107, 157, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9999; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3); border: 2px solid white; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; touch-action: manipulation;" title="å–®æ“Šæ’­æ”¾/æš«åœï¼Œé›™æ“Šåˆ‡æ›éŸ³æ¨‚ï¼Œé•·æŒ‰è¨­ç½®">
                <img src="https://files.catbox.moe/b2bgvm.png" alt="éŸ³æ¨‚" class="music-icon" id="musicIcon" style="width: 20px; height: 20px; transition: transform 0.3s ease; pointer-events: none; filter: brightness(0) invert(1);">
            </div>
            


            <div class="swipe-container">
                <div class="swipe-wrapper" id="swipeWrapper">
                    <!-- æ–°é¡µé¢ - ç©ºå®¹å™¨ -->
                    <div class="swipe-slide page-new">

                        
                        <div class="new-page-content" style="position: relative; overflow: hidden;">
                            <iframe id="vnPanelIframe" src="about:blank" style="width: 400px; height: 400px; max-width: 90%; border: none; border-radius: 40px; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); will-change: transform, width, height; z-index: 10;"></iframe>
                        </div>
                    </div>

                    <!-- ç¬¬ä¸€é¡µ - çŠ¶æ€é¡µé¢ -->
                    <div class="swipe-slide page-one">

                        
                        <div class="status-content">
                            <!-- è®¾ç½®èœå•æŒ‰é’® -->
                            <div class="settings-menu-btn" onclick="toggleSettingsMenu()">
                                <div class="hamburger-icon">
                                    <div class="line"></div>
                                    <div class="line"></div>
                                    <div class="line"></div>
                                </div>
                            </div>



                            <!-- é¡¶éƒ¨çŠ¶æ€ä¿¡æ¯ -->
                            <div class="top-status-cards">
                                <!-- æ—¥æœŸæ—¶é—´ä¿¡æ¯ -->
                                <div class="status-card datetime-card">
                                    <div class="card-icon">ğŸ“…</div>
                                    <div class="card-content">
                                        <div class="datetime-info">2025-06-26|08:15</div>
                                    </div>

                                </div>

                                <!-- å½•åˆ¶åŒºåŸŸä¿¡æ¯ -->
                                <div class="status-card location-card">
                                    <div class="card-icon">ğŸ </div>
                                    <div class="card-content">
                                        <div class="location-info">AREA_D_DAY | ç¶­æ–¯é “è±ªå®…_é»æ˜‚è‡¥å®¤</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ä¸»è§’ä¿¡æ¯åŒºåŸŸ -->
                            <div class="custom-info-section">
                                <div class="custom-header">
                                    <div class="custom-title" id="projectTitle">é¡¹ç›®ä¿¡æ¯</div>
                                    <button class="schedule-icon-btn" onclick="openScheduleModal()">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="main-custom-card">
                                    <div class="custom-avatar">
                                        <img src="https://files.catbox.moe/ew2nex.png" alt="ä¸»è§’å¤´åƒ" />
                                        <div class="avatar-glow"></div>
                                    </div>
                                    
                                    <div class="custom-name" id="userName">ç”¨æˆ·å</div>
                                    
                                    <div class="custom-buttons">
                                        <button class="custom-btn pending" id="statusBtn">â­ åè²å¾…å®š</button>
                                        <button class="custom-btn level" id="levelBtn">å¾…å®šçº§</button>
                                    </div>
                                    
                                    <div class="custom-action" id="userAction">
                                        è¿™é‡Œæ˜¯Action
                                    </div>
                                </div>
                            </div>

                            <!-- è§’è‰²åé€‰æ‹©åŒºåŸŸ -->
                            <div class="teammates-section">
                                <div class="teammates-grid">
                                    <button class="teammate-btn" onclick="showTeammateInfo('A')" data-teammate="A">
                                        <div class="teammate-label">A</div>
                                        <div class="teammate-name" id="memberA">è§’è‰²åA</div>
                                    </button>
                                    <button class="teammate-btn" onclick="showTeammateInfo('B')" data-teammate="B">
                                        <div class="teammate-label">B</div>
                                        <div class="teammate-name" id="memberB">è§’è‰²åB</div>
                                    </button>
                                    <button class="teammate-btn" onclick="showTeammateInfo('C')" data-teammate="C">
                                        <div class="teammate-label">C</div>
                                        <div class="teammate-name" id="memberC">è§’è‰²åC</div>
                                    </button>
                                    <button class="teammate-btn" onclick="showTeammateInfo('D')" data-teammate="D">
                                        <div class="teammate-label">D</div>
                                        <div class="teammate-name" id="memberD">è§’è‰²åD</div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- è®¾ç½®èœå•é¢æ¿ -->
                        <div class="settings-panel" id="settingsPanel">
                            <div class="settings-header">
                                <h3>è®¾ç½®é¢æ¿</h3>
                                <button class="close-settings" onclick="toggleSettingsMenu()">Ã—</button>
                            </div>
                            
                            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                            <div class="settings-tabs">
                                <button class="tab-btn active" onclick="switchTab('style')">æ ·å¼è®¾ç½®</button>
                                <button class="tab-btn" onclick="switchTab('name')">åç§°å¥—ç”¨</button>
                            </div>
                            
                            <!-- æ ·å¼è®¾ç½®æ ‡ç­¾é¡µ -->
                            <div class="settings-content" id="styleTab" style="display: block;">
                                <div class="settings-tip">
                                    ğŸ’¡ é¢œè‰²è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°
                                </div>
                                
                                <div class="setting-group">
                                    <label>å®¹å™¨é¢œè‰²</label>
                                    <div class="color-options">
                                        <div class="color-option" data-container="pink" style="background: #FFB6C1;" onclick="changeContainerColor('pink')"></div>
                                        <div class="color-option" data-container="blue" style="background: #87CEEB;" onclick="changeContainerColor('blue')"></div>
                                        <div class="color-option" data-container="purple" style="background: #DDA0DD;" onclick="changeContainerColor('purple')"></div>
                                        <div class="color-option" data-container="green" style="background: #98FB98;" onclick="changeContainerColor('green')"></div>
                                        <div class="color-option" data-container="orange" style="background: #FFA07A;" onclick="changeContainerColor('orange')"></div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>èƒŒæ™¯è¨­ç½®</label>
                                    <div class="background-options">
                                        <div class="background-tabs">
                                            <button class="background-tab active" onclick="switchBackgroundTab('upload')">ä¸Šå‚³åœ–ç‰‡</button>
                                            <button class="background-tab" onclick="switchBackgroundTab('url')">URLè¼¸å…¥</button>
                                        </div>
                                        
                                        <!-- ä¸Šå‚³åœ–ç‰‡æ¨¡å¼ -->
                                        <div class="background-content" id="uploadBackgroundTab">
                                            <div class="upload-area" onclick="document.getElementById('backgroundFileInput').click()">
                                                <div class="upload-icon">ğŸ“</div>
                                                <div class="upload-text">é»æ“Šé¸æ“‡åœ–ç‰‡</div>
                                                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼</div>
                                            </div>
                                            <input type="file" id="backgroundFileInput" accept="image/*" style="display: none;" onchange="handleBackgroundFileUpload(event)">
                                            
                                            <div class="background-preview" id="backgroundPreview" style="display: none;">
                                                <img id="previewImage" src="" alt="èƒŒæ™¯é è¦½">
                                                <div class="preview-actions">
                                                    <button class="preview-btn apply-btn" onclick="applyBackgroundImage()">æ‡‰ç”¨èƒŒæ™¯</button>
                                                    <button class="preview-btn remove-btn" onclick="removeBackgroundImage()">ç§»é™¤èƒŒæ™¯</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- URLè¼¸å…¥æ¨¡å¼ -->
                                        <div class="background-content" id="urlBackgroundTab" style="display: none;">
                                            <div class="url-input-group">
                                                <input type="url" id="backgroundUrlInput" placeholder="è¼¸å…¥åœ–ç‰‡URLåœ°å€..." class="url-input">
                                                <button class="url-test-btn" onclick="testBackgroundUrl()">æ¸¬è©¦</button>
                                            </div>
                                            <div class="url-preview" id="urlPreview" style="display: none;">
                                                <img id="urlPreviewImage" src="" alt="URLé è¦½">
                                                <div class="preview-actions">
                                                    <button class="preview-btn apply-btn" onclick="applyUrlBackground()">æ‡‰ç”¨èƒŒæ™¯</button>
                                                    <button class="preview-btn remove-btn" onclick="removeBackgroundImage()">ç§»é™¤èƒŒæ™¯</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- ç•¶å‰èƒŒæ™¯é¡¯ç¤º -->
                                        <div class="current-background" id="currentBackground" style="display: none;">
                                            <div class="current-bg-label">ç•¶å‰èƒŒæ™¯:</div>
                                            <div class="current-bg-info">
                                                <span id="currentBgName">æœªè¨­ç½®</span>
                                                <button class="remove-current-btn" onclick="removeBackgroundImage()">ç§»é™¤</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>ä¸»è§’é ­åƒè¨­ç½®</label>
                                    <div class="avatar-options">
                                        <div class="avatar-tabs">
                                            <button class="avatar-tab active" onclick="switchAvatarTab('upload')">ä¸Šå‚³é ­åƒ</button>
                                            <button class="avatar-tab" onclick="switchAvatarTab('url')">URLè¼¸å…¥</button>
                                        </div>
                                        
                                        <!-- ä¸Šå‚³é ­åƒæ¨¡å¼ -->
                                        <div class="avatar-content" id="uploadAvatarTab">
                                            <div class="upload-area" onclick="document.getElementById('avatarFileInput').click()">
                                                <div class="upload-icon">ğŸ‘¤</div>
                                                <div class="upload-text">é»æ“Šé¸æ“‡ä¸»è§’é ­åƒ</div>
                                                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼</div>
                                            </div>
                                            <input type="file" id="avatarFileInput" accept="image/*" style="display: none;" onchange="handleAvatarFileUpload(event)">
                                            
                                            <div class="avatar-preview" id="avatarPreview" style="display: none;">
                                                                                                 <img id="previewAvatar" src="" alt="ä¸»è§’é ­åƒé è¦½">
                                                <div class="preview-actions">
                                                                                                         <button class="preview-btn apply-btn" onclick="applyAvatarImage()">æ‡‰ç”¨ä¸»è§’é ­åƒ</button>
                                                    <button class="preview-btn remove-btn" onclick="removeAvatarImage()">ç§»é™¤é ­åƒ</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- URLè¼¸å…¥æ¨¡å¼ -->
                                        <div class="avatar-content" id="urlAvatarTab" style="display: none;">
                                            <div class="url-input-group">
                                                                                                 <input type="url" id="avatarUrlInput" placeholder="è¼¸å…¥ä¸»è§’é ­åƒURLåœ°å€..." class="url-input">
                                                <button class="url-test-btn" onclick="testAvatarUrl()">æ¸¬è©¦</button>
                                            </div>
                                            <div class="url-preview" id="urlAvatarPreview" style="display: none;">
                                                                                                 <img id="urlPreviewAvatar" src="" alt="URLä¸»è§’é ­åƒé è¦½">
                                                <div class="preview-actions">
                                                                                                         <button class="preview-btn apply-btn" onclick="applyUrlAvatar()">æ‡‰ç”¨ä¸»è§’é ­åƒ</button>
                                                    <button class="preview-btn remove-btn" onclick="removeAvatarImage()">ç§»é™¤é ­åƒ</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- ç•¶å‰é ­åƒé¡¯ç¤º -->
                                        <div class="current-avatar" id="currentAvatar" style="display: none;">
                                                                                         <div class="current-avatar-label">ç•¶å‰ä¸»è§’é ­åƒ:</div>
                                            <div class="current-avatar-info">
                                                <span id="currentAvatarName">æœªè¨­ç½®</span>
                                                <button class="remove-current-btn" onclick="removeAvatarImage()">ç§»é™¤</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>éšŠå‹é ­åƒè¨­ç½®</label>
                                    <div class="teammate-avatar-options">
                                        <div class="teammate-avatar-header">
                                            <div class="teammate-avatar-title">è§’è‰²é ­åƒåº«</div>
                                            <button class="add-teammate-btn" onclick="openAddTeammateModal()">
                                                <span class="add-icon">+</span>
                                                æ·»åŠ è§’è‰²
                                            </button>
                                        </div>
                                        
                                        <div class="teammate-avatar-list" id="teammateAvatarList">
                                            <!-- å‹•æ…‹ç”Ÿæˆçš„éšŠå‹é ­åƒåˆ—è¡¨ -->
                                            <div class="no-teammates">æš«ç„¡è§’è‰²é ­åƒï¼Œè«‹é»æ“Š"æ·»åŠ è§’è‰²"é–‹å§‹</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>æ ç›®é¢œè‰²</label>
                                    <div class="color-options">
                                        <div class="color-option" data-section="light" style="background: #F5F5DC;" onclick="changeSectionColor('light')"></div>
                                        <div class="color-option" data-section="white" style="background: #FFFFFF;" onclick="changeSectionColor('white')"></div>
                                        <div class="color-option" data-section="cream" style="background: #FFF8DC;" onclick="changeSectionColor('cream')"></div>
                                        <div class="color-option" data-section="lavender" style="background: #E6E6FA;" onclick="changeSectionColor('lavender')"></div>
                                        <div class="color-option" data-section="mint" style="background: #F0FFF0;" onclick="changeSectionColor('mint')"></div>
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <label>å­—ä½“é¢œè‰²</label>
                                    <div class="color-options">
                                        <div class="color-option" data-text="dark" style="background: #333333;" onclick="changeTextColor('dark')"></div>
                                        <div class="color-option" data-text="white" style="background: #FFFFFF; border: 1px solid #ccc;" onclick="changeTextColor('white')"></div>
                                        <div class="color-option" data-text="purple" style="background: #663399;" onclick="changeTextColor('purple')"></div>
                                        <div class="color-option" data-text="blue" style="background: #4169E1;" onclick="changeTextColor('blue')"></div>
                                        <div class="color-option" data-text="pink" style="background: #FF69B4;" onclick="changeTextColor('pink')"></div>
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <button class="reset-btn" onclick="resetToDefault()">æ¢å¤é»˜è®¤</button>
                                </div>
                            </div>
                            
                            <!-- åç§°å¥—ç”¨æ ‡ç­¾é¡µ -->
                            <div class="settings-content" id="nameTab" style="display: none;">
                                <div class="settings-tip">
                                    ğŸ¯ é€‰æ‹©é¢„è®¾ä¸»é¢˜å¿«é€Ÿå¥—ç”¨åç§°è®¾ç½®
                                </div>
                                
                                <div class="setting-group">
                                    <label>é¢„è®¾ä¸»é¢˜</label>
                                    <div class="theme-options">
                                        <button class="theme-btn" onclick="applyTheme('custom')">
                                            <div class="theme-icon">â­</div>
                                            <div class="theme-name">å¶åƒç‰ˆæœ¬</div>
                                        </button>
                                        <button class="theme-btn" onclick="applyTheme('gaming')">
                                            <div class="theme-icon">ğŸ®</div>
                                            <div class="theme-name">ç”µç«ç‰ˆæœ¬</div>
                                        </button>
                                        <button class="theme-btn" onclick="applyTheme('business')">
                                            <div class="theme-icon">ğŸ’¼</div>
                                            <div class="theme-name">å•†åŠ¡ç‰ˆæœ¬</div>
                                        </button>
                                        <button class="theme-btn" onclick="applyTheme('school')">
                                            <div class="theme-icon">ğŸ“š</div>
                                            <div class="theme-name">å­¦æ ¡ç‰ˆæœ¬</div>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>è‡ªå®šä¹‰è®¾ç½®</label>
                                    <div class="custom-inputs">
                                        <div class="input-group">
                                            <label>ä¸»æ ‡é¢˜</label>
                                            <input type="text" id="customTitle" placeholder="è¾“å…¥ä¸»æ ‡é¢˜" value="é€šç”¨é¢æ¿">
                                        </div>
                                        <div class="input-group">
                                            <label>å‰¯æ ‡é¢˜</label>
                                            <input type="text" id="customSubtitle" placeholder="è¾“å…¥å‰¯æ ‡é¢˜" value="å¤šåŠŸèƒ½ç•Œé¢ï¼Œè‡ªå®šä¹‰ä½“éªŒ">
                                        </div>
                                        <div class="input-group">
                                            <label>é¡¹ç›®åç§°</label>
                                            <input type="text" id="customProject" placeholder="è¾“å…¥é¡¹ç›®åç§°" value="é¡¹ç›®ä¿¡æ¯">
                                        </div>

                                    </div>
                                    <button class="apply-btn" onclick="applyCustomSettings()">åº”ç”¨è‡ªå®šä¹‰è®¾ç½®</button>
                                </div>
                            </div>
                        </div>

                        <!-- é˜Ÿå‹ä¿¡æ¯å¼¹çª— -->
                        <div class="teammate-modal" id="teammateModal">
                            <div class="teammate-modal-content">
                                <div class="teammate-modal-header">
                                    <div class="teammate-avatar-small">
                                        <img id="teammateModalAvatar" src="https://i.pravatar.cc/150?img=1" alt="é˜Ÿå‹å¤´åƒ" />
                                    </div>
                                    <div class="teammate-modal-title" id="teammateModalTitle">
                                        <div class="teammate-role">ä¸»èˆ-å‰¯å”±</div>
                                        <div class="teammate-details">
                                            <span class="teammate-tag">#å¾…å®š</span>
                                            <span class="teammate-location">å±…ä½åœ°</span>
                                            <span class="teammate-level">è¯„çº§å¾…å®šçº§</span>
                                        </div>
                                    </div>
                                    <button class="close-teammate-modal" onclick="closeTeammateModal()">Ã—</button>
                                </div>
                                
                                <div class="teammate-modal-body">
                                    <div class="teammate-info-item">
                                        <div class="info-label">tagï¼š</div>
                                        <div class="info-value" id="teammateTag">å†·é™çš„è§‚å¯Ÿè€…</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">å¥½æ„Ÿï¼š</div>
                                        <div class="info-value" id="teammateFavor">5</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">CPå€¼ï¼š</div>
                                        <div class="info-value" id="teammateCP">1</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">çŠ¶æ€ï¼š</div>
                                        <div class="info-value" id="teammateStatus">ç«™åœ¨äººç¾¤ä¸­åæ–¹ï¼Œç›®å…‰å¹³é™åœ°çœ‹ç€è¢«è±çº³æ–¯å¸¦åˆ°å‰æ’çš„Nocturneã€‚</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">å¿ƒæƒ…ï¼š</div>
                                        <div class="info-value" id="teammateMood">ç¤¾äº¤èƒ½åŠ›ä¹Ÿæ˜¯å®åŠ›çš„ä¸€ç§ã€‚ä»–æ¯”çœ‹ä¸Šå»è¦èªæ˜ã€‚</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">ç€è£…ï¼š</div>
                                        <div class="info-value" id="teammateOutfit">é»‘è‰²å®½æ¾ç»ƒèˆè£¤ï¼Œçº¯ç™½Tæ¤ï¼Œå¤´å‘æ‰“ç†å¾—å¹²å‡€åˆ©è½ã€‚</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ·»åŠ è§’è‰²æ¨¡æ…‹çª—å£ -->
                        <div class="modal" id="addTeammateModal">
                            <div class="modal-content" style="width: 400px !important; max-width: 400px !important;">
                                <div class="modal-header">
                                    <div class="modal-title">
                                        <span class="modal-icon">ğŸ‘¥</span>
                                        æ·»åŠ è§’è‰²é ­åƒ
                                    </div>
                                    <button class="close-modal" onclick="closeModal('addTeammateModal')">Ã—</button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="teammateName">è§’è‰²åç¨±:</label>
                                        <input type="text" id="teammateName" placeholder="è¼¸å…¥è§’è‰²åç¨±..." class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label for="teammateTag">è§’è‰²æ¨™ç±¤:</label>
                                        <input type="text" id="teammateTag" placeholder="è¼¸å…¥è§’è‰²æ¨™ç±¤..." class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label>è§’è‰²é ­åƒ:</label>
                                        <div class="teammate-avatar-upload">
                                            <div class="upload-area" onclick="document.getElementById('teammateAvatarFileInput').click()">
                                                <div class="upload-icon">ğŸ‘¤</div>
                                                <div class="upload-text">é»æ“Šé¸æ“‡é ­åƒ</div>
                                                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼</div>
                                            </div>
                                            <input type="file" id="teammateAvatarFileInput" accept="image/*" style="display: none;" onchange="handleTeammateAvatarFileUpload(event)">
                                            
                                            <div class="teammate-avatar-preview" id="teammateAvatarPreview" style="display: none;">
                                                <img id="previewTeammateAvatar" src="" alt="è§’è‰²é ­åƒé è¦½">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn btn-cancel" onclick="closeModal('addTeammateModal')">å–æ¶ˆ</button>
                                        <button class="btn btn-save" onclick="saveTeammateAvatar()">ä¿å­˜è§’è‰²</button>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>

                    <!-- ç¬¬äºŒé¡µ - åŠŸèƒ½é¡µé¢ -->
                    <div class="swipe-slide page-two">
                        <div class="header">
                            <div class="header-time">å‘¨ä¸‰ 14:30</div>
                            <h1 class="app-title" id="mainTitle">é€šç”¨é¢æ¿</h1>
                            <p class="app-subtitle" id="mainSubtitle">å¤šåŠŸèƒ½ç•Œé¢ï¼Œè‡ªå®šä¹‰ä½“éªŒ</p>
                        </div>

                        <div class="nav-container">
                            <div class="nav-grid">
                                <!-- ğŸ“š ä¸–ç•Œæ›¸åŠŸèƒ½ -->
                                <button class="nav-button lorebook" onclick="openLorebookManagerModal()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M21 5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2s2-.89 2-2V7c0-1.11-.89-2-2-2zM3 5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2s2-.89 2-2V7c0-1.11-.89-2-2-2zM12 5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2s2-.89 2-2V7c0-1.11-.89-2-2-2z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">ä¸–ç•Œæ›¸</div>
                                    <div class="nav-description">ä¸–ç•Œè¨­å®š<br>çŸ¥è­˜ç®¡ç†</div>
                                </button>

                                <button class="nav-button map" onclick="openMap()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">åœ°å›¾</div>
                                    <div class="nav-description">åœºåœ°å¯¼èˆª<br>ä½ç½®æŸ¥çœ‹</div>
                                </button>

                                <button class="nav-button anonymous-forum" onclick="openAnonymousForum()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">åŒ¿åè®ºå›</div>
                                    <div class="nav-description">åŒ¿åäº¤æµ<br>è‡ªç”±è®¨è®º</div>
                                </button>

                                <button class="nav-button cp-activity" onclick="openCPActivity()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">CPè¶…æ´»</div>
                                    <div class="nav-description">CPäº’åŠ¨<br>ç”œèœœæ´»åŠ¨</div>
                                </button>

                                <button class="nav-button chat-room" onclick="openChatRoom()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">èŠå¤©å®¤</div>
                                    <div class="nav-description">ç§å¯†èŠå¤©<br>ç»ƒä¹ ç”Ÿä¸“å±</div>
                                </button>

                                <button class="nav-button live-room" onclick="openLiveRoom()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4zM14 13h-3v3H9v-3H6v-2h3V8h2v3h3v2z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">ç›´æ’­é—´</div>
                                    <div class="nav-description">å¼€å¯ç›´æ’­<br>ä¸ç²‰ä¸äº’åŠ¨</div>
                                </button>

                                <button class="nav-button" onclick="openEvent()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">äº‹ä»¶</div>
                                    <div class="nav-description">äº‹ä»¶é¢æ¿<br>æ´»åŠ¨ç®¡ç†</div>
                                </button>
                            </div>
                        </div>

                        <!-- åœ°å›¾æ¨¡æ€çª—å£ -->
                        <div class="modal" id="mapModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('mapModal')">&times;</button>
                                <iframe id="mapPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- åŒ¿åè®ºå›æ¨¡æ€çª—å£ -->
                        <div class="modal" id="anonymousForumModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('anonymousForumModal')">&times;</button>
                                <iframe id="forumPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- CPæ´»åŠ¨æ¨¡æ€çª—å£ -->
                        <div class="modal" id="cpActivityModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('cpActivityModal')">&times;</button>
                                <iframe id="echoPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- èŠå¤©å®¤æ¨¡æ€çª—å£ -->
                        <div class="modal" id="chatRoomModal">
                            <div class="modal-content">
                                <button id="chatIframeCloseBtn" class="floating-close-btn" onclick="closeModal('chatRoomModal')">&times;</button>
                                <iframe id="chatPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- ç›´æ’­é—´æ¨¡æ€çª—å£ -->
                        <div class="modal" id="liveRoomModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('liveRoomModal')">&times;</button>
                                <iframe id="livestreamPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>





                        <!-- äº‹ä»¶æ¨¡æ€çª—å£ -->
                        <div class="modal" id="eventModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <div class="modal-title">
                                        <span class="modal-icon">ğŸ“…</span>
                                        äº‹ä»¶
                                    </div>
                                    <button class="close-modal" onclick="closeModal('eventModal')">Ã—</button>
                                </div>
                                <div class="modal-body">
                                    <div class="modal-placeholder">
                                        è¿™é‡Œæ˜¯äº‹ä»¶é¢æ¿<br>
                                        ç­‰å¾…æ·»åŠ å†…å®¹...
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- é¡µé¢æŒ‡ç¤ºå™¨ -->
                <div class="page-indicator">
                    <div class="indicator-dot" onclick="goToPage(0)"></div>
                    <div class="indicator-dot active" onclick="goToPage(1)"></div>
                    <div class="indicator-dot" onclick="goToPage(2)"></div>
                </div>
            </div>

            <div class="notification" id="notification"></div>
        </div>
        <div class="phone-homebar"></div>
        </div>

    <!-- éŸ³ä¹è®¾ç½®æ¨¡æ€çª—å£ -->
    <div class="modal" id="musicSettingsModal">
        <!-- èƒŒæ™¯é»‘è† å”±ç‰‡ - èˆ‡å®¹å™¨åŒå±¤ -->
        <div id="vinylRecord" style="
            position: fixed;
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            height: 400px;
            background: url('https://files.catbox.moe/xn1a6j.png ') no-repeat center;
            background-size: contain;
            opacity: 1;
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 9997;
            pointer-events: none;
        "></div>
        
        <div class="modal-content" style="width: 380px !important; max-width: 320px !important; height: 500px !important; border-radius: 20px !important; background: linear-gradient(145deg, #f5f5dc, #e8e8d0) !important; backdrop-filter: blur(20px) !important; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important; position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; overflow: hidden !important; z-index: 9999; transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;">
            <!-- ä¸»ç•Œé¢å®¹å™¨ -->
            <div style="
                position: relative;
                z-index: 2;
                background: linear-gradient(145deg, #f5f5dc, #e8e8d0);
                border-radius: 20px;
                padding: 20px;
                height: 100%;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            ">
                <!-- é ‚éƒ¨æ¬„ä½ -->
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                ">
                    <!-- å·¦ä¸Šè§’æ·»åŠ æŒ‰éˆ• -->
                    <button onclick="openAddMusicModal()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'" title="æ·»åŠ éŸ³æ¨‚">
                        <img src="https://files.catbox.moe/8b9erj.png" alt="æ·»åŠ " style="width: 20px; height: 20px;">
                    </button>
                    
                    <!-- å³ä¸Šè§’è€³æ©Ÿåœ–ç¤º -->
                    <button onclick="closeModal('musicSettingsModal')" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/nqhnus.png" alt="é—œé–‰" style="width: 20px; height: 20px;">
                    </button>
                </div>
                
                <!-- ä¸»è¦–è¦ºå€åŸŸ - éŸ³æ¨‚å°é¢ -->
                <div style="
                    position: relative;
                    width: 100%;
                    height: 160px;
                    border-radius: 12px;
                    overflow: hidden;
                    margin-bottom: 15px;
                    background: linear-gradient(145deg, #e0e0e0, #f0f0f0);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <img id="musicCover" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUQ0Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYfliqDovb3lpLHotKU8L3RleHQ+Cjwvc3ZnPgo=" alt="éŸ³æ¨‚å°é¢" style="
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        border-radius: 15px;
                    ">
                    
                    <!-- éŸ³é‡æ§åˆ¶æŒ‰éˆ• -->
                    <div id="volumeControlBtn" style="
                        position: absolute;
                        bottom: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        padding: 6px;
                        border-radius: 50%;
                        font-size: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 28px;
                        height: 28px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onclick="toggleVolumeControl()">
                        <img src="https://files.catbox.moe/wexq69.png " alt="éŸ³é‡" style="width: 16px; height: 16px;">
            </div>
                    
                    <!-- éŸ³é‡æ§åˆ¶é¢æ¿ (éš±è—) -->
                    <div id="volumeControlPanel" style="
                        position: absolute;
                        bottom: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.9);
                        color: white;
                        padding: 16px 12px;
                        border-radius: 25px;
                        font-size: 12px;
                        display: none;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        min-height: 140px;
                        backdrop-filter: blur(15px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    ">
                        <img id="volumeIcon" src="https://files.catbox.moe/wexq69.png " alt="éŸ³é‡" style="width: 16px; height: 16px; cursor: pointer;" onclick="toggleMute()">
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" style="
                            width: 4px;
                            height: 80px;
                            background: #ddd;
                            border-radius: 2px;
                            outline: none;
                            cursor: pointer;
                            writing-mode: bt-lr;
                            -webkit-appearance: slider-vertical;
                        " oninput="changeVolume(this.value)">
                        </div>
                    </div>
                
                <!-- æ­Œæ›²è³‡è¨Š -->
                <div style="
                    text-align: center;
                    margin-bottom: 20px;
                ">
                    <div style="
                        font-weight: bold;
                        font-size: 18px;
                        color: #333;
                        margin-bottom: 5px;
                    ">TODAY'S SONG</div>
                    <div id="currentSongName" style="
                        font-size: 14px;
                        color: #666;
                    ">é¸æ“‡éŸ³æ¨‚</div>
                </div>

                <!-- é€²åº¦æ¢ -->
                <!-- é€²åº¦æ¢å’Œæ™‚é–“é¡¯ç¤º -->
                <div style="
                    margin-bottom: 20px;
                ">
                    <!-- æ™‚é–“é¡¯ç¤º -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                        font-size: 12px;
                        color: #666;
                    ">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    
                    <!-- å¯æ‹–æ‹½é€²åº¦æ¢ -->
                    <div id="progressContainer" style="
                        width: 100%;
                        height: 6px;
                        background: #ddd;
                        border-radius: 3px;
                        position: relative;
                        cursor: pointer;
                    " onclick="seekToPosition(event)" onmousedown="startDragging(event)">
                        <div id="progressBar" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #4CAF50, #45a049);
                            border-radius: 3px;
                            position: relative;
                            transition: width 0.1s ease;
                        ">
                            <div id="progressThumb" style="
                                position: absolute;
                                right: -6px;
                                top: -3px;
                                width: 12px;
                                height: 12px;
                                background: #4CAF50;
                                border-radius: 50%;
                                border: 2px solid #fff;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                cursor: grab;
                                transition: transform 0.2s ease;
                            " onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" onmousedown="startDragging(event)"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æ’­æ”¾æ§åˆ¶æŒ‰éˆ• -->
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                ">
                    <button onclick="toggleMusicList()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'" title="å±•é–‹/æ”¶ç¸®éŸ³æ¨‚åˆ—è¡¨">
                        <img src="https://files.catbox.moe/b2bgvm.png" alt="éŸ³æ¨‚åˆ—è¡¨" style="width: 20px; height: 20px;">
                    </button>
                    
                    <button onclick="previousMusic()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/cnffp6.png" alt="ä¸Šä¸€é¦–" style="width: 20px; height: 20px;">
                    </button>
                    
                    <button id="playPauseBtn" onclick="toggleMusic()" style="
                        background: #333;
                        border: none;
                        cursor: pointer;
                        padding: 12px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        color: white;
                        width: 45px;
                        height: 45px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        <img id="playPauseIcon" src="https://files.catbox.moe/4eigto.png" alt="æ’­æ”¾" style="width: 24px; height: 24px;">
                    </button>
                    
                    <button onclick="nextMusic()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/brjbks.png" alt="ä¸‹ä¸€é¦–" style="width: 20px; height: 20px;">
                    </button>
                    
                    <button style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/5slg6h.png" alt="æ”¶è—" style="width: 20px; height: 20px;">
                    </button>
                </div>
                
                <!-- éŸ³æ¨‚åˆ—è¡¨ï¼ˆå¯å±•é–‹ï¼‰ -->
                <div style="
                    flex: 1;
                    overflow: hidden;
                    position: relative;
                ">
                    <div id="musicListContainer" style="
                        height: 0px;
                        overflow: hidden;
                        transition: all 0.3s ease;
                    ">
                        <div id="musicList" style="
                            height: 100%;
                            overflow-y: auto;
                            padding: 10px;
                            background: rgba(255,255,255,0.5);
                            border-radius: 15px;
                        "></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ éŸ³æ¨‚å­æ¨¡æ…‹çª—å£ -->
    <div class="add-music-modal" id="addMusicModal" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.5) !important; backdrop-filter: blur(10px) !important; z-index: 99999 !important; display: none !important; align-items: center !important; justify-content: center !important;" onclick="closeAddMusicModal()">
        <div class="modal-content" style="width: 380px !important; max-width: 380px !important; height: auto !important; min-height: 280px !important; max-height: 600px !important; border-radius: 20px !important; background: linear-gradient(145deg, #f5f5dc, #e8e8d0) !important; backdrop-filter: blur(20px) !important; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important; position: relative !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; overflow-y: auto !important;" onclick="event.stopPropagation();">
            <div class="modal-header" style="background: linear-gradient(135deg, #e8e8d0, #f5f5dc) !important; color: #333333 !important; border-radius: 20px 20px 0 0 !important; padding: 15px 18px !important; border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important; position: relative !important;">
                <div class="modal-title" style="font-size: 16px !important; font-weight: bold !important; color: #333333 !important;">
                    <span class="modal-icon" style="font-size: 18px !important; margin-right: 8px !important;">ğŸµ</span>
                    æ·»åŠ æ–°éŸ³æ¨‚
                </div>
                <button class="close-modal" onclick="closeAddMusicModal()" style="background: rgba(0, 0, 0, 0.1) !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; color: #333333 !important; font-size: 18px !important; width: 28px !important; height: 28px !important; border-radius: 50% !important; transition: all 0.3s ease !important;">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 18px !important; background: linear-gradient(145deg, #f5f5dc, #e8e8d0) !important; min-height: 400px !important; border-radius: 0 0 20px 20px !important;">
                <!-- æ¨™ç±¤é åˆ‡æ› -->
                <div class="tab-container" style="margin-bottom: 20px;">
                    <div class="tab-buttons" style="display: flex; gap: 2px; background: rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 3px;">
                        <button id="urlTabBtn" class="tab-btn active" onclick="switchTab('url')" style="flex: 1; padding: 8px 12px; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); color: #333333;">URLè¼¸å…¥</button>
                        <button id="uploadTabBtn" class="tab-btn" onclick="switchTab('upload')" style="flex: 1; padding: 8px 12px; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: transparent; color: #666666;">æœ¬åœ°ä¸Šå‚³</button>
                    </div>
                </div>

                <!-- URLè¼¸å…¥æ¨¡å¼ -->
                <div id="urlTab" class="tab-content active" style="display: block;">
                    <div class="music-url-input" style="margin-bottom: 15px;">
                        <label for="addMusicNameInput" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">éŸ³æ¨‚åç¨±:</label>
                        <input type="text" id="addMusicNameInput" placeholder="è«‹è¼¸å…¥éŸ³æ¨‚åç¨±..." style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.2); border-radius: 10px; font-size: 13px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); color: #333333; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);">
                    </div>
                    <div class="music-url-input" style="margin-bottom: 20px;">
                        <label for="addMusicUrlInput" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">éŸ³æ¨‚URL:</label>
                        <input type="text" id="addMusicUrlInput" placeholder="è«‹è¼¸å…¥éŸ³æ¨‚URL..." style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.2); border-radius: 10px; font-size: 13px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); color: #333333; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);">
                    </div>
                    <div class="music-controls" style="display: flex; gap: 12px;">
                        <button class="music-add-btn" onclick="addMusicFromModal()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">æ·»åŠ </button>
                        <button class="music-test-btn" onclick="testMusicFromModal()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">æ¸¬è©¦</button>
                    </div>
                </div>

                <!-- æœ¬åœ°ä¸Šå‚³æ¨¡å¼ -->
                <div id="uploadTab" class="tab-content" style="display: none;">
                    <div class="music-upload-input" style="margin-bottom: 15px;">
                        <label for="addMusicNameInput2" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">éŸ³æ¨‚åç¨±:</label>
                        <input type="text" id="addMusicNameInput2" placeholder="è«‹è¼¸å…¥éŸ³æ¨‚åç¨±..." style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.2); border-radius: 10px; font-size: 13px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); color: #333333; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);">
                    </div>
                    <div class="music-upload-area" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">é¸æ“‡éŸ³æ¨‚æ–‡ä»¶:</label>
                        <div id="uploadArea" style="border: 2px dashed rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 30px 20px; text-align: center; background: rgba(255, 255, 255, 0.5); cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('musicFileInput').click()">
                            <div style="font-size: 24px; margin-bottom: 10px; color: #666;">ğŸ“</div>
                            <div style="color: #666; font-size: 12px; margin-bottom: 5px;">é»æ“Šé¸æ“‡éŸ³æ¨‚æ–‡ä»¶</div>
                            <div style="color: #999; font-size: 11px;">æ”¯æŒ MP3, WAV, OGG æ ¼å¼</div>
                        </div>
                        <input type="file" id="musicFileInput" accept="audio/*" style="display: none;" onchange="handleFileSelect(event)">
                        <div id="fileInfo" style="margin-top: 10px; padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; display: none;">
                            <div style="font-size: 12px; color: #333; font-weight: bold;">å·²é¸æ“‡æ–‡ä»¶:</div>
                            <div id="fileName" style="font-size: 11px; color: #666; margin-top: 2px;"></div>
                            <div id="fileSize" style="font-size: 11px; color: #666; margin-top: 2px;"></div>
                        </div>
                    </div>
                    <div class="music-controls" style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="music-add-btn" onclick="addMusicFromUpload()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">ä¸Šå‚³ä¸¦æ·»åŠ </button>
                        <button class="music-test-btn" onclick="testMusicFromUpload()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">æ¸¬è©¦æ’­æ”¾</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ä¸»é¢˜ç®¡ç†æ¨¡å— -->
    <script src="theme-manager.js"></script>
    <script src="background-manager.js"></script>
    <script src="main_listener.js"></script>
    <script src="lorebook-manager.js"></script>

    <!-- å¼•å…¥é€šä¿¡æµ‹è¯•è„šæœ¬ -->
    <script src="test_map_communication.js"></script>

    
    <script>
        // ç¾å¯¦æ™‚é–“æ›´æ–°å‡½æ•¸
        function initRealTimeUpdate() {
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateRealTime();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(updateRealTime, 1000);
        }

        function updateRealTime() {
            const now = new Date();
            const headerTimeElement = document.querySelector('.header-time');
            
            if (headerTimeElement) {
                // æ ¼å¼åŒ–æ™‚é–“ï¼šé€±å¹¾ æ™‚:åˆ†
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdays[now.getDay()];
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                
                headerTimeElement.textContent = `é€±${weekday} ${hours}:${minutes}`;
            }
        }

        let currentPage = 1; // é»˜è®¤ä»ä¸­é—´é¡µé¢å¼€å§‹
        let startX = 0;
        let isDragging = false;
        let isSettingsOpen = false;
        let isModalOpen = false;
        
        // éŸ³ä¹æ§åˆ¶ç›¸å…³å˜é‡
        let isMusicPlaying = false;
        let currentMusicUrl = '';
        let audioElement = null;
        
        // éŸ³æ¨‚åˆ—è¡¨ç®¡ç†ç›¸é—œè®Šæ•¸
        let musicList = [];
        let currentMusicIndex = 0;
        let musicDB = null;
        
        // VNé¢æ¿iframeå‹•æ…‹ä¼¸ç¸®ç›¸é—œè®Šæ•¸
        let vnIframeState = 'landing'; // 'landing', 'story', 'continue'
        
        // =======================================================================
        //                            éŸ³æ¨‚åˆ—è¡¨ç®¡ç†ç³»çµ±
        // =======================================================================
        
        // åˆå§‹åŒ–IndexedDB
        function initMusicDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('MusicListDB', 1);
                
                request.onerror = () => {
                    console.error('[éŸ³æ¨‚ç³»çµ±] IndexedDBæ‰“é–‹å¤±æ•—');
                    reject(new Error('IndexedDBæ‰“é–‹å¤±æ•—'));
                };
                
                request.onsuccess = (event) => {
                    musicDB = event.target.result;
                    console.log('[éŸ³æ¨‚ç³»çµ±] IndexedDBåˆå§‹åŒ–æˆåŠŸ');
                    resolve(musicDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // å‰µå»ºéŸ³æ¨‚åˆ—è¡¨å­˜å„²
                    if (!db.objectStoreNames.contains('musicList')) {
                        const musicStore = db.createObjectStore('musicList', { keyPath: 'id', autoIncrement: true });
                        musicStore.createIndex('name', 'name', { unique: false });
                        musicStore.createIndex('url', 'url', { unique: false });
                        console.log('[éŸ³æ¨‚ç³»çµ±] å‰µå»ºéŸ³æ¨‚åˆ—è¡¨å­˜å„²');
                    }
                };
            });
        }
        
        // æ·»åŠ éŸ³æ¨‚åˆ°åˆ—è¡¨
        async function addMusicToList() {
            const nameInput = document.getElementById('musicNameInput');
            const urlInput = document.getElementById('musicUrlInput');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!name || !url) {
                showNotification('è«‹è¼¸å…¥éŸ³æ¨‚åç¨±å’ŒURL', 'warning');
                return;
            }
            
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                const musicItem = {
                    name: name,
                    url: url,
                    addedAt: new Date().toISOString()
                };
                
                const request = store.add(musicItem);
                
                request.onsuccess = () => {
                    console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚æ·»åŠ æˆåŠŸ:', name);
                    showNotification(`éŸ³æ¨‚ "${name}" å·²æ·»åŠ åˆ°åˆ—è¡¨`, 'success');
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    nameInput.value = '';
                    urlInput.value = '';
                    
                    // é‡æ–°è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚æ·»åŠ å¤±æ•—');
                    showNotification('éŸ³æ¨‚æ·»åŠ å¤±æ•—', 'error');
                };
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ·»åŠ éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('æ·»åŠ éŸ³æ¨‚å¤±æ•—', 'error');
            }
        }
        
        // è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨
        async function loadMusicList() {
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readonly');
                const store = transaction.objectStore('musicList');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    musicList = request.result;
                    
                    // å¦‚æœåˆ—è¡¨ç‚ºç©ºï¼Œæª¢æŸ¥æ˜¯å¦æœ‰èˆŠçš„localStorageæ•¸æ“šéœ€è¦é·ç§»
                    if (musicList.length === 0) {
                        migrateOldMusicData();
                    } else {
                        renderMusicList();
                        updateCurrentMusicInfo();
                        
                        // ğŸ”¥ ä¿®æ”¹ï¼šå¾localStorageæ¢å¾©ä¹‹å‰ä¿å­˜çš„éŸ³æ¨‚ç´¢å¼•
                        // æ¯æ¬¡è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨æ™‚éƒ½å˜—è©¦æ¢å¾©ç·©å­˜ç‹€æ…‹
                            const savedIndex = localStorage.getItem('currentMusicIndex');
                            const savedUrl = localStorage.getItem('currentMusicUrl');
                        
                        console.log('[éŸ³æ¨‚ç³»çµ±] æª¢æŸ¥ç·©å­˜æ•¸æ“š:', { savedIndex, savedUrl });
                            
                            if (savedIndex !== null && savedUrl !== null) {
                                const index = parseInt(savedIndex);
                                // æª¢æŸ¥ä¿å­˜çš„ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
                                if (index >= 0 && index < musicList.length) {
                                    // æª¢æŸ¥ä¿å­˜çš„URLæ˜¯å¦é‚„å­˜åœ¨æ–¼åˆ—è¡¨ä¸­
                                    const savedMusic = musicList.find(music => music.url === savedUrl);
                                    if (savedMusic) {
                                        currentMusicIndex = index;
                                        currentMusicUrl = savedUrl;
                                        console.log('[éŸ³æ¨‚ç³»çµ±] æ¢å¾©ä¹‹å‰ä¿å­˜çš„éŸ³æ¨‚:', savedMusic.name, `(ç´¢å¼•: ${index})`);
                                    } else {
                                        // ä¿å­˜çš„URLä¸å­˜åœ¨ï¼Œä½¿ç”¨ä¿å­˜çš„ç´¢å¼•
                                        currentMusicIndex = index;
                                        currentMusicUrl = musicList[index].url;
                                        console.log('[éŸ³æ¨‚ç³»çµ±] æ¢å¾©ä¹‹å‰ä¿å­˜çš„éŸ³æ¨‚ç´¢å¼•:', musicList[index].name, `(ç´¢å¼•: ${index})`);
                                    }
                                } else {
                                    // ä¿å­˜çš„ç´¢å¼•ç„¡æ•ˆï¼Œä½¿ç”¨ç¬¬ä¸€é¦–
                                    currentMusicIndex = 0;
                                    currentMusicUrl = musicList[0].url;
                                    console.log('[éŸ³æ¨‚ç³»çµ±] ä¿å­˜çš„ç´¢å¼•ç„¡æ•ˆï¼Œæ’­æ”¾ç¬¬ä¸€é¦–éŸ³æ¨‚:', musicList[0].name);
                                }
                            } else {
                                // æ²’æœ‰ä¿å­˜çš„æ•¸æ“šï¼Œä½¿ç”¨ç¬¬ä¸€é¦–
                                currentMusicIndex = 0;
                                currentMusicUrl = musicList[0].url;
                                console.log('[éŸ³æ¨‚ç³»çµ±] æ²’æœ‰ä¿å­˜çš„æ•¸æ“šï¼Œæ’­æ”¾ç¬¬ä¸€é¦–éŸ³æ¨‚:', musicList[0].name);
                            }
                            
                        // ğŸ”¥ ä¿®æ”¹ï¼šç·©å­˜æ¢å¾©å¾Œï¼Œç›´æ¥æ’­æ”¾å°æ‡‰çš„éŸ³æ¨‚
                        if (currentMusicIndex >= 0 && currentMusicIndex < musicList.length) {
                            console.log('[éŸ³æ¨‚ç³»çµ±] ç·©å­˜æ¢å¾©å®Œæˆï¼Œç›´æ¥æ’­æ”¾éŸ³æ¨‚:', musicList[currentMusicIndex].name);
                            playMusicFromList(currentMusicIndex);
                        } else {
                            // åªæœ‰åœ¨æ²’æœ‰éŸ³é »å…ƒç´ æ™‚æ‰åˆå§‹åŒ–èƒŒæ™¯éŸ³æ¨‚
                            if (!audioElement) {
                            initBackgroundMusic();
                            }
                        }
                    }
                };
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨å¤±æ•—:', error);
            }
        }
        
        // é·ç§»èˆŠçš„localStorageéŸ³æ¨‚æ•¸æ“š
        async function migrateOldMusicData() {
            const oldMusicUrl = localStorage.getItem('musicUrl');
            
            if (oldMusicUrl && oldMusicUrl !== 'https://files.catbox.moe/snenpf.mp3') {
                try {
                    // å°‡èˆŠçš„éŸ³æ¨‚URLæ·»åŠ åˆ°æ–°çš„éŸ³æ¨‚åˆ—è¡¨ä¸­
                    const musicItem = {
                        name: 'ä¹‹å‰ä¿å­˜çš„éŸ³æ¨‚',
                        url: oldMusicUrl,
                        addedAt: new Date().toISOString()
                    };
                    
                    const transaction = musicDB.transaction(['musicList'], 'readwrite');
                    const store = transaction.objectStore('musicList');
                    
                    await new Promise((resolve, reject) => {
                        const request = store.add(musicItem);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject();
                    });
                    
                    console.log('[éŸ³æ¨‚ç³»çµ±] èˆŠéŸ³æ¨‚æ•¸æ“šé·ç§»æˆåŠŸ');
                    
                    // æ¸…é™¤èˆŠçš„localStorageæ•¸æ“š
                    localStorage.removeItem('musicUrl');
                    
                    // é‡æ–°è¼‰å…¥åˆ—è¡¨
                    await loadMusicList();
                    
                } catch (error) {
                    console.error('[éŸ³æ¨‚ç³»çµ±] é·ç§»èˆŠéŸ³æ¨‚æ•¸æ“šå¤±æ•—:', error);
                    // å¦‚æœé·ç§»å¤±æ•—ï¼Œç›´æ¥æ·»åŠ é è¨­éŸ³æ¨‚
                    addDefaultMusic();
                }
            } else {
                // æ²’æœ‰èˆŠæ•¸æ“šï¼Œç›´æ¥æ·»åŠ é è¨­éŸ³æ¨‚
                addDefaultMusic();
            }
        }
        
        // æ·»åŠ é è¨­éŸ³æ¨‚
        async function addDefaultMusic() {
            const defaultMusic = [
                {
                    name: 'æ£®æ—æ–ç±ƒæ›²',
                    url: 'https://files.catbox.moe/snenpf.mp3'
                },
                {
                    name: 'è‡ªç„¶ç¯€å¥',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav'
                },
                {
                    name: 'é›»è©±éˆ´è²',
                    url: 'https://www.soundjay.com/misc/sounds/phone-ringing-1.wav'
                }
            ];
            
            try {
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                for (const music of defaultMusic) {
                    const musicItem = {
                        name: music.name,
                        url: music.url,
                        addedAt: new Date().toISOString()
                    };
                    
                    await new Promise((resolve, reject) => {
                        const request = store.add(musicItem);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject();
                    });
                }
                
                console.log('[éŸ³æ¨‚ç³»çµ±] é è¨­éŸ³æ¨‚æ·»åŠ å®Œæˆ');
                
                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                await loadMusicList();
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ·»åŠ é è¨­éŸ³æ¨‚å¤±æ•—:', error);
            }
        }
        
        // æ¸²æŸ“éŸ³æ¨‚åˆ—è¡¨
        function renderMusicList() {
            const musicListContainer = document.getElementById('musicList');
            if (!musicListContainer) return;
            
            if (musicList.length === 0) {
                musicListContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 14px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“</div>
                        é‚„æ²’æœ‰æ·»åŠ ä»»ä½•éŸ³æ¨‚<br>
                        <span style="color: #999; font-size: 12px;">è«‹é»æ“Šå·¦ä¸Šè§’â•æ·»åŠ éŸ³æ¨‚</span>
                    </div>
                `;
                return;
            }
            
            musicListContainer.innerHTML = musicList.map((music, index) => `
                <div class="music-item" onclick="playMusicFromList(${index})" style="
                    display: flex; 
                    align-items: center; 
                    padding: 12px; 
                    margin-bottom: 8px; 
                    border-radius: 10px; 
                    background: ${index === currentMusicIndex ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.3)'}; 
                    border: 1px solid ${index === currentMusicIndex ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.1)'}; 
                    transition: all 0.3s ease; 
                    cursor: pointer; 
                    position: relative;
                " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='${index === currentMusicIndex ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.3)'}'">
                    <div class="music-info" style="flex: 1; margin-right: 15px;">
                        <div class="music-name" style="
                            font-weight: bold; 
                            color: ${index === currentMusicIndex ? '#333' : '#666'}; 
                            font-size: 14px; 
                            margin-bottom: 4px;
                        ">${music.name} ${index === currentMusicIndex ? 'â–¶ï¸' : ''}</div>
                        <div class="music-url" style="
                            color: #999; 
                            font-size: 11px; 
                            word-break: break-all; 
                            opacity: 0.8;
                        ">${music.url}</div>
                    </div>
                    <div class="music-actions" style="display: flex; gap: 8px;" onclick="event.stopPropagation();">
                        <button onclick="deleteMusicFromList(${music.id})" style="
                            padding: 6px 10px; 
                            border: none; 
                            border-radius: 6px; 
                            background: rgba(244, 67, 54, 0.8); 
                            color: white; 
                            font-size: 11px; 
                            cursor: pointer; 
                            transition: all 0.3s ease; 
                            font-weight: bold;
                        " onmouseover="this.style.background='rgba(244, 67, 54, 1)'" onmouseout="this.style.background='rgba(244, 67, 54, 0.8)'" title="åˆªé™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }
        
        // å¾åˆ—è¡¨æ’­æ”¾éŸ³æ¨‚
        function playMusicFromList(index) {
            if (index < 0 || index >= musicList.length) {
                showNotification('éŸ³æ¨‚ç´¢å¼•ç„¡æ•ˆ', 'error');
                return;
            }
            
            const music = musicList[index];
            currentMusicIndex = index;
            currentMusicUrl = music.url;
            
            // ğŸ”¥ æ–°å¢ï¼šä¿å­˜ç•¶å‰éŸ³æ¨‚ç´¢å¼•åˆ°localStorage
            localStorage.setItem('currentMusicIndex', index.toString());
            localStorage.setItem('currentMusicUrl', music.url);
            
            console.log(`[éŸ³æ¨‚ç³»çµ±] åˆ‡æ›åˆ°éŸ³æ¨‚: ${music.name} (ç´¢å¼•: ${index}, URL: ${music.url})`);
            
            // æ’­æ”¾é»‘è† å”±ç‰‡å‹•ç•«
            playVinylAnimation();
            
            // æ›´æ–°æ­Œæ›²åç¨±é¡¯ç¤º
            updateSongNameDisplay();
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
            if (isMusicPlaying) {
                stopMusic();
            }
            
            // æ›´æ–°éŸ³é »å…ƒç´ 
            if (audioElement) {
                audioElement.src = music.url;
                audioElement.load();
                
                // å˜—è©¦æ’­æ”¾
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        showNotification(`æ­£åœ¨æ’­æ”¾: ${music.name}`, 'success');
                        updateCurrentMusicInfo();
                    }).catch(error => {
                        console.error('[éŸ³æ¨‚ç³»çµ±] æ’­æ”¾å¤±æ•—:', error);
                        showNotification('æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŸ³æ¨‚URL', 'error');
                    });
                }
            }
        }
        
        // å¾åˆ—è¡¨åˆªé™¤éŸ³æ¨‚
        async function deleteMusicFromList(musicId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™é¦–éŸ³æ¨‚å—ï¼Ÿ')) {
                return;
            }
            
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                const request = store.delete(musicId);
                
                request.onsuccess = () => {
                    console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚åˆªé™¤æˆåŠŸ');
                    showNotification('éŸ³æ¨‚å·²åˆªé™¤', 'success');
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚åˆªé™¤å¤±æ•—');
                    showNotification('éŸ³æ¨‚åˆªé™¤å¤±æ•—', 'error');
                };
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] åˆªé™¤éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('åˆªé™¤éŸ³æ¨‚å¤±æ•—', 'error');
            }
        }
        
        // æ›´æ–°ç•¶å‰æ’­æ”¾ä¿¡æ¯
        function updateCurrentMusicInfo() {
            const currentMusicInfo = document.getElementById('currentMusicInfo');
            const songNameElement = document.getElementById('currentSongName');
            
            if (musicList.length === 0) {
                if (currentMusicInfo) currentMusicInfo.textContent = 'æ²’æœ‰éŸ³æ¨‚åœ¨æ’­æ”¾';
                if (songNameElement) songNameElement.textContent = 'é¸æ“‡éŸ³æ¨‚';
                return;
            }
            
            if (currentMusicIndex >= 0 && currentMusicIndex < musicList.length) {
                const currentMusic = musicList[currentMusicIndex];
                if (currentMusicInfo) currentMusicInfo.textContent = `${currentMusic.name} (${currentMusicIndex + 1}/${musicList.length})`;
                if (songNameElement) songNameElement.textContent = currentMusic.name;
            } else {
                if (currentMusicInfo) currentMusicInfo.textContent = 'æ²’æœ‰éŸ³æ¨‚åœ¨æ’­æ”¾';
                if (songNameElement) songNameElement.textContent = 'é¸æ“‡éŸ³æ¨‚';
            }
            
            // é‡æ–°æ¸²æŸ“éŸ³æ¨‚åˆ—è¡¨ä»¥æ›´æ–°ç•¶å‰æ’­æ”¾ç‹€æ…‹
            renderMusicList();
        }
        
        // åˆ‡æ›åˆ°ä¸‹ä¸€é¦–éŸ³æ¨‚
        function nextMusic() {
            if (musicList.length === 0) {
                showNotification('éŸ³æ¨‚åˆ—è¡¨ç‚ºç©º', 'warning');
                return;
            }
            
            currentMusicIndex = (currentMusicIndex + 1) % musicList.length;
            // ğŸ”¥ ä¿®æ”¹ï¼šç›´æ¥èª¿ç”¨playMusicFromListï¼Œå®ƒæœƒè‡ªå‹•ä¿å­˜ç‹€æ…‹
            playMusicFromList(currentMusicIndex);
        }
        
        // åˆ‡æ›åˆ°ä¸Šä¸€é¦–éŸ³æ¨‚
        function previousMusic() {
            if (musicList.length === 0) {
                showNotification('éŸ³æ¨‚åˆ—è¡¨ç‚ºç©º', 'warning');
                return;
            }
            
            currentMusicIndex = currentMusicIndex <= 0 ? musicList.length - 1 : currentMusicIndex - 1;
            // ğŸ”¥ ä¿®æ”¹ï¼šç›´æ¥èª¿ç”¨playMusicFromListï¼Œå®ƒæœƒè‡ªå‹•ä¿å­˜ç‹€æ…‹
            playMusicFromList(currentMusicIndex);
        }
        
        // åˆå§‹åŒ–èƒŒæ™¯éŸ³ä¹
        function initBackgroundMusic() {
            // ğŸ”¥ ä¿®æ”¹ï¼šæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°éŸ³é »å…ƒç´ 
                const musicUrl = currentMusicUrl || 'https://files.catbox.moe/snenpf.mp3';
                
            if (!audioElement) {
                // å‰µå»ºæ–°çš„éŸ³é »å…ƒç´ 
                console.log('[éŸ³æ¨‚ç³»çµ±] å‰µå»ºæ–°çš„éŸ³é »å…ƒç´ ï¼ŒURL:', musicUrl);
                
                audioElement = new Audio(musicUrl);
                audioElement.loop = true;
                audioElement.volume = 0.5;
                
                // è¨­ç½®é€²åº¦æ¢äº‹ä»¶ç›£è½å™¨
                setupAudioEventListeners();
                
                // éŸ³ä¹åŠ è½½å®Œæˆäº‹ä»¶
                audioElement.addEventListener('loadeddata', function() {
                    console.log('[éŸ³æ¨‚ç³»çµ±] èƒŒæ™¯éŸ³æ¨‚å·²è¼‰å…¥');
                    // åŠ è½½å®Œæˆåè‡ªåŠ¨å°è¯•æ’­æ”¾
                    autoPlayBackgroundMusic();
                });
                
                // éŸ³ä¹æ’­æ”¾äº‹ä»¶
                audioElement.addEventListener('play', function() {
                    isMusicPlaying = true;
                    updateMusicButtonState();
                    console.log('[éŸ³æ¨‚ç³»çµ±] èƒŒæ™¯éŸ³æ¨‚é–‹å§‹æ’­æ”¾');
                });
                
                // éŸ³ä¹æš‚åœäº‹ä»¶
                audioElement.addEventListener('pause', function() {
                    isMusicPlaying = false;
                    updateMusicButtonState();
                    console.log('[éŸ³æ¨‚ç³»çµ±] èƒŒæ™¯éŸ³æ¨‚å·²æš«åœ');
                });
                
                // éŸ³ä¹é”™è¯¯äº‹ä»¶
                audioElement.addEventListener('error', function(e) {
                    console.error('[éŸ³æ¨‚ç³»çµ±] èƒŒæ™¯éŸ³æ¨‚è¼‰å…¥éŒ¯èª¤:', e);
                    showNotification('éŸ³æ¨‚è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥URLæˆ–ç¶²çµ¡é€£æ¥', 'error');
                    
                    // ğŸ”¥ ä¿®æ”¹ï¼šç§»é™¤è‡ªå‹•åˆ‡æ›é‚è¼¯ï¼Œé¿å…æ„å¤–åˆ‡æ›
                    // è®“ç”¨æˆ¶æ‰‹å‹•é¸æ“‡è¦æ’­æ”¾çš„éŸ³æ¨‚
                    console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚è¼‰å…¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡å…¶ä»–éŸ³æ¨‚');
                });
            } else if (audioElement.src !== musicUrl && audioElement.src !== (window.location.origin + musicUrl)) {
                // ğŸ”¥ ä¿®æ”¹ï¼šå¦‚æœéŸ³é »å…ƒç´ å­˜åœ¨ä½†URLä¸åŒï¼Œæ›´æ–°URL
                console.log('[éŸ³æ¨‚ç³»çµ±] æ›´æ–°éŸ³é »å…ƒç´ URL:', musicUrl);
                console.log('[éŸ³æ¨‚ç³»çµ±] ç•¶å‰éŸ³é »URL:', audioElement.src);
                audioElement.src = musicUrl;
                audioElement.load();
                
                // é‡æ–°è¨­ç½®é€²åº¦æ¢äº‹ä»¶ç›£è½å™¨
                setupAudioEventListeners();
                
                // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œç¹¼çºŒæ’­æ”¾
                if (isMusicPlaying) {
                    const playPromise = audioElement.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.warn('[éŸ³æ¨‚ç³»çµ±] æ›´æ–°å¾Œæ’­æ”¾å¤±æ•—:', error);
                        });
                    }
                }
            }
        }

        // è‡ªåŠ¨æ’­æ”¾èƒŒæ™¯éŸ³ä¹
        function autoPlayBackgroundMusic() {
            if (audioElement && !isMusicPlaying) {
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // console.log('[ä¸»é¢æ¿] èƒŒæ™¯éŸ³æ¨‚è‡ªå‹•æ’­æ”¾æˆåŠŸ');
                        showNotification('èƒŒæ™¯éŸ³æ¨‚å·²é–‹å§‹æ’­æ”¾', 'success');
                    }).catch(error => {
                        console.warn('[ä¸»é¢æ¿] è‡ªå‹•æ’­æ”¾è¢«ç€è¦½å™¨é˜»æ­¢ï¼Œç­‰å¾…ç”¨æˆ¶äº¤äº’:', error);
                        // æ˜¾ç¤ºæ’­æ”¾æç¤º
                        showAutoPlayTip();
                    });
                }
            }
        }

        // æ˜¾ç¤ºè‡ªåŠ¨æ’­æ”¾æç¤º
        function showAutoPlayTip() {
            const musicBtn = document.getElementById('musicControlBtn');
            if (musicBtn) {
                // è®©éŸ³ä¹æŒ‰é’®é—ªçƒæç¤ºç”¨æˆ·ç‚¹å‡»
                musicBtn.style.animation = 'musicButtonBlink 1s ease-in-out infinite';
                musicBtn.title = 'é»æ“Šé–‹å§‹æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ ğŸµ';
                
                // 5ç§’ååœæ­¢é—ªçƒ
                setTimeout(() => {
                    musicBtn.style.animation = '';
                    musicBtn.title = 'å–®æ“Šæ’­æ”¾/æš«åœï¼Œé›™æ“Šåˆ‡æ›éŸ³æ¨‚ï¼Œé•·æŒ‰è¨­ç½®';
                }, 5000);
            }
        }
        const swipeWrapper = document.getElementById('swipeWrapper');
        const indicators = document.querySelectorAll('.indicator-dot');

        // è§¦æ‘¸äº‹ä»¶å¤„ç†
        swipeWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
        swipeWrapper.addEventListener('touchmove', handleTouchMove, { passive: true });
        swipeWrapper.addEventListener('touchend', handleTouchEnd, { passive: true });

        // é¼ æ ‡äº‹ä»¶å¤„ç†ï¼ˆæ¡Œé¢ç«¯ï¼‰
        swipeWrapper.addEventListener('mousedown', handleMouseStart);
        swipeWrapper.addEventListener('mousemove', handleMouseMove);
        swipeWrapper.addEventListener('mouseup', handleMouseEnd);
        swipeWrapper.addEventListener('mouseleave', handleMouseEnd);

        function handleTouchStart(e) {
            // å¦‚æœè®¾ç½®é¢æ¿æˆ–æ¨¡æ€çª—å£æ‰“å¼€ï¼Œä¸å¤„ç†æ»‘åŠ¨
            if (isSettingsOpen || isModalOpen) return;
            
            startX = e.touches[0].clientX;
            isDragging = true;
        }

        function handleTouchMove(e) {
            // å¦‚æœè®¾ç½®é¢æ¿æˆ–æ¨¡æ€çª—å£æ‰“å¼€ï¼Œä¸å¤„ç†æ»‘åŠ¨
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            const currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;
            const translateX = -currentPage * 33.33 + (deltaX / swipeWrapper.offsetWidth) * 33.33;
            swipeWrapper.style.transition = 'none';
            swipeWrapper.style.transform = `translateX(${Math.max(-66.66, Math.min(0, translateX))}%)`;
        }

        function handleTouchEnd(e) {
            // å¦‚æœè®¾ç½®é¢æ¿æˆ–æ¨¡æ€çª—å£æ‰“å¼€ï¼Œä¸å¤„ç†æ»‘åŠ¨
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            isDragging = false;
            const endX = e.changedTouches[0].clientX;
            const deltaX = endX - startX;
            
            if (Math.abs(deltaX) > 50) {
                if (deltaX > 0 && currentPage > 0) {
                    currentPage--;
                } else if (deltaX < 0 && currentPage < 2) {
                    currentPage++;
                }
            }
            
            updatePage();
        }

        function handleMouseStart(e) {
            // å¦‚æœè®¾ç½®é¢æ¿æˆ–æ¨¡æ€çª—å£æ‰“å¼€ï¼Œä¸å¤„ç†æ»‘åŠ¨
            if (isSettingsOpen || isModalOpen) return;
            
            startX = e.clientX;
            isDragging = true;
            e.preventDefault();
        }

        function handleMouseMove(e) {
            // å¦‚æœè®¾ç½®é¢æ¿æˆ–æ¨¡æ€çª—å£æ‰“å¼€ï¼Œä¸å¤„ç†æ»‘åŠ¨
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            const currentX = e.clientX;
            const deltaX = currentX - startX;
            const translateX = -currentPage * 33.33 + (deltaX / swipeWrapper.offsetWidth) * 33.33;
            swipeWrapper.style.transition = 'none';
            swipeWrapper.style.transform = `translateX(${Math.max(-66.66, Math.min(0, translateX))}%)`;
        }

        function handleMouseEnd(e) {
            // å¦‚æœè®¾ç½®é¢æ¿æˆ–æ¨¡æ€çª—å£æ‰“å¼€ï¼Œä¸å¤„ç†æ»‘åŠ¨
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            isDragging = false;
            const endX = e.clientX;
            const deltaX = endX - startX;
            
            if (Math.abs(deltaX) > 50) {
                if (deltaX > 0 && currentPage > 0) {
                    currentPage--;
                } else if (deltaX < 0 && currentPage < 2) {
                    currentPage++;
                }
            }
            
            updatePage();
        }

        function goToPage(page) {
            currentPage = page;
            updatePage();
        }

        function updatePage() {
            swipeWrapper.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            swipeWrapper.style.transform = `translateX(-${currentPage * 33.33}%)`;
            
            indicators.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentPage);
            });
        }

        // é˜Ÿå‹ä¿¡æ¯æ•°æ®ï¼ˆå ä½ç¬¦ï¼‰
        window.teammateData = {
            'A': {
                name: 'Lian',
                avatar: 'https://i.pravatar.cc/150?img=3',
                title: 'ä¸»èˆ-å‰¯å”± | #å¾…å®š|é›†ä½“å®¿èˆ | å¾…å®šçº§',
                tag: 'å†·é™çš„è§‚å¯Ÿè€…',
                favor: '5',
                cp: '1',
                status: 'ç«™åœ¨äººç¾¤ä¸­åæ–¹ï¼Œç›®å…‰å¹³é™åœ°çœ‹ç€è¢«è±çº³æ–¯å¸¦åˆ°å‰æ’çš„Nocturneã€‚',
                mood: 'ç¤¾äº¤èƒ½åŠ›ä¹Ÿæ˜¯å®åŠ›çš„ä¸€ç§ã€‚ä»–æ¯”çœ‹ä¸Šå»è¦èªæ˜ã€‚',
                outfit: 'é»‘è‰²å®½æ¾ç»ƒèˆè£¤ï¼Œçº¯ç™½Tæ¤ï¼Œå¤´å‘æ‰“ç†å¾—å¹²å‡€åˆ©è½ã€‚'
            },
            'B': {
                name: 'Sereno',
                avatar: 'https://i.pravatar.cc/150?img=12',
                title: 'å‰¯å”±-Rapper | #å¾…å®š|é›†ä½“å®¿èˆ | å¾…å®šçº§',
                tag: 'æ´»åŠ›å››å°„çš„è¡¨æ¼”è€…',
                favor: '3',
                cp: '2',
                status: 'æ­£åœ¨å’Œå…¶ä»–ç»ƒä¹ ç”Ÿçƒ­æƒ…äº¤æµï¼Œå±•ç°å‡ºå¤©ç”Ÿçš„äº²å’ŒåŠ›ã€‚',
                mood: 'ä»Šå¤©ä¸€å®šè¦å±•ç°å‡ºæœ€å¥½çš„è‡ªå·±ï¼',
                outfit: 'å½©è‰²è¿åŠ¨å¤–å¥—ï¼Œç ´æ´ç‰›ä»”è£¤ï¼Œå……æ»¡è¡—å¤´é£æ ¼ã€‚'
            },
            'C': {
                name: 'Alex',
                avatar: 'https://i.pravatar.cc/150?img=8',
                title: 'Rapper-èˆè¹ˆ | #å¾…å®š|é›†ä½“å®¿èˆ | å¾…å®šçº§',
                tag: 'æŠ€æœ¯å‹å®Œç¾ä¸»ä¹‰è€…',
                favor: '4',
                cp: '0',
                status: 'ä¸“æ³¨åœ°ç»ƒä¹ ç€èˆè¹ˆåŠ¨ä½œï¼Œè¿½æ±‚æ¯ä¸ªç»†èŠ‚çš„å®Œç¾ã€‚',
                mood: 'åªæœ‰ä¸æ–­ç»ƒä¹ æ‰èƒ½è¾¾åˆ°ç†æƒ³çš„æ°´å¹³ã€‚',
                outfit: 'ç®€çº¦é»‘è‰²è®­ç»ƒæœï¼Œè¿åŠ¨é‹ï¼Œå®ç”¨ä¸»ä¹‰é£æ ¼ã€‚'
            },
            'D': {
                name: 'Linus',
                avatar: 'https://i.pravatar.cc/150?img=15',
                title: 'å…¨èƒ½-é˜Ÿé•¿ | #å¾…å®š|é›†ä½“å®¿èˆ | å¾…å®šçº§',
                tag: 'å¤©ç”Ÿçš„é¢†å¯¼è€…',
                favor: '6',
                cp: '3',
                status: 'æ­£åœ¨å®‰æŠšç´§å¼ çš„é˜Ÿå‹ï¼Œå±•ç°å‡ºæˆç†Ÿçš„é¢†å¯¼é£èŒƒã€‚',
                mood: 'å›¢é˜Ÿçš„æˆåŠŸæ¯”ä¸ªäººè¡¨ç°æ›´é‡è¦ã€‚',
                outfit: 'é«˜è´¨æ„Ÿç™½è¡¬è¡«ï¼Œæ·±è‰²ä¼‘é—²è£¤ï¼Œå¹²å‡€åˆ©è½çš„å‘å‹ã€‚'
            }
        };

        // æ˜¾ç¤ºé˜Ÿå‹ä¿¡æ¯
        function showTeammateInfo(teammateId) {
            const modal = document.getElementById('teammateModal');
            const data = teammateData[teammateId];
            
            if (!data) return;
            
            // è§£ætitleä¿¡æ¯
            const titleParts = data.title.split(' | ');
            const role = titleParts[0] || '';
            const tag = titleParts[1] || '';
            const location = titleParts[2] || '';
            const level = titleParts[3] || '';
            
            // æ›´æ–°å¼¹çª—å†…å®¹
            document.getElementById('teammateModalAvatar').src = data.avatar;
            
            // æ„å»ºæ–°çš„header HTML
            const titleElement = document.getElementById('teammateModalTitle');
            titleElement.innerHTML = `
                <div class="teammate-role">${role}</div>
                <div class="teammate-details">
                    <span class="teammate-tag">${tag}</span>
                    <span class="teammate-location">${location}</span>
                    <span class="teammate-level">${level}</span>
                </div>
            `;
            
            document.getElementById('teammateTag').textContent = data.tag;
            document.getElementById('teammateFavor').textContent = data.favor;
            document.getElementById('teammateCP').textContent = data.cp;
            document.getElementById('teammateStatus').textContent = data.status;
            document.getElementById('teammateMood').textContent = data.mood;
            document.getElementById('teammateOutfit').textContent = data.outfit;
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.add('show');
        }

        // å…³é—­é˜Ÿå‹ä¿¡æ¯å¼¹çª—
        function closeTeammateModal() {
            const modal = document.getElementById('teammateModal');
            modal.classList.remove('show');
        }

        // é€šç”¨æ¨¡æ€çª—å£æ§åˆ¶
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            
            // ç‰¹æ®Šè™•ç†æ—¥ç¨‹è¡¨æ¨¡æ…‹æ¡†
            if (modalId === 'scheduleModal') {
                modal.style.display = 'flex';
                modal.style.opacity = '1';
            } else {
                modal.classList.add('show');
            }
            
            // ç¦æ­¢æ»‘åŠ¨
            isModalOpen = true;
            
            // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹ç¶­è­·å‡½æ•¸
            maintainMusicButtonHiddenState();
            
            // ğŸ†• æ–°å¢ï¼šéš±è—é é¢æŒ‡ç¤ºå™¨ï¼ˆç•¶ä»»ä½•æ¨¡æ…‹çª—å£æ‰“é–‹æ™‚ï¼‰
            const pageIndicator = document.querySelector('.page-indicator');
            if (pageIndicator) {
                pageIndicator.style.display = 'none';
                console.log('[ä¸»é¢æ¿] æ¨¡æ…‹çª—å£æ‰“é–‹ï¼Œéš±è—é é¢æŒ‡ç¤ºå™¨');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            
            // ç‰¹æ®Šè™•ç†æ—¥ç¨‹è¡¨æ¨¡æ…‹æ¡†
            if (modalId === 'scheduleModal') {
                modal.style.display = 'none';
                modal.style.opacity = '0';
            } else {
                modal.classList.remove('show');
            }
            
            // æ¢å¤æ»‘åŠ¨
            isModalOpen = false;
            
            // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹ç¶­è­·å‡½æ•¸
            maintainMusicButtonHiddenState();
            
            // ğŸ†• æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–æ¨¡æ…‹çª—å£æ‰“é–‹ï¼Œå¦‚æœæ²’æœ‰å‰‡é‡æ–°é¡¯ç¤ºé é¢æŒ‡ç¤ºå™¨
            const allModals = ['eventModal', 'mapModal', 'anonymousForumModal', 'cpActivityModal', 'chatRoomModal', 'liveRoomModal', 'scheduleModal', 'musicSettingsModal'];
            const hasOpenModal = allModals.some(modalId => {
                const modal = document.getElementById(modalId);
                if (modalId === 'scheduleModal') {
                    return modal && modal.style.display === 'flex';
                } else {
                    return modal && modal.classList.contains('show');
                }
            });
            
            if (!hasOpenModal) {
                const pageIndicator = document.querySelector('.page-indicator');
                if (pageIndicator) {
                    pageIndicator.style.display = 'flex';
                    console.log('[ä¸»é¢æ¿] æ‰€æœ‰æ¨¡æ…‹çª—å£é—œé–‰ï¼Œé‡æ–°é¡¯ç¤ºé é¢æŒ‡ç¤ºå™¨');
                }
            }
        }

        // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            // é˜Ÿå‹ä¿¡æ¯æ¨¡æ€çª—å£
            const teammateModal = document.getElementById('teammateModal');
            if (e.target === teammateModal) {
                closeTeammateModal();
            }

            // åŠŸèƒ½æ¨¡æ€çª—å£
            const modals = ['eventModal', 'mapModal', 'anonymousForumModal', 'cpActivityModal', 'chatRoomModal', 'liveRoomModal', 'scheduleModal', 'musicSettingsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (e.target === modal) {
                    closeModal(modalId);
                }
            });
        });

        // ğŸ”¥ æ–°å¢ï¼šä¿æŒéŸ³æ¨‚æŒ‰éˆ•éš±è—ç‹€æ…‹çš„å‡½æ•¸
        function maintainMusicButtonHiddenState() {
            const musicBtn = document.getElementById('musicControlBtn');
            if (!musicBtn) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¨¡æ…‹çª—å£æ‰“é–‹
            const allModals = ['eventModal', 'mapModal', 'anonymousForumModal', 'cpActivityModal', 'chatRoomModal', 'liveRoomModal', 'scheduleModal', 'musicSettingsModal'];
            const hasOpenModal = allModals.some(modalId => {
                const modal = document.getElementById(modalId);
                if (modalId === 'scheduleModal') {
                    return modal && modal.style.display === 'flex';
                } else {
                    return modal && modal.classList.contains('show');
                }
            });
            
            // æª¢æŸ¥VNé¢æ¿ç‹€æ…‹ - å¦‚æœè™•æ–¼storyç‹€æ…‹ï¼ŒéŸ³æ¨‚æŒ‰éˆ•æ‡‰è©²éš±è—
            const shouldHideForVNStory = vnIframeState === 'story';
            
            // å¦‚æœæœ‰æ¨¡æ…‹çª—å£æ‰“é–‹ã€è¨­ç½®é¢æ¿æ‰“é–‹ï¼Œæˆ–VNé¢æ¿è™•æ–¼storyç‹€æ…‹ï¼Œä¿æŒéŸ³æ¨‚æŒ‰éˆ•éš±è—
            if (hasOpenModal || isSettingsOpen || shouldHideForVNStory) {
                musicBtn.style.display = 'none';
                musicBtn.style.visibility = 'hidden';
                musicBtn.style.opacity = '0';
                musicBtn.style.pointerEvents = 'none';
            } else {
                // åªæœ‰åœ¨æ²’æœ‰ä»»ä½•æ¨¡æ…‹çª—å£ã€è¨­ç½®é¢æ¿éƒ½é—œé–‰ï¼Œä¸”VNé¢æ¿ä¸åœ¨storyç‹€æ…‹æ™‚æ‰é¡¯ç¤º
                musicBtn.style.display = 'flex';
                musicBtn.style.visibility = 'visible';
                musicBtn.style.opacity = '1';
                musicBtn.style.pointerEvents = 'auto';
            }
        }
        
        // ğŸ”¥ æ–°å¢ï¼šç›£è½ç€è¦½å™¨çª—å£å¤§å°è®ŠåŒ–
        window.addEventListener('resize', function() {
            // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿DOMæ›´æ–°å®Œæˆ
            setTimeout(maintainMusicButtonHiddenState, 100);
        });
        
        // ğŸ”¥ æ–°å¢ï¼šç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼ˆåˆ‡æ›æ¨™ç±¤é ï¼‰
        document.addEventListener('visibilitychange', function() {
            // ç•¶é é¢é‡æ–°å¯è¦‹æ™‚ï¼Œæª¢æŸ¥ä¸¦ç¶­æŒéŸ³æ¨‚æŒ‰éˆ•ç‹€æ…‹
            if (!document.hidden) {
                setTimeout(maintainMusicButtonHiddenState, 200);
            }
        });
        
        // ğŸ”¥ æ–°å¢ï¼šç›£è½çª—å£ç„¦é»è®ŠåŒ–
        window.addEventListener('focus', function() {
            setTimeout(maintainMusicButtonHiddenState, 100);
        });
        
        // ğŸ”¥ æ–°å¢ï¼šç›£è½çª—å£å¤±ç„¦è®ŠåŒ–
        window.addEventListener('blur', function() {
            setTimeout(maintainMusicButtonHiddenState, 100);
        });

        // æŠ˜å /å±•å¼€æ—¥ç¨‹è¡¨ï¼ˆåˆ é™¤åŸæœ‰åŠŸèƒ½ï¼‰
        // function toggleSchedule() {
        //     const scheduleContent = document.getElementById('scheduleContent');
        //     const toggleIcon = document.getElementById('scheduleToggle');
        //     
        //     isScheduleExpanded = !isScheduleExpanded;
        //     
        //     if (isScheduleExpanded) {
        //         scheduleContent.classList.add('expanded');
        //         toggleIcon.classList.add('rotated');
        //     } else {
        //         scheduleContent.classList.remove('expanded');
        //         toggleIcon.classList.remove('rotated');
        //     }
        // }

        // æ‰“å¼€æ—¥ç¨‹è¡¨æ¨¡æ€çª—å£
        function openScheduleModal() {
            openModal('scheduleModal');
        }

        // è®¾ç½®èœå•åŠŸèƒ½
        function toggleSettingsMenu() {
            const settingsPanel = document.getElementById('settingsPanel');
            isSettingsOpen = !isSettingsOpen;
            
            if (isSettingsOpen) {
                settingsPanel.classList.add('show');
                showNotification('æ‰“å¼€è®¾ç½®é¢æ¿ âš™ï¸');
                
                // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹ç¶­è­·å‡½æ•¸
                maintainMusicButtonHiddenState();
                
                // ç¡®ä¿è¾“å…¥æ¡†å¯ä»¥æ­£å¸¸å·¥ä½œ
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.settings-content .input-group input');
                    inputs.forEach(input => {
                        input.disabled = false;
                        input.readOnly = false;
                    });
                }, 100);
            } else {
                settingsPanel.classList.remove('show');
                
                // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹ç¶­è­·å‡½æ•¸
                maintainMusicButtonHiddenState();
            }
        }



        // é¢œè‰²é…ç½®
        const colorThemes = {
            container: {
                pink: '#FFB6C1',
                blue: '#87CEEB',
                purple: '#DDA0DD',
                green: '#98FB98',
                orange: '#FFA07A'
            },
            section: {
                light: 'rgba(245, 245, 220, 0.9)',
                white: 'rgba(255, 255, 255, 0.9)',
                cream: 'rgba(255, 248, 220, 0.9)',
                lavender: 'rgba(230, 230, 250, 0.9)',
                mint: 'rgba(240, 255, 240, 0.9)'
            },
            text: {
                dark: '#333333',
                white: '#FFFFFF',
                purple: '#663399',
                blue: '#4169E1',
                pink: '#FF69B4'
            },
            scrollbar: {
                pink: 'rgba(255, 105, 180, 0.6)',
                blue: 'rgba(135, 206, 235, 0.6)',
                purple: 'rgba(221, 160, 221, 0.6)',
                green: 'rgba(152, 251, 152, 0.6)',
                orange: 'rgba(255, 160, 122, 0.6)'
            }
        };

        // æ›´æ”¹å®¹å™¨é¢œè‰²
        function changeContainerColor(color) {
            document.documentElement.style.setProperty('--container-bg', colorThemes.container[color]);
            document.documentElement.style.setProperty('--scrollbar-color', colorThemes.scrollbar[color]);
            updateActiveColorOption('container', color);
            saveColorSettings(); // ä¿å­˜è®¾ç½®
            
            // å¦‚æœæœ‰èƒŒæ™¯åœ–ç‰‡ï¼Œç¢ºä¿èƒŒæ™¯åœ–ç‰‡åœ¨å®¹å™¨é¡è‰²ä¸Šé¢
            const container = document.querySelector('.phone-container');
            if (container && container.classList.contains('has-background')) {
                // ä¿æŒèƒŒæ™¯åœ–ç‰‡è¨­ç½®
                // console.log('[èƒŒæ™¯è¨­ç½®] å®¹å™¨é¡è‰²å·²æ›´æ”¹ï¼Œä¿æŒèƒŒæ™¯åœ–ç‰‡é¡¯ç¤º');
            }
        }

        // æ›´æ”¹æ ç›®é¢œè‰²
        function changeSectionColor(color) {
            document.documentElement.style.setProperty('--section-bg', colorThemes.section[color]);
            updateActiveColorOption('section', color);
            saveColorSettings(); // ä¿å­˜è®¾ç½®
        }

        // æ›´æ”¹å­—ä½“é¢œè‰²
        function changeTextColor(color) {
            document.documentElement.style.setProperty('--text-color', colorThemes.text[color]);
            updateActiveColorOption('text', color);
            saveColorSettings(); // ä¿å­˜è®¾ç½®
        }

        // ä¿å­˜é¢œè‰²è®¾ç½®åˆ°localStorage
        function saveColorSettings() {
            const settings = {
                containerColor: getCurrentActiveColor('container'),
                sectionColor: getCurrentActiveColor('section'),
                textColor: getCurrentActiveColor('text')
            };
            localStorage.setItem('customTraineeColors', JSON.stringify(settings));
            
            // æ˜¾ç¤ºä¿å­˜æç¤º
            showNotification('é¢œè‰²è®¾ç½®å·²ä¿å­˜ âœ¨');
        }

        // è·å–å½“å‰æ¿€æ´»çš„é¢œè‰²
        function getCurrentActiveColor(type) {
            const activeElement = document.querySelector(`[data-${type}].active`);
            return activeElement ? activeElement.getAttribute(`data-${type}`) : null;
        }

        // ä»localStorageåŠ è½½é¢œè‰²è®¾ç½®
        function loadColorSettings() {
            try {
                const saved = localStorage.getItem('customTraineeColors');
                if (saved) {
                    const settings = JSON.parse(saved);
                    
                    // åº”ç”¨ä¿å­˜çš„é¢œè‰²
                    if (settings.containerColor && colorThemes.container[settings.containerColor]) {
                        document.documentElement.style.setProperty('--container-bg', colorThemes.container[settings.containerColor]);
                        document.documentElement.style.setProperty('--scrollbar-color', colorThemes.scrollbar[settings.containerColor]);
                        updateActiveColorOption('container', settings.containerColor);
                    }
                    
                    if (settings.sectionColor && colorThemes.section[settings.sectionColor]) {
                        document.documentElement.style.setProperty('--section-bg', colorThemes.section[settings.sectionColor]);
                        updateActiveColorOption('section', settings.sectionColor);
                    }
                    
                    if (settings.textColor && colorThemes.text[settings.textColor]) {
                        document.documentElement.style.setProperty('--text-color', colorThemes.text[settings.textColor]);
                        updateActiveColorOption('text', settings.textColor);
                    }
                    
                    // console.log('å·²åŠ è½½ä¿å­˜çš„é¢œè‰²è®¾ç½®:', settings);
                    return true;
                }
            } catch (error) {
                console.error('åŠ è½½é¢œè‰²è®¾ç½®å¤±è´¥:', error);
            }
            return false;
        }

        // æ›´æ–°æ´»è·ƒé¢œè‰²é€‰é¡¹
        function updateActiveColorOption(type, color) {
            // ç§»é™¤åŒç±»å‹æ‰€æœ‰é€‰é¡¹çš„activeç±»
            document.querySelectorAll(`[data-${type}]`).forEach(option => {
                option.classList.remove('active');
            });
            // ä¸ºå½“å‰é€‰é¡¹æ·»åŠ activeç±»
            document.querySelector(`[data-${type}="${color}"]`).classList.add('active');
        }

        // æ¢å¤é»˜è®¤è®¾ç½®
        function resetToDefault() {
            // æ¸…é™¤localStorage
            localStorage.removeItem('customTraineeColors');
            
            // æ¢å¤é»˜è®¤CSSå˜é‡
            document.documentElement.style.setProperty('--container-bg', '#FFB6C1');
            document.documentElement.style.setProperty('--section-bg', 'rgba(255, 255, 255, 0.9)');
            document.documentElement.style.setProperty('--text-color', '#333333');
            document.documentElement.style.setProperty('--scrollbar-color', 'rgba(255, 105, 180, 0.6)');
            
            // é‡ç½®æ‰€æœ‰activeçŠ¶æ€
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // è®¾ç½®é»˜è®¤activeçŠ¶æ€
            updateActiveColorOption('container', 'pink');
            updateActiveColorOption('section', 'white');
            updateActiveColorOption('text', 'dark');
            
            // æ˜¾ç¤ºæ¢å¤æç¤º
            showNotification('å·²æ¢å¤é»˜è®¤è®¾ç½® ğŸ”„');
            // console.log('å·²æ¢å¤é»˜è®¤è®¾ç½®å¹¶æ¸…é™¤æœ¬åœ°å­˜å‚¨');
        }

        // åˆå§‹åŒ–é»˜è®¤é¢œè‰²çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆå°è¯•åŠ è½½ä¿å­˜çš„è®¾ç½®
            const hasLoadedSettings = loadColorSettings();
            const hasLoadedNames = themeManager.loadNameSettings();
            
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®
            if (!hasLoadedSettings) {
                updateActiveColorOption('container', 'pink');
                updateActiveColorOption('section', 'white');
                updateActiveColorOption('text', 'dark');
                // console.log('ä½¿ç”¨é»˜è®¤é¢œè‰²è®¾ç½®');
            } else {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                setTimeout(() => {
                    showNotification('å·²åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„é¢œè‰²è®¾ç½® ğŸ¨');
                }, 500);
            }
            
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åç§°è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®
            if (!hasLoadedNames) {
                // console.log('ä½¿ç”¨é»˜è®¤åç§°è®¾ç½®');
            } else {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                setTimeout(() => {
                    showNotification('å·²åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„åç§°è®¾ç½® ğŸ“');
                }, 800);
            }
            
            // åˆå§‹åŒ–ç¾å¯¦æ™‚é–“æ›´æ–°
            initRealTimeUpdate();
                    
        });

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2500);
        }

        // åŠŸèƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä¿®æ”¹ä¸ºæ‰“å¼€æ¨¡æ€çª—å£
        // æ·»åŠ Toasté€šçŸ¥å‡½æ•°
        function showSuccessToast(message) {
            console.log('[æˆåŠŸ]', message);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´ç¾è§‚çš„æç¤º
            alert('âœ… ' + message);
        }
        
        function showErrorToast(message) {
            console.error('[é”™è¯¯]', message);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´ç¾è§‚çš„æç¤º
            alert('âŒ ' + message);
        }



        function openLorebookManagerModal() {
            // ç›´æ¥è°ƒç”¨ä¸–ç•Œä¹¦ç®¡ç†å™¨åŠŸèƒ½
            if (typeof window.openLorebookManagerModalFromLibrary === 'function') {
                window.openLorebookManagerModalFromLibrary();
            } else {
                // å¦‚æœä¸–ç•Œä¹¦ç®¡ç†å™¨æœªåŠ è½½ï¼Œæ˜¾ç¤ºæç¤º
                alert('ä¸–ç•Œæ›¸ç®¡ç†å™¨æ­£åœ¨åŠ è¼‰ä¸­...');
            }
        }

        function openEvent() {
            openModal('eventModal');
        }

        // åˆå§‹åŒ–ç»Ÿä¸€é€šè®¯æ ¸å¿ƒ
        // UnifiedCommCore å·²ç”± communication_manager.js è¨­ç½®ç‚º window å°è±¡
        
        function openMap() {
            openModal('mapModal');
            
            // å‹•æ…‹è¨­ç½®iframe src
            const iframe = document.getElementById('mapPanelIframe');
            if (iframe) {
                // æ¯æ¬¡éƒ½é‡æ–°åŠ è¼‰åœ°åœ–é¢æ¿ï¼Œç¢ºä¿é‡æ–°åˆå§‹åŒ–
                iframe.src = 'map/map-panel.html';
                
                // ç­‰å¾…iframeåŠ è¼‰å®Œæˆå¾Œç™¼é€é‡ç½®æ¶ˆæ¯
                iframe.onload = function() {
                    // console.log('[ä¸»é¢æ¿] åœ°åœ–é¢æ¿å·²é‡æ–°åŠ è¼‰');
                    // ç™¼é€é‡ç½®æ¶ˆæ¯çµ¦åœ°åœ–é¢æ¿
                    setTimeout(() => {
                        if (iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                type: 'RESET_MAP_PANEL',
                                source: 'MAIN_PANEL_OPEN_MAP',
                                timestamp: Date.now()
                            }, '*');
                        }
                    }, 100);
                };
            }
            
            // é€šçŸ¥åœ°å›¾é¢æ¿å·²æ‰“å¼€
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('map');
            }
        }

        function openAnonymousForum() {
            openModal('anonymousForumModal');
            
            // å‹•æ…‹è¨­ç½®iframe src
            const iframe = document.getElementById('forumPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'forum/forum_panel.html';
            }
            
            // ğŸ”¥ æ–°å¢ï¼šå»¶é²ç™¼é€iframeé¡¯ç¤ºæ¶ˆæ¯ï¼Œç¢ºä¿iframeå·²è¼‰å…¥
            setTimeout(() => {
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'IFRAME_SHOWN',
                        target: 'forum',
                        timestamp: Date.now()
                    }, '*');
                    console.log('[ä¸»é¢æ¿] å·²ç™¼é€FORUM iframeé¡¯ç¤ºæ¶ˆæ¯');
                }
            }, 500);
            
            // é€šçŸ¥Forumé¢æ¿å·²æ‰“å¼€
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('forum');
            }
        }

        function openCPActivity() {
            openModal('cpActivityModal');
            
            // å‹•æ…‹è¨­ç½®iframe src
            const iframe = document.getElementById('echoPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'echo/echo_panel.html';
            }
            
            // ğŸ”¥ æ–°å¢ï¼šå»¶é²ç™¼é€iframeé¡¯ç¤ºæ¶ˆæ¯ï¼Œç¢ºä¿iframeå·²è¼‰å…¥
            setTimeout(() => {
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'IFRAME_SHOWN',
                        target: 'echo',
                        timestamp: Date.now()
                    }, '*');
                    console.log('[ä¸»é¢æ¿] å·²ç™¼é€ECHO iframeé¡¯ç¤ºæ¶ˆæ¯');
                }
            }, 500);
            
            // é€šçŸ¥Echoé¢æ¿å·²æ‰“å¼€
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('echo');
            }
        }

        function openChatRoom() {
            openModal('chatRoomModal');
            
            // å‹•æ…‹è¨­ç½®iframe src
            const iframe = document.getElementById('chatPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'chat/chat_panel.html';
            }
            
            // ğŸ”¥ æ–°å¢ï¼šå»¶é²ç™¼é€iframeé¡¯ç¤ºæ¶ˆæ¯ï¼Œç¢ºä¿iframeå·²è¼‰å…¥
            setTimeout(() => {
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'IFRAME_SHOWN',
                        target: 'chat',
                        timestamp: Date.now()
                    }, '*');
                    console.log('[ä¸»é¢æ¿] å·²ç™¼é€CHAT iframeé¡¯ç¤ºæ¶ˆæ¯');
                }
            }, 500);
            
            // ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥CHATè™•ç†å™¨é–‹å§‹æƒæèŠå¤©å…§å®¹
            notifyChatProcessorToScan();
            
            // é€šçŸ¥èŠå¤©é¢æ¿å·²æ‰“å¼€
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('chat');
            }
        }
        
        // ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥CHATè™•ç†å™¨é–‹å§‹æƒæèŠå¤©å…§å®¹
        function notifyChatProcessorToScan() {
            try {
                console.log('[MAINé¢æ¿] é€šçŸ¥CHATè™•ç†å™¨é–‹å§‹æƒæèŠå¤©å…§å®¹');
                
                // æ–¹æ³•1ï¼šç›´æ¥å‘çˆ¶çª—å£ç™¼é€æ¶ˆæ¯ï¼ˆå¦‚æœCHATè™•ç†å™¨åœ¨çˆ¶çª—å£ï¼‰
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'CHAT_FETCH_HISTORY_LIST',
                        source: 'MAIN_PANEL',
                        timestamp: Date.now()
                    }, '*');
                }
                
                // æ–¹æ³•2ï¼šå‘æ‰€æœ‰iframeå»£æ’­æ¶ˆæ¯
                const allIframes = document.querySelectorAll('iframe');
                allIframes.forEach(iframe => {
                    try {
                        if (iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                type: 'CHAT_FETCH_HISTORY_LIST',
                                source: 'MAIN_PANEL',
                                timestamp: Date.now()
                            }, '*');
                        }
                    } catch (error) {
                        // å¿½ç•¥è·¨åŸŸéŒ¯èª¤
                    }
                });
                
                // æ–¹æ³•3ï¼šå‘é ‚å±¤çª—å£ç™¼é€æ¶ˆæ¯
                if (window.top && window.top !== window) {
                    window.top.postMessage({
                        type: 'CHAT_FETCH_HISTORY_LIST',
                        source: 'MAIN_PANEL',
                        timestamp: Date.now()
                    }, '*');
                }
                
                console.log('[MAINé¢æ¿] âœ… å·²ç™¼é€CHATæƒæè«‹æ±‚');
                
            } catch (error) {
                console.error('[MAINé¢æ¿] é€šçŸ¥CHATè™•ç†å™¨å¤±æ•—:', error);
            }
        }
        
        // ğŸ”¥ æ–°å¢ï¼šè™•ç†CHATè™•ç†å™¨è¿”å›çš„èŠå¤©æ­·å²åˆ—è¡¨
        function handleChatHistoryList(data) {
            try {
                console.log('[MAINé¢æ¿] è™•ç†èŠå¤©æ­·å²åˆ—è¡¨æ•¸æ“š:', data);
                
                if (data && data.data && data.data.chatList) {
                    const chatList = data.data.chatList;
                    const totalCount = data.data.totalCount;
                    
                    console.log(`[MAINé¢æ¿] æ”¶åˆ° ${totalCount} å€‹èŠå¤©å®¤æ•¸æ“š`);
                    
                    // æ›´æ–°èŠå¤©å®¤æŒ‰éˆ•çš„æœªè®€è¨ˆæ•¸é¡¯ç¤º
                    updateChatButtonUnreadCount(chatList);
                    
                    // å¯ä»¥æ ¹æ“šéœ€è¦é€²ä¸€æ­¥è™•ç†èŠå¤©æ•¸æ“š
                    // ä¾‹å¦‚ï¼šé¡¯ç¤ºèŠå¤©å®¤é è¦½ã€æ›´æ–°UIç­‰
                    
                } else {
                    console.warn('[MAINé¢æ¿] èŠå¤©æ­·å²åˆ—è¡¨æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                }
                
            } catch (error) {
                console.error('[MAINé¢æ¿] è™•ç†èŠå¤©æ­·å²åˆ—è¡¨å¤±æ•—:', error);
            }
        }
        
        // ğŸ†• æ–°å¢ï¼šè½‰ç™¼æ¶ˆæ¯çµ¦åœ°åœ–é¢æ¿
        function forwardMessageToMapPanel(messageData) {
            try {
                const mapIframe = document.getElementById('mapPanelIframe');
                if (mapIframe && mapIframe.contentWindow) {
                    // æª¢æŸ¥åœ°åœ–é¢æ¿æ˜¯å¦å·²è¼‰å…¥
                    if (mapIframe.src === 'about:blank' || mapIframe.src.includes('about:blank')) {
                        console.log('[ä¸»é¢æ¿] åœ°åœ–é¢æ¿å°šæœªè¼‰å…¥ï¼Œå»¶é²è½‰ç™¼æ¶ˆæ¯');
                        // å»¶é²è½‰ç™¼ï¼Œç­‰å¾…åœ°åœ–é¢æ¿è¼‰å…¥
                        setTimeout(() => {
                            forwardMessageToMapPanel(messageData);
                        }, 1000);
                        return;
                    }
                    
                    // è½‰ç™¼æ¶ˆæ¯çµ¦åœ°åœ–é¢æ¿
                    mapIframe.contentWindow.postMessage(messageData, '*');
                    console.log('[ä¸»é¢æ¿] å·²è½‰ç™¼æ¶ˆæ¯çµ¦åœ°åœ–é¢æ¿:', messageData.type);
                } else {
                    console.warn('[ä¸»é¢æ¿] æ‰¾ä¸åˆ°åœ°åœ–é¢æ¿iframeæˆ–contentWindowä¸å¯ç”¨');
                }
            } catch (error) {
                console.error('[ä¸»é¢æ¿] è½‰ç™¼æ¶ˆæ¯çµ¦åœ°åœ–é¢æ¿å¤±æ•—:', error);
            }
        }

        // ğŸ”¥ æ–°å¢ï¼šè½‰ç™¼æ¶ˆæ¯çµ¦Forumé¢æ¿
        function forwardMessageToForumPanel(messageData) {
            try {
                const forumIframe = document.getElementById('forumPanelIframe');
                if (forumIframe && forumIframe.contentWindow) {
                    // æª¢æŸ¥Forumé¢æ¿æ˜¯å¦å·²è¼‰å…¥
                    if (forumIframe.src === 'about:blank' || forumIframe.src.includes('about:blank')) {
                        console.log('[ä¸»é¢æ¿] Forumé¢æ¿å°šæœªè¼‰å…¥ï¼Œå»¶é²è½‰ç™¼æ¶ˆæ¯');
                        // å»¶é²è½‰ç™¼ï¼Œç­‰å¾…Forumé¢æ¿è¼‰å…¥
                        setTimeout(() => {
                            forwardMessageToForumPanel(messageData);
                        }, 1000);
                        return;
                    }
                    
                    // è½‰ç™¼æ¶ˆæ¯çµ¦Forumé¢æ¿
                    forumIframe.contentWindow.postMessage(messageData, '*');
                    console.log('[ä¸»é¢æ¿] å·²è½‰ç™¼æ¶ˆæ¯çµ¦Forumé¢æ¿:', messageData.type);
                } else {
                    console.warn('[ä¸»é¢æ¿] æ‰¾ä¸åˆ°Forumé¢æ¿iframeæˆ–contentWindowä¸å¯ç”¨');
                }
            } catch (error) {
                console.error('[ä¸»é¢æ¿] è½‰ç™¼æ¶ˆæ¯çµ¦Forumé¢æ¿å¤±æ•—:', error);
            }
        }
        
        // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°èŠå¤©å®¤æŒ‰éˆ•çš„æœªè®€è¨ˆæ•¸é¡¯ç¤º
        function updateChatButtonUnreadCount(chatList) {
            try {
                // è¨ˆç®—ç¸½æœªè®€è¨ˆæ•¸
                let totalUnreadCount = 0;
                chatList.forEach(chat => {
                    if (chat.unreadCount && chat.unreadCount > 0) {
                        totalUnreadCount += chat.unreadCount;
                    }
                });
                
                // æ‰¾åˆ°èŠå¤©å®¤æŒ‰éˆ•
                const chatButton = document.querySelector('.nav-button.chat-room');
                if (chatButton) {
                    // ç§»é™¤ç¾æœ‰çš„æœªè®€è¨ˆæ•¸æ¨™ç±¤
                    const existingBadge = chatButton.querySelector('.unread-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // å¦‚æœæœ‰æœªè®€æ¶ˆæ¯ï¼Œæ·»åŠ æœªè®€è¨ˆæ•¸æ¨™ç±¤
                    if (totalUnreadCount > 0) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.textContent = totalUnreadCount > 99 ? '99+' : totalUnreadCount;
                        badge.style.cssText = `
                            position: absolute;
                            top: -5px;
                            right: -5px;
                            background: #ff4757;
                            color: white;
                            border-radius: 50%;
                            min-width: 20px;
                            height: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: bold;
                            z-index: 10;
                        `;
                        
                        // ç¢ºä¿æŒ‰éˆ•æœ‰ç›¸å°å®šä½
                        chatButton.style.position = 'relative';
                        chatButton.appendChild(badge);
                        
                        console.log(`[MAINé¢æ¿] å·²æ›´æ–°èŠå¤©å®¤æŒ‰éˆ•æœªè®€è¨ˆæ•¸: ${totalUnreadCount}`);
                    }
                }
                
            } catch (error) {
                console.error('[MAINé¢æ¿] æ›´æ–°èŠå¤©å®¤æŒ‰éˆ•æœªè®€è¨ˆæ•¸å¤±æ•—:', error);
            }
        }
        
        // ğŸ”¥ æ–°å¢ï¼šè¨­ç½®eventOnButtonç¶å®š
        function setupEventOnButtonBindings() {
            try {
                // æª¢æŸ¥eventOnButtonæ˜¯å¦å¯ç”¨
                if (typeof eventOnButton === 'function') {
                    console.log('[MAINé¢æ¿] è¨­ç½®eventOnButtonç¶å®š...');
                    
                    // ç¶å®šèŠå¤©ICONæŒ‰éˆ•
                    eventOnButton('ğŸ’¬', function() {
                        console.log('[MAINé¢æ¿] é€šéeventOnButtonè§¸ç™¼èŠå¤©å®¤æ‰“é–‹');
                        openChatRoom();
                    });
                    
                    // ç¶å®šå…¶ä»–ICONæŒ‰éˆ•ï¼ˆå¯é¸ï¼‰
                    eventOnButton('ğŸ—ºï¸', function() {
                        console.log('[MAINé¢æ¿] é€šéeventOnButtonè§¸ç™¼åœ°åœ–æ‰“é–‹');
                        openMap();
                    });
                    
                    eventOnButton('ğŸ“º', function() {
                        console.log('[MAINé¢æ¿] é€šéeventOnButtonè§¸ç™¼VNé¢æ¿æ‰“é–‹');
                        openVNPanel();
                    });
                    
                    eventOnButton('ğŸ“¢', function() {
                        console.log('[MAINé¢æ¿] é€šéeventOnButtonè§¸ç™¼Echoé¢æ¿æ‰“é–‹');
                        openEchoPanel();
                    });
                    
                    eventOnButton('ğŸ“±', function() {
                        console.log('[MAINé¢æ¿] é€šéeventOnButtonè§¸ç™¼ç›´æ’­é–“æ‰“é–‹');
                        openLiveRoom();
                    });
                    
                    console.log('[MAINé¢æ¿] âœ… eventOnButtonç¶å®šè¨­ç½®å®Œæˆ');
                } else {
                    console.log('[MAINé¢æ¿] eventOnButtonä¸å¯ç”¨ï¼Œè·³éç¶å®šè¨­ç½®');
                }
                
            } catch (error) {
                console.error('[MAINé¢æ¿] è¨­ç½®eventOnButtonç¶å®šå¤±æ•—:', error);
            }
        }

        function openLiveRoom() {
            openModal('liveRoomModal');
            
            // å‹•æ…‹è¨­ç½®iframe src
            const iframe = document.getElementById('livestreamPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'livestream/livestream_panel.html';
            }
            
            // é€šçŸ¥ç›´æ’­é¢æ¿å·²æ‰“å¼€
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('livestream');
            }
        }

        // ç»Ÿä¸€çš„DOMContentLoadedäº‹ä»¶å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é€šè®¯ç®¡ç†å™¨
            if (typeof UnifiedCommunicationCore !== 'undefined' && !window.UnifiedCommCore) {
                window.UnifiedCommCore = new UnifiedCommunicationCore();
                // console.log('[ä¸»é¢æ¿] ç»Ÿä¸€é€šè®¯æ ¸å¿ƒå·²åˆå§‹åŒ–');
            }
            
            // å‹•æ…‹åŠ è¼‰VNé¢æ¿
            const vnIframe = document.getElementById('vnPanelIframe');
            if (vnIframe && vnIframe.src === 'about:blank') {
                vnIframe.src = 'vn/vn_panel.html';
                // è¨­ç½®åˆå§‹ç‹€æ…‹ç‚ºlanding
                resizeVNIframe('landing');
            }
            
            // æ·»åŠ æŒ‰é’®äº¤äº’æ•ˆæœ
            const buttons = document.querySelectorAll('.nav-button');
            
            buttons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
            
            // ğŸ”¥ æ–°å¢ï¼šè¨­ç½®eventOnButtonç¶å®šï¼ˆå¦‚æœå¯ç”¨ï¼‰
            setupEventOnButtonBindings();

            // æ·»åŠ iframeæ¶ˆæ¯ç›‘å¬å™¨
            window.addEventListener('message', function(event) {
                // console.log('[ä¸»é¢æ¿] æ”¶åˆ°iframeæ¶ˆæ¯:', event.data);
                
                // å¤„ç†æ¥è‡ªå„ä¸ªé¢æ¿çš„æ¶ˆæ¯
                if (event.data && event.data.type) {
                    switch (event.data.type) {
                        case 'PANEL_READY':
                            // console.log('[ä¸»é¢æ¿] é¢æ¿å·²å‡†å¤‡å°±ç»ª:', event.data.panel);
                            break;
                        case 'PANEL_CLOSE':
                            // console.log('[ä¸»é¢æ¿] é¢æ¿è¯·æ±‚å…³é—­:', event.data.panel);
                            closeModal(event.data.panel + 'Modal');
                            break;
                        case 'REQUEST_DATA':
                            // console.log('[ä¸»é¢æ¿] æ”¶åˆ°æ•°æ®è¯·æ±‚:', event.data);
                            // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†æ•°æ®è¯·æ±‚
                            break;
                        case 'CLOSE_MAP_PANEL':
                            // console.log('[ä¸»é¢æ¿] å…³é—­åœ°å›¾é¢æ¿');
                            closeModal('mapModal');
                            break;
                        case 'GO_TO_MAIN_HOME':
                            // console.log('[ä¸»é¢æ¿] è¿”å›ä¸»é¡µé¢');
                            // å…³é—­åœ°å›¾é¢æ¿å¹¶æ˜¾ç¤ºä¸»é¡µé¢
                            closeModal('mapModal');
                            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–ä¸»é¡µé¢é€»è¾‘
                            break;
                        case 'GO_TO_VN_PANEL':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°è·³è½‰VNé¢æ¿è«‹æ±‚');
                            // é—œé–‰åœ°åœ–é¢æ¿
                            closeModal('mapModal');
                            // è·³è½‰åˆ°VNé¢æ¿ï¼ˆç¬¬0é ï¼‰
                            setTimeout(() => {
                                goToPage(0);
                                console.log('[ä¸»é¢æ¿] å·²è·³è½‰åˆ°VNé¢æ¿');
                            }, 500); // å»¶é²500msç¢ºä¿åœ°åœ–é¢æ¿å·²é—œé–‰
                            break;
                        case 'VN_IFRAME_RESIZE':
                            // console.log('[ä¸»é¢æ¿] VNé¢æ¿iframeå°ºå¯¸ç«‹å³èª¿æ•´:', event.data.state);
                            // ç«‹å³åŸ·è¡Œï¼Œä¸ä½¿ç”¨setTimeoutï¼Œå„ªå…ˆç´šæœ€é«˜
                            requestAnimationFrame(() => {
                                resizeVNIframe(event.data.state);
                            });
                            break;
                        // ğŸ”¥ æ–°å¢ï¼šè™•ç†CHATè™•ç†å™¨çš„å›æ‡‰
                        case 'CHAT_HISTORY_LIST':
                            console.log('[MAINé¢æ¿] æ”¶åˆ°CHATè™•ç†å™¨çš„èŠå¤©æ­·å²åˆ—è¡¨:', event.data);
                            handleChatHistoryList(event.data);
                            break;
                        case 'VN_STOP_MAIN_MUSIC':
                            // console.log('[ä¸»é¢æ¿] VNé¢æ¿è«‹æ±‚åœæ­¢éŸ³æ¨‚');
                            // ğŸ”¥ æ–°å¢ï¼šVNé¢æ¿é–‹å•ŸåŠ‡æƒ…æ™‚è‡ªå‹•åœæ­¢éŸ³æ¨‚
                            if (isMusicPlaying) {
                                stopMusic();
                                // console.log('[ä¸»é¢æ¿] å·²è‡ªå‹•åœæ­¢éŸ³æ¨‚ï¼ˆVNåŠ‡æƒ…æ¨¡å¼ï¼‰');
                                showNotification('VNåŠ‡æƒ…æ¨¡å¼å·²å•Ÿå‹•ï¼ŒéŸ³æ¨‚å·²è‡ªå‹•åœæ­¢', 'info');
                            }
                            break;
                        case 'VN_RESUME_MAIN_MUSIC':
                            // console.log('[ä¸»é¢æ¿] VNé¢æ¿è«‹æ±‚æ¢å¾©éŸ³æ¨‚');
                            // ğŸ”¥ æ–°å¢ï¼šVNé¢æ¿è¿”å›å•Ÿå‹•é é¢æ™‚è‡ªå‹•æ¢å¾©éŸ³æ¨‚
                            if (!isMusicPlaying) {
                                playMusic();
                                // console.log('[ä¸»é¢æ¿] å·²è‡ªå‹•æ¢å¾©éŸ³æ¨‚ï¼ˆVNå•Ÿå‹•é é¢ï¼‰');
                                showNotification('VNå•Ÿå‹•é é¢å·²é¡¯ç¤ºï¼ŒéŸ³æ¨‚å·²è‡ªå‹•æ¢å¾©', 'info');
                            }
                            break;
                        case 'ECHO_PANEL_READY':
                            // console.log('[ä¸»é¢æ¿] Echoé¢æ¿å·²å‡†å¤‡å°±ç»ªï¼Œè½¬å‘æ¶ˆæ¯åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼ECHOé¢æ¿çš„æº–å‚™å°±ç·’ä¿¡è™Ÿåˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'ECHO_DATA':
                            // console.log('[ä¸»é¢æ¿] æ”¶åˆ°Echoæ•¸æ“šï¼Œè½¬å‘åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼ECHOæ•¸æ“šåˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'ECHO_USER_COMMENT':
                            // console.log('[ä¸»é¢æ¿] æ”¶åˆ°Echoç”¨æˆ¶è©•è«–ï¼Œè½¬å‘åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼ECHOç”¨æˆ¶è©•è«–åˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'ECHO_DELETE_COMMENT':
                            // console.log('[ä¸»é¢æ¿] æ”¶åˆ°Echoåˆªé™¤è©•è«–è«‹æ±‚ï¼Œè½¬å‘åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼ECHOåˆªé™¤è©•è«–è«‹æ±‚åˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'MAIN_PANEL_DATA':
                            // console.log('[ä¸»é¢æ¿] æ”¶åˆ°ä¸»é¢æ¿æ•¸æ“š:', event.data);
                            // è½‰ç™¼ä¸»é¢æ¿æ•¸æ“šåˆ°ç›£è½å™¨
                            if (window.mainListener && typeof window.mainListener.handleMainPanelData === 'function') {
                                window.mainListener.handleMainPanelData(event.data);
                            } else {
                                // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥è§¸ç™¼äº‹ä»¶
                                window.dispatchEvent(new CustomEvent('MAIN_PANEL_DATA_RECEIVED', {
                                    detail: event.data
                                }));
                            }
                            break;
                        // ğŸ†• æ–°å¢ï¼šè™•ç†CHATé¢æ¿é é¢ç‹€æ…‹è®ŠåŒ–
                        case 'CHAT_PAGE_STATE_CHANGE':
                            console.log('[ä¸»é¢æ¿] Chaté¢æ¿é é¢ç‹€æ…‹è®ŠåŒ–:', event.data);
                            handleChatPageStateChange(event.data);
                            break;
                        // ğŸ†• æ–°å¢ï¼šè™•ç†ä¾†è‡ªmap_processor.jsçš„æ¶ˆæ¯ä¸¦è½‰ç™¼çµ¦åœ°åœ–é¢æ¿
                        case 'MAP_LOCATION_DATA':
                        case 'NEWS_BROADCAST_DATA':
                        case 'STORY_OPTIONS_DATA':
                        case 'MAP_PROCESSOR_READY':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°map_processoræ¶ˆæ¯ï¼Œè½‰ç™¼çµ¦åœ°åœ–é¢æ¿:', event.data.type);
                            forwardMessageToMapPanel(event.data);
                            break;
                        case 'SEND_MESSAGE_TO_CHAT':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°ç™¼é€æ¶ˆæ¯åˆ°èŠå¤©å®¤è«‹æ±‚:', event.data.message);
                            // ğŸ†• è½‰ç™¼æ¶ˆæ¯åˆ°èŠå¤©é¢æ¿
                            const chatIframe = document.getElementById('chatPanelIframe');
                            if (chatIframe && chatIframe.contentWindow) {
                                chatIframe.contentWindow.postMessage({
                                    type: 'SEND_MESSAGE_TO_CHAT',
                                    message: event.data.message,
                                    source: event.data.source,
                                    timestamp: event.data.timestamp
                                }, '*');
                                console.log('[ä¸»é¢æ¿] å·²è½‰ç™¼æ¶ˆæ¯åˆ°èŠå¤©é¢æ¿');
                            } else {
                                console.warn('[ä¸»é¢æ¿] æ‰¾ä¸åˆ°èŠå¤©é¢æ¿iframe');
                            }
                            break;
                        // ğŸ”¥ æ–°å¢ï¼šè™•ç†ä¾†è‡ªé…’é¤¨AIçš„Forumæ¶ˆæ¯
                        case 'forum_message':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°ä¾†è‡ªé…’é¤¨AIçš„Forumæ¶ˆæ¯:', event.data.message);
                            // è½‰ç™¼Forumæ¶ˆæ¯åˆ°Forumé¢æ¿
                            forwardMessageToForumPanel({
                                type: 'forum_message',
                                message: event.data.message,
                                source: event.data.source || 'tavern',
                                timestamp: event.data.timestamp || Date.now()
                            });
                            break;
                        // ğŸ”¥ æ–°å¢ï¼šè™•ç†Forumç›¸é—œæ¶ˆæ¯
                        case 'FORUM_PANEL_READY':
                            console.log('[ä¸»é¢æ¿] Forumé¢æ¿å·²æº–å‚™å°±ç·’ï¼Œè½‰ç™¼æ¶ˆæ¯åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼Forumé¢æ¿çš„æº–å‚™å°±ç·’ä¿¡è™Ÿåˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_DATA_UPDATE':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°Forumæ•¸æ“šæ›´æ–°ï¼Œè½‰ç™¼åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼Forumæ•¸æ“šåˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_USER_POST':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°Forumç”¨æˆ¶ç™¼å¸–ï¼Œè½‰ç™¼åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼Forumç”¨æˆ¶ç™¼å¸–åˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_USER_REPLY':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°Forumç”¨æˆ¶è©•è«–ï¼Œè½‰ç™¼åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼Forumç”¨æˆ¶è©•è«–åˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_DELETE_POST':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°Forumåˆªé™¤å¸–å­è«‹æ±‚ï¼Œè½‰ç™¼åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼Forumåˆªé™¤å¸–å­è«‹æ±‚åˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_DELETE_REPLY':
                            console.log('[ä¸»é¢æ¿] æ”¶åˆ°Forumåˆªé™¤è©•è«–è«‹æ±‚ï¼Œè½‰ç™¼åˆ°çˆ¶çª—å£');
                            // è½‰ç™¼Forumåˆªé™¤è©•è«–è«‹æ±‚åˆ°çˆ¶çª—å£ï¼ˆé…’é¤¨AIï¼‰
                            window.parent.postMessage(event.data, '*');
                            break;
                        default:
                            // console.log('[ä¸»é¢æ¿] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', event.data.type);
                    }
                }
            });
        });

        // éŸ³ä¹æ§åˆ¶å‡½æ•°
        function toggleMusic() {
            initBackgroundMusic();
            
            if (isMusicPlaying) {
                stopMusic();
            } else {
                playMusic();
            }
            
            // æ›´æ–°æ’­æ”¾/æš«åœæŒ‰éˆ•ç‹€æ…‹
            const playPauseIcon = document.getElementById('playPauseIcon');
            if (playPauseIcon) {
                playPauseIcon.src = isMusicPlaying ? 'https://files.catbox.moe/a3rofp.png' : 'https://files.catbox.moe/pwv6aw.png';
                playPauseIcon.alt = isMusicPlaying ? 'æš«åœ' : 'æ’­æ”¾';
            }
        }

        function playMusic() {
            if (audioElement) {
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // æ’­æ”¾æˆåŠŸï¼Œäº‹ä»¶ç›£è½å™¨æœƒè™•ç†ç‹€æ…‹æ›´æ–°
                    }).catch(error => {
                        console.error('[ä¸»é¢æ¿] èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', error);
                        showNotification('è«‹æ‰‹å‹•é»æ“Šæ’­æ”¾æŒ‰éˆ•ä»¥é–‹å§‹èƒŒæ™¯éŸ³æ¨‚', 'warning');
                    });
                }
            }
        }

        function stopMusic() {
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
            }
            isMusicPlaying = false;
            updateMusicButtonState();
            showNotification('éŸ³æ¨‚å·²åœæ­¢', 'info');
        }

        function updateMusicButtonState() {
            const musicBtn = document.getElementById('musicControlBtn');
            const musicIcon = document.getElementById('musicIcon');
            
            if (!musicBtn || !musicIcon) {
                console.warn('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚æŒ‰éˆ•æˆ–åœ–æ¨™å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // console.log('[éŸ³æ¨‚ç³»çµ±] æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼Œæ’­æ”¾ç‹€æ…‹:', isMusicPlaying);
            
            if (isMusicPlaying) {
                musicBtn.classList.add('playing');
                musicBtn.style.background = 'rgba(76, 175, 80, 0.9)';
                musicBtn.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.3)';
                        musicIcon.style.animation = 'musicRotate 2s linear infinite';
        musicIcon.style.filter = 'brightness(0) invert(1)';
                // console.log('[éŸ³æ¨‚ç³»çµ±] è¨­ç½®ç‚ºæ’­æ”¾ç‹€æ…‹');
            } else {
                musicBtn.classList.remove('playing');
                musicBtn.style.background = 'rgba(255, 107, 157, 0.9)';
                musicBtn.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                        musicIcon.style.animation = 'none';
        musicIcon.style.filter = 'brightness(0) invert(1)';
                // console.log('[éŸ³æ¨‚ç³»çµ±] è¨­ç½®ç‚ºåœæ­¢ç‹€æ…‹');
            }
            
            // åŒæ­¥æ›´æ–°éŸ³æ¨‚è¨­ç½®ç•Œé¢ä¸­çš„æ’­æ”¾æŒ‰éˆ•ç‹€æ…‹
            const playPauseIcon = document.getElementById('playPauseIcon');
            if (playPauseIcon) {
                playPauseIcon.src = isMusicPlaying ? 'https://files.catbox.moe/a3rofp.png' : 'https://files.catbox.moe/3ou5xd.png';
                playPauseIcon.alt = isMusicPlaying ? 'æš«åœ' : 'æ’­æ”¾';
            }
        }

        // é€²åº¦æ¢ç›¸é—œå‡½æ•¸
        function updateProgressBar() {
            if (!audioElement) return;
            
            const progressBar = document.getElementById('progressBar');
            const currentTimeSpan = document.getElementById('currentTime');
            const totalTimeSpan = document.getElementById('totalTime');
            
            if (!progressBar || !currentTimeSpan || !totalTimeSpan) return;
            
            const currentTime = audioElement.currentTime;
            const duration = audioElement.duration;
            
            if (duration > 0) {
                const progress = (currentTime / duration) * 100;
                progressBar.style.width = progress + '%';
                
                // æ›´æ–°æ™‚é–“é¡¯ç¤º
                currentTimeSpan.textContent = formatTime(currentTime);
                totalTimeSpan.textContent = formatTime(duration);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function seekToPosition(event) {
            if (!audioElement) return;
            
            const progressContainer = document.getElementById('progressContainer');
            if (!progressContainer) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = (clickX / containerWidth) * 100;
            
            if (audioElement.duration > 0) {
                const newTime = (percentage / 100) * audioElement.duration;
                audioElement.currentTime = newTime;
            }
        }

        // è¨­ç½®éŸ³é »äº‹ä»¶ç›£è½å™¨
        function setupAudioEventListeners() {
            if (!audioElement) return;
            
            // æ™‚é–“æ›´æ–°äº‹ä»¶
            audioElement.addEventListener('timeupdate', updateProgressBar);
            
            // å…ƒæ•¸æ“šåŠ è¼‰å®Œæˆäº‹ä»¶
            audioElement.addEventListener('loadedmetadata', function() {
                const totalTimeSpan = document.getElementById('totalTime');
                if (totalTimeSpan && audioElement.duration > 0) {
                    totalTimeSpan.textContent = formatTime(audioElement.duration);
                }
            });
            
            // æ’­æ”¾é–‹å§‹äº‹ä»¶
            audioElement.addEventListener('play', function() {
                isMusicPlaying = true;
                updateMusicButtonState();
                updateProgressBar();
            });
            
            // æ’­æ”¾æš«åœäº‹ä»¶
            audioElement.addEventListener('pause', function() {
                isMusicPlaying = false;
                updateMusicButtonState();
            });
            
            // æ’­æ”¾çµæŸäº‹ä»¶
            audioElement.addEventListener('ended', function() {
                isMusicPlaying = false;
                updateMusicButtonState();
                // é‡ç½®é€²åº¦æ¢
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                const currentTimeSpan = document.getElementById('currentTime');
                if (currentTimeSpan) {
                    currentTimeSpan.textContent = '0:00';
                }
            });
        }

        // éŸ³é‡æ§åˆ¶ç›¸é—œè®Šæ•¸
        let isDraggingProgress = false;
        let lastVolume = 50;

        // éŸ³é‡æ§åˆ¶å‡½æ•¸
        function changeVolume(value) {
            if (audioElement) {
                const volume = value / 100;
                audioElement.volume = volume;
                lastVolume = value;
                
                // ä¸å†å‹•æ…‹æ›´æ–°åœ–ç‰‡ï¼Œé¿å…ç ´åœ–å•é¡Œ
                // éŸ³é‡åœ–æ¨™ä¿æŒå›ºå®šï¼Œåªé€šéæ»‘å¡Šæ•¸å€¼ä¾†è¡¨ç¤ºéŸ³é‡å¤§å°
            }
        }

        // åˆ‡æ›éŸ³é‡æ§åˆ¶é¢æ¿é¡¯ç¤º/éš±è—
        function toggleVolumeControl() {
            const panel = document.getElementById('volumeControlPanel');
            const btn = document.getElementById('volumeControlBtn');
            
            if (panel && btn) {
                if (panel.style.display === 'none' || !panel.style.display) {
                    panel.style.display = 'flex';
                    btn.style.background = 'rgba(0,0,0,0.9)';
                    btn.style.transform = 'scale(1.1)';
                    
                    // æ·»åŠ é»æ“Šå¤–éƒ¨æ”¶èµ·åŠŸèƒ½
                    setTimeout(() => {
                        document.addEventListener('click', closeVolumePanelOnOutsideClick);
                    }, 100);
                } else {
                    closeVolumePanel();
                }
            }
        }

        // é»æ“Šå¤–éƒ¨æ”¶èµ·éŸ³é‡é¢æ¿
        function closeVolumePanelOnOutsideClick(event) {
            const panel = document.getElementById('volumeControlPanel');
            const btn = document.getElementById('volumeControlBtn');
            
            if (panel && btn) {
                // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨é¢æ¿æˆ–æŒ‰éˆ•å¤–éƒ¨
                if (!panel.contains(event.target) && !btn.contains(event.target)) {
                    closeVolumePanel();
                }
            }
        }

        // æ”¶èµ·éŸ³é‡é¢æ¿
        function closeVolumePanel() {
            const panel = document.getElementById('volumeControlPanel');
            const btn = document.getElementById('volumeControlBtn');
            
            if (panel && btn) {
                panel.style.display = 'none';
                btn.style.background = 'rgba(0,0,0,0.7)';
                btn.style.transform = 'scale(1)';
                
                // ç§»é™¤é»æ“Šå¤–éƒ¨æ”¶èµ·çš„äº‹ä»¶ç›£è½å™¨
                document.removeEventListener('click', closeVolumePanelOnOutsideClick);
            }
        }

        // éœéŸ³åˆ‡æ›
        function toggleMute() {
            const volumeSlider = document.getElementById('volumeSlider');
            if (volumeSlider) {
                if (volumeSlider.value > 0) {
                    lastVolume = volumeSlider.value;
                    volumeSlider.value = 0;
                    changeVolume(0);
                } else {
                    volumeSlider.value = lastVolume;
                    changeVolume(lastVolume);
                }
            }
        }

        // é€²åº¦æ¢æ‹–æ‹½åŠŸèƒ½
        function startDragging(event) {
            event.preventDefault();
            isDraggingProgress = true;
            
            const thumb = document.getElementById('progressThumb');
            if (thumb) {
                thumb.style.cursor = 'grabbing';
            }
            
            document.addEventListener('mousemove', dragProgress);
            document.addEventListener('mouseup', stopDragging);
        }

        function dragProgress(event) {
            if (!isDraggingProgress || !audioElement) return;
            
            const progressContainer = document.getElementById('progressContainer');
            if (!progressContainer) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = Math.max(0, Math.min(100, (clickX / containerWidth) * 100));
            
            if (audioElement.duration > 0) {
                const newTime = (percentage / 100) * audioElement.duration;
                audioElement.currentTime = newTime;
                updateProgressBar();
            }
        }

        function stopDragging() {
            isDraggingProgress = false;
            
            const thumb = document.getElementById('progressThumb');
            if (thumb) {
                thumb.style.cursor = 'grab';
            }
            
            document.removeEventListener('mousemove', dragProgress);
            document.removeEventListener('mouseup', stopDragging);
        }

        function openMusicSettings(event) {
            event.preventDefault();
            // console.log('[éŸ³æ¨‚ç³»çµ±] å˜—è©¦æ‰“é–‹éŸ³æ¨‚è¨­ç½®çª—å£');
            
            try {
                openModal('musicSettingsModal');
                // console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚è¨­ç½®çª—å£å·²æ‰“é–‹');
                
                // è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨
                loadMusicList();
                
                // ğŸ”¥ æ–°å¢ï¼šç¢ºä¿éŸ³æ¨‚åˆ—è¡¨ç‚ºæ”¶èµ·ä¾†çš„ç‹€æ…‹
                setTimeout(() => {
                    const container = document.getElementById('musicListContainer');
                    const modalContent = document.querySelector('#musicSettingsModal .modal-content');
                    if (container && modalContent) {
                        container.style.height = '0px';
                        modalContent.style.height = '500px';
                        console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚åˆ—è¡¨å·²è¨­å®šç‚ºæ”¶èµ·ä¾†ç‹€æ…‹');
                    }
                }, 100);
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ‰“é–‹è¨­ç½®çª—å£å¤±æ•—:', error);
            }
        }
        
        // æ‰“é–‹æ·»åŠ éŸ³æ¨‚å­æ¨¡æ…‹çª—å£
        function openAddMusicModal() {
            try {
                const modal = document.getElementById('addMusicModal');
                if (modal) {
                    modal.style.display = 'flex';
                    console.log('[éŸ³æ¨‚ç³»çµ±] æ·»åŠ éŸ³æ¨‚çª—å£å·²æ‰“é–‹');
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    const nameInput = document.getElementById('addMusicNameInput');
                    const urlInput = document.getElementById('addMusicUrlInput');
                    if (nameInput) nameInput.value = '';
                    if (urlInput) urlInput.value = '';
                    
                    // è¨­ç½®æ‹–æ‹½ä¸Šå‚³åŠŸèƒ½
                    setTimeout(() => {
                        setupDragAndDrop();
                        if (nameInput) nameInput.focus();
                    }, 100);
                } else {
                    console.error('[éŸ³æ¨‚ç³»çµ±] æ‰¾ä¸åˆ°æ·»åŠ éŸ³æ¨‚æ¨¡æ…‹çª—å£å…ƒç´ ');
                }
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ‰“é–‹æ·»åŠ éŸ³æ¨‚çª—å£å¤±æ•—:', error);
            }
        }
        
        // é—œé–‰æ·»åŠ éŸ³æ¨‚å­æ¨¡æ…‹çª—å£
        function closeAddMusicModal() {
            try {
                const modal = document.getElementById('addMusicModal');
                if (modal) {
                    modal.style.display = 'none';
                    
                    // æ¸…ç†æ–‡ä»¶é¸æ“‡ç‹€æ…‹
                    const fileInput = document.getElementById('musicFileInput');
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    // éš±è—æ–‡ä»¶ä¿¡æ¯
                    const fileInfo = document.getElementById('fileInfo');
                    if (fileInfo) {
                        fileInfo.style.display = 'none';
                    }
                    
                    // æ¸…ç©ºå…¨å±€æ–‡ä»¶è®Šé‡
                    window.selectedMusicFile = null;
                    
                    // é‡ç½®æ¨™ç±¤é åˆ°URLæ¨¡å¼
                    switchTab('url');
                    
                    console.log('[éŸ³æ¨‚ç³»çµ±] æ·»åŠ éŸ³æ¨‚çª—å£å·²é—œé–‰');
                } else {
                    console.error('[éŸ³æ¨‚ç³»çµ±] æ‰¾ä¸åˆ°æ·»åŠ éŸ³æ¨‚æ¨¡æ…‹çª—å£å…ƒç´ ');
                }
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] é—œé–‰æ·»åŠ éŸ³æ¨‚çª—å£å¤±æ•—:', error);
            }
        }
        
        // åˆ‡æ›éŸ³æ¨‚åˆ—è¡¨å±•é–‹/æ”¶ç¸®
        function toggleMusicList() {
            const container = document.getElementById('musicListContainer');
            const modalContent = document.querySelector('#musicSettingsModal .modal-content');
            
            if (container && modalContent) {
                if (container.style.height === '0px' || !container.style.height) {
                    // å±•é–‹åˆ—è¡¨
                    container.style.height = '100%';
                    modalContent.style.height = '650px';
                } else {
                    // æ”¶ç¸®åˆ—è¡¨
                    container.style.height = '0px';
                    modalContent.style.height = '500px';
                }
            }
        }
        
        // æ’­æ”¾é»‘è† å”±ç‰‡å‹•ç•«
        function playVinylAnimation() {
            const vinyl = document.getElementById('vinylRecord');
            if (vinyl) {
                console.log('[éŸ³æ¨‚ç³»çµ±] é–‹å§‹æ’­æ”¾é»‘è† å”±ç‰‡å‹•ç•«');
                
                // é‡ç½®åˆå§‹ç‹€æ…‹ - åœ¨å®¹å™¨å…§éƒ¨
                vinyl.style.transition = 'none';
                vinyl.style.opacity = '0';
                vinyl.style.right = '200px';
                vinyl.style.transform = 'translateY(-50%) rotate(0deg)';
                
                // å¼·åˆ¶é‡ç¹ª
                vinyl.offsetHeight;
                
                // æ¢å¾©éæ¸¡æ•ˆæœ
                vinyl.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                
                // å»¶é²ä¸€é»å†é–‹å§‹å‹•ç•«
                setTimeout(() => {
                    // é–‹å§‹å‹•ç•« - å¾€å³æ»‘å‡ºåˆ°å®¹å™¨å¤–éƒ¨
                    vinyl.style.opacity = '1';
                    vinyl.style.right = '150px';
                    vinyl.style.transform = 'translateY(-50%) rotate(180deg)';
                    
                    console.log('[éŸ³æ¨‚ç³»çµ±] é»‘è† å”±ç‰‡å‹•ç•«å·²è§¸ç™¼ï¼Œå›ºå®šé¡¯ç¤º');
                }, 50);
                
                // ä¸å†è‡ªå‹•éš±è—ï¼Œä¿æŒå›ºå®šé¡¯ç¤ºç›´åˆ°ä¸‹æ¬¡åˆ‡æ›éŸ³æ¨‚
            } else {
                console.warn('[éŸ³æ¨‚ç³»çµ±] æ‰¾ä¸åˆ°é»‘è† å”±ç‰‡å…ƒç´ ');
            }
        }
        
        // æ›´æ–°éŸ³æ¨‚å°é¢
        function updateMusicCover(imageUrl) {
            const cover = document.getElementById('musicCover');
            if (cover && imageUrl) {
                cover.src = imageUrl;
            }
        }
        
        // æ›´æ–°æ­Œæ›²åç¨±é¡¯ç¤º
        function updateSongNameDisplay() {
            const songNameElement = document.getElementById('currentSongName');
            if (songNameElement && musicList.length > 0 && currentMusicIndex >= 0 && currentMusicIndex < musicList.length) {
                songNameElement.textContent = musicList[currentMusicIndex].name;
            }
        }
        
        // å¾å­æ¨¡æ…‹çª—å£æ·»åŠ éŸ³æ¨‚
        async function addMusicFromModal() {
            const nameInput = document.getElementById('addMusicNameInput');
            const urlInput = document.getElementById('addMusicUrlInput');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!name || !url) {
                showNotification('è«‹è¼¸å…¥éŸ³æ¨‚åç¨±å’ŒURL', 'warning');
                return;
            }
            
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                const musicItem = {
                    name: name,
                    url: url,
                    addedAt: new Date().toISOString()
                };
                
                const request = store.add(musicItem);
                
                request.onsuccess = () => {
                    console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚æ·»åŠ æˆåŠŸ:', name);
                    showNotification(`éŸ³æ¨‚ "${name}" å·²æ·»åŠ åˆ°åˆ—è¡¨`, 'success');
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    nameInput.value = '';
                    urlInput.value = '';
                    
                    // é—œé–‰å­æ¨¡æ…‹çª—å£
                    closeAddMusicModal();
                    
                    // é‡æ–°è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚æ·»åŠ å¤±æ•—');
                    showNotification('éŸ³æ¨‚æ·»åŠ å¤±æ•—', 'error');
                };
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ·»åŠ éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('æ·»åŠ éŸ³æ¨‚å¤±æ•—', 'error');
            }
        }
        
        // å¾å­æ¨¡æ…‹çª—å£æ¸¬è©¦éŸ³æ¨‚
        function testMusicFromModal() {
            const urlInput = document.getElementById('addMusicUrlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                showNotification('è«‹è¼¸å…¥éŸ³æ¨‚URL', 'warning');
                return;
            }
            
            try {
                // å‰µå»ºè‡¨æ™‚éŸ³é »å…ƒç´ é€²è¡Œæ¸¬è©¦
                const testAudio = new Audio();
                testAudio.src = url;
                
                testAudio.addEventListener('loadeddata', function() {
                    showNotification('éŸ³æ¨‚URLæ¸¬è©¦æˆåŠŸï¼', 'success');
                    testAudio.remove(); // æ¸…ç†è‡¨æ™‚éŸ³é »å…ƒç´ 
                });
                
                testAudio.addEventListener('error', function() {
                    showNotification('éŸ³æ¨‚URLæ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢º', 'error');
                    testAudio.remove(); // æ¸…ç†è‡¨æ™‚éŸ³é »å…ƒç´ 
                });
                
                // è¨­ç½®è¶…æ™‚è™•ç†
                setTimeout(() => {
                    if (testAudio.readyState === 0) {
                        showNotification('éŸ³æ¨‚URLæ¸¬è©¦è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥', 'warning');
                        testAudio.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ¸¬è©¦éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('æ¸¬è©¦éŸ³æ¨‚å¤±æ•—', 'error');
            }
        }

        // æ¨™ç±¤é åˆ‡æ›åŠŸèƒ½
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤é å…§å®¹
            const tabContents = document.querySelectorAll('.settings-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•çš„activeç‹€æ…‹
            const tabButtons = document.querySelectorAll('.settings-tabs .tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤é 
            const selectedTab = document.getElementById(tabName + 'Tab');
            const selectedBtn = document.querySelector(`.settings-tabs .tab-btn[onclick*="switchTab('${tabName}')"]`);
            
            if (selectedTab && selectedBtn) {
                selectedTab.style.display = 'block';
                selectedTab.classList.add('active');
                selectedBtn.classList.add('active');
            }
        }

        // æ–‡ä»¶é¸æ“‡è™•ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            processSelectedFile(file);
        }

        // è™•ç†é¸ä¸­çš„æ–‡ä»¶
        function processSelectedFile(file) {
            if (!file) return;
            
            // æª¢æŸ¥æ–‡ä»¶é¡å‹
            if (!file.type.startsWith('audio/')) {
                showNotification('è«‹é¸æ“‡éŸ³é »æ–‡ä»¶', 'warning');
                return;
            }
            
            // æª¢æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ç‚º50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showNotification('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…é50MB', 'warning');
                return;
            }
            
            // é¡¯ç¤ºæ–‡ä»¶ä¿¡æ¯
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            
            fileName.textContent = file.name;
            fileSize.textContent = `å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            fileInfo.style.display = 'block';
            
            // è‡ªå‹•å¡«å……éŸ³æ¨‚åç¨±ï¼ˆå¦‚æœç‚ºç©ºï¼‰
            const nameInput = document.getElementById('addMusicNameInput2');
            if (!nameInput.value.trim()) {
                nameInput.value = file.name.replace(/\.[^/.]+$/, ""); // ç§»é™¤æ–‡ä»¶æ“´å±•å
            }
            
            // å­˜å„²é¸ä¸­çš„æ–‡ä»¶åˆ°å…¨å±€è®Šé‡
            window.selectedMusicFile = file;
        }

        // è¨­ç½®æ‹–æ‹½ä¸Šå‚³åŠŸèƒ½
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;
            
            // é˜²æ­¢é»˜èªæ‹–æ‹½è¡Œç‚º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // æ‹–æ‹½é€²å…¥å’Œé›¢é–‹æ•ˆæœ
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            // è™•ç†æ–‡ä»¶æ‹–æ”¾
            uploadArea.addEventListener('drop', handleDrop, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight(e) {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.add('dragover');
        }
        
        function unhighlight(e) {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                processSelectedFile(files[0]);
            }
        }

        // å¾ä¸Šå‚³æ·»åŠ éŸ³æ¨‚
        async function addMusicFromUpload() {
            const nameInput = document.getElementById('addMusicNameInput2');
            const name = nameInput.value.trim();
            const file = window.selectedMusicFile;
            
            if (!name || !file) {
                showNotification('è«‹è¼¸å…¥éŸ³æ¨‚åç¨±ä¸¦é¸æ“‡æ–‡ä»¶', 'warning');
                return;
            }
            
            try {
                // å°‡æ–‡ä»¶è½‰æ›ç‚ºblob URLä¸¦å­˜å„²åˆ°Cache Storage
                const blobUrl = URL.createObjectURL(file);
                
                // å­˜å„²åˆ°Cache Storage
                const cache = await caches.open('music-cache');
                const response = await fetch(blobUrl);
                await cache.put(`music-${Date.now()}`, response);
                
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                const musicItem = {
                    name: name,
                    url: blobUrl,
                    type: 'local',
                    fileSize: file.size,
                    addedAt: new Date().toISOString()
                };
                
                const request = store.add(musicItem);
                
                request.onsuccess = () => {
                    console.log('[éŸ³æ¨‚ç³»çµ±] æœ¬åœ°éŸ³æ¨‚æ·»åŠ æˆåŠŸ:', name);
                    showNotification(`éŸ³æ¨‚ "${name}" å·²ä¸Šå‚³ä¸¦æ·»åŠ åˆ°åˆ—è¡¨`, 'success');
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†å’Œæ–‡ä»¶ä¿¡æ¯
                    nameInput.value = '';
                    document.getElementById('fileInfo').style.display = 'none';
                    window.selectedMusicFile = null;
                    
                    // é—œé–‰å­æ¨¡æ…‹çª—å£
                    closeAddMusicModal();
                    
                    // é‡æ–°è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[éŸ³æ¨‚ç³»çµ±] æœ¬åœ°éŸ³æ¨‚æ·»åŠ å¤±æ•—');
                    showNotification('éŸ³æ¨‚æ·»åŠ å¤±æ•—', 'error');
                };
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] ä¸Šå‚³éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('ä¸Šå‚³éŸ³æ¨‚å¤±æ•—', 'error');
            }
        }

        // æ¸¬è©¦ä¸Šå‚³çš„éŸ³æ¨‚
        function testMusicFromUpload() {
            const file = window.selectedMusicFile;
            
            if (!file) {
                showNotification('è«‹å…ˆé¸æ“‡éŸ³æ¨‚æ–‡ä»¶', 'warning');
                return;
            }
            
            try {
                const blobUrl = URL.createObjectURL(file);
                const testAudio = new Audio();
                testAudio.src = blobUrl;
                
                testAudio.addEventListener('loadeddata', function() {
                    showNotification('éŸ³æ¨‚æ–‡ä»¶æ¸¬è©¦æˆåŠŸï¼', 'success');
                    testAudio.remove();
                });
                
                testAudio.addEventListener('error', function() {
                    showNotification('éŸ³æ¨‚æ–‡ä»¶æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                    testAudio.remove();
                });
                
                // è¨­ç½®è¶…æ™‚è™•ç†
                setTimeout(() => {
                    if (testAudio.readyState === 0) {
                        showNotification('éŸ³æ¨‚æ–‡ä»¶æ¸¬è©¦è¶…æ™‚', 'warning');
                        testAudio.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ¸¬è©¦ä¸Šå‚³éŸ³æ¨‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('æ¸¬è©¦éŸ³æ¨‚å¤±æ•—', 'error');
            }
        }

        function applyMusicSettings() {
            const urlInput = document.getElementById('musicUrlInput');
            const newUrl = urlInput.value.trim();
            
            if (!newUrl) {
                showNotification('è«‹è¼¸å…¥éŸ³æ¨‚URL', 'warning');
                return;
            }

            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
            if (isMusicPlaying) {
                stopMusic();
            }

            currentMusicUrl = newUrl;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('musicUrl', newUrl);
            
            // æ›´æ–°éŸ³é »å…ƒç´ 
            if (audioElement) {
                audioElement.src = newUrl;
                // console.log('[éŸ³æ¨‚ç³»çµ±] å·²æ›´æ–°éŸ³é »æº:', newUrl);
                
                // é‡æ–°åˆå§‹åŒ–éŸ³é »äº‹ä»¶ç›£è½å™¨
                audioElement.addEventListener('loadeddata', function() {
                    // console.log('[éŸ³æ¨‚ç³»çµ±] æ–°éŸ³æ¨‚å·²è¼‰å…¥');
                });
                
                audioElement.addEventListener('error', function(e) {
                    console.error('[éŸ³æ¨‚ç³»çµ±] æ–°éŸ³æ¨‚è¼‰å…¥éŒ¯èª¤:', e);
                    showNotification('æ–°éŸ³æ¨‚è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥URL', 'error');
                });
            }
            
            showNotification('éŸ³æ¨‚è¨­ç½®å·²ä¿å­˜ä¸¦æ›´æ–°', 'success');
            closeModal('musicSettingsModal');
        }

        function testMusic() {
            const urlInput = document.getElementById('musicUrlInput');
            const testUrl = urlInput.value.trim();
            
            if (!testUrl) {
                showNotification('è«‹å…ˆè¼¸å…¥éŸ³æ¨‚URL', 'warning');
                return;
            }

            // console.log('[éŸ³æ¨‚ç³»çµ±] é–‹å§‹æ¸¬è©¦éŸ³æ¨‚URL:', testUrl);

            // å‰µå»ºè‡¨æ™‚éŸ³é »å…ƒç´ é€²è¡Œæ¸¬è©¦
            const testAudio = new Audio();
            
            // è¨­ç½®è¶…æ™‚è™•ç†
            const timeout = setTimeout(() => {
                console.error('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚æ¸¬è©¦è¶…æ™‚');
                showNotification('éŸ³æ¨‚æ¸¬è©¦è¶…æ™‚ï¼Œè«‹æª¢æŸ¥URLæ˜¯å¦æœ‰æ•ˆ', 'error');
                testAudio.pause();
            }, 10000); // 10ç§’è¶…æ™‚
            
            testAudio.addEventListener('canplay', function() {
                clearTimeout(timeout);
                // console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚URLæ¸¬è©¦æˆåŠŸ');
                showNotification('éŸ³æ¨‚URLæ¸¬è©¦æˆåŠŸï¼å¯ä»¥æ’­æ”¾', 'success');
                testAudio.pause();
            });
            
            testAudio.addEventListener('error', function(e) {
                clearTimeout(timeout);
                console.error('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚URLæ¸¬è©¦å¤±æ•—:', e);
                let errorMessage = 'éŸ³æ¨‚URLæ¸¬è©¦å¤±æ•—';
                
                // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›æ›´å…·é«”çš„éŒ¯èª¤ä¿¡æ¯
                if (testAudio.error) {
                    switch(testAudio.error.code) {
                        case MediaError.MEDIA_ERR_ABORTED:
                            errorMessage = 'éŸ³æ¨‚è¼‰å…¥è¢«ä¸­æ­¢';
                            break;
                        case MediaError.MEDIA_ERR_NETWORK:
                            errorMessage = 'ç¶²çµ¡éŒ¯èª¤ï¼Œç„¡æ³•è¨ªå•éŸ³æ¨‚æ–‡ä»¶';
                            break;
                        case MediaError.MEDIA_ERR_DECODE:
                            errorMessage = 'éŸ³æ¨‚æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æå£';
                            break;
                        case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMessage = 'éŸ³æ¨‚æ ¼å¼ä¸æ”¯æŒï¼Œè«‹ä½¿ç”¨MP3ã€WAVç­‰æ ¼å¼';
                            break;
                        default:
                            errorMessage = 'éŸ³æ¨‚è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢º';
                    }
                }
                
                showNotification(errorMessage, 'error');
            });

            // è¨­ç½®éŸ³é »æºä¸¦å˜—è©¦æ’­æ”¾
            testAudio.src = testUrl;
            testAudio.load(); // å¼·åˆ¶è¼‰å…¥
            
            testAudio.play().catch(error => {
                clearTimeout(timeout);
                console.error('[éŸ³æ¨‚ç³»çµ±] æ¸¬è©¦æ’­æ”¾å¤±æ•—:', error);
                showNotification('éŸ³æ¨‚æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥URLå’Œæ ¼å¼', 'error');
            });
        }
        
        // ğŸ†• VNé¢æ¿ç‹€æ…‹æŒä¹…åŒ–
        let lastVNState = 'landing';   // æœ€å¾Œä¿å­˜çš„ç‹€æ…‹
        
        // VNé¢æ¿iframeå‹•æ…‹ä¼¸ç¸®å‡½æ•¸
        function resizeVNIframe(state) {
            const vnIframe = document.getElementById('vnPanelIframe');
            if (!vnIframe) return;
            
            vnIframeState = state;
            lastVNState = state; // ä¿å­˜æœ€å¾Œç‹€æ…‹
            
            // é˜²æŠ–å‹•ï¼šä½¿ç”¨requestAnimationFrameç¢ºä¿å¹³æ»‘å‹•ç•«
            requestAnimationFrame(() => {
                switch(state) {
                    case 'landing':
                        // ç¸®å°å°ºå¯¸ - vn-landing-contentå°ºå¯¸
                        vnIframe.style.position = 'absolute';
                        vnIframe.style.left = '50%';
                        vnIframe.style.top = '50%';
                        vnIframe.style.transform = 'translate(-50%, -50%)';
                        vnIframe.style.width = '300px';
                        vnIframe.style.height = '400px';
                        vnIframe.style.maxWidth = '90%';
                        vnIframe.style.borderRadius = '40px';
                        vnIframe.style.transformOrigin = 'center center';
                        // é¡¯ç¤ºéŸ³æ¨‚æŒ‰éˆ•
                        const musicBtnLanding = document.querySelector('.music-control-btn');
                        if (musicBtnLanding) {
                            musicBtnLanding.style.setProperty('display', 'flex', 'important');
                            musicBtnLanding.style.setProperty('visibility', 'visible', 'important');
                            musicBtnLanding.style.setProperty('opacity', '1', 'important');
                            musicBtnLanding.style.setProperty('pointer-events', 'auto', 'important');
                        }
                        // èª¿ç”¨ç‹€æ…‹ç¶­è­·å‡½æ•¸ç¢ºä¿ä¸€è‡´æ€§
                        maintainMusicButtonHiddenState();
                        break;
                        
                    case 'story':
                        // å±•é–‹å°ºå¯¸ - æ»¿ç‰ˆnew-page-contentå®¹å™¨
                        vnIframe.style.position = 'absolute';
                        vnIframe.style.left = '0';
                        vnIframe.style.top = '0';
                        vnIframe.style.transform = 'none';
                        vnIframe.style.width = '100%';
                        vnIframe.style.height = '100%';
                        vnIframe.style.maxWidth = '100%';
                        vnIframe.style.maxHeight = '100%';
                        vnIframe.style.borderRadius = '0';
                        vnIframe.style.zIndex = '9999';
                        vnIframe.style.transformOrigin = 'center center';
                        // éš±è—éŸ³æ¨‚æŒ‰éˆ•
                        const musicBtnStory = document.querySelector('.music-control-btn');
                        if (musicBtnStory) {
                            musicBtnStory.style.setProperty('display', 'none', 'important');
                            musicBtnStory.style.setProperty('visibility', 'hidden', 'important');
                            musicBtnStory.style.setProperty('opacity', '0', 'important');
                            musicBtnStory.style.setProperty('pointer-events', 'none', 'important');
                        }
                        // èª¿ç”¨ç‹€æ…‹ç¶­è­·å‡½æ•¸ç¢ºä¿ä¸€è‡´æ€§
                        maintainMusicButtonHiddenState();
                        break;
                        
                    case 'continue':
                        // ç¸®å°å°ºå¯¸ - åŠ‡æƒ…çµå°¾æ™‚çš„å°ºå¯¸
                        vnIframe.style.position = 'absolute';
                        vnIframe.style.left = '50%';
                        vnIframe.style.top = '50%';
                        vnIframe.style.transform = 'translate(-50%, -50%)';
                        vnIframe.style.width = '300px';
                        vnIframe.style.height = '400px';
                        vnIframe.style.maxWidth = '90%';
                        vnIframe.style.borderRadius = '40px';
                        vnIframe.style.transformOrigin = 'center center';
                        // é¡¯ç¤ºéŸ³æ¨‚æŒ‰éˆ•
                        const musicBtnContinue = document.querySelector('.music-control-btn');
                        if (musicBtnContinue) {
                            musicBtnContinue.style.setProperty('display', 'flex', 'important');
                            musicBtnContinue.style.setProperty('visibility', 'visible', 'important');
                            musicBtnContinue.style.setProperty('opacity', '1', 'important');
                            musicBtnContinue.style.setProperty('pointer-events', 'auto', 'important');
                        }
                        // èª¿ç”¨ç‹€æ…‹ç¶­è­·å‡½æ•¸ç¢ºä¿ä¸€è‡´æ€§
                        maintainMusicButtonHiddenState();
                        break;
                }
                
                // console.log(`[VNé¢æ¿] iframeå°ºå¯¸å¹³æ»‘èª¿æ•´ç‚º: ${state}`);
            });
        }
        
        // ç¢ºä¿resizeVNIframeå‡½æ•¸ç«‹å³å¯ç”¨
        window.resizeVNIframe = resizeVNIframe;
        
        // ğŸ†• é é¢å¯è¦‹æ€§ç‹€æ…‹æ¢å¾©
        function handlePageVisibilityChange() {
            if (!document.hidden) {
                console.log('[ä¸»é¢æ¿] é é¢é‡æ–°å¯è¦‹ï¼Œæ¢å¾©VNé¢æ¿ç‹€æ…‹');
                
                // å»¶é²ä¸€é»æ™‚é–“ç¢ºä¿iframeå®Œå…¨åŠ è¼‰
                setTimeout(() => {
                    if (vnIframeState !== lastVNState) {
                        console.log(`[ä¸»é¢æ¿] æª¢æ¸¬åˆ°ç‹€æ…‹ä¸åŒ¹é…ï¼Œæ¢å¾©ç‚º: ${lastVNState}`);
                        resizeVNIframe(lastVNState);
                    }
                }, 200);
            } else {
                console.log('[ä¸»é¢æ¿] é é¢éš±è—ï¼Œä¿å­˜ç•¶å‰ç‹€æ…‹');
                lastVNState = vnIframeState;
            }
        }
        
        // ğŸ†• çª—å£ç„¦é»è®ŠåŒ–è™•ç†
        function handleWindowFocusChange() {
            if (document.hasFocus()) {
                console.log('[ä¸»é¢æ¿] çª—å£é‡æ–°ç²å¾—ç„¦é»ï¼Œæª¢æŸ¥VNé¢æ¿ç‹€æ…‹');
                
                setTimeout(() => {
                    if (vnIframeState !== lastVNState) {
                        console.log(`[ä¸»é¢æ¿] ç„¦é»æ¢å¾©æ™‚æª¢æ¸¬åˆ°ç‹€æ…‹ä¸åŒ¹é…ï¼Œæ¢å¾©ç‚º: ${lastVNState}`);
                        resizeVNIframe(lastVNState);
                    }
                }, 100);
            }
        }
        
        // ğŸ†• æ·»åŠ é é¢å¯è¦‹æ€§ç›£è½å™¨
        document.addEventListener('visibilitychange', handlePageVisibilityChange);
        
        // ğŸ†• æ·»åŠ çª—å£ç„¦é»ç›£è½å™¨
        window.addEventListener('focus', handleWindowFocusChange);
        
        // ğŸ†• æ·»åŠ å¼·åˆ¶ç‹€æ…‹æ¢å¾©åŠŸèƒ½
        window.forceRestoreVNState = function() {
            console.log('[ä¸»é¢æ¿] å¼·åˆ¶æ¢å¾©VNé¢æ¿ç‹€æ…‹:', lastVNState);
            resizeVNIframe(lastVNState);
        };
        
        // ğŸ†• æ·»åŠ ç‹€æ…‹æŸ¥è©¢åŠŸèƒ½
        window.getVNState = function() {
            return {
                currentState: vnIframeState,
                lastSavedState: lastVNState
            };
        };
        
        // ç›£è½VNé¢æ¿iframeæ¶ˆæ¯
        function setupVNIframeListener() {
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'VN_IFRAME_RESIZE') {
                    resizeVNIframe(event.data.state);
                }
            });
        }

        // åˆå§‹åŒ–éŸ³æ¨‚è¨­ç½®
        async function initMusicSettings() {
            try {
                // åˆå§‹åŒ–éŸ³æ¨‚æ•¸æ“šåº«
                await initMusicDatabase();
                
                // è¼‰å…¥éŸ³æ¨‚åˆ—è¡¨ï¼ˆé€™å€‹å‡½æ•¸æœƒè‡ªå‹•è™•ç†ç·©å­˜æ¢å¾©ï¼‰
                await loadMusicList();
                
                // ğŸ”¥ ä¿®æ”¹ï¼šç§»é™¤é‡è¤‡çš„ç·©å­˜é‚è¼¯ï¼Œå› ç‚ºloadMusicList()å·²ç¶“è™•ç†äº†
                // åªæœ‰åœ¨éŸ³æ¨‚åˆ—è¡¨ç‚ºç©ºæ™‚æ‰ä½¿ç”¨é è¨­éŸ³æ¨‚
                if (musicList.length === 0) {
                    currentMusicUrl = 'https://files.catbox.moe/snenpf.mp3';
                    console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚åˆ—è¡¨ç‚ºç©ºï¼Œä½¿ç”¨é è¨­éŸ³æ¨‚');
                }
                
                // åˆå§‹åŒ–éŸ³æ¨‚æŒ‰éˆ•ç‹€æ…‹
                updateMusicButtonState();
                
                // åˆå§‹åŒ–èƒŒæ™¯éŸ³æ¨‚
                initBackgroundMusic();
                
                // ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–éŸ³æ¨‚åˆ—è¡¨ç‚ºæ”¶èµ·ä¾†çš„ç‹€æ…‹
                const container = document.getElementById('musicListContainer');
                const modalContent = document.querySelector('#musicSettingsModal .modal-content');
                if (container && modalContent) {
                    container.style.height = '0px';
                    modalContent.style.height = '500px';
                    console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚åˆ—è¡¨å·²åˆå§‹åŒ–ç‚ºæ”¶èµ·ä¾†ç‹€æ…‹');
                }
                
                console.log('[éŸ³æ¨‚ç³»çµ±] éŸ³æ¨‚è¨­ç½®åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('[éŸ³æ¨‚ç³»çµ±] åˆå§‹åŒ–éŸ³æ¨‚è¨­ç½®å¤±æ•—:', error);
            }
        }
        
        // ğŸ†• æ–°å¢ï¼šé˜²æ­¢æ‰‹æ©Ÿç«¯å½ˆæ€§æ»¾å‹•çš„JavaScripté˜²è­·
        function setupMobileScrollProtection() {
            // è¨­ç½®æ‰€æœ‰iframeçš„é˜²è­·
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                iframe.style.overscrollBehavior = 'none';
                iframe.style.webkitOverflowScrolling = 'auto';
                iframe.style.touchAction = 'manipulation';
                
                // å˜—è©¦è¨­ç½®iframeå…§éƒ¨çš„é˜²è­·ï¼ˆå¦‚æœåŒæºï¼‰
                try {
                    if (iframe.contentDocument && iframe.contentDocument.body) {
                        iframe.contentDocument.body.style.overscrollBehavior = 'none';
                        iframe.contentDocument.body.style.webkitOverflowScrolling = 'auto';
                        iframe.contentDocument.body.style.touchAction = 'manipulation';
                        
                        // è¨­ç½®iframeå…§éƒ¨æ‰€æœ‰å…ƒç´ çš„é˜²è­·
                        const iframeElements = iframe.contentDocument.querySelectorAll('*');
                        iframeElements.forEach(element => {
                            element.style.overscrollBehavior = 'none';
                            element.style.webkitOverflowScrolling = 'auto';
                            element.style.touchAction = 'manipulation';
                        });
                    }
                } catch (e) {
                    // è·¨åŸŸæƒ…æ³ä¸‹ç„¡æ³•è¨ªå•iframeå…§å®¹ï¼Œé€™æ˜¯æ­£å¸¸çš„
                    console.log('[é˜²è­·ç³»çµ±] iframeå…§å®¹è·¨åŸŸï¼Œç„¡æ³•ç›´æ¥è¨­ç½®æ¨£å¼');
                }
            });
            
            // è¨­ç½®æ‰€æœ‰å®¹å™¨çš„é˜²è­·
            const containers = document.querySelectorAll('.swipe-container, .swipe-wrapper, .swipe-slide, .phone-container');
            containers.forEach(container => {
                container.style.overscrollBehavior = 'none';
                container.style.webkitOverflowScrolling = 'auto';
                container.style.touchAction = 'manipulation';
            });
            
            console.log('[é˜²è­·ç³»çµ±] æ‰‹æ©Ÿç«¯å½ˆæ€§æ»¾å‹•é˜²è­·å·²è¨­ç½®');
        }

        // é•·æŒ‰äº‹ä»¶è™•ç†
        function setupLongPress() {
            const musicBtn = document.getElementById('musicControlBtn');
            if (!musicBtn) {
                console.error('[éŸ³æ¨‚ç³»çµ±] æ‰¾ä¸åˆ°éŸ³æ¨‚æŒ‰éˆ•å…ƒç´ ');
                return;
            }

            let pressTimer = null;
            let isLongPress = false;
            let clickCount = 0;
            let clickTimer = null;

            // é˜²æ­¢æ–‡å­—é¸å–
            musicBtn.style.userSelect = 'none';
            musicBtn.style.webkitUserSelect = 'none';
            musicBtn.style.mozUserSelect = 'none';
            musicBtn.style.msUserSelect = 'none';

            // ç°¡åŒ–çš„é•·æŒ‰æª¢æ¸¬
            function startLongPress(e) {
                e.preventDefault();
                isLongPress = false;
                
                // æ·»åŠ è¦–è¦ºåé¥‹ - è¼•å¾®ç¸®æ”¾æ•ˆæœ
                musicBtn.style.transform = 'scale(0.95)';
                musicBtn.style.transition = 'transform 0.1s ease';
                
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    // console.log('[éŸ³æ¨‚ç³»çµ±] é•·æŒ‰è§¸ç™¼ï¼Œæ‰“é–‹è¨­ç½®çª—å£');
                    openMusicSettings(e);
                }, 500); // ç¸®çŸ­åˆ°500msï¼Œæ›´å¿«é€ŸéŸ¿æ‡‰
            }

            function endPress(e) {
                e.preventDefault();
                clearTimeout(pressTimer);
                
                // æ¢å¾©æŒ‰éˆ•è¦–è¦ºç‹€æ…‹
                musicBtn.style.transform = 'scale(1)';
                
                if (!isLongPress) {
                    clickCount++;
                    
                    if (clickCount === 1) {
                        // ç¬¬ä¸€æ¬¡é»æ“Šï¼Œç­‰å¾…å¯èƒ½çš„ç¬¬äºŒæ¬¡é»æ“Š
                        clickTimer = setTimeout(() => {
                            // å–®æ“Šï¼šåˆ‡æ›æ’­æ”¾ç‹€æ…‹
                            // console.log('[éŸ³æ¨‚ç³»çµ±] å–®æ“Šè§¸ç™¼ï¼Œåˆ‡æ›æ’­æ”¾ç‹€æ…‹');
                            toggleMusic();
                            clickCount = 0;
                        }, 250);
                    } else if (clickCount === 2) {
                        // é›™æ“Šï¼šåˆ‡æ›åˆ°ä¸‹ä¸€é¦–éŸ³æ¨‚
                        clearTimeout(clickTimer);
                        // console.log('[éŸ³æ¨‚ç³»çµ±] é›™æ“Šè§¸ç™¼ï¼Œåˆ‡æ›åˆ°ä¸‹ä¸€é¦–éŸ³æ¨‚');
                        nextMusic();
                        clickCount = 0;
                    }
                }
            }

            // æ»‘é¼ äº‹ä»¶
            musicBtn.addEventListener('mousedown', startLongPress);
            musicBtn.addEventListener('mouseup', endPress);
            musicBtn.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
                musicBtn.style.transform = 'scale(1)';
            });

            // è§¸æ‘¸äº‹ä»¶
            musicBtn.addEventListener('touchstart', startLongPress);
            musicBtn.addEventListener('touchend', endPress);

            // é˜²æ­¢å³éµèœå–®
            musicBtn.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        // ğŸ†• æ–°å¢ï¼šè™•ç†CHATé¢æ¿é é¢ç‹€æ…‹è®ŠåŒ–
        function handleChatPageStateChange(data) {
            const closeBtn = document.getElementById('chatIframeCloseBtn');
            if (!closeBtn) {
                console.error('[ä¸»é¢æ¿] æ‰¾ä¸åˆ°chat iframeé—œé–‰æŒ‰éˆ•');
                return;
            }
            
            // æ ¹æ“šé é¢ç‹€æ…‹æ§åˆ¶é—œé–‰æŒ‰éˆ•çš„é¡¯ç¤º
            if (data.isInChatRoom) {
                // åœ¨èŠå¤©å®¤é é¢ï¼Œéš±è—é—œé–‰æŒ‰éˆ•
                closeBtn.style.display = 'none';
                console.log('[ä¸»é¢æ¿] Chaté¢æ¿é€²å…¥èŠå¤©å®¤ï¼Œéš±è—iframeé—œé–‰æŒ‰éˆ•');
            } else {
                // åœ¨èŠå¤©åˆ—è¡¨é é¢ï¼Œé¡¯ç¤ºé—œé–‰æŒ‰éˆ•
                closeBtn.style.display = 'flex';
                console.log('[ä¸»é¢æ¿] Chaté¢æ¿è¿”å›èŠå¤©åˆ—è¡¨ï¼Œé¡¯ç¤ºiframeé—œé–‰æŒ‰éˆ•');
            }
        }

        // åœ¨DOMContentLoadedä¸­èª¿ç”¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await initMusicSettings();
            setupLongPress();
            setupVNIframeListener();
            
            // ğŸ†• æ–°å¢ï¼šè¨­ç½®æ‰‹æ©Ÿç«¯å½ˆæ€§æ»¾å‹•é˜²è­·
            setupMobileScrollProtection();
            
            // ğŸ†• æ–°å¢ï¼šåˆå§‹åŒ–é é¢ä½ç½®
            updatePage();
            
            // å»¶é²è¨­ç½®é˜²è­·ï¼Œç¢ºä¿iframeå·²è¼‰å…¥
            setTimeout(() => {
                setupMobileScrollProtection();
                // ğŸ†• æ–°å¢ï¼šå†æ¬¡ç¢ºä¿é é¢ä½ç½®æ­£ç¢º
                updatePage();
            }, 1000);
            
            // console.log('[éŸ³æ¨‚ç³»çµ±] åˆå§‹åŒ–å®Œæˆ');
            // console.log('[VNé¢æ¿] iframeç›£è½å™¨å·²è¨­ç½®');
        });

    </script>
</body>
</html>