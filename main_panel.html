<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通用面板 - 多功能界面</title>
    <link rel="stylesheet" href="map/map-style.css">
    <script src="map_core.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="communication_manager.js"></script>

    <style>
        :root {
            --container-bg: #FFB6C1;
            --section-bg: rgba(255, 255, 255, 0.9);
            --text-color: #333333;
            --scrollbar-color: rgba(255, 105, 180, 0.6);
            --hover-bg-color: rgba(255, 255, 255, 0.1);
            --active-bg-color: rgba(255, 255, 255, 0.2);
            --border-color: rgba(255, 255, 255, 0.2);
            --background-image: none;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow: hidden;
            /* 🆕 新增：防止手機端彈性滾動 */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        .phone-frame {
            width: min(375px, 95vw);
            height: min(712px, 95vh);
            background: #000;
            border-radius: 48px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 0 8px #222;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 8px;
            /* 確保在小屏幕上也能正常顯示 */
            min-width: 320px;
            min-height: 500px;
        }



        .phone-homebar {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 6px;
            background: #bbb;
            border-radius: 6px;
            opacity: 0.7;
            z-index: 10;
        }

        .phone-container {
            width: 100%;
            height: 100%;
            border-radius: 40px;
            background: var(--container-bg);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* 防止iframe尺寸變化導致的抖動 */
            transform: translateZ(0);
            backface-visibility: hidden;
            /* 確保背景圖片在容器顏色上面 */
            z-index: 0;
            /* 🆕 新增：防止手機端彈性滾動 */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }



        /* 確保內容在背景圖片上面 */
        .swipe-container > * {
            position: relative;
            z-index: 1;
        }

        /* 滑动容器 */
        .swipe-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: var(--container-bg);
            /* 🆕 新增：防止手機端彈性滾動 */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        /* 背景圖片層，確保在容器顏色上面 */
        .swipe-container.has-background {
            background: transparent !important;
        }

        .swipe-container.has-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--background-image, none);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 40px;
            z-index: -1;
            pointer-events: none;
            display: block;
            opacity: 1;
            /* 調試：添加邊框以便查看 */
            border: 2px solid #d3d1d1;
        }

        .swipe-wrapper {
            width: 300%;
            height: 100%;
            display: flex;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-33.33%);
            /* 🆕 新增：防止手機端彈性滾動 */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-x pan-y;
        }

        .swipe-slide {
            width: 33.33%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 页面指示器 */
        .page-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .indicator-dot.active {
            background: rgba(255,255,255,0.9);
            transform: scale(1.2);
        }

        /* 🆕 新增：手機端防止彈性滾動的額外設置 */
        @media (max-width: 768px) {
            body {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* 🆕 修正：移除強制固定位置，保持原有布局 */
                position: relative !important;
                width: 100vw !important;
                height: 100vh !important;
            }
            
            .phone-container {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* 🆕 修正：移除強制固定位置，保持原有布局 */
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .swipe-container {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* 🆕 修正：移除強制固定位置，保持原有布局 */
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            .swipe-wrapper {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* 🆕 修正：移除transform覆蓋，保持滑動功能 */
                will-change: transform !important;
            }
            
            .swipe-slide {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
                /* 🆕 修正：移除transform覆蓋，保持滑動功能 */
                will-change: transform !important;
            }
            
            /* 🆕 新增：iframe防護 */
            iframe {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            
            /* 🆕 新增：所有子元素防護 */
            * {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            
            /* 🆕 新增：特定容器防護 */
            .page-new, .page-one, .page-two {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            
            .new-page-content, .status-content, .map-content {
                overscroll-behavior: none !important;
                -webkit-overflow-scrolling: auto !important;
                touch-action: manipulation !important;
            }
            

            
            .phone-frame {
                position: relative !important;
                overflow: visible !important;
            }
        }

        /* 新页面样式 */
        .page-new {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.3)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.25)"/><circle cx="70" cy="70" r="1" fill="rgba(255,255,255,0.2)"/></svg>') repeat;
        }

        .page-new::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(106,90,205,0.3) 0%, rgba(72,61,139,0.2) 100%);
            z-index: 1;
        }

        .new-page-content {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            z-index: 2;
            position: relative;
        }

        .new-page-container {
            background: var(--section-bg);
            backdrop-filter: blur(20px);
            border-radius: 40px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 500px;
        }

        .new-page-header {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .new-page-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #6a5acd, #483d8b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .new-page-subtitle {
            font-size: 12px;
            opacity: 0.8;
            color: var(--text-color);
        }

        .new-page-body {
            flex: 1;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            border: none;
            border-radius: 0;
            color: var(--text-color);
            font-size: 14px;
            opacity: 1;
            text-align: center;
            overflow: hidden;
        }

        /* 第一页样式 */
        .page-one {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.3)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.25)"/><circle cx="70" cy="70" r="1" fill="rgba(255,255,255,0.2)"/></svg>') repeat;
        }

        .page-one::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(106,90,205,0.3) 0%, rgba(72,61,139,0.2) 100%);
            z-index: 1;
        }

        .page-one-content {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            position: relative;
        }

        .page-one-placeholder {
            text-align: center;
            color: rgba(255,255,255,0.7);
        }

        .page-one-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-one-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }

        /* 状态页面样式 */
        .status-content {
            flex: 1;
            padding: 20px 15px 60px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 2;
            position: relative;
            overflow-y: auto;
        }

        /* 设置菜单按钮 */
        .settings-menu-btn {
            position: absolute;
            top: 25px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: var(--section-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 50;
        }

        .settings-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .hamburger-icon .line {
            width: 18px;
            height: 2px;
            background: var(--text-color);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        /* 模态窗口基础样式 */
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 15000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            border-radius: 0px;
            overflow: hidden;
        }

        /* 音樂設置模態窗口特殊樣式 - 透明背景 */
        #musicSettingsModal {
            background: transparent !important;
            backdrop-filter: none !important;
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }

        #musicSettingsModal.show {
            background: transparent !important;
            backdrop-filter: none !important;
        }

        /* 音樂設置模態窗口動畫優化 */
        #musicSettingsModal .modal-content {
            transform: scale(0.7) translateY(30px) !important;
            opacity: 0 !important;
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }

        #musicSettingsModal.show .modal-content {
            transform: scale(1) translateY(0) !important;
            opacity: 1 !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25) !important;
        }

        /* 標籤頁樣式優化 */
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.7) !important;
            color: #333333 !important;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 文件上傳區域樣式 */
        #uploadArea:hover {
            border-color: rgba(0, 0, 0, 0.5) !important;
            background: rgba(255, 255, 255, 0.7) !important;
        }

        #uploadArea.dragover {
            border-color: #4CAF50 !important;
            background: rgba(76, 175, 80, 0.1) !important;
        }


        .modal.show {
            display: flex;
            opacity: 1;
            border-radius: 40px;
        }

        .modal-content {
            background: transparent;
            backdrop-filter: none;
            border-radius: 24px;
            width: 100%;
            height: 100%;
            border: none;
            box-shadow: none;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .modal.show .modal-content {
            transform: scale(1);
            border-radius: 0;
        }

        .modal-header {
            background: rgba(255, 105, 180, 0.2);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-icon {
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .modal-placeholder {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            color: var(--text-color);
            font-size: 14px;
            opacity: 0.7;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        /* 日程表模态框特殊样式 */
        #scheduleModal {
            border-radius: 0 !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 15000 !important;
        }
        
        #scheduleModal .modal-content {
            transform: none !important;
            border-radius: 15px !important;
            width: 350px !important;
            max-width: 350px !important;
            height: auto !important;
            min-height: 200px !important;
            max-height: 400px !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            margin: 0 !important;
        }

        /* 浮動關閉按鈕 */
        .floating-close-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(231, 76, 60, 0.9);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .floating-close-btn:hover {
            background: rgba(231, 76, 60, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        /* 设置面板 */
        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.show {
            opacity: 1;
            visibility: visible;
        }

        .settings-header {
            background: var(--section-bg);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-settings:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* 标签页样式 */
        .settings-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 0 20px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: rgba(255, 105, 180, 0.3);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-tip {
            background: rgba(255, 107, 157, 0.1);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 107, 157, 0.3);
        }

        .setting-group {
            margin-bottom: 24px;
        }

        .setting-group label {
            display: block;
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .color-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: white;
        }

        .color-option.active {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #e55a5a;
            transform: translateY(-2px);
        }

        /* 主题按钮样式 */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .theme-btn {
            background: var(--section-bg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .theme-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 105, 180, 0.5);
        }

        .theme-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .theme-name {
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
        }

        /* 自定义输入框样式 */
        .custom-inputs {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
        }

        .input-group input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 13px;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .input-group input:focus {
            outline: none;
            border-color: rgba(255, 105, 180, 0.5);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.3);
        }

        .input-group input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group input:enabled {
            cursor: text;
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* 背景設置樣式 */
        .background-options {
            margin-top: 10px;
        }

        .background-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .background-tab {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .background-tab.active {
            background: rgba(255, 105, 180, 0.3);
            border-color: rgba(255, 105, 180, 0.5);
        }

        .background-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .background-content {
            margin-bottom: 15px;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area:hover {
            border-color: rgba(255, 105, 180, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .upload-text {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
        }

        .url-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .url-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 13px;
        }

        .url-input:focus {
            outline: none;
            border-color: rgba(255, 105, 180, 0.5);
        }

        .url-test-btn {
            background: rgba(255, 105, 180, 0.3);
            border: 1px solid rgba(255, 105, 180, 0.5);
            border-radius: 8px;
            padding: 10px 16px;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .url-test-btn:hover {
            background: rgba(255, 105, 180, 0.4);
        }

        /* 頭像設置樣式 */
        .avatar-options {
            margin-top: 10px;
        }

        .avatar-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .avatar-tab {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-tab.active {
            background: rgba(255, 105, 180, 0.3);
            border-color: rgba(255, 105, 180, 0.5);
        }

        .avatar-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .avatar-content {
            margin-bottom: 15px;
        }

        .avatar-preview {
            margin-top: 15px;
            text-align: center;
        }

        .avatar-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 50%;
            border: 3px solid rgba(255, 105, 180, 0.3);
            margin-bottom: 10px;
        }

        .current-avatar {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .current-avatar-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .current-avatar-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-avatar-info span {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
        }

        /* 隊友頭像設置樣式 */
        .teammate-avatar-options {
            margin-top: 10px;
        }

        .teammate-avatar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .teammate-avatar-title {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
        }

        .add-teammate-btn {
            background: rgba(255, 105, 180, 0.3);
            border: 1px solid rgba(255, 105, 180, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-teammate-btn:hover {
            background: rgba(255, 105, 180, 0.4);
        }

        .add-icon {
            font-size: 16px;
            font-weight: bold;
        }

        .teammate-avatar-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .no-teammates {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-align: center;
            padding: 20px;
        }

        .teammate-avatar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .teammate-avatar-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .teammate-avatar-info {
            flex: 1;
        }

        .teammate-avatar-name {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .teammate-avatar-tag {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
        }

        .teammate-avatar-actions {
            display: flex;
            gap: 5px;
        }

        .teammate-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: #ffffff;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .teammate-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .teammate-action-btn.delete {
            background: rgba(244, 67, 54, 0.3);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .teammate-action-btn.delete:hover {
            background: rgba(244, 67, 54, 0.4);
        }

        /* 表單樣式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(255, 105, 180, 0.5);
        }

        .teammate-avatar-upload {
            margin-top: 5px;
        }

        .teammate-avatar-preview {
            margin-top: 10px;
            text-align: center;
        }

        .teammate-avatar-preview img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 50%;
            border: 2px solid rgba(255, 105, 180, 0.3);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-save {
            background: rgba(76, 175, 80, 0.3);
            color: #ffffff;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .btn-save:hover {
            background: rgba(76, 175, 80, 0.4);
        }

        .url-test-btn:hover {
            background: rgba(255, 105, 180, 0.4);
        }

        .background-preview, .url-preview {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 15px;
        }

        .background-preview img, .url-preview img {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .preview-btn.apply-btn {
            background: rgba(76, 175, 80, 0.3);
            color: #ffffff;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .preview-btn.apply-btn:hover {
            background: rgba(76, 175, 80, 0.4);
        }

        .preview-btn.remove-btn {
            background: rgba(244, 67, 54, 0.3);
            color: #ffffff;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .preview-btn.remove-btn:hover {
            background: rgba(244, 67, 54, 0.4);
        }

        .current-background {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 15px;
        }

        .current-bg-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .current-bg-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-bg-info span {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
        }

        .remove-current-btn {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 6px;
            padding: 6px 12px;
            color: #ffffff;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-current-btn:hover {
            background: rgba(244, 67, 54, 0.4);
        }

        /* 确保输入框在所有情况下都可以交互 */
        .settings-content .input-group input {
            pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            cursor: text !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 10000 !important;
        }

        /* 确保设置内容区域可以交互 */
        .settings-content {
            pointer-events: auto !important;
        }

        /* 确保输入组可以交互 */
        .input-group {
            pointer-events: auto !important;
        }

        /* 确保设置面板内容可以交互 */
        .settings-content {
            pointer-events: auto !important;
        }

        /* 确保输入组可以交互 */
        .input-group {
            pointer-events: auto !important;
        }

        .apply-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        /* 顶部状态卡片 */
        .top-status-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 50px;
        }

        /* 底部日程表 */
        .bottom-schedule {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* 主角信息区域 */
        .custom-info-section {
            background: var(--section-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .custom-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .custom-title {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }

        /* 日程图标 */
        .schedule-icon-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            z-index: 20;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .schedule-icon-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
        }

        .schedule-icon-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .main-custom-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .custom-avatar {
            position: relative;
            margin-bottom: 16px;
        }

        .custom-avatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid rgba(255, 105, 180, 0.8);
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.4);
            object-fit: cover;
            object-position: center;
        }

        .avatar-glow {
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff69b4, #ff1493, #ff69b4);
            opacity: 0.3;
            animation: avatarPulse 3s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.6; }
        }

        @keyframes musicRotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .custom-name {
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .custom-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .custom-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-btn.pending {
            background: linear-gradient(135deg, #ffd700, #ffa500);
            color: white;
        }

        .custom-btn.level {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        .custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .custom-action {
            color: var(--text-color);
            font-size: 12px;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 12px;
            border-left: 3px solid rgba(255, 105, 180, 0.8);
        }

        /* 队友选择区域 */
        .teammates-section {
            margin-bottom: 8px;
        }

        .teammates-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .teammate-btn {
            background: var(--section-bg);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .teammate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }

        .teammate-btn:hover::before {
            left: 100%;
        }

        .teammate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 105, 180, 0.5);
        }

        /* 不同队友的颜色标识 */
        .teammate-btn[data-teammate="A"] .teammate-label {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
        }

        .teammate-btn[data-teammate="B"] .teammate-label {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .teammate-btn[data-teammate="C"] .teammate-label {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .teammate-btn[data-teammate="D"] .teammate-label {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
        }

        .teammate-label {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 50%;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
        }

        .teammate-name {
            color: var(--text-color);
            font-size: 12px;
            font-weight: 500;
        }

        .status-card {
            background: var(--section-bg);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }

        .status-card:hover::before {
            left: 100%;
        }

        .schedule-card {
            cursor: pointer;
        }

        .schedule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
            color: var(--text-color);
        }

        .card-decoration {
            font-size: 16px;
            opacity: 0.8;
        }

        .datetime-info, .location-info {
            font-size: 13px;
            font-weight: 500;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
        }

        /* 删除不再使用的折叠相关样式 */
        /* .toggle-icon, .schedule-content, .schedule-content.expanded 等样式已移除 */

        .schedule-section {
            margin-bottom: 16px;
        }

        .schedule-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            color: #337690;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 2px;
            margin-right: 8px;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            padding: 6px 0;
        }

        .time-slot {
            color: #000000;
            font-size: 11px;
            font-weight: 500;
            min-width: 70px;
            background: rgba(255, 182, 193, 0.2);
            padding: 3px 6px;
            border-radius: 6px;
            text-align: center;
        }

        .activity {
            color: var(--text-color);
            font-size: 11px;
            flex: 1;
        }

        .status-tag {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 9px;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .status-tag.ongoing {
            background: rgba(255, 193, 7, 0.3);
            color: #804c03;
            border-color: rgba(255, 193, 7, 0.5);
        }

        .important-event {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .event-date {
            color: #621621;
            font-size: 10px;
            margin-bottom: 3px;
        }

        .event-title {
            color: var(--text-color);
            font-size: 11px;
            font-weight: 500;
        }

        .highlight {
            color: #ba2929;
            font-weight: 600;
        }

        /* 队友信息弹窗 */
        .teammate-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            border-radius: 40px;
            overflow: hidden;
        }

        .teammate-modal.show {
            display: flex;
            opacity: 1;
        }

        .teammate-modal-content {
            background: var(--section-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 90%;
            max-width: 320px;
            max-height: 80%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .teammate-modal.show .teammate-modal-content {
            transform: scale(1);
        }

        .teammate-modal-header {
            background: rgba(255, 105, 180, 0.2);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .teammate-avatar-small img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 105, 180, 0.8);
            object-fit: cover;
            object-position: center;
        }

        .teammate-modal-title {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .teammate-role {
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            line-height: 1.2;
        }

        .teammate-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .teammate-tag {
            background: rgba(255, 105, 180, 0.2);
            color: var(--text-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid rgba(255, 105, 180, 0.3);
        }

        .teammate-location {
            color: var(--text-color);
            font-size: 12px;
            opacity: 0.8;
        }

        .teammate-level {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .close-teammate-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-teammate-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .teammate-modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .teammate-info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-left: 12px;
            border-left: 3px solid rgba(255, 105, 180, 0.5);
        }

        .info-label {
            color: #87CEEB;
            font-size: 13px;
            font-weight: 600;
            min-width: 60px;
            margin-right: 12px;
        }

        .info-value {
            color: var(--text-color);
            font-size: 13px;
            line-height: 1.4;
            flex: 1;
        }

        /* 自定义滚动条样式 */
        .status-content::-webkit-scrollbar,
        .teammate-modal-body::-webkit-scrollbar,
        .modal-body::-webkit-scrollbar {
            width: 4px;
        }

        .status-content::-webkit-scrollbar-track,
        .teammate-modal-body::-webkit-scrollbar-track,
        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .status-content::-webkit-scrollbar-thumb,
        .teammate-modal-body::-webkit-scrollbar-thumb,
        .modal-body::-webkit-scrollbar-thumb {
            background: var(--scrollbar-color);
            border-radius: 2px;
        }

        .status-content::-webkit-scrollbar-thumb:hover,
        .teammate-modal-body::-webkit-scrollbar-thumb:hover,
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-color);
            opacity: 0.8;
        }

        /* 第二页样式 */
        .page-two {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.3)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.2)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.25)"/><circle cx="70" cy="70" r="1" fill="rgba(255,255,255,0.2)"/></svg>') repeat;
        }

        .page-two::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(106,90,205,0.3) 0%, rgba(72,61,139,0.2) 100%);
            z-index: 1;
        }



        .header {
            padding: 25px 20px 10px;
            text-align: center;
            z-index: 2;
            position: relative;
        }

        .header-time {
            background: rgba(255,255,255,0.2);
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 13px;
            color: #fff;
            display: inline-block;
            margin-top: 25px;
            margin-bottom: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .app-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(255,107,107,0.3);
        }

        .app-subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
        }

        .nav-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 30px 40px;
            z-index: 2;
            position: relative;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 320px;
            grid-template-rows: repeat(3, 1fr);
        }



        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 110px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .nav-button:hover::before {
            left: 100%;
        }

        .nav-button:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border-color: rgba(255,107,107,0.5);
        }

        .nav-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(255,107,107,0.3);
        }

        .nav-icon svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        .nav-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .nav-description {
            font-size: 10px;
            color: #666;
            text-align: center;
            line-height: 1.3;
        }



















        .notification {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,107,107,0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(255,107,107,0.3);
        }

        .notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(10px);
        }



        @media (max-width: 400px) {
            .phone-frame {
                width: min(350px, 98vw);
                height: min(620px, 98vh);
                min-width: 280px;
                min-height: 450px;
            }
            
            .nav-button {
                height: 100px;
            }
            
            .nav-grid {
                gap: 10px;
            }



            .nav-container {
                padding: 10px 15px 25px;
            }
            
            .nav-icon {
                width: 36px;
                height: 36px;
            }
            
            .nav-icon svg {
                width: 20px;
                height: 20px;
            }

            .nav-label {
                font-size: 13px;
            }

            .nav-description {
                font-size: 9px;
            }

            .status-content {
                padding: 15px 12px 50px;
                gap: 12px;
            }

            .settings-menu-btn {
                top: 10px;
                left: 10px;
                width: 35px;
                height: 35px;
            }

            .hamburger-icon .line {
                width: 16px;
            }

            .settings-header {
                padding: 16px;
            }

            .settings-header h3 {
                font-size: 16px;
            }

            .settings-content {
                padding: 16px;
            }

            .settings-tip {
                padding: 8px 12px;
                font-size: 11px;
                margin-bottom: 16px;
            }

            .setting-group {
                margin-bottom: 20px;
            }

            .setting-group label {
                font-size: 13px;
                margin-bottom: 10px;
            }

            .color-option {
                width: 35px;
                height: 35px;
            }

            .color-options {
                gap: 10px;
            }

            .top-status-cards {
                gap: 6px;
            }

            .custom-info-section {
                padding: 16px;
            }

            .custom-title {
                font-size: 16px;
            }

            .custom-avatar img {
                width: 80px;
                height: 80px;
            }

            .custom-name {
                font-size: 14px;
            }

            .custom-action {
                font-size: 11px;
                padding: 10px;
            }
        }

        /* 🔥 新增：針對更小屏幕的優化 */
        @media (max-width: 360px) {
            .phone-frame {
                width: 98vw;
                height: 98vh;
                min-width: 260px;
                min-height: 400px;
                border-radius: 24px;
            }
            

            
            .phone-homebar {
                width: 100px;
                height: 4px;
                bottom: 12px;
            }
            
            .nav-container {
                padding: 8px 12px 20px;
            }
            
            .nav-button {
                height: 80px;
            }
            
            .nav-icon {
                width: 32px;
                height: 32px;
            }
            
            .nav-label {
                font-size: 12px;
            }
            
            .nav-description {
                font-size: 8px;
            }
        }
        
        /* 音樂列表樣式 */
        .music-item:hover {
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 215, 0, 0.3) !important;
        }
        
        .music-item .music-actions button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .music-item .music-actions button:active {
            transform: scale(0.98);
        }
        
        /* 音樂項目點擊效果 */
        .music-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 215, 0, 0.3);
            background: linear-gradient(145deg, #3a3a3a, #4a4a4a) !important;
        }
        
        .music-item:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 添加音樂按鈕懸停效果 */
        .music-list-section h4 button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, #FFA500, #FF8C00) !important;
        }
        
        .music-list-section h4 button:active {
            transform: scale(0.95);
        }
        
        #musicList::-webkit-scrollbar {
            width: 6px;
        }
        
        #musicList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #musicList::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #musicList::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .music-add-btn:hover,
        .music-test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .music-add-btn:active,
        .music-test-btn:active {
            transform: translateY(0);
        }
        
        /* 輸入框焦點效果 */
        #musicNameInput:focus,
        #musicUrlInput:focus,
        #addMusicNameInput:focus,
        #addMusicUrlInput:focus {
            outline: none;
            border-color: #FFD700 !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), inset 0 2px 5px rgba(0, 0, 0, 0.2) !important;
            background: rgba(0, 0, 0, 0.5) !important;
        }
        
        /* 音樂列表滾動條樣式 */
        #musicList::-webkit-scrollbar {
            width: 8px;
        }
        
        #musicList::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        #musicList::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 4px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        #musicList::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
        }
    </style>
</head>
<body>
    <!-- 日程表模态窗口 -->
    <div class="modal" id="scheduleModal" style="position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.5) !important; backdrop-filter: blur(10px) !important; z-index: 15000 !important; display: none !important; align-items: center !important; justify-content: center !important; opacity: 0 !important; transition: all 0.3s ease !important; border-radius: 0px !important; overflow: hidden !important;">
        <div class="modal-content" style="transform: none !important; border-radius: 15px !important; width: 350px !important; max-width: 350px !important; height: auto !important; min-height: 200px !important; max-height: 400px !important; background: rgba(255, 255, 255, 0.95) !important; backdrop-filter: blur(10px) !important; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important; position: relative !important; left: 0 !important; top: 0 !important; margin: auto !important;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff6b9d, #e55982) !important; color: white !important; border-radius: 15px 15px 0 0 !important; padding: 12px 15px !important;">
                <div class="modal-title" style="font-size: 16px !important; font-weight: bold !important; color: white !important;">
                    <span class="modal-icon">📅</span>
                    日程表
                </div>
                <button class="close-modal" onclick="closeModal('scheduleModal')" style="position: absolute !important; top: 10px !important; right: 10px !important; width: 30px !important; height: 30px !important; background: rgba(255, 255, 255, 0.2) !important; color: white !important; border: none !important; border-radius: 50% !important; display: flex !important; align-items: center !important; justify-content: center !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important;">×</button>
            </div>
            <div class="modal-body" style="padding: 15px !important; max-height: 300px !important; overflow-y: auto !important; background: white !important;">
                <div class="schedule-section" style="margin-bottom: 20px;">
                    <div class="section-title" style="font-size: 14px !important; font-weight: bold !important; color: #333 !important; margin-bottom: 10px !important; border-bottom: 2px solid #4CAF50 !important; padding-bottom: 5px !important;">今日剩余行程:</div>
                    <div class="schedule-item" style="display: flex !important; align-items: center !important; margin-bottom: 12px !important; padding: 10px !important; background: rgba(76, 175, 80, 0.1) !important; border-radius: 8px !important; border-left: 4px solid #4CAF50 !important;">
                        <div class="time-slot" style="font-size: 12px !important; font-weight: bold !important; color: #4CAF50 !important; min-width: 80px !important; margin-right: 10px !important;">09:00-12:00</div>
                        <div class="activity" style="font-size: 13px !important; color: #333 !important; flex: 1 !important;">全体见面会 <span class="status-tag ongoing" style="font-size: 11px !important; padding: 2px 6px !important; border-radius: 10px !important; margin-left: 5px !important; background: #ff9800 !important; color: white !important;">（进行中）</span></div>
                    </div>
                    <div class="schedule-item" style="display: flex !important; align-items: center !important; margin-bottom: 12px !important; padding: 10px !important; background: rgba(76, 175, 80, 0.1) !important; border-radius: 8px !important; border-left: 4px solid #4CAF50 !important;">
                        <div class="time-slot" style="font-size: 12px !important; font-weight: bold !important; color: #4CAF50 !important; min-width: 80px !important; margin-right: 10px !important;">14:00-17:00</div>
                        <div class="activity" style="font-size: 13px !important; color: #333 !important; flex: 1 !important;">导师示范表演</div>
                    </div>
                    <div class="schedule-item" style="display: flex !important; align-items: center !important; margin-bottom: 12px !important; padding: 10px !important; background: rgba(76, 175, 80, 0.1) !important; border-radius: 8px !important; border-left: 4px solid #4CAF50 !important;">
                        <div class="time-slot" style="font-size: 12px !important; font-weight: bold !important; color: #4CAF50 !important; min-width: 80px !important; margin-right: 10px !important;">19:00-21:00</div>
                        <div class="activity" style="font-size: 13px !important; color: #333 !important; flex: 1 !important;">公司组排练</div>
                    </div>
                </div>

                <div class="schedule-section" style="margin-bottom: 20px;">
                    <div class="section-title" style="font-size: 14px !important; font-weight: bold !important; color: #333 !important; margin-bottom: 10px !important; border-bottom: 2px solid #4CAF50 !important; padding-bottom: 5px !important;">近期重要安排:</div>
                    <div class="important-event" style="background: rgba(255, 193, 7, 0.1) !important; border: 2px solid #ffc107 !important; border-radius: 10px !important; padding: 15px !important; margin-top: 10px !important;">
                        <div class="event-date" style="font-size: 12px !important; color: #ff9800 !important; font-weight: bold !important; margin-bottom: 5px !important;">2025年6月11日</div>
                        <div class="event-title" style="font-size: 14px !important; color: #333 !important; font-weight: bold !important;">初评级录制 <span class="highlight" style="color: #ff9800 !important; font-weight: bold !important;">（准备中）</span> ✨</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="phone-frame">
        <div class="phone-container">
            <!-- 音乐控制按钮 -->
            <div class="music-control-btn" id="musicControlBtn" style="position: absolute; top: 20px; right: 20px; width: 45px; height: 45px; background: rgba(255, 107, 157, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9999; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3); border: 2px solid white; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; touch-action: manipulation;" title="單擊播放/暫停，雙擊切換音樂，長按設置">
                <img src="https://files.catbox.moe/b2bgvm.png" alt="音樂" class="music-icon" id="musicIcon" style="width: 20px; height: 20px; transition: transform 0.3s ease; pointer-events: none; filter: brightness(0) invert(1);">
            </div>
            


            <div class="swipe-container">
                <div class="swipe-wrapper" id="swipeWrapper">
                    <!-- 新页面 - 空容器 -->
                    <div class="swipe-slide page-new">

                        
                        <div class="new-page-content" style="position: relative; overflow: hidden;">
                            <iframe id="vnPanelIframe" src="about:blank" style="width: 400px; height: 400px; max-width: 90%; border: none; border-radius: 40px; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); will-change: transform, width, height; z-index: 10;"></iframe>
                        </div>
                    </div>

                    <!-- 第一页 - 状态页面 -->
                    <div class="swipe-slide page-one">

                        
                        <div class="status-content">
                            <!-- 设置菜单按钮 -->
                            <div class="settings-menu-btn" onclick="toggleSettingsMenu()">
                                <div class="hamburger-icon">
                                    <div class="line"></div>
                                    <div class="line"></div>
                                    <div class="line"></div>
                                </div>
                            </div>



                            <!-- 顶部状态信息 -->
                            <div class="top-status-cards">
                                <!-- 日期时间信息 -->
                                <div class="status-card datetime-card">
                                    <div class="card-icon">📅</div>
                                    <div class="card-content">
                                        <div class="datetime-info">2025-06-26|08:15</div>
                                    </div>

                                </div>

                                <!-- 录制区域信息 -->
                                <div class="status-card location-card">
                                    <div class="card-icon">🏠</div>
                                    <div class="card-content">
                                        <div class="location-info">AREA_D_DAY | 維斯頓豪宅_黎昂臥室</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 主角信息区域 -->
                            <div class="custom-info-section">
                                <div class="custom-header">
                                    <div class="custom-title" id="projectTitle">项目信息</div>
                                    <button class="schedule-icon-btn" onclick="openScheduleModal()">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="main-custom-card">
                                    <div class="custom-avatar">
                                        <img src="https://files.catbox.moe/ew2nex.png" alt="主角头像" />
                                        <div class="avatar-glow"></div>
                                    </div>
                                    
                                    <div class="custom-name" id="userName">用户名</div>
                                    
                                    <div class="custom-buttons">
                                        <button class="custom-btn pending" id="statusBtn">⭐ 名聲待定</button>
                                        <button class="custom-btn level" id="levelBtn">待定级</button>
                                    </div>
                                    
                                    <div class="custom-action" id="userAction">
                                        这里是Action
                                    </div>
                                </div>
                            </div>

                            <!-- 角色名选择区域 -->
                            <div class="teammates-section">
                                <div class="teammates-grid">
                                    <button class="teammate-btn" onclick="showTeammateInfo('A')" data-teammate="A">
                                        <div class="teammate-label">A</div>
                                        <div class="teammate-name" id="memberA">角色名A</div>
                                    </button>
                                    <button class="teammate-btn" onclick="showTeammateInfo('B')" data-teammate="B">
                                        <div class="teammate-label">B</div>
                                        <div class="teammate-name" id="memberB">角色名B</div>
                                    </button>
                                    <button class="teammate-btn" onclick="showTeammateInfo('C')" data-teammate="C">
                                        <div class="teammate-label">C</div>
                                        <div class="teammate-name" id="memberC">角色名C</div>
                                    </button>
                                    <button class="teammate-btn" onclick="showTeammateInfo('D')" data-teammate="D">
                                        <div class="teammate-label">D</div>
                                        <div class="teammate-name" id="memberD">角色名D</div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 设置菜单面板 -->
                        <div class="settings-panel" id="settingsPanel">
                            <div class="settings-header">
                                <h3>设置面板</h3>
                                <button class="close-settings" onclick="toggleSettingsMenu()">×</button>
                            </div>
                            
                            <!-- 标签页导航 -->
                            <div class="settings-tabs">
                                <button class="tab-btn active" onclick="switchTab('style')">样式设置</button>
                                <button class="tab-btn" onclick="switchTab('name')">名称套用</button>
                            </div>
                            
                            <!-- 样式设置标签页 -->
                            <div class="settings-content" id="styleTab" style="display: block;">
                                <div class="settings-tip">
                                    💡 颜色设置会自动保存到本地
                                </div>
                                
                                <div class="setting-group">
                                    <label>容器颜色</label>
                                    <div class="color-options">
                                        <div class="color-option" data-container="pink" style="background: #FFB6C1;" onclick="changeContainerColor('pink')"></div>
                                        <div class="color-option" data-container="blue" style="background: #87CEEB;" onclick="changeContainerColor('blue')"></div>
                                        <div class="color-option" data-container="purple" style="background: #DDA0DD;" onclick="changeContainerColor('purple')"></div>
                                        <div class="color-option" data-container="green" style="background: #98FB98;" onclick="changeContainerColor('green')"></div>
                                        <div class="color-option" data-container="orange" style="background: #FFA07A;" onclick="changeContainerColor('orange')"></div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>背景設置</label>
                                    <div class="background-options">
                                        <div class="background-tabs">
                                            <button class="background-tab active" onclick="switchBackgroundTab('upload')">上傳圖片</button>
                                            <button class="background-tab" onclick="switchBackgroundTab('url')">URL輸入</button>
                                        </div>
                                        
                                        <!-- 上傳圖片模式 -->
                                        <div class="background-content" id="uploadBackgroundTab">
                                            <div class="upload-area" onclick="document.getElementById('backgroundFileInput').click()">
                                                <div class="upload-icon">📁</div>
                                                <div class="upload-text">點擊選擇圖片</div>
                                                <div class="upload-hint">支持 JPG、PNG、GIF 格式</div>
                                            </div>
                                            <input type="file" id="backgroundFileInput" accept="image/*" style="display: none;" onchange="handleBackgroundFileUpload(event)">
                                            
                                            <div class="background-preview" id="backgroundPreview" style="display: none;">
                                                <img id="previewImage" src="" alt="背景預覽">
                                                <div class="preview-actions">
                                                    <button class="preview-btn apply-btn" onclick="applyBackgroundImage()">應用背景</button>
                                                    <button class="preview-btn remove-btn" onclick="removeBackgroundImage()">移除背景</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- URL輸入模式 -->
                                        <div class="background-content" id="urlBackgroundTab" style="display: none;">
                                            <div class="url-input-group">
                                                <input type="url" id="backgroundUrlInput" placeholder="輸入圖片URL地址..." class="url-input">
                                                <button class="url-test-btn" onclick="testBackgroundUrl()">測試</button>
                                            </div>
                                            <div class="url-preview" id="urlPreview" style="display: none;">
                                                <img id="urlPreviewImage" src="" alt="URL預覽">
                                                <div class="preview-actions">
                                                    <button class="preview-btn apply-btn" onclick="applyUrlBackground()">應用背景</button>
                                                    <button class="preview-btn remove-btn" onclick="removeBackgroundImage()">移除背景</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 當前背景顯示 -->
                                        <div class="current-background" id="currentBackground" style="display: none;">
                                            <div class="current-bg-label">當前背景:</div>
                                            <div class="current-bg-info">
                                                <span id="currentBgName">未設置</span>
                                                <button class="remove-current-btn" onclick="removeBackgroundImage()">移除</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>主角頭像設置</label>
                                    <div class="avatar-options">
                                        <div class="avatar-tabs">
                                            <button class="avatar-tab active" onclick="switchAvatarTab('upload')">上傳頭像</button>
                                            <button class="avatar-tab" onclick="switchAvatarTab('url')">URL輸入</button>
                                        </div>
                                        
                                        <!-- 上傳頭像模式 -->
                                        <div class="avatar-content" id="uploadAvatarTab">
                                            <div class="upload-area" onclick="document.getElementById('avatarFileInput').click()">
                                                <div class="upload-icon">👤</div>
                                                <div class="upload-text">點擊選擇主角頭像</div>
                                                <div class="upload-hint">支持 JPG、PNG、GIF 格式</div>
                                            </div>
                                            <input type="file" id="avatarFileInput" accept="image/*" style="display: none;" onchange="handleAvatarFileUpload(event)">
                                            
                                            <div class="avatar-preview" id="avatarPreview" style="display: none;">
                                                                                                 <img id="previewAvatar" src="" alt="主角頭像預覽">
                                                <div class="preview-actions">
                                                                                                         <button class="preview-btn apply-btn" onclick="applyAvatarImage()">應用主角頭像</button>
                                                    <button class="preview-btn remove-btn" onclick="removeAvatarImage()">移除頭像</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- URL輸入模式 -->
                                        <div class="avatar-content" id="urlAvatarTab" style="display: none;">
                                            <div class="url-input-group">
                                                                                                 <input type="url" id="avatarUrlInput" placeholder="輸入主角頭像URL地址..." class="url-input">
                                                <button class="url-test-btn" onclick="testAvatarUrl()">測試</button>
                                            </div>
                                            <div class="url-preview" id="urlAvatarPreview" style="display: none;">
                                                                                                 <img id="urlPreviewAvatar" src="" alt="URL主角頭像預覽">
                                                <div class="preview-actions">
                                                                                                         <button class="preview-btn apply-btn" onclick="applyUrlAvatar()">應用主角頭像</button>
                                                    <button class="preview-btn remove-btn" onclick="removeAvatarImage()">移除頭像</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 當前頭像顯示 -->
                                        <div class="current-avatar" id="currentAvatar" style="display: none;">
                                                                                         <div class="current-avatar-label">當前主角頭像:</div>
                                            <div class="current-avatar-info">
                                                <span id="currentAvatarName">未設置</span>
                                                <button class="remove-current-btn" onclick="removeAvatarImage()">移除</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>隊友頭像設置</label>
                                    <div class="teammate-avatar-options">
                                        <div class="teammate-avatar-header">
                                            <div class="teammate-avatar-title">角色頭像庫</div>
                                            <button class="add-teammate-btn" onclick="openAddTeammateModal()">
                                                <span class="add-icon">+</span>
                                                添加角色
                                            </button>
                                        </div>
                                        
                                        <div class="teammate-avatar-list" id="teammateAvatarList">
                                            <!-- 動態生成的隊友頭像列表 -->
                                            <div class="no-teammates">暫無角色頭像，請點擊"添加角色"開始</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>栏目颜色</label>
                                    <div class="color-options">
                                        <div class="color-option" data-section="light" style="background: #F5F5DC;" onclick="changeSectionColor('light')"></div>
                                        <div class="color-option" data-section="white" style="background: #FFFFFF;" onclick="changeSectionColor('white')"></div>
                                        <div class="color-option" data-section="cream" style="background: #FFF8DC;" onclick="changeSectionColor('cream')"></div>
                                        <div class="color-option" data-section="lavender" style="background: #E6E6FA;" onclick="changeSectionColor('lavender')"></div>
                                        <div class="color-option" data-section="mint" style="background: #F0FFF0;" onclick="changeSectionColor('mint')"></div>
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <label>字体颜色</label>
                                    <div class="color-options">
                                        <div class="color-option" data-text="dark" style="background: #333333;" onclick="changeTextColor('dark')"></div>
                                        <div class="color-option" data-text="white" style="background: #FFFFFF; border: 1px solid #ccc;" onclick="changeTextColor('white')"></div>
                                        <div class="color-option" data-text="purple" style="background: #663399;" onclick="changeTextColor('purple')"></div>
                                        <div class="color-option" data-text="blue" style="background: #4169E1;" onclick="changeTextColor('blue')"></div>
                                        <div class="color-option" data-text="pink" style="background: #FF69B4;" onclick="changeTextColor('pink')"></div>
                                    </div>
                                </div>

                                <div class="setting-group">
                                    <button class="reset-btn" onclick="resetToDefault()">恢复默认</button>
                                </div>
                            </div>
                            
                            <!-- 名称套用标签页 -->
                            <div class="settings-content" id="nameTab" style="display: none;">
                                <div class="settings-tip">
                                    🎯 选择预设主题快速套用名称设置
                                </div>
                                
                                <div class="setting-group">
                                    <label>预设主题</label>
                                    <div class="theme-options">
                                        <button class="theme-btn" onclick="applyTheme('custom')">
                                            <div class="theme-icon">⭐</div>
                                            <div class="theme-name">偶像版本</div>
                                        </button>
                                        <button class="theme-btn" onclick="applyTheme('gaming')">
                                            <div class="theme-icon">🎮</div>
                                            <div class="theme-name">电竞版本</div>
                                        </button>
                                        <button class="theme-btn" onclick="applyTheme('business')">
                                            <div class="theme-icon">💼</div>
                                            <div class="theme-name">商务版本</div>
                                        </button>
                                        <button class="theme-btn" onclick="applyTheme('school')">
                                            <div class="theme-icon">📚</div>
                                            <div class="theme-name">学校版本</div>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <label>自定义设置</label>
                                    <div class="custom-inputs">
                                        <div class="input-group">
                                            <label>主标题</label>
                                            <input type="text" id="customTitle" placeholder="输入主标题" value="通用面板">
                                        </div>
                                        <div class="input-group">
                                            <label>副标题</label>
                                            <input type="text" id="customSubtitle" placeholder="输入副标题" value="多功能界面，自定义体验">
                                        </div>
                                        <div class="input-group">
                                            <label>项目名称</label>
                                            <input type="text" id="customProject" placeholder="输入项目名称" value="项目信息">
                                        </div>

                                    </div>
                                    <button class="apply-btn" onclick="applyCustomSettings()">应用自定义设置</button>
                                </div>
                            </div>
                        </div>

                        <!-- 队友信息弹窗 -->
                        <div class="teammate-modal" id="teammateModal">
                            <div class="teammate-modal-content">
                                <div class="teammate-modal-header">
                                    <div class="teammate-avatar-small">
                                        <img id="teammateModalAvatar" src="https://i.pravatar.cc/150?img=1" alt="队友头像" />
                                    </div>
                                    <div class="teammate-modal-title" id="teammateModalTitle">
                                        <div class="teammate-role">主舞-副唱</div>
                                        <div class="teammate-details">
                                            <span class="teammate-tag">#待定</span>
                                            <span class="teammate-location">居住地</span>
                                            <span class="teammate-level">评级待定级</span>
                                        </div>
                                    </div>
                                    <button class="close-teammate-modal" onclick="closeTeammateModal()">×</button>
                                </div>
                                
                                <div class="teammate-modal-body">
                                    <div class="teammate-info-item">
                                        <div class="info-label">tag：</div>
                                        <div class="info-value" id="teammateTag">冷静的观察者</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">好感：</div>
                                        <div class="info-value" id="teammateFavor">5</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">CP值：</div>
                                        <div class="info-value" id="teammateCP">1</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">状态：</div>
                                        <div class="info-value" id="teammateStatus">站在人群中后方，目光平静地看着被莱纳斯带到前排的Nocturne。</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">心情：</div>
                                        <div class="info-value" id="teammateMood">社交能力也是实力的一种。他比看上去要聪明。</div>
                                    </div>
                                    <div class="teammate-info-item">
                                        <div class="info-label">着装：</div>
                                        <div class="info-value" id="teammateOutfit">黑色宽松练舞裤，纯白T恤，头发打理得干净利落。</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 添加角色模態窗口 -->
                        <div class="modal" id="addTeammateModal">
                            <div class="modal-content" style="width: 400px !important; max-width: 400px !important;">
                                <div class="modal-header">
                                    <div class="modal-title">
                                        <span class="modal-icon">👥</span>
                                        添加角色頭像
                                    </div>
                                    <button class="close-modal" onclick="closeModal('addTeammateModal')">×</button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="teammateName">角色名稱:</label>
                                        <input type="text" id="teammateName" placeholder="輸入角色名稱..." class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label for="teammateTag">角色標籤:</label>
                                        <input type="text" id="teammateTag" placeholder="輸入角色標籤..." class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label>角色頭像:</label>
                                        <div class="teammate-avatar-upload">
                                            <div class="upload-area" onclick="document.getElementById('teammateAvatarFileInput').click()">
                                                <div class="upload-icon">👤</div>
                                                <div class="upload-text">點擊選擇頭像</div>
                                                <div class="upload-hint">支持 JPG、PNG、GIF 格式</div>
                                            </div>
                                            <input type="file" id="teammateAvatarFileInput" accept="image/*" style="display: none;" onchange="handleTeammateAvatarFileUpload(event)">
                                            
                                            <div class="teammate-avatar-preview" id="teammateAvatarPreview" style="display: none;">
                                                <img id="previewTeammateAvatar" src="" alt="角色頭像預覽">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn btn-cancel" onclick="closeModal('addTeammateModal')">取消</button>
                                        <button class="btn btn-save" onclick="saveTeammateAvatar()">保存角色</button>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>

                    <!-- 第二页 - 功能页面 -->
                    <div class="swipe-slide page-two">
                        <div class="header">
                            <div class="header-time">周三 14:30</div>
                            <h1 class="app-title" id="mainTitle">通用面板</h1>
                            <p class="app-subtitle" id="mainSubtitle">多功能界面，自定义体验</p>
                        </div>

                        <div class="nav-container">
                            <div class="nav-grid">
                                <!-- 📚 世界書功能 -->
                                <button class="nav-button lorebook" onclick="openLorebookManagerModal()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M21 5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2s2-.89 2-2V7c0-1.11-.89-2-2-2zM3 5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2s2-.89 2-2V7c0-1.11-.89-2-2-2zM12 5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2s2-.89 2-2V7c0-1.11-.89-2-2-2z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">世界書</div>
                                    <div class="nav-description">世界設定<br>知識管理</div>
                                </button>

                                <button class="nav-button map" onclick="openMap()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">地图</div>
                                    <div class="nav-description">场地导航<br>位置查看</div>
                                </button>

                                <button class="nav-button anonymous-forum" onclick="openAnonymousForum()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">匿名论坛</div>
                                    <div class="nav-description">匿名交流<br>自由讨论</div>
                                </button>

                                <button class="nav-button cp-activity" onclick="openCPActivity()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">CP超活</div>
                                    <div class="nav-description">CP互动<br>甜蜜活动</div>
                                </button>

                                <button class="nav-button chat-room" onclick="openChatRoom()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">聊天室</div>
                                    <div class="nav-description">私密聊天<br>练习生专属</div>
                                </button>

                                <button class="nav-button live-room" onclick="openLiveRoom()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4zM14 13h-3v3H9v-3H6v-2h3V8h2v3h3v2z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">直播间</div>
                                    <div class="nav-description">开启直播<br>与粉丝互动</div>
                                </button>

                                <button class="nav-button" onclick="openEvent()">
                                    <div class="nav-icon">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                    </div>
                                    <div class="nav-label">事件</div>
                                    <div class="nav-description">事件面板<br>活动管理</div>
                                </button>
                            </div>
                        </div>

                        <!-- 地图模态窗口 -->
                        <div class="modal" id="mapModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('mapModal')">&times;</button>
                                <iframe id="mapPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- 匿名论坛模态窗口 -->
                        <div class="modal" id="anonymousForumModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('anonymousForumModal')">&times;</button>
                                <iframe id="forumPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- CP活动模态窗口 -->
                        <div class="modal" id="cpActivityModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('cpActivityModal')">&times;</button>
                                <iframe id="echoPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- 聊天室模态窗口 -->
                        <div class="modal" id="chatRoomModal">
                            <div class="modal-content">
                                <button id="chatIframeCloseBtn" class="floating-close-btn" onclick="closeModal('chatRoomModal')">&times;</button>
                                <iframe id="chatPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>

                        <!-- 直播间模态窗口 -->
                        <div class="modal" id="liveRoomModal">
                            <div class="modal-content">
                                <button class="floating-close-btn" onclick="closeModal('liveRoomModal')">&times;</button>
                                <iframe id="livestreamPanelIframe" src="about:blank" style="width: 100%; height: 100%; border: none; border-radius: 24px;"></iframe>
                            </div>
                        </div>





                        <!-- 事件模态窗口 -->
                        <div class="modal" id="eventModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <div class="modal-title">
                                        <span class="modal-icon">📅</span>
                                        事件
                                    </div>
                                    <button class="close-modal" onclick="closeModal('eventModal')">×</button>
                                </div>
                                <div class="modal-body">
                                    <div class="modal-placeholder">
                                        这里是事件面板<br>
                                        等待添加内容...
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 页面指示器 -->
                <div class="page-indicator">
                    <div class="indicator-dot" onclick="goToPage(0)"></div>
                    <div class="indicator-dot active" onclick="goToPage(1)"></div>
                    <div class="indicator-dot" onclick="goToPage(2)"></div>
                </div>
            </div>

            <div class="notification" id="notification"></div>
        </div>
        <div class="phone-homebar"></div>
        </div>

    <!-- 音乐设置模态窗口 -->
    <div class="modal" id="musicSettingsModal">
        <!-- 背景黑膠唱片 - 與容器同層 -->
        <div id="vinylRecord" style="
            position: fixed;
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            height: 400px;
            background: url('https://files.catbox.moe/xn1a6j.png ') no-repeat center;
            background-size: contain;
            opacity: 1;
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 9997;
            pointer-events: none;
        "></div>
        
        <div class="modal-content" style="width: 380px !important; max-width: 320px !important; height: 500px !important; border-radius: 20px !important; background: linear-gradient(145deg, #f5f5dc, #e8e8d0) !important; backdrop-filter: blur(20px) !important; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important; position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; overflow: hidden !important; z-index: 9999; transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;">
            <!-- 主界面容器 -->
            <div style="
                position: relative;
                z-index: 2;
                background: linear-gradient(145deg, #f5f5dc, #e8e8d0);
                border-radius: 20px;
                padding: 20px;
                height: 100%;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            ">
                <!-- 頂部欄位 -->
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                ">
                    <!-- 左上角添加按鈕 -->
                    <button onclick="openAddMusicModal()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'" title="添加音樂">
                        <img src="https://files.catbox.moe/8b9erj.png" alt="添加" style="width: 20px; height: 20px;">
                    </button>
                    
                    <!-- 右上角耳機圖示 -->
                    <button onclick="closeModal('musicSettingsModal')" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/nqhnus.png" alt="關閉" style="width: 20px; height: 20px;">
                    </button>
                </div>
                
                <!-- 主視覺區域 - 音樂封面 -->
                <div style="
                    position: relative;
                    width: 100%;
                    height: 160px;
                    border-radius: 12px;
                    overflow: hidden;
                    margin-bottom: 15px;
                    background: linear-gradient(145deg, #e0e0e0, #f0f0f0);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <img id="musicCover" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUQ0Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYfliqDovb3lpLHotKU8L3RleHQ+Cjwvc3ZnPgo=" alt="音樂封面" style="
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        border-radius: 15px;
                    ">
                    
                    <!-- 音量控制按鈕 -->
                    <div id="volumeControlBtn" style="
                        position: absolute;
                        bottom: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        padding: 6px;
                        border-radius: 50%;
                        font-size: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 28px;
                        height: 28px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onclick="toggleVolumeControl()">
                        <img src="https://files.catbox.moe/wexq69.png " alt="音量" style="width: 16px; height: 16px;">
            </div>
                    
                    <!-- 音量控制面板 (隱藏) -->
                    <div id="volumeControlPanel" style="
                        position: absolute;
                        bottom: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.9);
                        color: white;
                        padding: 16px 12px;
                        border-radius: 25px;
                        font-size: 12px;
                        display: none;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        min-height: 140px;
                        backdrop-filter: blur(15px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    ">
                        <img id="volumeIcon" src="https://files.catbox.moe/wexq69.png " alt="音量" style="width: 16px; height: 16px; cursor: pointer;" onclick="toggleMute()">
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" style="
                            width: 4px;
                            height: 80px;
                            background: #ddd;
                            border-radius: 2px;
                            outline: none;
                            cursor: pointer;
                            writing-mode: bt-lr;
                            -webkit-appearance: slider-vertical;
                        " oninput="changeVolume(this.value)">
                        </div>
                    </div>
                
                <!-- 歌曲資訊 -->
                <div style="
                    text-align: center;
                    margin-bottom: 20px;
                ">
                    <div style="
                        font-weight: bold;
                        font-size: 18px;
                        color: #333;
                        margin-bottom: 5px;
                    ">TODAY'S SONG</div>
                    <div id="currentSongName" style="
                        font-size: 14px;
                        color: #666;
                    ">選擇音樂</div>
                </div>

                <!-- 進度條 -->
                <!-- 進度條和時間顯示 -->
                <div style="
                    margin-bottom: 20px;
                ">
                    <!-- 時間顯示 -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                        font-size: 12px;
                        color: #666;
                    ">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    
                    <!-- 可拖拽進度條 -->
                    <div id="progressContainer" style="
                        width: 100%;
                        height: 6px;
                        background: #ddd;
                        border-radius: 3px;
                        position: relative;
                        cursor: pointer;
                    " onclick="seekToPosition(event)" onmousedown="startDragging(event)">
                        <div id="progressBar" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #4CAF50, #45a049);
                            border-radius: 3px;
                            position: relative;
                            transition: width 0.1s ease;
                        ">
                            <div id="progressThumb" style="
                                position: absolute;
                                right: -6px;
                                top: -3px;
                                width: 12px;
                                height: 12px;
                                background: #4CAF50;
                                border-radius: 50%;
                                border: 2px solid #fff;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                cursor: grab;
                                transition: transform 0.2s ease;
                            " onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" onmousedown="startDragging(event)"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 播放控制按鈕 -->
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                ">
                    <button onclick="toggleMusicList()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'" title="展開/收縮音樂列表">
                        <img src="https://files.catbox.moe/b2bgvm.png" alt="音樂列表" style="width: 20px; height: 20px;">
                    </button>
                    
                    <button onclick="previousMusic()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/cnffp6.png" alt="上一首" style="width: 20px; height: 20px;">
                    </button>
                    
                    <button id="playPauseBtn" onclick="toggleMusic()" style="
                        background: #333;
                        border: none;
                        cursor: pointer;
                        padding: 12px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        color: white;
                        width: 45px;
                        height: 45px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        <img id="playPauseIcon" src="https://files.catbox.moe/4eigto.png" alt="播放" style="width: 24px; height: 24px;">
                    </button>
                    
                    <button onclick="nextMusic()" style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/brjbks.png" alt="下一首" style="width: 20px; height: 20px;">
                    </button>
                    
                    <button style="
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                        <img src="https://files.catbox.moe/5slg6h.png" alt="收藏" style="width: 20px; height: 20px;">
                    </button>
                </div>
                
                <!-- 音樂列表（可展開） -->
                <div style="
                    flex: 1;
                    overflow: hidden;
                    position: relative;
                ">
                    <div id="musicListContainer" style="
                        height: 0px;
                        overflow: hidden;
                        transition: all 0.3s ease;
                    ">
                        <div id="musicList" style="
                            height: 100%;
                            overflow-y: auto;
                            padding: 10px;
                            background: rgba(255,255,255,0.5);
                            border-radius: 15px;
                        "></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加音樂子模態窗口 -->
    <div class="add-music-modal" id="addMusicModal" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.5) !important; backdrop-filter: blur(10px) !important; z-index: 99999 !important; display: none !important; align-items: center !important; justify-content: center !important;" onclick="closeAddMusicModal()">
        <div class="modal-content" style="width: 380px !important; max-width: 380px !important; height: auto !important; min-height: 280px !important; max-height: 600px !important; border-radius: 20px !important; background: linear-gradient(145deg, #f5f5dc, #e8e8d0) !important; backdrop-filter: blur(20px) !important; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important; position: relative !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; overflow-y: auto !important;" onclick="event.stopPropagation();">
            <div class="modal-header" style="background: linear-gradient(135deg, #e8e8d0, #f5f5dc) !important; color: #333333 !important; border-radius: 20px 20px 0 0 !important; padding: 15px 18px !important; border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important; position: relative !important;">
                <div class="modal-title" style="font-size: 16px !important; font-weight: bold !important; color: #333333 !important;">
                    <span class="modal-icon" style="font-size: 18px !important; margin-right: 8px !important;">🎵</span>
                    添加新音樂
                </div>
                <button class="close-modal" onclick="closeAddMusicModal()" style="background: rgba(0, 0, 0, 0.1) !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; color: #333333 !important; font-size: 18px !important; width: 28px !important; height: 28px !important; border-radius: 50% !important; transition: all 0.3s ease !important;">×</button>
            </div>
            <div class="modal-body" style="padding: 18px !important; background: linear-gradient(145deg, #f5f5dc, #e8e8d0) !important; min-height: 400px !important; border-radius: 0 0 20px 20px !important;">
                <!-- 標籤頁切換 -->
                <div class="tab-container" style="margin-bottom: 20px;">
                    <div class="tab-buttons" style="display: flex; gap: 2px; background: rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 3px;">
                        <button id="urlTabBtn" class="tab-btn active" onclick="switchTab('url')" style="flex: 1; padding: 8px 12px; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); color: #333333;">URL輸入</button>
                        <button id="uploadTabBtn" class="tab-btn" onclick="switchTab('upload')" style="flex: 1; padding: 8px 12px; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: transparent; color: #666666;">本地上傳</button>
                    </div>
                </div>

                <!-- URL輸入模式 -->
                <div id="urlTab" class="tab-content active" style="display: block;">
                    <div class="music-url-input" style="margin-bottom: 15px;">
                        <label for="addMusicNameInput" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">音樂名稱:</label>
                        <input type="text" id="addMusicNameInput" placeholder="請輸入音樂名稱..." style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.2); border-radius: 10px; font-size: 13px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); color: #333333; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);">
                    </div>
                    <div class="music-url-input" style="margin-bottom: 20px;">
                        <label for="addMusicUrlInput" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">音樂URL:</label>
                        <input type="text" id="addMusicUrlInput" placeholder="請輸入音樂URL..." style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.2); border-radius: 10px; font-size: 13px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); color: #333333; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);">
                    </div>
                    <div class="music-controls" style="display: flex; gap: 12px;">
                        <button class="music-add-btn" onclick="addMusicFromModal()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">添加</button>
                        <button class="music-test-btn" onclick="testMusicFromModal()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">測試</button>
                    </div>
                </div>

                <!-- 本地上傳模式 -->
                <div id="uploadTab" class="tab-content" style="display: none;">
                    <div class="music-upload-input" style="margin-bottom: 15px;">
                        <label for="addMusicNameInput2" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">音樂名稱:</label>
                        <input type="text" id="addMusicNameInput2" placeholder="請輸入音樂名稱..." style="width: 100%; padding: 12px 15px; border: 2px solid rgba(0, 0, 0, 0.2); border-radius: 10px; font-size: 13px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); color: #333333; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);">
                    </div>
                    <div class="music-upload-area" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333333; font-size: 13px;">選擇音樂文件:</label>
                        <div id="uploadArea" style="border: 2px dashed rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 30px 20px; text-align: center; background: rgba(255, 255, 255, 0.5); cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('musicFileInput').click()">
                            <div style="font-size: 24px; margin-bottom: 10px; color: #666;">📁</div>
                            <div style="color: #666; font-size: 12px; margin-bottom: 5px;">點擊選擇音樂文件</div>
                            <div style="color: #999; font-size: 11px;">支持 MP3, WAV, OGG 格式</div>
                        </div>
                        <input type="file" id="musicFileInput" accept="audio/*" style="display: none;" onchange="handleFileSelect(event)">
                        <div id="fileInfo" style="margin-top: 10px; padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; display: none;">
                            <div style="font-size: 12px; color: #333; font-weight: bold;">已選擇文件:</div>
                            <div id="fileName" style="font-size: 11px; color: #666; margin-top: 2px;"></div>
                            <div id="fileSize" style="font-size: 11px; color: #666; margin-top: 2px;"></div>
                        </div>
                    </div>
                    <div class="music-controls" style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="music-add-btn" onclick="addMusicFromUpload()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">上傳並添加</button>
                        <button class="music-test-btn" onclick="testMusicFromUpload()" style="flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">測試播放</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入主题管理模块 -->
    <script src="theme-manager.js"></script>
    <script src="background-manager.js"></script>
    <script src="main_listener.js"></script>
    <script src="lorebook-manager.js"></script>

    <!-- 引入通信测试脚本 -->
    <script src="test_map_communication.js"></script>

    
    <script>
        // 現實時間更新函數
        function initRealTimeUpdate() {
            // 立即更新一次
            updateRealTime();
            
            // 每秒更新一次
            setInterval(updateRealTime, 1000);
        }

        function updateRealTime() {
            const now = new Date();
            const headerTimeElement = document.querySelector('.header-time');
            
            if (headerTimeElement) {
                // 格式化時間：週幾 時:分
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const weekday = weekdays[now.getDay()];
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                
                headerTimeElement.textContent = `週${weekday} ${hours}:${minutes}`;
            }
        }

        let currentPage = 1; // 默认从中间页面开始
        let startX = 0;
        let isDragging = false;
        let isSettingsOpen = false;
        let isModalOpen = false;
        
        // 音乐控制相关变量
        let isMusicPlaying = false;
        let currentMusicUrl = '';
        let audioElement = null;
        
        // 音樂列表管理相關變數
        let musicList = [];
        let currentMusicIndex = 0;
        let musicDB = null;
        
        // VN面板iframe動態伸縮相關變數
        let vnIframeState = 'landing'; // 'landing', 'story', 'continue'
        
        // =======================================================================
        //                            音樂列表管理系統
        // =======================================================================
        
        // 初始化IndexedDB
        function initMusicDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('MusicListDB', 1);
                
                request.onerror = () => {
                    console.error('[音樂系統] IndexedDB打開失敗');
                    reject(new Error('IndexedDB打開失敗'));
                };
                
                request.onsuccess = (event) => {
                    musicDB = event.target.result;
                    console.log('[音樂系統] IndexedDB初始化成功');
                    resolve(musicDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // 創建音樂列表存儲
                    if (!db.objectStoreNames.contains('musicList')) {
                        const musicStore = db.createObjectStore('musicList', { keyPath: 'id', autoIncrement: true });
                        musicStore.createIndex('name', 'name', { unique: false });
                        musicStore.createIndex('url', 'url', { unique: false });
                        console.log('[音樂系統] 創建音樂列表存儲');
                    }
                };
            });
        }
        
        // 添加音樂到列表
        async function addMusicToList() {
            const nameInput = document.getElementById('musicNameInput');
            const urlInput = document.getElementById('musicUrlInput');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!name || !url) {
                showNotification('請輸入音樂名稱和URL', 'warning');
                return;
            }
            
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                const musicItem = {
                    name: name,
                    url: url,
                    addedAt: new Date().toISOString()
                };
                
                const request = store.add(musicItem);
                
                request.onsuccess = () => {
                    console.log('[音樂系統] 音樂添加成功:', name);
                    showNotification(`音樂 "${name}" 已添加到列表`, 'success');
                    
                    // 清空輸入框
                    nameInput.value = '';
                    urlInput.value = '';
                    
                    // 重新載入音樂列表
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[音樂系統] 音樂添加失敗');
                    showNotification('音樂添加失敗', 'error');
                };
                
            } catch (error) {
                console.error('[音樂系統] 添加音樂時發生錯誤:', error);
                showNotification('添加音樂失敗', 'error');
            }
        }
        
        // 載入音樂列表
        async function loadMusicList() {
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readonly');
                const store = transaction.objectStore('musicList');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    musicList = request.result;
                    
                    // 如果列表為空，檢查是否有舊的localStorage數據需要遷移
                    if (musicList.length === 0) {
                        migrateOldMusicData();
                    } else {
                        renderMusicList();
                        updateCurrentMusicInfo();
                        
                        // 🔥 修改：從localStorage恢復之前保存的音樂索引
                        // 每次載入音樂列表時都嘗試恢復緩存狀態
                            const savedIndex = localStorage.getItem('currentMusicIndex');
                            const savedUrl = localStorage.getItem('currentMusicUrl');
                        
                        console.log('[音樂系統] 檢查緩存數據:', { savedIndex, savedUrl });
                            
                            if (savedIndex !== null && savedUrl !== null) {
                                const index = parseInt(savedIndex);
                                // 檢查保存的索引是否有效
                                if (index >= 0 && index < musicList.length) {
                                    // 檢查保存的URL是否還存在於列表中
                                    const savedMusic = musicList.find(music => music.url === savedUrl);
                                    if (savedMusic) {
                                        currentMusicIndex = index;
                                        currentMusicUrl = savedUrl;
                                        console.log('[音樂系統] 恢復之前保存的音樂:', savedMusic.name, `(索引: ${index})`);
                                    } else {
                                        // 保存的URL不存在，使用保存的索引
                                        currentMusicIndex = index;
                                        currentMusicUrl = musicList[index].url;
                                        console.log('[音樂系統] 恢復之前保存的音樂索引:', musicList[index].name, `(索引: ${index})`);
                                    }
                                } else {
                                    // 保存的索引無效，使用第一首
                                    currentMusicIndex = 0;
                                    currentMusicUrl = musicList[0].url;
                                    console.log('[音樂系統] 保存的索引無效，播放第一首音樂:', musicList[0].name);
                                }
                            } else {
                                // 沒有保存的數據，使用第一首
                                currentMusicIndex = 0;
                                currentMusicUrl = musicList[0].url;
                                console.log('[音樂系統] 沒有保存的數據，播放第一首音樂:', musicList[0].name);
                            }
                            
                        // 🔥 修改：緩存恢復後，直接播放對應的音樂
                        if (currentMusicIndex >= 0 && currentMusicIndex < musicList.length) {
                            console.log('[音樂系統] 緩存恢復完成，直接播放音樂:', musicList[currentMusicIndex].name);
                            playMusicFromList(currentMusicIndex);
                        } else {
                            // 只有在沒有音頻元素時才初始化背景音樂
                            if (!audioElement) {
                            initBackgroundMusic();
                            }
                        }
                    }
                };
                
            } catch (error) {
                console.error('[音樂系統] 載入音樂列表失敗:', error);
            }
        }
        
        // 遷移舊的localStorage音樂數據
        async function migrateOldMusicData() {
            const oldMusicUrl = localStorage.getItem('musicUrl');
            
            if (oldMusicUrl && oldMusicUrl !== 'https://files.catbox.moe/snenpf.mp3') {
                try {
                    // 將舊的音樂URL添加到新的音樂列表中
                    const musicItem = {
                        name: '之前保存的音樂',
                        url: oldMusicUrl,
                        addedAt: new Date().toISOString()
                    };
                    
                    const transaction = musicDB.transaction(['musicList'], 'readwrite');
                    const store = transaction.objectStore('musicList');
                    
                    await new Promise((resolve, reject) => {
                        const request = store.add(musicItem);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject();
                    });
                    
                    console.log('[音樂系統] 舊音樂數據遷移成功');
                    
                    // 清除舊的localStorage數據
                    localStorage.removeItem('musicUrl');
                    
                    // 重新載入列表
                    await loadMusicList();
                    
                } catch (error) {
                    console.error('[音樂系統] 遷移舊音樂數據失敗:', error);
                    // 如果遷移失敗，直接添加預設音樂
                    addDefaultMusic();
                }
            } else {
                // 沒有舊數據，直接添加預設音樂
                addDefaultMusic();
            }
        }
        
        // 添加預設音樂
        async function addDefaultMusic() {
            const defaultMusic = [
                {
                    name: '森林搖籃曲',
                    url: 'https://files.catbox.moe/snenpf.mp3'
                },
                {
                    name: '自然節奏',
                    url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav'
                },
                {
                    name: '電話鈴聲',
                    url: 'https://www.soundjay.com/misc/sounds/phone-ringing-1.wav'
                }
            ];
            
            try {
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                for (const music of defaultMusic) {
                    const musicItem = {
                        name: music.name,
                        url: music.url,
                        addedAt: new Date().toISOString()
                    };
                    
                    await new Promise((resolve, reject) => {
                        const request = store.add(musicItem);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject();
                    });
                }
                
                console.log('[音樂系統] 預設音樂添加完成');
                
                // 重新載入列表
                await loadMusicList();
                
            } catch (error) {
                console.error('[音樂系統] 添加預設音樂失敗:', error);
            }
        }
        
        // 渲染音樂列表
        function renderMusicList() {
            const musicListContainer = document.getElementById('musicList');
            if (!musicListContainer) return;
            
            if (musicList.length === 0) {
                musicListContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 14px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">📝</div>
                        還沒有添加任何音樂<br>
                        <span style="color: #999; font-size: 12px;">請點擊左上角➕添加音樂</span>
                    </div>
                `;
                return;
            }
            
            musicListContainer.innerHTML = musicList.map((music, index) => `
                <div class="music-item" onclick="playMusicFromList(${index})" style="
                    display: flex; 
                    align-items: center; 
                    padding: 12px; 
                    margin-bottom: 8px; 
                    border-radius: 10px; 
                    background: ${index === currentMusicIndex ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.3)'}; 
                    border: 1px solid ${index === currentMusicIndex ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.1)'}; 
                    transition: all 0.3s ease; 
                    cursor: pointer; 
                    position: relative;
                " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='${index === currentMusicIndex ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.3)'}'">
                    <div class="music-info" style="flex: 1; margin-right: 15px;">
                        <div class="music-name" style="
                            font-weight: bold; 
                            color: ${index === currentMusicIndex ? '#333' : '#666'}; 
                            font-size: 14px; 
                            margin-bottom: 4px;
                        ">${music.name} ${index === currentMusicIndex ? '▶️' : ''}</div>
                        <div class="music-url" style="
                            color: #999; 
                            font-size: 11px; 
                            word-break: break-all; 
                            opacity: 0.8;
                        ">${music.url}</div>
                    </div>
                    <div class="music-actions" style="display: flex; gap: 8px;" onclick="event.stopPropagation();">
                        <button onclick="deleteMusicFromList(${music.id})" style="
                            padding: 6px 10px; 
                            border: none; 
                            border-radius: 6px; 
                            background: rgba(244, 67, 54, 0.8); 
                            color: white; 
                            font-size: 11px; 
                            cursor: pointer; 
                            transition: all 0.3s ease; 
                            font-weight: bold;
                        " onmouseover="this.style.background='rgba(244, 67, 54, 1)'" onmouseout="this.style.background='rgba(244, 67, 54, 0.8)'" title="刪除">🗑️</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 從列表播放音樂
        function playMusicFromList(index) {
            if (index < 0 || index >= musicList.length) {
                showNotification('音樂索引無效', 'error');
                return;
            }
            
            const music = musicList[index];
            currentMusicIndex = index;
            currentMusicUrl = music.url;
            
            // 🔥 新增：保存當前音樂索引到localStorage
            localStorage.setItem('currentMusicIndex', index.toString());
            localStorage.setItem('currentMusicUrl', music.url);
            
            console.log(`[音樂系統] 切換到音樂: ${music.name} (索引: ${index}, URL: ${music.url})`);
            
            // 播放黑膠唱片動畫
            playVinylAnimation();
            
            // 更新歌曲名稱顯示
            updateSongNameDisplay();
            
            // 如果正在播放，先停止
            if (isMusicPlaying) {
                stopMusic();
            }
            
            // 更新音頻元素
            if (audioElement) {
                audioElement.src = music.url;
                audioElement.load();
                
                // 嘗試播放
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        showNotification(`正在播放: ${music.name}`, 'success');
                        updateCurrentMusicInfo();
                    }).catch(error => {
                        console.error('[音樂系統] 播放失敗:', error);
                        showNotification('播放失敗，請檢查音樂URL', 'error');
                    });
                }
            }
        }
        
        // 從列表刪除音樂
        async function deleteMusicFromList(musicId) {
            if (!confirm('確定要刪除這首音樂嗎？')) {
                return;
            }
            
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                const request = store.delete(musicId);
                
                request.onsuccess = () => {
                    console.log('[音樂系統] 音樂刪除成功');
                    showNotification('音樂已刪除', 'success');
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[音樂系統] 音樂刪除失敗');
                    showNotification('音樂刪除失敗', 'error');
                };
                
            } catch (error) {
                console.error('[音樂系統] 刪除音樂時發生錯誤:', error);
                showNotification('刪除音樂失敗', 'error');
            }
        }
        
        // 更新當前播放信息
        function updateCurrentMusicInfo() {
            const currentMusicInfo = document.getElementById('currentMusicInfo');
            const songNameElement = document.getElementById('currentSongName');
            
            if (musicList.length === 0) {
                if (currentMusicInfo) currentMusicInfo.textContent = '沒有音樂在播放';
                if (songNameElement) songNameElement.textContent = '選擇音樂';
                return;
            }
            
            if (currentMusicIndex >= 0 && currentMusicIndex < musicList.length) {
                const currentMusic = musicList[currentMusicIndex];
                if (currentMusicInfo) currentMusicInfo.textContent = `${currentMusic.name} (${currentMusicIndex + 1}/${musicList.length})`;
                if (songNameElement) songNameElement.textContent = currentMusic.name;
            } else {
                if (currentMusicInfo) currentMusicInfo.textContent = '沒有音樂在播放';
                if (songNameElement) songNameElement.textContent = '選擇音樂';
            }
            
            // 重新渲染音樂列表以更新當前播放狀態
            renderMusicList();
        }
        
        // 切換到下一首音樂
        function nextMusic() {
            if (musicList.length === 0) {
                showNotification('音樂列表為空', 'warning');
                return;
            }
            
            currentMusicIndex = (currentMusicIndex + 1) % musicList.length;
            // 🔥 修改：直接調用playMusicFromList，它會自動保存狀態
            playMusicFromList(currentMusicIndex);
        }
        
        // 切換到上一首音樂
        function previousMusic() {
            if (musicList.length === 0) {
                showNotification('音樂列表為空', 'warning');
                return;
            }
            
            currentMusicIndex = currentMusicIndex <= 0 ? musicList.length - 1 : currentMusicIndex - 1;
            // 🔥 修改：直接調用playMusicFromList，它會自動保存狀態
            playMusicFromList(currentMusicIndex);
        }
        
        // 初始化背景音乐
        function initBackgroundMusic() {
            // 🔥 修改：檢查是否需要更新音頻元素
                const musicUrl = currentMusicUrl || 'https://files.catbox.moe/snenpf.mp3';
                
            if (!audioElement) {
                // 創建新的音頻元素
                console.log('[音樂系統] 創建新的音頻元素，URL:', musicUrl);
                
                audioElement = new Audio(musicUrl);
                audioElement.loop = true;
                audioElement.volume = 0.5;
                
                // 設置進度條事件監聽器
                setupAudioEventListeners();
                
                // 音乐加载完成事件
                audioElement.addEventListener('loadeddata', function() {
                    console.log('[音樂系統] 背景音樂已載入');
                    // 加载完成后自动尝试播放
                    autoPlayBackgroundMusic();
                });
                
                // 音乐播放事件
                audioElement.addEventListener('play', function() {
                    isMusicPlaying = true;
                    updateMusicButtonState();
                    console.log('[音樂系統] 背景音樂開始播放');
                });
                
                // 音乐暂停事件
                audioElement.addEventListener('pause', function() {
                    isMusicPlaying = false;
                    updateMusicButtonState();
                    console.log('[音樂系統] 背景音樂已暫停');
                });
                
                // 音乐错误事件
                audioElement.addEventListener('error', function(e) {
                    console.error('[音樂系統] 背景音樂載入錯誤:', e);
                    showNotification('音樂載入失敗，請檢查URL或網絡連接', 'error');
                    
                    // 🔥 修改：移除自動切換邏輯，避免意外切換
                    // 讓用戶手動選擇要播放的音樂
                    console.log('[音樂系統] 音樂載入失敗，請手動選擇其他音樂');
                });
            } else if (audioElement.src !== musicUrl && audioElement.src !== (window.location.origin + musicUrl)) {
                // 🔥 修改：如果音頻元素存在但URL不同，更新URL
                console.log('[音樂系統] 更新音頻元素URL:', musicUrl);
                console.log('[音樂系統] 當前音頻URL:', audioElement.src);
                audioElement.src = musicUrl;
                audioElement.load();
                
                // 重新設置進度條事件監聽器
                setupAudioEventListeners();
                
                // 如果之前正在播放，繼續播放
                if (isMusicPlaying) {
                    const playPromise = audioElement.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.warn('[音樂系統] 更新後播放失敗:', error);
                        });
                    }
                }
            }
        }

        // 自动播放背景音乐
        function autoPlayBackgroundMusic() {
            if (audioElement && !isMusicPlaying) {
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // console.log('[主面板] 背景音樂自動播放成功');
                        showNotification('背景音樂已開始播放', 'success');
                    }).catch(error => {
                        console.warn('[主面板] 自動播放被瀏覽器阻止，等待用戶交互:', error);
                        // 显示播放提示
                        showAutoPlayTip();
                    });
                }
            }
        }

        // 显示自动播放提示
        function showAutoPlayTip() {
            const musicBtn = document.getElementById('musicControlBtn');
            if (musicBtn) {
                // 让音乐按钮闪烁提示用户点击
                musicBtn.style.animation = 'musicButtonBlink 1s ease-in-out infinite';
                musicBtn.title = '點擊開始播放背景音樂 🎵';
                
                // 5秒后停止闪烁
                setTimeout(() => {
                    musicBtn.style.animation = '';
                    musicBtn.title = '單擊播放/暫停，雙擊切換音樂，長按設置';
                }, 5000);
            }
        }
        const swipeWrapper = document.getElementById('swipeWrapper');
        const indicators = document.querySelectorAll('.indicator-dot');

        // 触摸事件处理
        swipeWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
        swipeWrapper.addEventListener('touchmove', handleTouchMove, { passive: true });
        swipeWrapper.addEventListener('touchend', handleTouchEnd, { passive: true });

        // 鼠标事件处理（桌面端）
        swipeWrapper.addEventListener('mousedown', handleMouseStart);
        swipeWrapper.addEventListener('mousemove', handleMouseMove);
        swipeWrapper.addEventListener('mouseup', handleMouseEnd);
        swipeWrapper.addEventListener('mouseleave', handleMouseEnd);

        function handleTouchStart(e) {
            // 如果设置面板或模态窗口打开，不处理滑动
            if (isSettingsOpen || isModalOpen) return;
            
            startX = e.touches[0].clientX;
            isDragging = true;
        }

        function handleTouchMove(e) {
            // 如果设置面板或模态窗口打开，不处理滑动
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            const currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;
            const translateX = -currentPage * 33.33 + (deltaX / swipeWrapper.offsetWidth) * 33.33;
            swipeWrapper.style.transition = 'none';
            swipeWrapper.style.transform = `translateX(${Math.max(-66.66, Math.min(0, translateX))}%)`;
        }

        function handleTouchEnd(e) {
            // 如果设置面板或模态窗口打开，不处理滑动
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            isDragging = false;
            const endX = e.changedTouches[0].clientX;
            const deltaX = endX - startX;
            
            if (Math.abs(deltaX) > 50) {
                if (deltaX > 0 && currentPage > 0) {
                    currentPage--;
                } else if (deltaX < 0 && currentPage < 2) {
                    currentPage++;
                }
            }
            
            updatePage();
        }

        function handleMouseStart(e) {
            // 如果设置面板或模态窗口打开，不处理滑动
            if (isSettingsOpen || isModalOpen) return;
            
            startX = e.clientX;
            isDragging = true;
            e.preventDefault();
        }

        function handleMouseMove(e) {
            // 如果设置面板或模态窗口打开，不处理滑动
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            const currentX = e.clientX;
            const deltaX = currentX - startX;
            const translateX = -currentPage * 33.33 + (deltaX / swipeWrapper.offsetWidth) * 33.33;
            swipeWrapper.style.transition = 'none';
            swipeWrapper.style.transform = `translateX(${Math.max(-66.66, Math.min(0, translateX))}%)`;
        }

        function handleMouseEnd(e) {
            // 如果设置面板或模态窗口打开，不处理滑动
            if (isSettingsOpen || isModalOpen) return;
            
            if (!isDragging) return;
            isDragging = false;
            const endX = e.clientX;
            const deltaX = endX - startX;
            
            if (Math.abs(deltaX) > 50) {
                if (deltaX > 0 && currentPage > 0) {
                    currentPage--;
                } else if (deltaX < 0 && currentPage < 2) {
                    currentPage++;
                }
            }
            
            updatePage();
        }

        function goToPage(page) {
            currentPage = page;
            updatePage();
        }

        function updatePage() {
            swipeWrapper.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            swipeWrapper.style.transform = `translateX(-${currentPage * 33.33}%)`;
            
            indicators.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentPage);
            });
        }

        // 队友信息数据（占位符）
        window.teammateData = {
            'A': {
                name: 'Lian',
                avatar: 'https://i.pravatar.cc/150?img=3',
                title: '主舞-副唱 | #待定|集体宿舍 | 待定级',
                tag: '冷静的观察者',
                favor: '5',
                cp: '1',
                status: '站在人群中后方，目光平静地看着被莱纳斯带到前排的Nocturne。',
                mood: '社交能力也是实力的一种。他比看上去要聪明。',
                outfit: '黑色宽松练舞裤，纯白T恤，头发打理得干净利落。'
            },
            'B': {
                name: 'Sereno',
                avatar: 'https://i.pravatar.cc/150?img=12',
                title: '副唱-Rapper | #待定|集体宿舍 | 待定级',
                tag: '活力四射的表演者',
                favor: '3',
                cp: '2',
                status: '正在和其他练习生热情交流，展现出天生的亲和力。',
                mood: '今天一定要展现出最好的自己！',
                outfit: '彩色运动外套，破洞牛仔裤，充满街头风格。'
            },
            'C': {
                name: 'Alex',
                avatar: 'https://i.pravatar.cc/150?img=8',
                title: 'Rapper-舞蹈 | #待定|集体宿舍 | 待定级',
                tag: '技术型完美主义者',
                favor: '4',
                cp: '0',
                status: '专注地练习着舞蹈动作，追求每个细节的完美。',
                mood: '只有不断练习才能达到理想的水平。',
                outfit: '简约黑色训练服，运动鞋，实用主义风格。'
            },
            'D': {
                name: 'Linus',
                avatar: 'https://i.pravatar.cc/150?img=15',
                title: '全能-队长 | #待定|集体宿舍 | 待定级',
                tag: '天生的领导者',
                favor: '6',
                cp: '3',
                status: '正在安抚紧张的队友，展现出成熟的领导风范。',
                mood: '团队的成功比个人表现更重要。',
                outfit: '高质感白衬衫，深色休闲裤，干净利落的发型。'
            }
        };

        // 显示队友信息
        function showTeammateInfo(teammateId) {
            const modal = document.getElementById('teammateModal');
            const data = teammateData[teammateId];
            
            if (!data) return;
            
            // 解析title信息
            const titleParts = data.title.split(' | ');
            const role = titleParts[0] || '';
            const tag = titleParts[1] || '';
            const location = titleParts[2] || '';
            const level = titleParts[3] || '';
            
            // 更新弹窗内容
            document.getElementById('teammateModalAvatar').src = data.avatar;
            
            // 构建新的header HTML
            const titleElement = document.getElementById('teammateModalTitle');
            titleElement.innerHTML = `
                <div class="teammate-role">${role}</div>
                <div class="teammate-details">
                    <span class="teammate-tag">${tag}</span>
                    <span class="teammate-location">${location}</span>
                    <span class="teammate-level">${level}</span>
                </div>
            `;
            
            document.getElementById('teammateTag').textContent = data.tag;
            document.getElementById('teammateFavor').textContent = data.favor;
            document.getElementById('teammateCP').textContent = data.cp;
            document.getElementById('teammateStatus').textContent = data.status;
            document.getElementById('teammateMood').textContent = data.mood;
            document.getElementById('teammateOutfit').textContent = data.outfit;
            
            // 显示弹窗
            modal.classList.add('show');
        }

        // 关闭队友信息弹窗
        function closeTeammateModal() {
            const modal = document.getElementById('teammateModal');
            modal.classList.remove('show');
        }

        // 通用模态窗口控制
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            
            // 特殊處理日程表模態框
            if (modalId === 'scheduleModal') {
                modal.style.display = 'flex';
                modal.style.opacity = '1';
            } else {
                modal.classList.add('show');
            }
            
            // 禁止滑动
            isModalOpen = true;
            
            // 🔥 修改：使用統一的狀態維護函數
            maintainMusicButtonHiddenState();
            
            // 🆕 新增：隱藏頁面指示器（當任何模態窗口打開時）
            const pageIndicator = document.querySelector('.page-indicator');
            if (pageIndicator) {
                pageIndicator.style.display = 'none';
                console.log('[主面板] 模態窗口打開，隱藏頁面指示器');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            
            // 特殊處理日程表模態框
            if (modalId === 'scheduleModal') {
                modal.style.display = 'none';
                modal.style.opacity = '0';
            } else {
                modal.classList.remove('show');
            }
            
            // 恢复滑动
            isModalOpen = false;
            
            // 🔥 修改：使用統一的狀態維護函數
            maintainMusicButtonHiddenState();
            
            // 🆕 新增：檢查是否還有其他模態窗口打開，如果沒有則重新顯示頁面指示器
            const allModals = ['eventModal', 'mapModal', 'anonymousForumModal', 'cpActivityModal', 'chatRoomModal', 'liveRoomModal', 'scheduleModal', 'musicSettingsModal'];
            const hasOpenModal = allModals.some(modalId => {
                const modal = document.getElementById(modalId);
                if (modalId === 'scheduleModal') {
                    return modal && modal.style.display === 'flex';
                } else {
                    return modal && modal.classList.contains('show');
                }
            });
            
            if (!hasOpenModal) {
                const pageIndicator = document.querySelector('.page-indicator');
                if (pageIndicator) {
                    pageIndicator.style.display = 'flex';
                    console.log('[主面板] 所有模態窗口關閉，重新顯示頁面指示器');
                }
            }
        }

        // 点击模态窗口外部关闭
        document.addEventListener('click', function(e) {
            // 队友信息模态窗口
            const teammateModal = document.getElementById('teammateModal');
            if (e.target === teammateModal) {
                closeTeammateModal();
            }

            // 功能模态窗口
            const modals = ['eventModal', 'mapModal', 'anonymousForumModal', 'cpActivityModal', 'chatRoomModal', 'liveRoomModal', 'scheduleModal', 'musicSettingsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (e.target === modal) {
                    closeModal(modalId);
                }
            });
        });

        // 🔥 新增：保持音樂按鈕隱藏狀態的函數
        function maintainMusicButtonHiddenState() {
            const musicBtn = document.getElementById('musicControlBtn');
            if (!musicBtn) return;
            
            // 檢查是否有任何模態窗口打開
            const allModals = ['eventModal', 'mapModal', 'anonymousForumModal', 'cpActivityModal', 'chatRoomModal', 'liveRoomModal', 'scheduleModal', 'musicSettingsModal'];
            const hasOpenModal = allModals.some(modalId => {
                const modal = document.getElementById(modalId);
                if (modalId === 'scheduleModal') {
                    return modal && modal.style.display === 'flex';
                } else {
                    return modal && modal.classList.contains('show');
                }
            });
            
            // 檢查VN面板狀態 - 如果處於story狀態，音樂按鈕應該隱藏
            const shouldHideForVNStory = vnIframeState === 'story';
            
            // 如果有模態窗口打開、設置面板打開，或VN面板處於story狀態，保持音樂按鈕隱藏
            if (hasOpenModal || isSettingsOpen || shouldHideForVNStory) {
                musicBtn.style.display = 'none';
                musicBtn.style.visibility = 'hidden';
                musicBtn.style.opacity = '0';
                musicBtn.style.pointerEvents = 'none';
            } else {
                // 只有在沒有任何模態窗口、設置面板都關閉，且VN面板不在story狀態時才顯示
                musicBtn.style.display = 'flex';
                musicBtn.style.visibility = 'visible';
                musicBtn.style.opacity = '1';
                musicBtn.style.pointerEvents = 'auto';
            }
        }
        
        // 🔥 新增：監聽瀏覽器窗口大小變化
        window.addEventListener('resize', function() {
            // 延遲執行，確保DOM更新完成
            setTimeout(maintainMusicButtonHiddenState, 100);
        });
        
        // 🔥 新增：監聽頁面可見性變化（切換標籤頁）
        document.addEventListener('visibilitychange', function() {
            // 當頁面重新可見時，檢查並維持音樂按鈕狀態
            if (!document.hidden) {
                setTimeout(maintainMusicButtonHiddenState, 200);
            }
        });
        
        // 🔥 新增：監聽窗口焦點變化
        window.addEventListener('focus', function() {
            setTimeout(maintainMusicButtonHiddenState, 100);
        });
        
        // 🔥 新增：監聽窗口失焦變化
        window.addEventListener('blur', function() {
            setTimeout(maintainMusicButtonHiddenState, 100);
        });

        // 折叠/展开日程表（删除原有功能）
        // function toggleSchedule() {
        //     const scheduleContent = document.getElementById('scheduleContent');
        //     const toggleIcon = document.getElementById('scheduleToggle');
        //     
        //     isScheduleExpanded = !isScheduleExpanded;
        //     
        //     if (isScheduleExpanded) {
        //         scheduleContent.classList.add('expanded');
        //         toggleIcon.classList.add('rotated');
        //     } else {
        //         scheduleContent.classList.remove('expanded');
        //         toggleIcon.classList.remove('rotated');
        //     }
        // }

        // 打开日程表模态窗口
        function openScheduleModal() {
            openModal('scheduleModal');
        }

        // 设置菜单功能
        function toggleSettingsMenu() {
            const settingsPanel = document.getElementById('settingsPanel');
            isSettingsOpen = !isSettingsOpen;
            
            if (isSettingsOpen) {
                settingsPanel.classList.add('show');
                showNotification('打开设置面板 ⚙️');
                
                // 🔥 修改：使用統一的狀態維護函數
                maintainMusicButtonHiddenState();
                
                // 确保输入框可以正常工作
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.settings-content .input-group input');
                    inputs.forEach(input => {
                        input.disabled = false;
                        input.readOnly = false;
                    });
                }, 100);
            } else {
                settingsPanel.classList.remove('show');
                
                // 🔥 修改：使用統一的狀態維護函數
                maintainMusicButtonHiddenState();
            }
        }



        // 颜色配置
        const colorThemes = {
            container: {
                pink: '#FFB6C1',
                blue: '#87CEEB',
                purple: '#DDA0DD',
                green: '#98FB98',
                orange: '#FFA07A'
            },
            section: {
                light: 'rgba(245, 245, 220, 0.9)',
                white: 'rgba(255, 255, 255, 0.9)',
                cream: 'rgba(255, 248, 220, 0.9)',
                lavender: 'rgba(230, 230, 250, 0.9)',
                mint: 'rgba(240, 255, 240, 0.9)'
            },
            text: {
                dark: '#333333',
                white: '#FFFFFF',
                purple: '#663399',
                blue: '#4169E1',
                pink: '#FF69B4'
            },
            scrollbar: {
                pink: 'rgba(255, 105, 180, 0.6)',
                blue: 'rgba(135, 206, 235, 0.6)',
                purple: 'rgba(221, 160, 221, 0.6)',
                green: 'rgba(152, 251, 152, 0.6)',
                orange: 'rgba(255, 160, 122, 0.6)'
            }
        };

        // 更改容器颜色
        function changeContainerColor(color) {
            document.documentElement.style.setProperty('--container-bg', colorThemes.container[color]);
            document.documentElement.style.setProperty('--scrollbar-color', colorThemes.scrollbar[color]);
            updateActiveColorOption('container', color);
            saveColorSettings(); // 保存设置
            
            // 如果有背景圖片，確保背景圖片在容器顏色上面
            const container = document.querySelector('.phone-container');
            if (container && container.classList.contains('has-background')) {
                // 保持背景圖片設置
                // console.log('[背景設置] 容器顏色已更改，保持背景圖片顯示');
            }
        }

        // 更改栏目颜色
        function changeSectionColor(color) {
            document.documentElement.style.setProperty('--section-bg', colorThemes.section[color]);
            updateActiveColorOption('section', color);
            saveColorSettings(); // 保存设置
        }

        // 更改字体颜色
        function changeTextColor(color) {
            document.documentElement.style.setProperty('--text-color', colorThemes.text[color]);
            updateActiveColorOption('text', color);
            saveColorSettings(); // 保存设置
        }

        // 保存颜色设置到localStorage
        function saveColorSettings() {
            const settings = {
                containerColor: getCurrentActiveColor('container'),
                sectionColor: getCurrentActiveColor('section'),
                textColor: getCurrentActiveColor('text')
            };
            localStorage.setItem('customTraineeColors', JSON.stringify(settings));
            
            // 显示保存提示
            showNotification('颜色设置已保存 ✨');
        }

        // 获取当前激活的颜色
        function getCurrentActiveColor(type) {
            const activeElement = document.querySelector(`[data-${type}].active`);
            return activeElement ? activeElement.getAttribute(`data-${type}`) : null;
        }

        // 从localStorage加载颜色设置
        function loadColorSettings() {
            try {
                const saved = localStorage.getItem('customTraineeColors');
                if (saved) {
                    const settings = JSON.parse(saved);
                    
                    // 应用保存的颜色
                    if (settings.containerColor && colorThemes.container[settings.containerColor]) {
                        document.documentElement.style.setProperty('--container-bg', colorThemes.container[settings.containerColor]);
                        document.documentElement.style.setProperty('--scrollbar-color', colorThemes.scrollbar[settings.containerColor]);
                        updateActiveColorOption('container', settings.containerColor);
                    }
                    
                    if (settings.sectionColor && colorThemes.section[settings.sectionColor]) {
                        document.documentElement.style.setProperty('--section-bg', colorThemes.section[settings.sectionColor]);
                        updateActiveColorOption('section', settings.sectionColor);
                    }
                    
                    if (settings.textColor && colorThemes.text[settings.textColor]) {
                        document.documentElement.style.setProperty('--text-color', colorThemes.text[settings.textColor]);
                        updateActiveColorOption('text', settings.textColor);
                    }
                    
                    // console.log('已加载保存的颜色设置:', settings);
                    return true;
                }
            } catch (error) {
                console.error('加载颜色设置失败:', error);
            }
            return false;
        }

        // 更新活跃颜色选项
        function updateActiveColorOption(type, color) {
            // 移除同类型所有选项的active类
            document.querySelectorAll(`[data-${type}]`).forEach(option => {
                option.classList.remove('active');
            });
            // 为当前选项添加active类
            document.querySelector(`[data-${type}="${color}"]`).classList.add('active');
        }

        // 恢复默认设置
        function resetToDefault() {
            // 清除localStorage
            localStorage.removeItem('customTraineeColors');
            
            // 恢复默认CSS变量
            document.documentElement.style.setProperty('--container-bg', '#FFB6C1');
            document.documentElement.style.setProperty('--section-bg', 'rgba(255, 255, 255, 0.9)');
            document.documentElement.style.setProperty('--text-color', '#333333');
            document.documentElement.style.setProperty('--scrollbar-color', 'rgba(255, 105, 180, 0.6)');
            
            // 重置所有active状态
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // 设置默认active状态
            updateActiveColorOption('container', 'pink');
            updateActiveColorOption('section', 'white');
            updateActiveColorOption('text', 'dark');
            
            // 显示恢复提示
            showNotification('已恢复默认设置 🔄');
            // console.log('已恢复默认设置并清除本地存储');
        }

        // 初始化默认颜色状态
        document.addEventListener('DOMContentLoaded', function() {
            // 先尝试加载保存的设置
            const hasLoadedSettings = loadColorSettings();
            const hasLoadedNames = themeManager.loadNameSettings();
            
            // 如果没有保存的设置，使用默认设置
            if (!hasLoadedSettings) {
                updateActiveColorOption('container', 'pink');
                updateActiveColorOption('section', 'white');
                updateActiveColorOption('text', 'dark');
                // console.log('使用默认颜色设置');
            } else {
                // 显示加载提示
                setTimeout(() => {
                    showNotification('已加载上次保存的颜色设置 🎨');
                }, 500);
            }
            
            // 如果没有保存的名称设置，使用默认设置
            if (!hasLoadedNames) {
                // console.log('使用默认名称设置');
            } else {
                // 显示加载提示
                setTimeout(() => {
                    showNotification('已加载上次保存的名称设置 📝');
                }, 800);
            }
            
            // 初始化現實時間更新
            initRealTimeUpdate();
                    
        });

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2500);
        }

        // 功能按钮点击事件 - 修改为打开模态窗口
        // 添加Toast通知函数
        function showSuccessToast(message) {
            console.log('[成功]', message);
            // 可以在这里添加更美观的提示
            alert('✅ ' + message);
        }
        
        function showErrorToast(message) {
            console.error('[错误]', message);
            // 可以在这里添加更美观的提示
            alert('❌ ' + message);
        }



        function openLorebookManagerModal() {
            // 直接调用世界书管理器功能
            if (typeof window.openLorebookManagerModalFromLibrary === 'function') {
                window.openLorebookManagerModalFromLibrary();
            } else {
                // 如果世界书管理器未加载，显示提示
                alert('世界書管理器正在加載中...');
            }
        }

        function openEvent() {
            openModal('eventModal');
        }

        // 初始化统一通讯核心
        // UnifiedCommCore 已由 communication_manager.js 設置為 window 對象
        
        function openMap() {
            openModal('mapModal');
            
            // 動態設置iframe src
            const iframe = document.getElementById('mapPanelIframe');
            if (iframe) {
                // 每次都重新加載地圖面板，確保重新初始化
                iframe.src = 'map/map-panel.html';
                
                // 等待iframe加載完成後發送重置消息
                iframe.onload = function() {
                    // console.log('[主面板] 地圖面板已重新加載');
                    // 發送重置消息給地圖面板
                    setTimeout(() => {
                        if (iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                type: 'RESET_MAP_PANEL',
                                source: 'MAIN_PANEL_OPEN_MAP',
                                timestamp: Date.now()
                            }, '*');
                        }
                    }, 100);
                };
            }
            
            // 通知地图面板已打开
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('map');
            }
        }

        function openAnonymousForum() {
            openModal('anonymousForumModal');
            
            // 動態設置iframe src
            const iframe = document.getElementById('forumPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'forum/forum_panel.html';
            }
            
            // 🔥 新增：延遲發送iframe顯示消息，確保iframe已載入
            setTimeout(() => {
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'IFRAME_SHOWN',
                        target: 'forum',
                        timestamp: Date.now()
                    }, '*');
                    console.log('[主面板] 已發送FORUM iframe顯示消息');
                }
            }, 500);
            
            // 通知Forum面板已打开
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('forum');
            }
        }

        function openCPActivity() {
            openModal('cpActivityModal');
            
            // 動態設置iframe src
            const iframe = document.getElementById('echoPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'echo/echo_panel.html';
            }
            
            // 🔥 新增：延遲發送iframe顯示消息，確保iframe已載入
            setTimeout(() => {
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'IFRAME_SHOWN',
                        target: 'echo',
                        timestamp: Date.now()
                    }, '*');
                    console.log('[主面板] 已發送ECHO iframe顯示消息');
                }
            }, 500);
            
            // 通知Echo面板已打开
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('echo');
            }
        }

        function openChatRoom() {
            openModal('chatRoomModal');
            
            // 動態設置iframe src
            const iframe = document.getElementById('chatPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'chat/chat_panel.html';
            }
            
            // 🔥 新增：延遲發送iframe顯示消息，確保iframe已載入
            setTimeout(() => {
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'IFRAME_SHOWN',
                        target: 'chat',
                        timestamp: Date.now()
                    }, '*');
                    console.log('[主面板] 已發送CHAT iframe顯示消息');
                }
            }, 500);
            
            // 🔥 新增：通知CHAT處理器開始掃描聊天內容
            notifyChatProcessorToScan();
            
            // 通知聊天面板已打开
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('chat');
            }
        }
        
        // 🔥 新增：通知CHAT處理器開始掃描聊天內容
        function notifyChatProcessorToScan() {
            try {
                console.log('[MAIN面板] 通知CHAT處理器開始掃描聊天內容');
                
                // 方法1：直接向父窗口發送消息（如果CHAT處理器在父窗口）
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'CHAT_FETCH_HISTORY_LIST',
                        source: 'MAIN_PANEL',
                        timestamp: Date.now()
                    }, '*');
                }
                
                // 方法2：向所有iframe廣播消息
                const allIframes = document.querySelectorAll('iframe');
                allIframes.forEach(iframe => {
                    try {
                        if (iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                type: 'CHAT_FETCH_HISTORY_LIST',
                                source: 'MAIN_PANEL',
                                timestamp: Date.now()
                            }, '*');
                        }
                    } catch (error) {
                        // 忽略跨域錯誤
                    }
                });
                
                // 方法3：向頂層窗口發送消息
                if (window.top && window.top !== window) {
                    window.top.postMessage({
                        type: 'CHAT_FETCH_HISTORY_LIST',
                        source: 'MAIN_PANEL',
                        timestamp: Date.now()
                    }, '*');
                }
                
                console.log('[MAIN面板] ✅ 已發送CHAT掃描請求');
                
            } catch (error) {
                console.error('[MAIN面板] 通知CHAT處理器失敗:', error);
            }
        }
        
        // 🔥 新增：處理CHAT處理器返回的聊天歷史列表
        function handleChatHistoryList(data) {
            try {
                console.log('[MAIN面板] 處理聊天歷史列表數據:', data);
                
                if (data && data.data && data.data.chatList) {
                    const chatList = data.data.chatList;
                    const totalCount = data.data.totalCount;
                    
                    console.log(`[MAIN面板] 收到 ${totalCount} 個聊天室數據`);
                    
                    // 更新聊天室按鈕的未讀計數顯示
                    updateChatButtonUnreadCount(chatList);
                    
                    // 可以根據需要進一步處理聊天數據
                    // 例如：顯示聊天室預覽、更新UI等
                    
                } else {
                    console.warn('[MAIN面板] 聊天歷史列表數據格式不正確');
                }
                
            } catch (error) {
                console.error('[MAIN面板] 處理聊天歷史列表失敗:', error);
            }
        }
        
        // 🆕 新增：轉發消息給地圖面板
        function forwardMessageToMapPanel(messageData) {
            try {
                const mapIframe = document.getElementById('mapPanelIframe');
                if (mapIframe && mapIframe.contentWindow) {
                    // 檢查地圖面板是否已載入
                    if (mapIframe.src === 'about:blank' || mapIframe.src.includes('about:blank')) {
                        console.log('[主面板] 地圖面板尚未載入，延遲轉發消息');
                        // 延遲轉發，等待地圖面板載入
                        setTimeout(() => {
                            forwardMessageToMapPanel(messageData);
                        }, 1000);
                        return;
                    }
                    
                    // 轉發消息給地圖面板
                    mapIframe.contentWindow.postMessage(messageData, '*');
                    console.log('[主面板] 已轉發消息給地圖面板:', messageData.type);
                } else {
                    console.warn('[主面板] 找不到地圖面板iframe或contentWindow不可用');
                }
            } catch (error) {
                console.error('[主面板] 轉發消息給地圖面板失敗:', error);
            }
        }

        // 🔥 新增：轉發消息給Forum面板
        function forwardMessageToForumPanel(messageData) {
            try {
                const forumIframe = document.getElementById('forumPanelIframe');
                if (forumIframe && forumIframe.contentWindow) {
                    // 檢查Forum面板是否已載入
                    if (forumIframe.src === 'about:blank' || forumIframe.src.includes('about:blank')) {
                        console.log('[主面板] Forum面板尚未載入，延遲轉發消息');
                        // 延遲轉發，等待Forum面板載入
                        setTimeout(() => {
                            forwardMessageToForumPanel(messageData);
                        }, 1000);
                        return;
                    }
                    
                    // 轉發消息給Forum面板
                    forumIframe.contentWindow.postMessage(messageData, '*');
                    console.log('[主面板] 已轉發消息給Forum面板:', messageData.type);
                } else {
                    console.warn('[主面板] 找不到Forum面板iframe或contentWindow不可用');
                }
            } catch (error) {
                console.error('[主面板] 轉發消息給Forum面板失敗:', error);
            }
        }
        
        // 🔥 新增：更新聊天室按鈕的未讀計數顯示
        function updateChatButtonUnreadCount(chatList) {
            try {
                // 計算總未讀計數
                let totalUnreadCount = 0;
                chatList.forEach(chat => {
                    if (chat.unreadCount && chat.unreadCount > 0) {
                        totalUnreadCount += chat.unreadCount;
                    }
                });
                
                // 找到聊天室按鈕
                const chatButton = document.querySelector('.nav-button.chat-room');
                if (chatButton) {
                    // 移除現有的未讀計數標籤
                    const existingBadge = chatButton.querySelector('.unread-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // 如果有未讀消息，添加未讀計數標籤
                    if (totalUnreadCount > 0) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.textContent = totalUnreadCount > 99 ? '99+' : totalUnreadCount;
                        badge.style.cssText = `
                            position: absolute;
                            top: -5px;
                            right: -5px;
                            background: #ff4757;
                            color: white;
                            border-radius: 50%;
                            min-width: 20px;
                            height: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: bold;
                            z-index: 10;
                        `;
                        
                        // 確保按鈕有相對定位
                        chatButton.style.position = 'relative';
                        chatButton.appendChild(badge);
                        
                        console.log(`[MAIN面板] 已更新聊天室按鈕未讀計數: ${totalUnreadCount}`);
                    }
                }
                
            } catch (error) {
                console.error('[MAIN面板] 更新聊天室按鈕未讀計數失敗:', error);
            }
        }
        
        // 🔥 新增：設置eventOnButton綁定
        function setupEventOnButtonBindings() {
            try {
                // 檢查eventOnButton是否可用
                if (typeof eventOnButton === 'function') {
                    console.log('[MAIN面板] 設置eventOnButton綁定...');
                    
                    // 綁定聊天ICON按鈕
                    eventOnButton('💬', function() {
                        console.log('[MAIN面板] 通過eventOnButton觸發聊天室打開');
                        openChatRoom();
                    });
                    
                    // 綁定其他ICON按鈕（可選）
                    eventOnButton('🗺️', function() {
                        console.log('[MAIN面板] 通過eventOnButton觸發地圖打開');
                        openMap();
                    });
                    
                    eventOnButton('📺', function() {
                        console.log('[MAIN面板] 通過eventOnButton觸發VN面板打開');
                        openVNPanel();
                    });
                    
                    eventOnButton('📢', function() {
                        console.log('[MAIN面板] 通過eventOnButton觸發Echo面板打開');
                        openEchoPanel();
                    });
                    
                    eventOnButton('📱', function() {
                        console.log('[MAIN面板] 通過eventOnButton觸發直播間打開');
                        openLiveRoom();
                    });
                    
                    console.log('[MAIN面板] ✅ eventOnButton綁定設置完成');
                } else {
                    console.log('[MAIN面板] eventOnButton不可用，跳過綁定設置');
                }
                
            } catch (error) {
                console.error('[MAIN面板] 設置eventOnButton綁定失敗:', error);
            }
        }

        function openLiveRoom() {
            openModal('liveRoomModal');
            
            // 動態設置iframe src
            const iframe = document.getElementById('livestreamPanelIframe');
            if (iframe && iframe.src === 'about:blank') {
                iframe.src = 'livestream/livestream_panel.html';
            }
            
            // 通知直播面板已打开
            if (window.UnifiedCommCore) {
                window.UnifiedCommCore.notifyPanelOpened('livestream');
            }
        }

        // 统一的DOMContentLoaded事件处理
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化通讯管理器
            if (typeof UnifiedCommunicationCore !== 'undefined' && !window.UnifiedCommCore) {
                window.UnifiedCommCore = new UnifiedCommunicationCore();
                // console.log('[主面板] 统一通讯核心已初始化');
            }
            
            // 動態加載VN面板
            const vnIframe = document.getElementById('vnPanelIframe');
            if (vnIframe && vnIframe.src === 'about:blank') {
                vnIframe.src = 'vn/vn_panel.html';
                // 設置初始狀態為landing
                resizeVNIframe('landing');
            }
            
            // 添加按钮交互效果
            const buttons = document.querySelectorAll('.nav-button');
            
            buttons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
            
            // 🔥 新增：設置eventOnButton綁定（如果可用）
            setupEventOnButtonBindings();

            // 添加iframe消息监听器
            window.addEventListener('message', function(event) {
                // console.log('[主面板] 收到iframe消息:', event.data);
                
                // 处理来自各个面板的消息
                if (event.data && event.data.type) {
                    switch (event.data.type) {
                        case 'PANEL_READY':
                            // console.log('[主面板] 面板已准备就绪:', event.data.panel);
                            break;
                        case 'PANEL_CLOSE':
                            // console.log('[主面板] 面板请求关闭:', event.data.panel);
                            closeModal(event.data.panel + 'Modal');
                            break;
                        case 'REQUEST_DATA':
                            // console.log('[主面板] 收到数据请求:', event.data);
                            // 可以在这里处理数据请求
                            break;
                        case 'CLOSE_MAP_PANEL':
                            // console.log('[主面板] 关闭地图面板');
                            closeModal('mapModal');
                            break;
                        case 'GO_TO_MAIN_HOME':
                            // console.log('[主面板] 返回主页面');
                            // 关闭地图面板并显示主页面
                            closeModal('mapModal');
                            // 可以在这里添加其他主页面逻辑
                            break;
                        case 'GO_TO_VN_PANEL':
                            console.log('[主面板] 收到跳轉VN面板請求');
                            // 關閉地圖面板
                            closeModal('mapModal');
                            // 跳轉到VN面板（第0頁）
                            setTimeout(() => {
                                goToPage(0);
                                console.log('[主面板] 已跳轉到VN面板');
                            }, 500); // 延遲500ms確保地圖面板已關閉
                            break;
                        case 'VN_IFRAME_RESIZE':
                            // console.log('[主面板] VN面板iframe尺寸立即調整:', event.data.state);
                            // 立即執行，不使用setTimeout，優先級最高
                            requestAnimationFrame(() => {
                                resizeVNIframe(event.data.state);
                            });
                            break;
                        // 🔥 新增：處理CHAT處理器的回應
                        case 'CHAT_HISTORY_LIST':
                            console.log('[MAIN面板] 收到CHAT處理器的聊天歷史列表:', event.data);
                            handleChatHistoryList(event.data);
                            break;
                        case 'VN_STOP_MAIN_MUSIC':
                            // console.log('[主面板] VN面板請求停止音樂');
                            // 🔥 新增：VN面板開啟劇情時自動停止音樂
                            if (isMusicPlaying) {
                                stopMusic();
                                // console.log('[主面板] 已自動停止音樂（VN劇情模式）');
                                showNotification('VN劇情模式已啟動，音樂已自動停止', 'info');
                            }
                            break;
                        case 'VN_RESUME_MAIN_MUSIC':
                            // console.log('[主面板] VN面板請求恢復音樂');
                            // 🔥 新增：VN面板返回啟動頁面時自動恢復音樂
                            if (!isMusicPlaying) {
                                playMusic();
                                // console.log('[主面板] 已自動恢復音樂（VN啟動頁面）');
                                showNotification('VN啟動頁面已顯示，音樂已自動恢復', 'info');
                            }
                            break;
                        case 'ECHO_PANEL_READY':
                            // console.log('[主面板] Echo面板已准备就绪，转发消息到父窗口');
                            // 轉發ECHO面板的準備就緒信號到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'ECHO_DATA':
                            // console.log('[主面板] 收到Echo數據，转发到父窗口');
                            // 轉發ECHO數據到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'ECHO_USER_COMMENT':
                            // console.log('[主面板] 收到Echo用戶評論，转发到父窗口');
                            // 轉發ECHO用戶評論到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'ECHO_DELETE_COMMENT':
                            // console.log('[主面板] 收到Echo刪除評論請求，转发到父窗口');
                            // 轉發ECHO刪除評論請求到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'MAIN_PANEL_DATA':
                            // console.log('[主面板] 收到主面板數據:', event.data);
                            // 轉發主面板數據到監聽器
                            if (window.mainListener && typeof window.mainListener.handleMainPanelData === 'function') {
                                window.mainListener.handleMainPanelData(event.data);
                            } else {
                                // 備用方案：直接觸發事件
                                window.dispatchEvent(new CustomEvent('MAIN_PANEL_DATA_RECEIVED', {
                                    detail: event.data
                                }));
                            }
                            break;
                        // 🆕 新增：處理CHAT面板頁面狀態變化
                        case 'CHAT_PAGE_STATE_CHANGE':
                            console.log('[主面板] Chat面板頁面狀態變化:', event.data);
                            handleChatPageStateChange(event.data);
                            break;
                        // 🆕 新增：處理來自map_processor.js的消息並轉發給地圖面板
                        case 'MAP_LOCATION_DATA':
                        case 'NEWS_BROADCAST_DATA':
                        case 'STORY_OPTIONS_DATA':
                        case 'MAP_PROCESSOR_READY':
                            console.log('[主面板] 收到map_processor消息，轉發給地圖面板:', event.data.type);
                            forwardMessageToMapPanel(event.data);
                            break;
                        case 'SEND_MESSAGE_TO_CHAT':
                            console.log('[主面板] 收到發送消息到聊天室請求:', event.data.message);
                            // 🆕 轉發消息到聊天面板
                            const chatIframe = document.getElementById('chatPanelIframe');
                            if (chatIframe && chatIframe.contentWindow) {
                                chatIframe.contentWindow.postMessage({
                                    type: 'SEND_MESSAGE_TO_CHAT',
                                    message: event.data.message,
                                    source: event.data.source,
                                    timestamp: event.data.timestamp
                                }, '*');
                                console.log('[主面板] 已轉發消息到聊天面板');
                            } else {
                                console.warn('[主面板] 找不到聊天面板iframe');
                            }
                            break;
                        // 🔥 新增：處理來自酒館AI的Forum消息
                        case 'forum_message':
                            console.log('[主面板] 收到來自酒館AI的Forum消息:', event.data.message);
                            // 轉發Forum消息到Forum面板
                            forwardMessageToForumPanel({
                                type: 'forum_message',
                                message: event.data.message,
                                source: event.data.source || 'tavern',
                                timestamp: event.data.timestamp || Date.now()
                            });
                            break;
                        // 🔥 新增：處理Forum相關消息
                        case 'FORUM_PANEL_READY':
                            console.log('[主面板] Forum面板已準備就緒，轉發消息到父窗口');
                            // 轉發Forum面板的準備就緒信號到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_DATA_UPDATE':
                            console.log('[主面板] 收到Forum數據更新，轉發到父窗口');
                            // 轉發Forum數據到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_USER_POST':
                            console.log('[主面板] 收到Forum用戶發帖，轉發到父窗口');
                            // 轉發Forum用戶發帖到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_USER_REPLY':
                            console.log('[主面板] 收到Forum用戶評論，轉發到父窗口');
                            // 轉發Forum用戶評論到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_DELETE_POST':
                            console.log('[主面板] 收到Forum刪除帖子請求，轉發到父窗口');
                            // 轉發Forum刪除帖子請求到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        case 'FORUM_DELETE_REPLY':
                            console.log('[主面板] 收到Forum刪除評論請求，轉發到父窗口');
                            // 轉發Forum刪除評論請求到父窗口（酒館AI）
                            window.parent.postMessage(event.data, '*');
                            break;
                        default:
                            // console.log('[主面板] 未知消息类型:', event.data.type);
                    }
                }
            });
        });

        // 音乐控制函数
        function toggleMusic() {
            initBackgroundMusic();
            
            if (isMusicPlaying) {
                stopMusic();
            } else {
                playMusic();
            }
            
            // 更新播放/暫停按鈕狀態
            const playPauseIcon = document.getElementById('playPauseIcon');
            if (playPauseIcon) {
                playPauseIcon.src = isMusicPlaying ? 'https://files.catbox.moe/a3rofp.png' : 'https://files.catbox.moe/pwv6aw.png';
                playPauseIcon.alt = isMusicPlaying ? '暫停' : '播放';
            }
        }

        function playMusic() {
            if (audioElement) {
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // 播放成功，事件監聽器會處理狀態更新
                    }).catch(error => {
                        console.error('[主面板] 背景音樂播放失敗:', error);
                        showNotification('請手動點擊播放按鈕以開始背景音樂', 'warning');
                    });
                }
            }
        }

        function stopMusic() {
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
            }
            isMusicPlaying = false;
            updateMusicButtonState();
            showNotification('音樂已停止', 'info');
        }

        function updateMusicButtonState() {
            const musicBtn = document.getElementById('musicControlBtn');
            const musicIcon = document.getElementById('musicIcon');
            
            if (!musicBtn || !musicIcon) {
                console.warn('[音樂系統] 音樂按鈕或圖標元素不存在');
                return;
            }
            
            // console.log('[音樂系統] 更新按鈕狀態，播放狀態:', isMusicPlaying);
            
            if (isMusicPlaying) {
                musicBtn.classList.add('playing');
                musicBtn.style.background = 'rgba(76, 175, 80, 0.9)';
                musicBtn.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.3)';
                        musicIcon.style.animation = 'musicRotate 2s linear infinite';
        musicIcon.style.filter = 'brightness(0) invert(1)';
                // console.log('[音樂系統] 設置為播放狀態');
            } else {
                musicBtn.classList.remove('playing');
                musicBtn.style.background = 'rgba(255, 107, 157, 0.9)';
                musicBtn.style.boxShadow = '0 4px 15px rgba(255, 107, 157, 0.3)';
                        musicIcon.style.animation = 'none';
        musicIcon.style.filter = 'brightness(0) invert(1)';
                // console.log('[音樂系統] 設置為停止狀態');
            }
            
            // 同步更新音樂設置界面中的播放按鈕狀態
            const playPauseIcon = document.getElementById('playPauseIcon');
            if (playPauseIcon) {
                playPauseIcon.src = isMusicPlaying ? 'https://files.catbox.moe/a3rofp.png' : 'https://files.catbox.moe/3ou5xd.png';
                playPauseIcon.alt = isMusicPlaying ? '暫停' : '播放';
            }
        }

        // 進度條相關函數
        function updateProgressBar() {
            if (!audioElement) return;
            
            const progressBar = document.getElementById('progressBar');
            const currentTimeSpan = document.getElementById('currentTime');
            const totalTimeSpan = document.getElementById('totalTime');
            
            if (!progressBar || !currentTimeSpan || !totalTimeSpan) return;
            
            const currentTime = audioElement.currentTime;
            const duration = audioElement.duration;
            
            if (duration > 0) {
                const progress = (currentTime / duration) * 100;
                progressBar.style.width = progress + '%';
                
                // 更新時間顯示
                currentTimeSpan.textContent = formatTime(currentTime);
                totalTimeSpan.textContent = formatTime(duration);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function seekToPosition(event) {
            if (!audioElement) return;
            
            const progressContainer = document.getElementById('progressContainer');
            if (!progressContainer) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = (clickX / containerWidth) * 100;
            
            if (audioElement.duration > 0) {
                const newTime = (percentage / 100) * audioElement.duration;
                audioElement.currentTime = newTime;
            }
        }

        // 設置音頻事件監聽器
        function setupAudioEventListeners() {
            if (!audioElement) return;
            
            // 時間更新事件
            audioElement.addEventListener('timeupdate', updateProgressBar);
            
            // 元數據加載完成事件
            audioElement.addEventListener('loadedmetadata', function() {
                const totalTimeSpan = document.getElementById('totalTime');
                if (totalTimeSpan && audioElement.duration > 0) {
                    totalTimeSpan.textContent = formatTime(audioElement.duration);
                }
            });
            
            // 播放開始事件
            audioElement.addEventListener('play', function() {
                isMusicPlaying = true;
                updateMusicButtonState();
                updateProgressBar();
            });
            
            // 播放暫停事件
            audioElement.addEventListener('pause', function() {
                isMusicPlaying = false;
                updateMusicButtonState();
            });
            
            // 播放結束事件
            audioElement.addEventListener('ended', function() {
                isMusicPlaying = false;
                updateMusicButtonState();
                // 重置進度條
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                const currentTimeSpan = document.getElementById('currentTime');
                if (currentTimeSpan) {
                    currentTimeSpan.textContent = '0:00';
                }
            });
        }

        // 音量控制相關變數
        let isDraggingProgress = false;
        let lastVolume = 50;

        // 音量控制函數
        function changeVolume(value) {
            if (audioElement) {
                const volume = value / 100;
                audioElement.volume = volume;
                lastVolume = value;
                
                // 不再動態更新圖片，避免破圖問題
                // 音量圖標保持固定，只通過滑塊數值來表示音量大小
            }
        }

        // 切換音量控制面板顯示/隱藏
        function toggleVolumeControl() {
            const panel = document.getElementById('volumeControlPanel');
            const btn = document.getElementById('volumeControlBtn');
            
            if (panel && btn) {
                if (panel.style.display === 'none' || !panel.style.display) {
                    panel.style.display = 'flex';
                    btn.style.background = 'rgba(0,0,0,0.9)';
                    btn.style.transform = 'scale(1.1)';
                    
                    // 添加點擊外部收起功能
                    setTimeout(() => {
                        document.addEventListener('click', closeVolumePanelOnOutsideClick);
                    }, 100);
                } else {
                    closeVolumePanel();
                }
            }
        }

        // 點擊外部收起音量面板
        function closeVolumePanelOnOutsideClick(event) {
            const panel = document.getElementById('volumeControlPanel');
            const btn = document.getElementById('volumeControlBtn');
            
            if (panel && btn) {
                // 檢查點擊是否在面板或按鈕外部
                if (!panel.contains(event.target) && !btn.contains(event.target)) {
                    closeVolumePanel();
                }
            }
        }

        // 收起音量面板
        function closeVolumePanel() {
            const panel = document.getElementById('volumeControlPanel');
            const btn = document.getElementById('volumeControlBtn');
            
            if (panel && btn) {
                panel.style.display = 'none';
                btn.style.background = 'rgba(0,0,0,0.7)';
                btn.style.transform = 'scale(1)';
                
                // 移除點擊外部收起的事件監聽器
                document.removeEventListener('click', closeVolumePanelOnOutsideClick);
            }
        }

        // 靜音切換
        function toggleMute() {
            const volumeSlider = document.getElementById('volumeSlider');
            if (volumeSlider) {
                if (volumeSlider.value > 0) {
                    lastVolume = volumeSlider.value;
                    volumeSlider.value = 0;
                    changeVolume(0);
                } else {
                    volumeSlider.value = lastVolume;
                    changeVolume(lastVolume);
                }
            }
        }

        // 進度條拖拽功能
        function startDragging(event) {
            event.preventDefault();
            isDraggingProgress = true;
            
            const thumb = document.getElementById('progressThumb');
            if (thumb) {
                thumb.style.cursor = 'grabbing';
            }
            
            document.addEventListener('mousemove', dragProgress);
            document.addEventListener('mouseup', stopDragging);
        }

        function dragProgress(event) {
            if (!isDraggingProgress || !audioElement) return;
            
            const progressContainer = document.getElementById('progressContainer');
            if (!progressContainer) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = Math.max(0, Math.min(100, (clickX / containerWidth) * 100));
            
            if (audioElement.duration > 0) {
                const newTime = (percentage / 100) * audioElement.duration;
                audioElement.currentTime = newTime;
                updateProgressBar();
            }
        }

        function stopDragging() {
            isDraggingProgress = false;
            
            const thumb = document.getElementById('progressThumb');
            if (thumb) {
                thumb.style.cursor = 'grab';
            }
            
            document.removeEventListener('mousemove', dragProgress);
            document.removeEventListener('mouseup', stopDragging);
        }

        function openMusicSettings(event) {
            event.preventDefault();
            // console.log('[音樂系統] 嘗試打開音樂設置窗口');
            
            try {
                openModal('musicSettingsModal');
                // console.log('[音樂系統] 音樂設置窗口已打開');
                
                // 載入音樂列表
                loadMusicList();
                
                // 🔥 新增：確保音樂列表為收起來的狀態
                setTimeout(() => {
                    const container = document.getElementById('musicListContainer');
                    const modalContent = document.querySelector('#musicSettingsModal .modal-content');
                    if (container && modalContent) {
                        container.style.height = '0px';
                        modalContent.style.height = '500px';
                        console.log('[音樂系統] 音樂列表已設定為收起來狀態');
                    }
                }, 100);
                
            } catch (error) {
                console.error('[音樂系統] 打開設置窗口失敗:', error);
            }
        }
        
        // 打開添加音樂子模態窗口
        function openAddMusicModal() {
            try {
                const modal = document.getElementById('addMusicModal');
                if (modal) {
                    modal.style.display = 'flex';
                    console.log('[音樂系統] 添加音樂窗口已打開');
                    
                    // 清空輸入框
                    const nameInput = document.getElementById('addMusicNameInput');
                    const urlInput = document.getElementById('addMusicUrlInput');
                    if (nameInput) nameInput.value = '';
                    if (urlInput) urlInput.value = '';
                    
                    // 設置拖拽上傳功能
                    setTimeout(() => {
                        setupDragAndDrop();
                        if (nameInput) nameInput.focus();
                    }, 100);
                } else {
                    console.error('[音樂系統] 找不到添加音樂模態窗口元素');
                }
            } catch (error) {
                console.error('[音樂系統] 打開添加音樂窗口失敗:', error);
            }
        }
        
        // 關閉添加音樂子模態窗口
        function closeAddMusicModal() {
            try {
                const modal = document.getElementById('addMusicModal');
                if (modal) {
                    modal.style.display = 'none';
                    
                    // 清理文件選擇狀態
                    const fileInput = document.getElementById('musicFileInput');
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    // 隱藏文件信息
                    const fileInfo = document.getElementById('fileInfo');
                    if (fileInfo) {
                        fileInfo.style.display = 'none';
                    }
                    
                    // 清空全局文件變量
                    window.selectedMusicFile = null;
                    
                    // 重置標籤頁到URL模式
                    switchTab('url');
                    
                    console.log('[音樂系統] 添加音樂窗口已關閉');
                } else {
                    console.error('[音樂系統] 找不到添加音樂模態窗口元素');
                }
            } catch (error) {
                console.error('[音樂系統] 關閉添加音樂窗口失敗:', error);
            }
        }
        
        // 切換音樂列表展開/收縮
        function toggleMusicList() {
            const container = document.getElementById('musicListContainer');
            const modalContent = document.querySelector('#musicSettingsModal .modal-content');
            
            if (container && modalContent) {
                if (container.style.height === '0px' || !container.style.height) {
                    // 展開列表
                    container.style.height = '100%';
                    modalContent.style.height = '650px';
                } else {
                    // 收縮列表
                    container.style.height = '0px';
                    modalContent.style.height = '500px';
                }
            }
        }
        
        // 播放黑膠唱片動畫
        function playVinylAnimation() {
            const vinyl = document.getElementById('vinylRecord');
            if (vinyl) {
                console.log('[音樂系統] 開始播放黑膠唱片動畫');
                
                // 重置初始狀態 - 在容器內部
                vinyl.style.transition = 'none';
                vinyl.style.opacity = '0';
                vinyl.style.right = '200px';
                vinyl.style.transform = 'translateY(-50%) rotate(0deg)';
                
                // 強制重繪
                vinyl.offsetHeight;
                
                // 恢復過渡效果
                vinyl.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                
                // 延遲一點再開始動畫
                setTimeout(() => {
                    // 開始動畫 - 往右滑出到容器外部
                    vinyl.style.opacity = '1';
                    vinyl.style.right = '150px';
                    vinyl.style.transform = 'translateY(-50%) rotate(180deg)';
                    
                    console.log('[音樂系統] 黑膠唱片動畫已觸發，固定顯示');
                }, 50);
                
                // 不再自動隱藏，保持固定顯示直到下次切換音樂
            } else {
                console.warn('[音樂系統] 找不到黑膠唱片元素');
            }
        }
        
        // 更新音樂封面
        function updateMusicCover(imageUrl) {
            const cover = document.getElementById('musicCover');
            if (cover && imageUrl) {
                cover.src = imageUrl;
            }
        }
        
        // 更新歌曲名稱顯示
        function updateSongNameDisplay() {
            const songNameElement = document.getElementById('currentSongName');
            if (songNameElement && musicList.length > 0 && currentMusicIndex >= 0 && currentMusicIndex < musicList.length) {
                songNameElement.textContent = musicList[currentMusicIndex].name;
            }
        }
        
        // 從子模態窗口添加音樂
        async function addMusicFromModal() {
            const nameInput = document.getElementById('addMusicNameInput');
            const urlInput = document.getElementById('addMusicUrlInput');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!name || !url) {
                showNotification('請輸入音樂名稱和URL', 'warning');
                return;
            }
            
            try {
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                const musicItem = {
                    name: name,
                    url: url,
                    addedAt: new Date().toISOString()
                };
                
                const request = store.add(musicItem);
                
                request.onsuccess = () => {
                    console.log('[音樂系統] 音樂添加成功:', name);
                    showNotification(`音樂 "${name}" 已添加到列表`, 'success');
                    
                    // 清空輸入框
                    nameInput.value = '';
                    urlInput.value = '';
                    
                    // 關閉子模態窗口
                    closeAddMusicModal();
                    
                    // 重新載入音樂列表
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[音樂系統] 音樂添加失敗');
                    showNotification('音樂添加失敗', 'error');
                };
                
            } catch (error) {
                console.error('[音樂系統] 添加音樂時發生錯誤:', error);
                showNotification('添加音樂失敗', 'error');
            }
        }
        
        // 從子模態窗口測試音樂
        function testMusicFromModal() {
            const urlInput = document.getElementById('addMusicUrlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                showNotification('請輸入音樂URL', 'warning');
                return;
            }
            
            try {
                // 創建臨時音頻元素進行測試
                const testAudio = new Audio();
                testAudio.src = url;
                
                testAudio.addEventListener('loadeddata', function() {
                    showNotification('音樂URL測試成功！', 'success');
                    testAudio.remove(); // 清理臨時音頻元素
                });
                
                testAudio.addEventListener('error', function() {
                    showNotification('音樂URL測試失敗，請檢查URL是否正確', 'error');
                    testAudio.remove(); // 清理臨時音頻元素
                });
                
                // 設置超時處理
                setTimeout(() => {
                    if (testAudio.readyState === 0) {
                        showNotification('音樂URL測試超時，請檢查網絡連接', 'warning');
                        testAudio.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('[音樂系統] 測試音樂時發生錯誤:', error);
                showNotification('測試音樂失敗', 'error');
            }
        }

        // 標籤頁切換功能
        function switchTab(tabName) {
            // 隱藏所有標籤頁內容
            const tabContents = document.querySelectorAll('.settings-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // 移除所有標籤按鈕的active狀態
            const tabButtons = document.querySelectorAll('.settings-tabs .tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 顯示選中的標籤頁
            const selectedTab = document.getElementById(tabName + 'Tab');
            const selectedBtn = document.querySelector(`.settings-tabs .tab-btn[onclick*="switchTab('${tabName}')"]`);
            
            if (selectedTab && selectedBtn) {
                selectedTab.style.display = 'block';
                selectedTab.classList.add('active');
                selectedBtn.classList.add('active');
            }
        }

        // 文件選擇處理
        function handleFileSelect(event) {
            const file = event.target.files[0];
            processSelectedFile(file);
        }

        // 處理選中的文件
        function processSelectedFile(file) {
            if (!file) return;
            
            // 檢查文件類型
            if (!file.type.startsWith('audio/')) {
                showNotification('請選擇音頻文件', 'warning');
                return;
            }
            
            // 檢查文件大小 (限制為50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showNotification('文件大小不能超過50MB', 'warning');
                return;
            }
            
            // 顯示文件信息
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            
            fileName.textContent = file.name;
            fileSize.textContent = `大小: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            fileInfo.style.display = 'block';
            
            // 自動填充音樂名稱（如果為空）
            const nameInput = document.getElementById('addMusicNameInput2');
            if (!nameInput.value.trim()) {
                nameInput.value = file.name.replace(/\.[^/.]+$/, ""); // 移除文件擴展名
            }
            
            // 存儲選中的文件到全局變量
            window.selectedMusicFile = file;
        }

        // 設置拖拽上傳功能
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;
            
            // 防止默認拖拽行為
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // 拖拽進入和離開效果
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            // 處理文件拖放
            uploadArea.addEventListener('drop', handleDrop, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight(e) {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.add('dragover');
        }
        
        function unhighlight(e) {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                processSelectedFile(files[0]);
            }
        }

        // 從上傳添加音樂
        async function addMusicFromUpload() {
            const nameInput = document.getElementById('addMusicNameInput2');
            const name = nameInput.value.trim();
            const file = window.selectedMusicFile;
            
            if (!name || !file) {
                showNotification('請輸入音樂名稱並選擇文件', 'warning');
                return;
            }
            
            try {
                // 將文件轉換為blob URL並存儲到Cache Storage
                const blobUrl = URL.createObjectURL(file);
                
                // 存儲到Cache Storage
                const cache = await caches.open('music-cache');
                const response = await fetch(blobUrl);
                await cache.put(`music-${Date.now()}`, response);
                
                if (!musicDB) {
                    await initMusicDatabase();
                }
                
                const transaction = musicDB.transaction(['musicList'], 'readwrite');
                const store = transaction.objectStore('musicList');
                
                const musicItem = {
                    name: name,
                    url: blobUrl,
                    type: 'local',
                    fileSize: file.size,
                    addedAt: new Date().toISOString()
                };
                
                const request = store.add(musicItem);
                
                request.onsuccess = () => {
                    console.log('[音樂系統] 本地音樂添加成功:', name);
                    showNotification(`音樂 "${name}" 已上傳並添加到列表`, 'success');
                    
                    // 清空輸入框和文件信息
                    nameInput.value = '';
                    document.getElementById('fileInfo').style.display = 'none';
                    window.selectedMusicFile = null;
                    
                    // 關閉子模態窗口
                    closeAddMusicModal();
                    
                    // 重新載入音樂列表
                    loadMusicList();
                };
                
                request.onerror = () => {
                    console.error('[音樂系統] 本地音樂添加失敗');
                    showNotification('音樂添加失敗', 'error');
                };
                
            } catch (error) {
                console.error('[音樂系統] 上傳音樂時發生錯誤:', error);
                showNotification('上傳音樂失敗', 'error');
            }
        }

        // 測試上傳的音樂
        function testMusicFromUpload() {
            const file = window.selectedMusicFile;
            
            if (!file) {
                showNotification('請先選擇音樂文件', 'warning');
                return;
            }
            
            try {
                const blobUrl = URL.createObjectURL(file);
                const testAudio = new Audio();
                testAudio.src = blobUrl;
                
                testAudio.addEventListener('loadeddata', function() {
                    showNotification('音樂文件測試成功！', 'success');
                    testAudio.remove();
                });
                
                testAudio.addEventListener('error', function() {
                    showNotification('音樂文件測試失敗，請檢查文件格式', 'error');
                    testAudio.remove();
                });
                
                // 設置超時處理
                setTimeout(() => {
                    if (testAudio.readyState === 0) {
                        showNotification('音樂文件測試超時', 'warning');
                        testAudio.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('[音樂系統] 測試上傳音樂時發生錯誤:', error);
                showNotification('測試音樂失敗', 'error');
            }
        }

        function applyMusicSettings() {
            const urlInput = document.getElementById('musicUrlInput');
            const newUrl = urlInput.value.trim();
            
            if (!newUrl) {
                showNotification('請輸入音樂URL', 'warning');
                return;
            }

            // 如果正在播放，先停止
            if (isMusicPlaying) {
                stopMusic();
            }

            currentMusicUrl = newUrl;
            
            // 保存到本地存儲
            localStorage.setItem('musicUrl', newUrl);
            
            // 更新音頻元素
            if (audioElement) {
                audioElement.src = newUrl;
                // console.log('[音樂系統] 已更新音頻源:', newUrl);
                
                // 重新初始化音頻事件監聽器
                audioElement.addEventListener('loadeddata', function() {
                    // console.log('[音樂系統] 新音樂已載入');
                });
                
                audioElement.addEventListener('error', function(e) {
                    console.error('[音樂系統] 新音樂載入錯誤:', e);
                    showNotification('新音樂載入失敗，請檢查URL', 'error');
                });
            }
            
            showNotification('音樂設置已保存並更新', 'success');
            closeModal('musicSettingsModal');
        }

        function testMusic() {
            const urlInput = document.getElementById('musicUrlInput');
            const testUrl = urlInput.value.trim();
            
            if (!testUrl) {
                showNotification('請先輸入音樂URL', 'warning');
                return;
            }

            // console.log('[音樂系統] 開始測試音樂URL:', testUrl);

            // 創建臨時音頻元素進行測試
            const testAudio = new Audio();
            
            // 設置超時處理
            const timeout = setTimeout(() => {
                console.error('[音樂系統] 音樂測試超時');
                showNotification('音樂測試超時，請檢查URL是否有效', 'error');
                testAudio.pause();
            }, 10000); // 10秒超時
            
            testAudio.addEventListener('canplay', function() {
                clearTimeout(timeout);
                // console.log('[音樂系統] 音樂URL測試成功');
                showNotification('音樂URL測試成功！可以播放', 'success');
                testAudio.pause();
            });
            
            testAudio.addEventListener('error', function(e) {
                clearTimeout(timeout);
                console.error('[音樂系統] 音樂URL測試失敗:', e);
                let errorMessage = '音樂URL測試失敗';
                
                // 根據錯誤類型提供更具體的錯誤信息
                if (testAudio.error) {
                    switch(testAudio.error.code) {
                        case MediaError.MEDIA_ERR_ABORTED:
                            errorMessage = '音樂載入被中止';
                            break;
                        case MediaError.MEDIA_ERR_NETWORK:
                            errorMessage = '網絡錯誤，無法訪問音樂文件';
                            break;
                        case MediaError.MEDIA_ERR_DECODE:
                            errorMessage = '音樂格式不支持或文件損壞';
                            break;
                        case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMessage = '音樂格式不支持，請使用MP3、WAV等格式';
                            break;
                        default:
                            errorMessage = '音樂載入失敗，請檢查URL是否正確';
                    }
                }
                
                showNotification(errorMessage, 'error');
            });

            // 設置音頻源並嘗試播放
            testAudio.src = testUrl;
            testAudio.load(); // 強制載入
            
            testAudio.play().catch(error => {
                clearTimeout(timeout);
                console.error('[音樂系統] 測試播放失敗:', error);
                showNotification('音樂播放失敗，請檢查URL和格式', 'error');
            });
        }
        
        // 🆕 VN面板狀態持久化
        let lastVNState = 'landing';   // 最後保存的狀態
        
        // VN面板iframe動態伸縮函數
        function resizeVNIframe(state) {
            const vnIframe = document.getElementById('vnPanelIframe');
            if (!vnIframe) return;
            
            vnIframeState = state;
            lastVNState = state; // 保存最後狀態
            
            // 防抖動：使用requestAnimationFrame確保平滑動畫
            requestAnimationFrame(() => {
                switch(state) {
                    case 'landing':
                        // 縮小尺寸 - vn-landing-content尺寸
                        vnIframe.style.position = 'absolute';
                        vnIframe.style.left = '50%';
                        vnIframe.style.top = '50%';
                        vnIframe.style.transform = 'translate(-50%, -50%)';
                        vnIframe.style.width = '300px';
                        vnIframe.style.height = '400px';
                        vnIframe.style.maxWidth = '90%';
                        vnIframe.style.borderRadius = '40px';
                        vnIframe.style.transformOrigin = 'center center';
                        // 顯示音樂按鈕
                        const musicBtnLanding = document.querySelector('.music-control-btn');
                        if (musicBtnLanding) {
                            musicBtnLanding.style.setProperty('display', 'flex', 'important');
                            musicBtnLanding.style.setProperty('visibility', 'visible', 'important');
                            musicBtnLanding.style.setProperty('opacity', '1', 'important');
                            musicBtnLanding.style.setProperty('pointer-events', 'auto', 'important');
                        }
                        // 調用狀態維護函數確保一致性
                        maintainMusicButtonHiddenState();
                        break;
                        
                    case 'story':
                        // 展開尺寸 - 滿版new-page-content容器
                        vnIframe.style.position = 'absolute';
                        vnIframe.style.left = '0';
                        vnIframe.style.top = '0';
                        vnIframe.style.transform = 'none';
                        vnIframe.style.width = '100%';
                        vnIframe.style.height = '100%';
                        vnIframe.style.maxWidth = '100%';
                        vnIframe.style.maxHeight = '100%';
                        vnIframe.style.borderRadius = '0';
                        vnIframe.style.zIndex = '9999';
                        vnIframe.style.transformOrigin = 'center center';
                        // 隱藏音樂按鈕
                        const musicBtnStory = document.querySelector('.music-control-btn');
                        if (musicBtnStory) {
                            musicBtnStory.style.setProperty('display', 'none', 'important');
                            musicBtnStory.style.setProperty('visibility', 'hidden', 'important');
                            musicBtnStory.style.setProperty('opacity', '0', 'important');
                            musicBtnStory.style.setProperty('pointer-events', 'none', 'important');
                        }
                        // 調用狀態維護函數確保一致性
                        maintainMusicButtonHiddenState();
                        break;
                        
                    case 'continue':
                        // 縮小尺寸 - 劇情結尾時的尺寸
                        vnIframe.style.position = 'absolute';
                        vnIframe.style.left = '50%';
                        vnIframe.style.top = '50%';
                        vnIframe.style.transform = 'translate(-50%, -50%)';
                        vnIframe.style.width = '300px';
                        vnIframe.style.height = '400px';
                        vnIframe.style.maxWidth = '90%';
                        vnIframe.style.borderRadius = '40px';
                        vnIframe.style.transformOrigin = 'center center';
                        // 顯示音樂按鈕
                        const musicBtnContinue = document.querySelector('.music-control-btn');
                        if (musicBtnContinue) {
                            musicBtnContinue.style.setProperty('display', 'flex', 'important');
                            musicBtnContinue.style.setProperty('visibility', 'visible', 'important');
                            musicBtnContinue.style.setProperty('opacity', '1', 'important');
                            musicBtnContinue.style.setProperty('pointer-events', 'auto', 'important');
                        }
                        // 調用狀態維護函數確保一致性
                        maintainMusicButtonHiddenState();
                        break;
                }
                
                // console.log(`[VN面板] iframe尺寸平滑調整為: ${state}`);
            });
        }
        
        // 確保resizeVNIframe函數立即可用
        window.resizeVNIframe = resizeVNIframe;
        
        // 🆕 頁面可見性狀態恢復
        function handlePageVisibilityChange() {
            if (!document.hidden) {
                console.log('[主面板] 頁面重新可見，恢復VN面板狀態');
                
                // 延遲一點時間確保iframe完全加載
                setTimeout(() => {
                    if (vnIframeState !== lastVNState) {
                        console.log(`[主面板] 檢測到狀態不匹配，恢復為: ${lastVNState}`);
                        resizeVNIframe(lastVNState);
                    }
                }, 200);
            } else {
                console.log('[主面板] 頁面隱藏，保存當前狀態');
                lastVNState = vnIframeState;
            }
        }
        
        // 🆕 窗口焦點變化處理
        function handleWindowFocusChange() {
            if (document.hasFocus()) {
                console.log('[主面板] 窗口重新獲得焦點，檢查VN面板狀態');
                
                setTimeout(() => {
                    if (vnIframeState !== lastVNState) {
                        console.log(`[主面板] 焦點恢復時檢測到狀態不匹配，恢復為: ${lastVNState}`);
                        resizeVNIframe(lastVNState);
                    }
                }, 100);
            }
        }
        
        // 🆕 添加頁面可見性監聽器
        document.addEventListener('visibilitychange', handlePageVisibilityChange);
        
        // 🆕 添加窗口焦點監聽器
        window.addEventListener('focus', handleWindowFocusChange);
        
        // 🆕 添加強制狀態恢復功能
        window.forceRestoreVNState = function() {
            console.log('[主面板] 強制恢復VN面板狀態:', lastVNState);
            resizeVNIframe(lastVNState);
        };
        
        // 🆕 添加狀態查詢功能
        window.getVNState = function() {
            return {
                currentState: vnIframeState,
                lastSavedState: lastVNState
            };
        };
        
        // 監聽VN面板iframe消息
        function setupVNIframeListener() {
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'VN_IFRAME_RESIZE') {
                    resizeVNIframe(event.data.state);
                }
            });
        }

        // 初始化音樂設置
        async function initMusicSettings() {
            try {
                // 初始化音樂數據庫
                await initMusicDatabase();
                
                // 載入音樂列表（這個函數會自動處理緩存恢復）
                await loadMusicList();
                
                // 🔥 修改：移除重複的緩存邏輯，因為loadMusicList()已經處理了
                // 只有在音樂列表為空時才使用預設音樂
                if (musicList.length === 0) {
                    currentMusicUrl = 'https://files.catbox.moe/snenpf.mp3';
                    console.log('[音樂系統] 音樂列表為空，使用預設音樂');
                }
                
                // 初始化音樂按鈕狀態
                updateMusicButtonState();
                
                // 初始化背景音樂
                initBackgroundMusic();
                
                // 🔥 新增：初始化音樂列表為收起來的狀態
                const container = document.getElementById('musicListContainer');
                const modalContent = document.querySelector('#musicSettingsModal .modal-content');
                if (container && modalContent) {
                    container.style.height = '0px';
                    modalContent.style.height = '500px';
                    console.log('[音樂系統] 音樂列表已初始化為收起來狀態');
                }
                
                console.log('[音樂系統] 音樂設置初始化完成');
            } catch (error) {
                console.error('[音樂系統] 初始化音樂設置失敗:', error);
            }
        }
        
        // 🆕 新增：防止手機端彈性滾動的JavaScript防護
        function setupMobileScrollProtection() {
            // 設置所有iframe的防護
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                iframe.style.overscrollBehavior = 'none';
                iframe.style.webkitOverflowScrolling = 'auto';
                iframe.style.touchAction = 'manipulation';
                
                // 嘗試設置iframe內部的防護（如果同源）
                try {
                    if (iframe.contentDocument && iframe.contentDocument.body) {
                        iframe.contentDocument.body.style.overscrollBehavior = 'none';
                        iframe.contentDocument.body.style.webkitOverflowScrolling = 'auto';
                        iframe.contentDocument.body.style.touchAction = 'manipulation';
                        
                        // 設置iframe內部所有元素的防護
                        const iframeElements = iframe.contentDocument.querySelectorAll('*');
                        iframeElements.forEach(element => {
                            element.style.overscrollBehavior = 'none';
                            element.style.webkitOverflowScrolling = 'auto';
                            element.style.touchAction = 'manipulation';
                        });
                    }
                } catch (e) {
                    // 跨域情況下無法訪問iframe內容，這是正常的
                    console.log('[防護系統] iframe內容跨域，無法直接設置樣式');
                }
            });
            
            // 設置所有容器的防護
            const containers = document.querySelectorAll('.swipe-container, .swipe-wrapper, .swipe-slide, .phone-container');
            containers.forEach(container => {
                container.style.overscrollBehavior = 'none';
                container.style.webkitOverflowScrolling = 'auto';
                container.style.touchAction = 'manipulation';
            });
            
            console.log('[防護系統] 手機端彈性滾動防護已設置');
        }

        // 長按事件處理
        function setupLongPress() {
            const musicBtn = document.getElementById('musicControlBtn');
            if (!musicBtn) {
                console.error('[音樂系統] 找不到音樂按鈕元素');
                return;
            }

            let pressTimer = null;
            let isLongPress = false;
            let clickCount = 0;
            let clickTimer = null;

            // 防止文字選取
            musicBtn.style.userSelect = 'none';
            musicBtn.style.webkitUserSelect = 'none';
            musicBtn.style.mozUserSelect = 'none';
            musicBtn.style.msUserSelect = 'none';

            // 簡化的長按檢測
            function startLongPress(e) {
                e.preventDefault();
                isLongPress = false;
                
                // 添加視覺反饋 - 輕微縮放效果
                musicBtn.style.transform = 'scale(0.95)';
                musicBtn.style.transition = 'transform 0.1s ease';
                
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    // console.log('[音樂系統] 長按觸發，打開設置窗口');
                    openMusicSettings(e);
                }, 500); // 縮短到500ms，更快速響應
            }

            function endPress(e) {
                e.preventDefault();
                clearTimeout(pressTimer);
                
                // 恢復按鈕視覺狀態
                musicBtn.style.transform = 'scale(1)';
                
                if (!isLongPress) {
                    clickCount++;
                    
                    if (clickCount === 1) {
                        // 第一次點擊，等待可能的第二次點擊
                        clickTimer = setTimeout(() => {
                            // 單擊：切換播放狀態
                            // console.log('[音樂系統] 單擊觸發，切換播放狀態');
                            toggleMusic();
                            clickCount = 0;
                        }, 250);
                    } else if (clickCount === 2) {
                        // 雙擊：切換到下一首音樂
                        clearTimeout(clickTimer);
                        // console.log('[音樂系統] 雙擊觸發，切換到下一首音樂');
                        nextMusic();
                        clickCount = 0;
                    }
                }
            }

            // 滑鼠事件
            musicBtn.addEventListener('mousedown', startLongPress);
            musicBtn.addEventListener('mouseup', endPress);
            musicBtn.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
                musicBtn.style.transform = 'scale(1)';
            });

            // 觸摸事件
            musicBtn.addEventListener('touchstart', startLongPress);
            musicBtn.addEventListener('touchend', endPress);

            // 防止右鍵菜單
            musicBtn.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        // 🆕 新增：處理CHAT面板頁面狀態變化
        function handleChatPageStateChange(data) {
            const closeBtn = document.getElementById('chatIframeCloseBtn');
            if (!closeBtn) {
                console.error('[主面板] 找不到chat iframe關閉按鈕');
                return;
            }
            
            // 根據頁面狀態控制關閉按鈕的顯示
            if (data.isInChatRoom) {
                // 在聊天室頁面，隱藏關閉按鈕
                closeBtn.style.display = 'none';
                console.log('[主面板] Chat面板進入聊天室，隱藏iframe關閉按鈕');
            } else {
                // 在聊天列表頁面，顯示關閉按鈕
                closeBtn.style.display = 'flex';
                console.log('[主面板] Chat面板返回聊天列表，顯示iframe關閉按鈕');
            }
        }

        // 在DOMContentLoaded中調用初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await initMusicSettings();
            setupLongPress();
            setupVNIframeListener();
            
            // 🆕 新增：設置手機端彈性滾動防護
            setupMobileScrollProtection();
            
            // 🆕 新增：初始化頁面位置
            updatePage();
            
            // 延遲設置防護，確保iframe已載入
            setTimeout(() => {
                setupMobileScrollProtection();
                // 🆕 新增：再次確保頁面位置正確
                updatePage();
            }, 1000);
            
            // console.log('[音樂系統] 初始化完成');
            // console.log('[VN面板] iframe監聽器已設置');
        });

    </script>
</body>
</html>