<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–è¦ºå°èªªé¢æ¿ (JCYç‰ˆ)</title>
    <link rel="stylesheet" href="vn_style.css">
    <link rel="stylesheet" href="vn_landing_style.css">
    <link rel="stylesheet" href="calltype-style.css">
    <link rel="stylesheet" href="chattype-style.css">
    <link rel="stylesheet" href="echotype-style.css">
    <link rel="stylesheet" href="livestreamtype-style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <style>
        /* æ‰‹æœºç‰ˆç®€åŒ–æ ·å¼ */

        /* ç®€åŒ–çš„loadingåŠ¨ç”»æ ·å¼ */
        .dialog-loading-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border-radius: inherit;
        }

        .dialog-loading-container.active {
            opacity: 1;
            visibility: visible;
        }

        .dialog-loading-text {
            color: #fff;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            line-height: 1.4;
            max-width: 300px;
        }

        .dialog-loading-gif {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        /* æ‰‹æœºç‰ˆèƒŒæ™¯å›¾ç‰‡URLæ˜¾ç¤º */
        .mobile-background-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 6px 10px;
            border-radius: 40px;
            font-size: 10px;
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 250px;
            word-break: break-all;
        }

        .mobile-background-info.show {
            opacity: 0.8;
        }

        /* æ‰‹æœºç‰ˆè®¾ç½®æ ·å¼ç®€åŒ– */
        .mobile-settings-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .mobile-settings-title {
            color: var(--text-color-light);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .mobile-setting-item {
            margin-bottom: 10px;
            font-size: 12px;
        }

        .mobile-setting-label {
            color: var(--text-color-light);
            margin-bottom: 5px;
            display: block;
        }

        .mobile-setting-description {
            color: var(--text-color-muted);
            font-size: 11px;
            margin-top: 5px;
            line-height: 1.3;
        }

        /* æ‰‹æœºç‰ˆä¼˜åŒ–ï¼šç®€åŒ–æŒ‰é’® */
        .mobile-simple-button {
            padding: 6px 12px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .mobile-simple-button:hover {
            background-color: #357abd;
            transform: translateY(-1px);
        }

        .mobile-simple-button.secondary {
            background-color: #6c757d;
        }

        .mobile-simple-button.secondary:hover {
            background-color: #545b62;
        }

        /* åŠ‡æƒ…è¨­ç½®æŒ‰éˆ•æ¨£å¼ */
        .vn-landing-btn.settings {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .vn-landing-btn.settings:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* åŠ‡æƒ…è¨­ç½®æ¨¡æ…‹çª—å£æ¨£å¼ */
        .story-settings-container {
            background: var(--bg-color);
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .story-settings-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .story-settings-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .mode-badge {
            margin-left: 10px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: normal;
            background: #007bff;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .category-display {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-display::before {
            content: 'ğŸ“';
            font-size: 16px;
        }

        .close-story-settings {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-story-settings:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .story-settings-content {
            padding: 30px 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        /* è¨­ç½®ä½”ä½ç¬¦æ¨£å¼ */
        .settings-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-color-light);
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .placeholder-text {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .placeholder-subtitle {
            font-size: 14px;
            color: var(--text-color-muted);
            line-height: 1.4;
        }

        /* è¨­ç½®å€åŸŸæ¨£å¼ */
        .settings-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .story-settings-footer {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .settings-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .settings-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .settings-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .settings-btn.confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* åŠ‡æƒ…åˆ—è¡¨æ¨£å¼ */
        .story-list-section {
            margin-bottom: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .add-story-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .add-story-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .story-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* åŠ‡æƒ…é¸æ“‡æ¨£å¼ */
        .story-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .story-item:hover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .story-item.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        
        .story-selection-indicator {
            margin-top: 8px;
            text-align: center;
        }
        
        .selection-text {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        
        .story-item.selected .selection-text {
            color: #4CAF50;
            font-weight: 500;
        }
        
        /* é–‹å§‹åŠ‡æƒ…æŒ‰éˆ•æ¨£å¼ */
        .vn-landing-btn.primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .vn-landing-btn.primary.has-selection {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        
        .story-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .story-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .story-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .story-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
            margin: 0;
        }
        
        .story-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .story-item:hover .story-actions {
            opacity: 1;
        }
        
        .story-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color-light);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .story-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .story-action-btn.edit {
            color: #4CAF50;
        }
        
        .story-action-btn.delete {
            color: #f44336;
        }
        
        .story-description {
            color: var(--text-color-muted);
            font-size: 14px;
            line-height: 1.4;
            margin: 0;
        }
        
        .story-characters {
            margin-top: 8px;
            font-size: 12px;
            color: #ffffff;
        }
        
        .story-character-tag {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 2px 6px;
            border-radius: 12px;
            margin-right: 5px;
            font-size: 11px;
        }
        
        .empty-story-list {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-color-muted);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color-light);
        }
        
        .empty-subtitle {
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* åŠ‡æƒ…ç·¨è¼¯æ¨¡æ…‹çª—å£æ¨£å¼ */
        .story-edit-container {
            background: var(--bg-color);
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .story-edit-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .story-edit-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-story-edit {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-story-edit:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .story-edit-content {
            padding: 30px 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group select[multiple] {
            min-height: 100px;
        }
        
        /* ä¿®å¾©selectå’Œoptionçš„é¡è‰²å•é¡Œ */
        .form-group select {
            color: var(--text-color) !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }
        
        .form-group select option {
            background: #2a2a3a !important;
            color: var(--text-color) !important;
            padding: 8px 12px;
        }
        
        .form-group select option:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }
        
        .form-group select option:checked {
            background: rgba(76, 175, 80, 0.2) !important;
            color: #4CAF50 !important;
        }
        
        /* è§’è‰²é¸æ“‡å®¹å™¨æ¨£å¼ */
        .character-select-container {
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
        }
        
        /* ä¸–ç•Œæ›¸é¸æ“‡å®¹å™¨æ¨£å¼ */
        .worldbook-select-container {
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
        }
        
        .character-option, .worldbook-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .character-option:hover, .worldbook-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .character-option.selected, .worldbook-option.selected {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }
        
        .character-option.selected::before, .worldbook-option.selected::before {
            content: 'âœ“';
            margin-right: 8px;
            font-weight: bold;
        }
        
        .character-option:not(.selected)::before, .worldbook-option:not(.selected)::before {
            content: 'â—‹';
            margin-right: 8px;
            opacity: 0.5;
        }
        
        .character-option-name {
            flex: 1;
            font-size: 14px;
        }
        
        .character-option-personality {
            font-size: 12px;
            color: var(--text-color-muted);
            margin-left: 8px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ä¸–ç•Œæ›¸é¸é …æ¨£å¼ */
        .worldbook-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .worldbook-option-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }
        
        .worldbook-option-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .worldbook-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
        }
        
        .worldbook-badge.priority-æœ€é‡è¦ {
            background: #dc3545;
        }
        
        .worldbook-badge.priority-é‡è¦ {
            background: #fd7e14;
        }
        
        .worldbook-badge.priority-æ™®é€š {
            background: #6c757d;
        }
        
        .worldbook-badge.trigger-always-on {
            background: #28a745;
        }
        
        .worldbook-badge.trigger-keywords {
            background: #17a2b8;
        }
        
        .worldbook-badge.category-ç³»çµ± {
            background: #6f42c1;
        }
        
        .worldbook-badge.category-å‚™è¨» {
            background: #20c997;
        }
        
        .worldbook-option-content {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .worldbook-option-description {
            font-size: 12px;
            color: var(--text-color-muted);
            line-height: 1.3;
        }
        
        .worldbook-option-keywords {
            font-size: 11px;
            color: #ffc107;
            font-style: italic;
        }
        
        .form-help {
            font-size: 12px;
            margin-bottom: 10px;
            color: #ffffff;
            margin-top: 5px;
            font-style: italic;
        }
        
        .story-edit-footer {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .story-edit-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        
        .story-edit-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .story-edit-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .story-edit-btn.save {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }
        
        .story-edit-btn.save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        /* å…¨å±€åˆ‡æ›æ¨™ç±¤æ¨£å¼ */
        .source-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .source-mode-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: var(--text-color-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .source-mode-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .source-mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .source-mode-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .mode-icon {
            font-size: 24px;
        }
        
        .mode-text {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* URLè¼¸å…¥å€åŸŸæ¨£å¼ */
        .url-input-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .url-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .url-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .url-input::placeholder {
            color: var(--text-color-muted);
        }
        
        .url-add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .url-add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .url-add-btn:active {
            transform: translateY(0);
        }
        
        /* ä¸Šå‚³åœ–ç‰‡å€åŸŸæ¨£å¼ */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        
        .upload-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .upload-hint {
            font-size: 12px;
            color: var(--text-color-muted);
            margin-bottom: 15px;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* åœ–ç‰‡åˆ—è¡¨æ¨£å¼ */
        .image-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-item {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .image-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .image-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .image-info {
            padding: 8px;
            font-size: 11px;
            color: var(--text-color-light);
            text-align: center;
        }
        
        .image-name {
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .image-size {
            font-size: 10px;
            opacity: 0.7;
        }
        
        .image-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-item:hover .image-actions {
            opacity: 1;
        }
        
        .image-action-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .image-action-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .image-action-btn.delete {
            background: rgba(220, 53, 69, 0.8);
        }
        
        .image-action-btn.delete:hover {
            background: rgba(220, 53, 69, 1);
        }
        
        /* æ¸¬è©¦çµæœæ¨£å¼ */
        .portrait-test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .portrait-test-result .success {
            color: #4CAF50;
            font-weight: 500;
        }
        
        .portrait-test-result .error {
            color: #f44336;
            font-weight: 500;
        }
        
        .test-portrait-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-portrait-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        /* VNå•Ÿå‹•ç•Œé¢è¿”å›æŒ‰éˆ•æ¨£å¼ */
        .vn-landing-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
        }
        
        .vn-landing-back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .vn-landing-back-btn:active {
            transform: translateY(0);
        }

        /* åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£æ¨£å¼ */
        .image-tag-container {
            background: var(--dialog-bg, #2a2a2a);
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .image-tag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .image-tag-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color, #ffffff);
        }

        .close-image-tag {
            background: none;
            border: none;
            color: var(--text-color-light, #cccccc);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-image-tag:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color, #ffffff);
        }

        .image-tag-content {
            padding: 20px 24px;
        }

        .image-preview-section {
            margin-bottom: 24px;
        }

        .image-preview-container {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }

        .image-tag-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            object-fit: contain;
        }

        .image-info {
            text-align: center;
            font-size: 12px;
            color: var(--text-color-light, #cccccc);
        }

        .image-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .image-size {
            opacity: 0.8;
        }

        .tag-input-section {
            margin-bottom: 20px;
        }

        .tag-category-select,
        .tag-label-input,
        .tag-emotion-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color, #ffffff);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .tag-category-select:focus,
        .tag-label-input:focus,
        .tag-emotion-input:focus {
            outline: none;
            border-color: var(--accent-color, #667eea);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .tag-help-text {
            font-size: 12px;
            color: var(--text-color-light, #cccccc);
            margin-top: 6px;
            line-height: 1.4;
        }

        .tag-preview-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tag-preview-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color, #ffffff);
            margin-bottom: 8px;
        }

        .tag-preview-result {
            font-size: 13px;
            color: var(--text-color-light, #cccccc);
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 4px;
            word-break: break-all;
        }

        .image-tag-footer {
            display: flex;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .image-tag-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-tag-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color, #ffffff);
        }

        .image-tag-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .image-tag-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .image-tag-btn.confirm:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .image-tag-btn.confirm:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color-light, #cccccc);
            cursor: not-allowed;
            transform: none;
        }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 768px) {
            .image-tag-container {
                width: 95%;
                max-height: 85vh;
            }

            .image-tag-content {
                padding: 16px 20px;
            }

            .image-tag-header {
                padding: 16px 20px 12px;
            }

            .image-tag-footer {
                padding: 16px 20px;
            }

            .image-tag-preview {
                max-width: 150px;
                max-height: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- æ‰‹æœºç‰ˆèƒŒæ™¯ä¿¡æ¯æ˜¾ç¤º -->
    <div class="mobile-background-info" id="mobileBackgroundInfo">
        èƒŒæ™¯: æœªçŸ¥
    </div>

    <!-- VNä¸»å¯åŠ¨ç•Œé¢ -->
    <div class="vn-landing-container active" id="vnLandingContainer">        
        <div class="vn-landing-content">
            <div class="vn-landing-logo">ğŸ“–</div>
            <h1 class="vn-landing-title">è¦–è¦ºå°èªªé¢æ¿</h1>
            <p class="vn-landing-subtitle">é¸æ“‡æ‚¨è¦é€²è¡Œçš„æ“ä½œ</p>
            <div class="vn-landing-buttons">
                <button class="vn-landing-btn primary" id="startStoryBtn">ğŸ“š é–‹å§‹åŠ‡æƒ…</button>
                <button class="vn-landing-btn secondary" id="showHistoryBtn">ğŸ“œ æŸ¥çœ‹æ­·å²åŠ‡æƒ…</button>
                <button class="vn-landing-btn settings" id="storySettingsBtn">âš™ï¸ åŠ‡æƒ…è¨­ç½®</button>
                <button class="vn-landing-btn settings" id="materialSettingsBtn">ğŸ¨ ç´ æè¨­ç½®</button>
            </div>
            <!-- èª¿è©¦ä¿¡æ¯ -->
            <div style="margin-top: 20px; font-size: 12px; opacity: 0.7;">
                <p>VNé¢æ¿å·²åŠ è¼‰ - ç‰ˆæœ¬: v20.1</p>
                <p>æ™‚é–“: <span id="debug-time"></span></p>
            </div>
        </div>
    </div>

    <!-- VNä¸»å†…å®¹å®¹å™¨ -->
    <div class="vn-main-container" id="vnMainContainer">
        <!-- å…¨å±LoadingåŠ¨ç”»å®¹å™¨ -->
        <div id="fullscreen-loading-overlay" class="fullscreen-loading-overlay">
            <div class="fullscreen-loading-content">
                <img src="loading.gif" alt="Loading..." class="fullscreen-loading-gif">
                <div class="fullscreen-loading-text">AI æ€è€ƒä¸­...</div>
            </div>
        </div>
        

        <div class="outer-container">
            <div class="game-container">
                <div class="top-nav">
                    <div class="stats-container">
                        <div class="char-data-panel collapsed">
                            <div class="char-data-header">
                                <span>è§’è‰²é—œä¿‚</span>
                            </div>
                            <div class="char-data-content" id="char-data-content">
                            </div>
                        </div>
                    </div>
                     
                    <div class="menu-buttons-container">
                        <div class="menu-button back-to-landing-button" title="è¿”å›ä¸»é " id="backToLandingBtn">ğŸ </div>
                        <div class="menu-button settings-button" title="è¨­å®š"><div class="menu-icon">âš™ï¸</div></div>
                        <div class="menu-button mailbox-button" title="è¨˜æ†¶ä¿¡ç®±"><div class="menu-icon">ğŸ“®</div></div>
                        <div class="menu-button history-button" title="æ­·å²å°è©±"><div class="menu-icon">ğŸ“œ</div></div>
                    </div>
                </div>

                <div class="characters-container">
                    <div class="character-center">
                    </div>
                </div>
                
                <div class="choices-container"></div>
                <div class="dialog-container">
                    <div class="name-tag">è§’è‰²å</div>
                    <div class="dialog-box">
                        <div class="dialog-content">
                            <span class="dialog-text">é€™è£¡æ˜¯è§’è‰²çš„å°è©±å…§å®¹...</span>
                            <span class="typewriter-cursor"></span>
                            <span class="text-indicator">â–¼</span>
                        </div>
                        <div class="dialog-progress">
                            <span id="current-dialogue">1</span>/<span id="total-dialogues">1</span>
                        </div>
                    </div>
                </div>
                
                <div class="command-button-container">
                    <button id="command-button" class="command-button" title="ç™¼é€æŒ‡ä»¤">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2,3L22,12L2,21V3M6,10V14L15.5,12L6,10Z"/>
                        </svg>
                        æŒ‡ä»¤
                    </button>
                </div>    
                
                <div id="inline-chat-container" class="inline-chat-container">
                    <div class="inline-chat-header">
                        <div class="inline-chat-title">èŠå¤©</div>
                        <button class="close-inline-chat" id="close-inline-chat">&times;</button>
                    </div>
                    <iframe id="inline-chat-iframe" class="inline-chat-iframe" src="about:blank"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- è®°å¿†ä¿¡ç®±æ¨¡æ€çª—å£ -->
    <div class="modal" id="mailModal">
        <div class="mailbox-container">
            <div class="mailbox-header">
                <div class="mailbox-title">è¨˜æ†¶ä¿¡ç®±</div>
                <button class="close-mailbox">&times;</button>
            </div>
            <div class="mail-list">
                <!-- é‚®ä»¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                <!-- back æŒ‰é’®åªåœ¨æŸ¥çœ‹å…·ä½“é‚®ä»¶å†…å®¹æ—¶åŠ¨æ€åˆ›å»º -->
            </div>
        </div>
    </div>
    
    <!-- ç”¨æˆ·è¾“å…¥æ¨¡æ€çª—å£ -->
    <div class="modal" id="userInputModal">
        <div class="user-input-container">
            <div class="user-input-header">
                <div class="user-input-title">è«‹è¼¸å…¥ä½ çš„é¸æ“‡</div>
                <button class="close-user-input">&times;</button>
            </div>
            <div class="user-input-content">
                <textarea id="userInputTextarea" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„é¸æ“‡..."></textarea>
                <div class="user-input-buttons">
                    <button id="cancelUserInput" class="user-input-button">å–æ¶ˆ</button>
                    <button id="submitUserInput" class="user-input-button">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŒ‡ä»¤æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="commandInputModal">
        <div class="command-input-container">
            <div class="command-input-header">
                <div class="command-input-title">ç™¼é€æŒ‡ä»¤</div>
                <div class="command-type-selector">
                    <select id="commandTypeSelect">
                        <option value="è§’è‰²çŸ¯æ­£">è§’è‰²çŸ¯æ­£</option>
                        <option value="åŠ‡æƒ…çŸ¯æ­£">åŠ‡æƒ…çŸ¯æ­£</option>
                    </select>
                    <button id="addCommandType" class="add-command-type-button" title="æ·»åŠ æŒ‡ä»¤é¡å‹">+</button>
                </div>
                <button class="close-command-input">&times;</button>
            </div>
            <div class="command-input-content">
                <div class="command-preview" id="commandPreview">
                    <span class="command-prefix">è§’è‰²çŸ¯æ­£: </span>
                    <span class="command-preview-text">åœ¨æ­¤è¼¸å…¥æŒ‡ä»¤å…§å®¹...</span>
                </div>
                <textarea id="commandInputTextarea" placeholder="åœ¨æ­¤è¼¸å…¥æŒ‡ä»¤å…§å®¹..."></textarea>
                <div class="command-input-buttons">
                    <button id="cancelCommandInput" class="command-input-button">å–æ¶ˆ</button>
                    <button id="submitCommandInput" class="command-input-button">ç™¼é€æŒ‡ä»¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æŒ‡ä»¤ç±»å‹æ¨¡æ€çª—å£ -->
    <div class="modal" id="addCommandTypeModal">
        <div class="add-command-type-container">
            <div class="add-command-type-header">
                <div class="add-command-type-title">æ·»åŠ æŒ‡ä»¤é¡å‹</div>
                <button class="close-add-command-type">&times;</button>
            </div>
            <div class="add-command-type-content">
                <input type="text" id="newCommandTypeInput" placeholder="è¼¸å…¥æ–°çš„æŒ‡ä»¤é¡å‹åç¨±..." maxlength="20">
                <div class="add-command-type-buttons">
                    <button id="cancelAddCommandType" class="add-command-type-button">å–æ¶ˆ</button>
                    <button id="confirmAddCommandType" class="add-command-type-button">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šæ¨¡æ…‹çª—å£ï¼ˆæ‰‹æœºç‰ˆç®€åŒ–ï¼‰ -->
    <div class="modal" id="settingsModal">
        <div class="settings-container">
            <div class="settings-header">
                <div class="settings-title">è¨­å®š</div>
                <button class="close-settings">&times;</button>
            </div>
            <div class="settings-content">
                <!-- åŸºç¡€è®¾ç½® -->
                <div class="setting-item">
                    <label for="typeSpeedSlider">æ‰“å­—é€Ÿåº¦</label>
                    <input type="range" id="typeSpeedSlider" min="10" max="100" value="30" step="5">
                    <span id="typeSpeedValue">30</span>ms
                </div>
                
                <div class="setting-item">
                    <label for="bgmVolumeSlider">BGMéŸ³é‡</label>
                    <input type="range" id="bgmVolumeSlider" min="0" max="100" value="70" step="5">
                    <span id="bgmVolumeValue">70</span>%
                </div>

                <!-- BGMæ§åˆ¶ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸµ BGMæ§åˆ¶</h4>
                    <div class="mobile-setting-item">
                        <button id="resetBgmButton" class="mobile-simple-button">é‡ç½®BGM</button>
                        <div class="mobile-setting-description">è‹¥BGMæ’­æ”¾ç•°å¸¸(å¦‚é‡ç–Š)ï¼Œå¯å˜—è©¦æ­¤åŠŸèƒ½ã€‚</div>
                    </div>
                </div>

                <!-- æ‰‹æœºç‰ˆèƒŒæ™¯ç³»ç»Ÿè¯´æ˜ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸï¸ èƒŒæ™¯åœ–ç‰‡ç³»çµ± (æ‰‹æ©Ÿç‰ˆ)</h4>
                    
                    <div class="mobile-setting-item">
                        <div class="mobile-setting-label">åœ–ç‰‡ä¾†æº</div>
                        <div class="mobile-setting-description">
                            æ‰‹æ©Ÿç‰ˆä½¿ç”¨å›ºå®šURLæ¨¡å¼ç²å–èƒŒæ™¯åœ–ç‰‡ï¼š<br>
                            <code>https://nancywang3641.github.io/sound-files/location_img/{è¨­æ–½åç¨±}.jpeg</code><br>
                            è‹¥åœ–ç‰‡ä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­èƒŒæ™¯ã€‚
                        </div>
                    </div>
                    
                    <div class="mobile-setting-item">
                        <button id="showCurrentBackground" class="mobile-simple-button">é¡¯ç¤ºç•¶å‰èƒŒæ™¯</button>
                        <div class="mobile-setting-description">é¡¯ç¤ºç•¶å‰ä½¿ç”¨çš„èƒŒæ™¯åœ–ç‰‡URL</div>
                    </div>
                    
                    <div class="mobile-setting-item">
                        <button id="testDefaultBackground" class="mobile-simple-button secondary">æ¸¬è©¦é è¨­èƒŒæ™¯</button>
                        <div class="mobile-setting-description">è¼‰å…¥ä¸¦æ¸¬è©¦é è¨­èƒŒæ™¯åœ–ç‰‡</div>
                    </div>
                </div>

                <!-- è°ƒè¯•åŠŸèƒ½ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸ› ï¸ èª¿è©¦åŠŸèƒ½</h4>
                    
                    <div class="mobile-setting-item">
                        <button id="testTransition" class="mobile-simple-button">æ¸¬è©¦Transitionéå ´</button>
                        <div class="mobile-setting-description">æ¸¬è©¦éå ´å‹•ç•«æ•ˆæœ</div>
                    </div>
                    
                    <div class="mobile-setting-item">
                        <button id="showDebugInfo" class="mobile-simple-button secondary">é¡¯ç¤ºèª¿è©¦ä¿¡æ¯</button>
                        <div class="mobile-setting-description">åœ¨æ§åˆ¶å°é¡¯ç¤ºç•¶å‰ç‹€æ…‹ä¿¡æ¯</div>
                    </div>
                </div>
                
                <!-- å¿«æ·é”®è¯´æ˜ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">âŒ¨ï¸ å¿«æ·éµèªªæ˜</h4>
                    <div class="mobile-setting-description" style="line-height: 1.8;">
                        <strong>é»æ“Šå°è©±æ¡†ï¼š</strong>æ¨é€²å°è©±<br>
                        <strong>C éµï¼š</strong>å¼·åˆ¶é¡¯ç¤ºé¸é …ï¼ˆèª¿è©¦ç”¨ï¼‰<br>
                        <strong>D éµï¼š</strong>é¡¯ç¤ºèª¿è©¦ä¿¡æ¯ï¼ˆæ§åˆ¶å°ï¼‰<br>
                        <strong>R éµï¼š</strong>é‡ç½®è§’è‰²é—œä¿‚é¢æ¿ç‚ºæ‘ºç–Šç‹€æ…‹<br>
                        <strong>/ éµï¼š</strong>å¿«é€Ÿæ‰“é–‹æŒ‡ä»¤è¼¸å…¥<br>
                        <strong>B éµï¼š</strong>é¡¯ç¤ºBGMç‹€æ…‹<br>
                        <strong>L éµï¼š</strong>æ¸¬è©¦Loadingå‹•ç•«<br>
                        <strong>G éµï¼š</strong>æ¸¬è©¦èƒŒæ™¯åœ–ç‰‡åŠŸèƒ½<br>
                        <strong>ESC éµï¼š</strong>é—œé–‰æ¨¡æ…‹çª—å£
                    </div>
                </div>

                <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
                <div class="mobile-settings-section">
                    <h4 class="mobile-settings-title">ğŸ“± ç‰ˆæœ¬ä¿¡æ¯</h4>
                    <div class="mobile-setting-description">
                        <strong>VNé¢æ¿ï¼š</strong>v21.1-mobile<br>
                        <strong>ç‰¹æ€§ï¼š</strong>æ‰‹æ©Ÿç‰ˆç°¡åŒ–ï¼Œç„¡åœ–ç‰‡ç”Ÿæˆ<br>
                        <strong>èƒŒæ™¯ï¼š</strong>å›ºå®šURLæ¨¡å¼<br>
                        <strong>éŸ³é »ï¼š</strong>GitHub CDNè³‡æº
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ­·å²å°è©±æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="historyModal">
        <div class="history-container">
            <div class="history-header">
                <div class="history-title">æ­·å²å°è©±</div>
                <button class="close-history">&times;</button>
            </div>
            <div class="history-content">
            </div>
        </div>
    </div>
    
    <!-- åŠ‡æƒ…è¨­ç½®æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="storySettingsModal">
        <div class="story-settings-container">
            <div class="story-settings-header">
                <div class="story-settings-title">âš™ï¸ åŠ‡æƒ…è¨­ç½®</div>
                <button class="close-story-settings">&times;</button>
            </div>
            <div class="story-settings-content">
                <!-- åŠ‡æƒ…åˆ—è¡¨ -->
                <div class="story-list-section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ“š åŠ‡æƒ…åˆ—è¡¨</h3>
                        <button class="add-story-btn" id="addStoryBtn" title="æ·»åŠ æ–°åŠ‡æƒ…">
                            <span>+</span>
                        </button>
                    </div>
                    <div class="story-list" id="storyList">
                        <!-- åŠ‡æƒ…é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="empty-story-list" id="emptyStoryList" style="display: none;">
                        <div class="empty-icon">ğŸ“–</div>
                        <div class="empty-text">é‚„æ²’æœ‰å‰µå»ºä»»ä½•åŠ‡æƒ…</div>
                        <div class="empty-subtitle">é»æ“Š + è™Ÿé–‹å§‹å‰µå»ºæ‚¨çš„ç¬¬ä¸€å€‹åŠ‡æƒ…</div>
                    </div>
                </div>
            </div>
            <div class="story-settings-footer">
                <button class="settings-btn cancel" id="cancelStorySettings">å–æ¶ˆ</button>
                <button class="settings-btn confirm" id="confirmStorySettings">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- ç´ æè¨­ç½®æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="materialSettingsModal">
        <div class="story-settings-container">
            <div class="story-settings-header">
                <div class="story-settings-title">
                    ğŸ¨ ç´ æè¨­ç½®
                    <span id="current-mode-badge" class="mode-badge">
                        ğŸŒ URLæ¨¡å¼
                    </span>
                </div>
                <button class="close-story-settings" id="closeMaterialSettings">&times;</button>
            </div>
            <div class="story-settings-content">
                <!-- å…¨å±€åˆ‡æ›æ¨™ç±¤ -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸŒ å…¨å±€åˆ‡æ›</h3>
                    <div class="form-group">
                        <label>é¸æ“‡æ‰€æœ‰ç´ æé¡åˆ¥çš„ä¾†æºæ¨¡å¼</label>
                        <div class="source-mode-selector">
                            <button type="button" class="source-mode-btn active" data-mode="url" id="urlModeBtn">
                                <span class="mode-icon">ğŸŒ</span>
                                <span class="mode-text">URLè³‡æ–™å¤¾</span>
                            </button>
                            <button type="button" class="source-mode-btn" data-mode="upload" id="uploadModeBtn">
                                <span class="mode-icon">ğŸ“</span>
                                <span class="mode-text">ä¸Šå‚³åœ–ç‰‡</span>
                            </button>
                            <button type="button" class="source-mode-btn" data-mode="url-single" id="urlSingleModeBtn">
                                <span class="mode-icon">ğŸ”—</span>
                                <span class="mode-text">URLå–®å¼µ</span>
                            </button>
                        </div>
                        <div class="form-help">é¸æ“‡æ‰€æœ‰ç´ æé¡åˆ¥ï¼ˆç«‹ç¹ªã€è²¼åœ–ã€é ­åƒç­‰ï¼‰çš„ä¾†æºæ¨¡å¼ã€‚URLæ¨¡å¼å¾ç¶²çµ¡ç²å–ï¼Œä¸Šå‚³æ¨¡å¼ä½¿ç”¨æœ¬åœ°å­˜å„²çš„åœ–ç‰‡ã€‚</div>
                    </div>
                </div>
                <!-- é è¨­è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ­ é è¨­è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="portrait-base-url">é è¨­åŸºç¤URL</label>
                        <input type="url" id="portrait-base-url" placeholder="https://nancywang3641.github.io/sound-files/char_presets/" value="https://nancywang3641.github.io/sound-files/char_presets/">
                        <div class="form-help">è§’è‰²é è¨­åœ–ç‰‡å°‡è‡ªå‹•å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{è§’è‰²å}_presets.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="portrait-format">é è¨­æ ¼å¼</label>
                        <input type="text" id="portrait-format" placeholder="_presets.png" value="_presets.png">
                        <div class="form-help">è¼¸å…¥é è¨­æ–‡ä»¶çš„å‘½åæ ¼å¼ï¼Œä¾‹å¦‚ï¼š_presets.pngã€_portrait.pngã€_char.png ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³é è¨­åœ–ç‰‡</label>
                        <div class="upload-area" id="portrait-upload-area">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">ä¸Šå‚³é è¨­åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="portrait-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="portrait-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="portrait-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µé è¨­åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="portrait-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="portrait-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="portrait-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>é è¨­æ¸¬è©¦</label>
                        <div class="portrait-test-container">
                            <input type="text" id="test-character-name" placeholder="è¼¸å…¥è§’è‰²åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-portrait-btn" class="test-portrait-btn">æ¸¬è©¦é è¨­</button>
                            <div id="portrait-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- BGMè¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸµ BGMè¨­ç½®</h3>
                    
                    <div class="form-group">
                        <label for="bgm-base-url">BGMåŸºç¤URL</label>
                        <input type="url" id="bgm-base-url" placeholder="https://nancywang3641.github.io/sound-files/bgm/" value="https://nancywang3641.github.io/sound-files/bgm/">
                        <div class="form-help">BGMéŸ³æ¨‚å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{bgmåç¨±}.mp3</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="bgm-format">BGMæ ¼å¼</label>
                        <input type="text" id="bgm-format" placeholder=".mp3" value=".mp3">
                        <div class="form-help">BGMæ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.mp3ã€.wavã€.ogg ç­‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label>BGMæ¸¬è©¦</label>
                        <div class="bgm-test-container">
                            <input type="text" id="test-bgm-name" placeholder="è¼¸å…¥BGMåç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-bgm-btn" class="test-portrait-btn">æ¸¬è©¦BGM</button>
                            <div id="bgm-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- éŸ³æ•ˆè¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ”Š éŸ³æ•ˆè¨­ç½®</h3>
                    
                    <div class="form-group">
                        <label for="sound-effect-base-url">éŸ³æ•ˆåŸºç¤URL</label>
                        <input type="url" id="sound-effect-base-url" placeholder="https://nancywang3641.github.io/sound-files/sound_effect/" value="https://nancywang3641.github.io/sound-files/sound_effect/">
                        <div class="form-help">éŸ³æ•ˆå°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{éŸ³æ•ˆåç¨±}.mp3</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="sound-effect-format">éŸ³æ•ˆæ ¼å¼</label>
                        <input type="text" id="sound-effect-format" placeholder=".mp3" value=".mp3">
                        <div class="form-help">éŸ³æ•ˆæ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.mp3ã€.wavã€.ogg ç­‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label>éŸ³æ•ˆæ¸¬è©¦</label>
                        <div class="sound-effect-test-container">
                            <input type="text" id="test-sound-effect-name" placeholder="è¼¸å…¥éŸ³æ•ˆåç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-sound-effect-btn" class="test-portrait-btn">æ¸¬è©¦éŸ³æ•ˆ</button>
                            <div id="sound-effect-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- è§’è‰²åœ–ç‰‡è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ‘¤ è§’è‰²åœ–ç‰‡è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="character-img-base-url">è§’è‰²åœ–ç‰‡åŸºç¤URL</label>
                        <input type="url" id="character-img-base-url" placeholder="https://nancywang3641.github.io/sound-files/char_img/" value="https://nancywang3641.github.io/sound-files/char_img/">
                        <div class="form-help">è§’è‰²åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{è§’è‰²å}_{è¡¨æƒ…}.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="character-img-format">è§’è‰²åœ–ç‰‡æ ¼å¼</label>
                        <input type="text" id="character-img-format" placeholder=".png" value=".png">
                        <div class="form-help">è§’è‰²åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.pngã€.jpgã€.jpeg ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³è§’è‰²åœ–ç‰‡</label>
                        <div class="upload-area" id="character-img-upload-area">
                            <div class="upload-icon">ğŸ‘¤</div>
                            <div class="upload-text">ä¸Šå‚³è§’è‰²åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="character-img-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="character-img-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="character-img-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µè§’è‰²åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="character-img-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="character-img-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="character-img-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>è§’è‰²åœ–ç‰‡æ¸¬è©¦</label>
                        <div class="character-img-test-container">
                            <input type="text" id="test-character-img-name" placeholder="è¼¸å…¥è§’è‰²åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <input type="text" id="test-character-img-emotion" placeholder="è¼¸å…¥è¡¨æƒ…åç¨±(å¦‚: happy, sad)" style="margin-bottom: 10px;">
                            <button type="button" id="test-character-img-btn" class="test-portrait-btn">æ¸¬è©¦è§’è‰²åœ–ç‰‡</button>
                            <div id="character-img-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- èƒŒæ™¯åœ–ç‰‡è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ–¼ï¸ èƒŒæ™¯åœ–ç‰‡è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="background-base-url">èƒŒæ™¯åœ–ç‰‡åŸºç¤URL</label>
                        <input type="url" id="background-base-url" placeholder="http://127.0.0.1:8000/location_img/" value="http://127.0.0.1:8000/location_img/">
                        <div class="form-help">èƒŒæ™¯åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{åœ°é»å}.jpeg</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="background-fallback-url">èƒŒæ™¯åœ–ç‰‡é è¨­URL</label>
                        <input type="url" id="background-fallback-url" placeholder="https://nancywang3641.github.io/sound-files/location_img/default.jpeg" value="https://nancywang3641.github.io/sound-files/location_img/default.jpeg">
                        <div class="form-help">ç•¶æ‰¾ä¸åˆ°æŒ‡å®šèƒŒæ™¯åœ–ç‰‡æ™‚ä½¿ç”¨çš„é è¨­åœ–ç‰‡</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="background-format">èƒŒæ™¯åœ–ç‰‡æ ¼å¼</label>
                        <input type="text" id="background-format" placeholder=".jpeg" value=".jpeg">
                        <div class="form-help">èƒŒæ™¯åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.jpegã€.jpgã€.png ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡</label>
                        <div class="upload-area" id="background-upload-area">
                            <div class="upload-icon">ğŸ–¼ï¸</div>
                            <div class="upload-text">ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="background-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="background-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="background-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µèƒŒæ™¯åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="background-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="background-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="background-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>èƒŒæ™¯åœ–ç‰‡æ¸¬è©¦</label>
                        <div class="background-test-container">
                            <input type="text" id="test-background-name" placeholder="è¼¸å…¥åœ°é»åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-background-btn" class="test-portrait-btn">æ¸¬è©¦èƒŒæ™¯åœ–ç‰‡</button>
                            <div id="background-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Area GIFè¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ¬ Area GIFè¨­ç½®</h3>
                    
                    <div class="form-group">
                        <label for="area-gif-base-url">Area GIFåŸºç¤URL</label>
                        <input type="url" id="area-gif-base-url" placeholder="https://nancywang3641.github.io/sound-files/Area_img/" value="https://nancywang3641.github.io/sound-files/Area_img/">
                        <div class="form-help">Areaéå ´å‹•ç•«å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{å€åŸŸå}.gif</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="area-gif-format">Area GIFæ ¼å¼</label>
                        <input type="text" id="area-gif-format" placeholder=".gif" value=".gif">
                        <div class="form-help">Areaéå ´å‹•ç•«æ–‡ä»¶çš„æ ¼å¼ï¼Œé€šå¸¸ç‚ºï¼š.gif</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>Area GIFæ¸¬è©¦</label>
                        <div class="area-gif-test-container">
                            <input type="text" id="test-area-gif-name" placeholder="è¼¸å…¥å€åŸŸåç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-area-gif-btn" class="test-portrait-btn">æ¸¬è©¦Area GIF</button>
                            <div id="area-gif-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- è²¼åœ–è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ˜Š è²¼åœ–è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="sticker-base-url">è²¼åœ–åŸºç¤URL</label>
                        <input type="url" id="sticker-base-url" placeholder="https://nancywang3641.github.io/sound-files/sticker/" value="https://nancywang3641.github.io/sound-files/sticker/">
                        <div class="form-help">è²¼åœ–å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{è²¼åœ–å}.jpg</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="sticker-default-url">è²¼åœ–é è¨­URL</label>
                        <input type="url" id="sticker-default-url" placeholder="https://nancywang3641.github.io/sound-files/sticker/default.jpg" value="https://nancywang3641.github.io/sound-files/sticker/default.jpg">
                        <div class="form-help">ç•¶æ‰¾ä¸åˆ°æŒ‡å®šè²¼åœ–æ™‚ä½¿ç”¨çš„é è¨­è²¼åœ–</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="sticker-format">è²¼åœ–æ ¼å¼</label>
                        <input type="text" id="sticker-format" placeholder=".jpg" value=".jpg">
                        <div class="form-help">è²¼åœ–æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.jpgã€.pngã€.gif ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³è²¼åœ–</label>
                        <div class="upload-area" id="sticker-upload-area">
                            <div class="upload-icon">ğŸ˜Š</div>
                            <div class="upload-text">ä¸Šå‚³è²¼åœ–</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="sticker-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="sticker-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="sticker-image-list">
                            <!-- ä¸Šå‚³çš„è²¼åœ–å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µè²¼åœ–</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="sticker-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="sticker-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="sticker-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>è²¼åœ–æ¸¬è©¦</label>
                        <div class="sticker-test-container">
                            <input type="text" id="test-sticker-name" placeholder="è¼¸å…¥è²¼åœ–åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-sticker-btn" class="test-portrait-btn">æ¸¬è©¦è²¼åœ–</button>
                            <div id="sticker-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ç‰©å“åœ–ç‰‡è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ ç‰©å“åœ–ç‰‡è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="item-img-base-url">ç‰©å“åœ–ç‰‡åŸºç¤URL</label>
                        <input type="url" id="item-img-base-url" placeholder="https://nancywang3641.github.io/sound-files/item_img/" value="https://nancywang3641.github.io/sound-files/item_img/">
                        <div class="form-help">ç‰©å“åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{ç‰©å“åç¨±}.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="item-img-format">ç‰©å“åœ–ç‰‡æ ¼å¼</label>
                        <input type="text" id="item-img-format" placeholder=".png" value=".png">
                        <div class="form-help">ç‰©å“åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.pngã€.jpgã€.jpeg ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³ç‰©å“åœ–ç‰‡</label>
                        <div class="upload-area" id="item-img-upload-area">
                            <div class="upload-icon">ğŸ</div>
                            <div class="upload-text">ä¸Šå‚³ç‰©å“åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="item-img-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="item-img-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="item-img-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µç‰©å“åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="item-img-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="item-img-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="item-img-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>ç‰©å“åœ–ç‰‡æ¸¬è©¦</label>
                        <div class="item-img-test-container">
                            <input type="text" id="test-item-img-name" placeholder="è¼¸å…¥ç‰©å“åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <div style="font-size: 11px; color: var(--text-color-muted); margin-bottom: 10px;">
                                å°‡ç”Ÿæˆ: {ç‰©å“åç¨±}.png æ ¼å¼çš„URL
                            </div>
                            <button type="button" id="test-item-img-btn" class="test-portrait-btn">æ¸¬è©¦ç‰©å“åœ–ç‰‡</button>
                            <div id="item-img-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ç‰©å“é¡å‹è¨­ç½® -->
                <div class="settings-section">
                    <h3 class="section-title">ğŸ“¦ ç‰©å“é¡å‹è¨­ç½®</h3>
                    
                    <!-- URLæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-mode-settings">
                        <label for="item-type-base-url">ç‰©å“é¡å‹åŸºç¤URL</label>
                        <input type="url" id="item-type-base-url" placeholder="https://nancywang3641.github.io/sound-files/item_type/" value="https://nancywang3641.github.io/sound-files/item_type/">
                        <div class="form-help">ç‰©å“é¡å‹åœ–ç‰‡å°‡å¾æ­¤URLç²å–ï¼Œæ ¼å¼ï¼š{URL}/{é¡å‹}.png</div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label for="item-type-format">ç‰©å“é¡å‹æ ¼å¼</label>
                        <input type="text" id="item-type-format" placeholder=".png" value=".png">
                        <div class="form-help">ç‰©å“é¡å‹åœ–ç‰‡æ–‡ä»¶çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š.pngã€.jpgã€.jpeg ç­‰</div>
                    </div>
                    
                    <!-- ä¸Šå‚³æ¨¡å¼è¨­ç½® -->
                    <div class="form-group upload-mode-settings" style="display: none;">
                        <label>ä¸Šå‚³ç‰©å“é¡å‹åœ–ç‰‡</label>
                        <div class="upload-area" id="item-type-upload-area">
                            <div class="upload-icon">ğŸ“¦</div>
                            <div class="upload-text">ä¸Šå‚³ç‰©å“é¡å‹åœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF</div>
                            <button type="button" class="upload-btn" id="item-type-upload-btn">é¸æ“‡åœ–ç‰‡æ–‡ä»¶</button>
                            <input type="file" id="item-type-file-input" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="image-list" id="item-type-image-list">
                            <!-- ä¸Šå‚³çš„åœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- URLå–®å¼µæ¨¡å¼è¨­ç½® -->
                    <div class="form-group url-single-mode-settings" style="display: none;">
                        <label>URLå–®å¼µç‰©å“é¡å‹åœ–ç‰‡</label>
                        
                        <!-- URLè¼¸å…¥å€åŸŸ -->
                        <div class="url-input-section">
                            <div class="url-input-container">
                                <input type="url" id="item-type-url-input" placeholder="è¼¸å…¥åœ–ç‰‡URL (å¦‚: https://catbox.moe/xxx.png)" class="url-input">
                                <button type="button" id="item-type-url-add-btn" class="url-add-btn">æ·»åŠ URLåœ–ç‰‡</button>
                            </div>
                            <div class="form-help">æ”¯æŒcatboxã€imgurç­‰åœ–ç‰‡è¨—ç®¡æœå‹™çš„URL</div>
                        </div>
                        
                        <div class="image-list" id="item-type-url-image-list">
                            <!-- URLåœ–ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group url-mode-settings">
                        <label>ç‰©å“é¡å‹æ¸¬è©¦</label>
                        <div class="item-type-test-container">
                            <input type="text" id="test-item-type-name" placeholder="è¼¸å…¥ç‰©å“é¡å‹åç¨±é€²è¡Œæ¸¬è©¦" style="margin-bottom: 10px;">
                            <button type="button" id="test-item-type-btn" class="test-portrait-btn">æ¸¬è©¦ç‰©å“é¡å‹</button>
                            <div id="item-type-test-result" class="portrait-test-result"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="story-settings-footer">
                <button class="settings-btn cancel" id="cancelMaterialSettings">å–æ¶ˆ</button>
                <button class="settings-btn confirm" id="saveMaterialSettings">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åŠ‡æƒ…ç·¨è¼¯æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="storyEditModal">
        <div class="story-edit-container">
            <div class="story-edit-header">
                <div class="story-edit-title" id="storyEditTitle">ğŸ“ ç·¨è¼¯åŠ‡æƒ…</div>
                <button class="close-story-edit">&times;</button>
            </div>
            <div class="story-edit-content">
                <form id="storyEditForm">
                    <!-- åŠ‡æƒ…å…§å®¹ -->
                    <div class="form-section">
                        <h3 class="form-section-title">åŠ‡æƒ…å…§å®¹</h3>
                        
                        <div class="form-group">
                            <label for="storyTitle">åŠ‡æƒ…æ¨™é¡Œ</label>
                            <input type="text" id="storyTitle" placeholder="è«‹è¼¸å…¥åŠ‡æƒ…æ¨™é¡Œï¼Œå°‡ä½œç‚ºè³‡æ–™å¤¾åç¨±..." required>
                            <div class="form-help">åŠ‡æƒ…æ¨™é¡Œå°‡ä½œç‚ºæ­·å²åŠ‡æƒ…ä¸­çš„è³‡æ–™å¤¾åç¨±ï¼Œæ–¹ä¾¿åˆ†é¡ç®¡ç†</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="storyContent">å…§å®¹</label>
                            <textarea id="storyContent" placeholder="è©³ç´°æè¿°åŠ‡æƒ…å…§å®¹ã€å ´æ™¯ã€æƒ…ç¯€ç™¼å±•..." rows="6" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="storyOpening">èµ·æ‰‹</label>
                            <textarea id="storyOpening" placeholder="åŠ‡æƒ…é–‹å§‹çš„é–‹å ´ç™½æˆ–å¼•å°èª..." rows="4"></textarea>
                        </div>
                    </div>
                    
                    <!-- è§’è‰²è¨­ç½® -->
                    <div class="form-section">
                        <h3 class="form-section-title">è§’è‰²è¨­ç½®</h3>
                        
                        <div class="form-group">
                            <label for="worldBooks">ä¸–ç•Œæ›¸</label>
                            <div class="worldbook-select-container" id="worldBooksContainer">
                                <!-- ä¸–ç•Œæ›¸é¸é …å°‡å¾ä¸–ç•Œæ›¸åº«å‹•æ…‹è¼‰å…¥ -->
                            </div>
                            <div class="form-help">é¸æ“‡éœ€è¦åŒ…å«çš„ä¸–ç•Œæ›¸è¨­å®šï¼Œå°‡èˆ‡è§’è‰²è¨­å®šä¸€èµ·ç™¼é€çµ¦AIã€‚é»æ“Šä¸–ç•Œæ›¸å¯é¸æ“‡/å–æ¶ˆé¸æ“‡</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="mainCharacter">ä¸»è§’</label>
                            <select id="mainCharacter" required>
                                <option value="">è«‹é¸æ“‡ä¸»è§’...</option>
                                <!-- è§’è‰²é¸é …å°‡å¾äººè¨­åº«å‹•æ…‹è¼‰å…¥ -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="supportingCharacters">é…è§’ç¾¤</label>
                            <div class="character-select-container" id="supportingCharactersContainer">
                                <!-- è§’è‰²é¸é …å°‡å¾äººè¨­åº«å‹•æ…‹è¼‰å…¥ -->
                            </div>
                            <div class="form-help">é»æ“Šè§’è‰²å¯é¸æ“‡/å–æ¶ˆé¸æ“‡</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="story-edit-footer">
                <button class="story-edit-btn cancel" id="cancelStoryEdit">å–æ¶ˆ</button>
                <button class="story-edit-btn save" id="saveStoryEdit">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- EventonåŠ‡æƒ…æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="vnHistoryChoiceModal">
        <div class="vn-history-choice-container">
            <div class="vn-history-choice-header">
                <div class="vn-history-choice-title">é¸æ“‡è¦æŸ¥çœ‹çš„åŠ‡æƒ…</div>
                <button class="close-vn-history-choice">&times;</button>
            </div>
            <div class="vn-history-choice-content">
            </div>
        </div>
    </div>
    
    <!-- CalltypeåŠ‡æƒ…æ¨¡æ…‹çª—å£ -->
    <div class="vn-modal" id="callDialog">
        <div class="call-dialog-container">
            <div class="call-single-background"></div>

            <div id="incoming-call-interface" class="incoming-call-interface" style="display: none;">
                <div class="incoming-call-header">
                    <div class="incoming-call-status">æ¥ç”µ</div>
                </div>
                
                <div class="incoming-call-content">
                    <div class="incoming-caller-info">
                        <div class="incoming-caller-avatar-container">
                            <img src="" alt="Caller" class="incoming-caller-avatar">
                        </div>
                        <div class="incoming-caller-name">æœªçŸ¥æ¥ç”µ</div>
                        <div class="incoming-call-subtitle">æ­£åœ¨å‘¼å«...</div>
                    </div>
                </div>
                
                <div class="incoming-call-actions">
                    <button id="decline-call-button" class="call-action-btn decline-btn">
                        <svg class="call-action-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12,9C10.89,9 10,8.1 10,7C10,5.89 10.89,5 12,5C13.11,5 14,5.89 14,7C14,8.1 13.11,9 12,9M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2Z"/>
                        </svg>
                        <span>æ‹’ç»</span>
                    </button>
                    
                    <button id="answer-call-button" class="call-action-btn answer-btn">
                        <svg class="call-action-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/>
                        </svg>
                        <span>æ¥å¬</span>
                    </button>
                </div>
            </div>

            <div id="call-content-interface" class="call-content-interface" style="display: none;">
                <div class="call-dialog-header">
                    <span class="call-time-indicator">00:00</span>
                </div>

                <div class="call-dialog-content">
                    <div class="call-phone-style-character">
                        <div class="other-character-image-container">
                            <img src="" alt="Other Character" class="other-character-image">
                        </div>
                        <div class="other-character-name">è§’è‰²å</div>
                    </div>

                    <div class="call-messages">
                    </div>
                </div>

                <div class="call-dialog-footer">
                    <button class="call-action-button">
                        <svg class="call-action-button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" /></svg>
                    </button>
                     <button class="call-action-button">
                        <svg class="call-action-button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4C7,4 2.73,7.11 1,11.5C2.73,15.89 7,19 12,19S21.27,15.89 23,11.5C21.27,7.11 17,4 12,4M12,16.5A4.5,4.5 0 0,1 7.5,12A4.5,4.5 0 0,1 12,7.5A4.5,4.5 0 0,1 16.5,12A4.5,4.5 0 0,1 12,16.5M12,9.5A2.5,2.5 0 0,0 9.5,12A2.5,2.5 0 0,0 12,14.5A2.5,2.5 0 0,0 14.5,12A2.5,2.5 0 0,0 12,9.5Z" /></svg>
                    </button>
                    <button id="end-call-dialog">
                        <svg class="call-action-button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M13.07,12.38L14.5,13.81C15.03,13.56 15.5,13.21 16,12.78L17.42,14.2C16.63,15 15.72,15.65 14.75,16.08L15.9,17.23C16.89,16.63 17.78,15.89 18.54,15.08L20,16.54C18.25,18.29 16.04,19.5 13.5,19.5C11.53,19.5 9.68,18.91 8.1,17.9L9.25,16.75C10.5,17.5 11.95,18 13.5,18C15.05,18 16.45,17.45 17.58,16.58L16.16,15.16C15.45,15.58 14.63,15.89 13.76,16.05L12.38,13.07M12,3C16.97,3 21,7.03 21,12C21,14.08 20.3,16 19.13,17.5L17.7,16.07C18.4,14.9 18.81,13.5 18.81,12C18.81,8.19 15.81,5.19 12,5.19C10.5,5.19 9.1,5.6 7.93,6.3L6.5,4.87C8.04,3.71 9.92,3 12,3M4.93,4.93L3.5,6.36L6.5,9.36C6.1,10.15 5.81,11.04 5.81,12C5.81,12.11 5.82,12.21 5.82,12.32L3.77,10.27C3.28,10.77 3,11.36 3,12A9,9 0 0,0 12,21C12.64,21 13.23,20.72 13.73,20.23L17.64,24.14L19.07,22.71L4.93,4.93Z" /></svg>
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Livestreamæ¨¡æ…‹çª—å£ -->
    <div class="vn-modal" id="livestreamDialog">
        <div class="livestream-dialog-container">
            <div class="livestream-dialog-header">
                <div class="livestream-info">
                    <span class="livestream-name" id="ls-stream-name">ç›´æ’­é–“åç¨±</span>
                    <span class="livestream-status"><span class="livestream-status-dot"></span><span id="ls-stream-status">ç›´æ’­ä¸­</span></span>
                </div>
                <div class="livestream-stats">
                    <span class="livestream-viewers" id="ls-viewers"><i class="fa fa-eye"></i> <span id="ls-viewers-count">0</span></span>
                    <span class="livestream-gifts" id="ls-gifts"><i class="fa fa-gift"></i> <span id="ls-gifts-count">0</span></span>
                </div>
                <button class="close-livestream-dialog">&times;</button>
            </div>
            <div class="livestream-dialog-content">
                <div class="livestream-background"></div>
                
                <div class="livestream-main">
                    <div class="livestream-character">
                        <img src="" alt="Streamer" class="streamer-image" id="streamer-image">
                        <div class="streamer-name" id="streamer-name">ä¸»æ’­å</div>
                    </div>
                    
                    <div class="livestream-dialog-box">
                        <div class="livestream-dialog-text" id="livestream-dialog-text"></div>
                    </div>
                </div>
                
                <div class="livestream-chat">
                    <div class="livestream-chat-header">
                        <span>ç›´æ’­èŠå¤©å®¤</span>
                    </div>
                    <div class="livestream-chat-messages" id="livestream-chat-messages">
                    </div>
                    <div class="livestream-gift-ranking">
                        <div class="gift-ranking-header">ç¦®ç‰©æ’è¡Œæ¦œ</div>
                        <div class="gift-ranking-list" id="gift-ranking-list">
                        </div>
                    </div>
                </div>
            </div>
            <div class="livestream-dialog-footer">
                <button class="livestream-end-button" id="end-livestream-dialog">é›¢é–‹ç›´æ’­é–“</button>
            </div>
        </div>
    </div>
    
    <!-- EchoåŠ‡æƒ…æ¨¡æ…‹çª—å£ -->
    <div class="vn-modal" id="echoModal">
        <div class="echo-dialog-container">
            <button class="close-echo-dialog" id="close-echo-dialog">&times;</button>

            <div class="echo-dialog-content">
                <iframe id="echo-iframe" class="echo-iframe" src="about:blank"></iframe>
            </div>
            
            <div class="echo-dialog-footer">
                <button class="echo-close-button" id="close-echo-button">é—œé–‰Echo</button>
            </div>
        </div>
    </div>

    <!-- Itemç‰©å“å±•ç¤ºæ¨¡æ…‹çª—å£ -->
<div class="vn-modal" id="itemModal">
    <div class="item-dialog-container">
        <button class="close-item-dialog" id="close-item-dialog">&times;</button>

        <div class="item-dialog-content">
            <div class="item-image-container">
                <img id="item-image" class="item-image" src="" alt="ç‰©å“åœ–ç‰‡">
            </div>
            
            <div class="item-info">
                <h3 id="item-name" class="item-name">ç‰©å“åç¨±</h3>
                <p id="item-description" class="item-description">ç‰©å“æè¿°</p>
            </div>
        </div>
        
        <div class="item-dialog-footer">
            <button class="item-close-button" id="close-item-button">ç¢ºèª</button>
        </div>
    </div>
</div>
    
    <!-- ChatåŠ‡æƒ…æ¨¡æ…‹çª—å£ - iPhoneé¢¨æ ¼ -->
    <div id="simple-chat-modal" class="simple-chat-modal">
        <div class="simple-chat-container">
            <div class="simple-chat-header">
                <button id="continue-chat-story" class="continue-chat-button">è·³éä¸¦ç¹¼çºŒ</button>
                <div id="simple-chat-modal-title">èŠå¤©çª—å£</div>
                <button id="close-simple-chat" class="close-simple-chat" title="è¿”å›">&times;</button>
            </div>
            <div id="simple-chat-messages" class="simple-chat-messages">
                <div class="simple-chat-loading">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="iphone-home-indicator"></div>
            <div class="dynamic-island-sensor"></div>
        </div>
    </div>

    <!-- åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£ -->
    <div class="modal" id="imageTagModal">
        <div class="image-tag-container">
            <div class="image-tag-header">
                <div class="image-tag-title">ğŸ“ åœ–ç‰‡æ¨™ç±¤è¨­ç½®</div>
                <button class="close-image-tag" id="closeImageTag">&times;</button>
            </div>
            
            <div class="image-tag-content">
                <div class="image-preview-section">
                    <div class="image-preview-container">
                        <img id="imageTagPreview" class="image-tag-preview" src="" alt="åœ–ç‰‡é è¦½">
                    </div>
                    <div class="image-info">
                        <div class="image-name" id="imageTagFileName">æœªé¸æ“‡åœ–ç‰‡</div>
                        <div class="image-size" id="imageTagFileSize">0 KB</div>
                    </div>
                </div>
                
                <div class="tag-input-section">
                    <div class="form-group" id="categoryDisplayGroup">
                        <label>ç´ æåˆ†é¡</label>
                        <div class="category-display" id="categoryDisplay">è§’è‰²ç«‹ç¹ªï¼ˆé è¨­ï¼‰</div>
                        <input type="hidden" id="imageTagCategory" value="portrait">
                    </div>
                    
                    <div class="form-group">
                        <label for="imageTagLabel">æ¨™ç±¤åç¨±</label>
                        <input type="text" id="imageTagLabel" class="tag-label-input" placeholder="ä¾‹å¦‚ï¼šå°ç±³ã€happyã€å­¸æ ¡ç­‰">
                        <div class="tag-help-text" id="tagHelpText">è¼¸å…¥è§’è‰²åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_presets.png</div>
                    </div>
                    
                    <div class="form-group" id="emotionTagGroup" style="display: none;">
                        <label for="imageTagEmotion">è¡¨æƒ…æ¨™ç±¤</label>
                        <input type="text" id="imageTagEmotion" class="tag-emotion-input" placeholder="ä¾‹å¦‚ï¼šhappyã€sadã€angryç­‰">
                        <div class="tag-help-text">è¼¸å…¥è¡¨æƒ…åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_è¡¨æƒ….png</div>
                    </div>
                </div>
                
                <div class="tag-preview-section">
                    <div class="tag-preview-title">é è¦½å‘½å</div>
                    <div class="tag-preview-result" id="tagPreviewResult">æœªè¨­ç½®æ¨™ç±¤</div>
                </div>
            </div>
            
            <div class="image-tag-footer">
                <button class="image-tag-btn cancel" id="cancelImageTag">å–æ¶ˆ</button>
                <button class="image-tag-btn confirm" id="confirmImageTag" disabled>ç¢ºèªä¸Šå‚³</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // å…¨å±€Markdownè™•ç†å‡½æ•¸
        window.processMarkdown = function(text) {
            if (!text) return '';
            
            if (typeof text !== 'string') {
                return String(text);
            }
            
            try {
                if (typeof marked === 'undefined') {
                    console.error('Markdownè™•ç†éŒ¯èª¤: markedåº«æœªåŠ è¼‰');
                    return text;
                }
                
                const html = marked.parse(text, {
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    mangle: false,
                    sanitize: false
                });
                
                return html.replace(/^<p>(.+)<\/p>$/s, '$1');
            } catch (e) {
                console.error('Markdownè™•ç†éŒ¯èª¤:', e);
                return text;
            }
        };

        // æ‰‹æœºç‰ˆèƒŒæ™¯ä¿¡æ¯æ˜¾ç¤º
        function showMobileBackgroundInfo(location, url) {
            const info = document.getElementById('mobileBackgroundInfo');
            if (info) {
                info.textContent = `èƒŒæ™¯: ${location} (${url})`;
                info.classList.add('show');
                setTimeout(() => {
                    info.classList.remove('show');
                }, 5000);
            }
        }

        // æ‰‹æœºç‰ˆè®¾ç½®æŒ‰é’®åŠŸèƒ½
        $(document).ready(function() {
            // æ˜¾ç¤ºå½“å‰èƒŒæ™¯
            $('#showCurrentBackground').click(function() {
                const vnData = window.VNCoreAPI?.vnData;
                const currentLocation = vnData?.sceneInfo?.location || 'æœªçŸ¥';
                const backgroundUrl = window.VNCoreAPI?.generateBackgroundUrl ? 
                    window.VNCoreAPI.generateBackgroundUrl(currentLocation) : 
                    'https://nancywang3641.github.io/sound-files/location_img/default.jpeg';
                
                showMobileBackgroundInfo(currentLocation, backgroundUrl);
                console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] ç•¶å‰èƒŒæ™¯:', { location: currentLocation, url: backgroundUrl });
            });

            // æµ‹è¯•é»˜è®¤èƒŒæ™¯
            $('#testDefaultBackground').click(function() {
                const defaultUrl = 'https://nancywang3641.github.io/sound-files/location_img/default.jpeg';
                if (window.VNCoreAPI?.applyBackgroundImage) {
                    window.VNCoreAPI.applyBackgroundImage(defaultUrl);
                    showMobileBackgroundInfo('é è¨­èƒŒæ™¯', defaultUrl);
                    console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] å·²è¼‰å…¥é è¨­èƒŒæ™¯');
                }
            });

            // æµ‹è¯•Transitionè¿‡åœº
            $('#testTransition').click(function() {
                if (window.VNFeatures?.showTransition) {
                    window.VNFeatures.showTransition('é€™æ˜¯æ‰‹æ©Ÿç‰ˆTransitionæ¸¬è©¦\néå ´æ•ˆæœæ­£å¸¸é‹ä½œ', () => {
                        console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ] Transitionæ¸¬è©¦å®Œæˆ');
                    });
                }
            });

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            $('#showDebugInfo').click(function() {
                const vnData = window.VNCoreAPI?.vnData;
                const backgroundState = window.VNCoreAPI?.backgroundImageState;
                
                console.log('[VNé¢æ¿-æ‰‹æœºç‰ˆ èª¿è©¦ä¿¡æ¯]', {
                    ç‰ˆæœ¬: '21.1-mobile',
                    ç•¶å‰å ´æ™¯: vnData?.sceneInfo?.location || 'æœªçŸ¥',
                    èƒŒæ™¯ç‹€æ…‹: backgroundState,
                    å°è©±ç´¢å¼•: window.VNCoreAPI?.currentDialogueIndex || 0,
                    ç¸½å°è©±æ•¸: vnData?.dialogues?.length || 0,
                    è§’è‰²æ•¸æ“š: vnData?.charData,
                    ç”¨æˆ¶æ•¸æ“š: vnData?.userData
                });
                
                alert('èª¿è©¦ä¿¡æ¯å·²è¼¸å‡ºåˆ°æ§åˆ¶å° (F12æŸ¥çœ‹)');
            });
        });
    </script>
    
    <!-- JCYé©é…å™¨ -->
    <script src="jcy-adapter.js"></script>              <!-- JCYç³»çµ±é©é…å™¨ -->
    
    <!-- ä¸»åŠŸèƒ½ -->
    <script src="vntype-core-base.js"></script>        <!-- å¿…é¡»ç¬¬ä¸€ä¸ª -->
    <script src="vntype-character-scene.js"></script>   <!-- è§’è‰²åœºæ™¯åŠŸèƒ½ -->
    <script src="vntype-ui-dialogue.js"></script>       <!-- å¯¹è¯UIåŠŸèƒ½ -->
    <script src="vntype-features-audio.js"></script>    <!-- éŸ³é¢‘åŠŸèƒ½ -->
    <script src="vntype-features-special.js"></script>  <!-- ç‰¹æ®ŠåŠŸèƒ½ -->

 <!-- ç«‹ç¹ªåŠŸèƒ½ -->
    <!-- TPYEåŠŸèƒ½ -->
    <script src="chattype-listeners.js"></script>
    <script src="calltype-listeners.js"></script>
    <script src="livestreamtype-listeners.js"></script>
    
    <!-- åŠ‡æƒ…è¨­ç½®åŠŸèƒ½ -->
    <script src="story_settings.js"></script>
    
    <!-- VNç«‹ç¹ªè™•ç†å™¨ -->
    <script src="vn_portrait_processor.js"></script>

    <script>
        // VNä¸»å¯åŠ¨ç•Œé¢æ§åˆ¶é€»è¾‘ - JCYç‰ˆ
        document.addEventListener('DOMContentLoaded', function() {
            const vnLandingContainer = document.getElementById('vnLandingContainer');
            const vnMainContainer = document.getElementById('vnMainContainer');
            const startStoryBtn = document.getElementById('startStoryBtn');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const storySettingsBtn = document.getElementById('storySettingsBtn');
            const backToLandingBtn = document.getElementById('backToLandingBtn');
            const vnLandingBackBtn = document.getElementById('vnLandingBackBtn');
            
            // åŠ‡æƒ…è¨­ç½®ç›¸é—œå…ƒç´ 
            const storySettingsModal = document.getElementById('storySettingsModal');
            const closeStorySettings = document.querySelector('.close-story-settings');
            const cancelStorySettings = document.getElementById('cancelStorySettings');
            const confirmStorySettings = document.getElementById('confirmStorySettings');
            
            // ç´ æè¨­ç½®ç›¸é—œå…ƒç´ 
            const materialSettingsBtn = document.getElementById('materialSettingsBtn');
            const materialSettingsModal = document.getElementById('materialSettingsModal');
            const closeMaterialSettings = document.getElementById('closeMaterialSettings');
            const cancelMaterialSettings = document.getElementById('cancelMaterialSettings');
            const saveMaterialSettings = document.getElementById('saveMaterialSettings');



            // åˆå§‹çŠ¶æ€ï¼šæ˜¾ç¤ºå¯åŠ¨ç•Œé¢
            if (vnLandingContainer) vnLandingContainer.classList.add('active');
            if (vnMainContainer) vnMainContainer.classList.remove('active');

            // "å¼€å§‹å‰§æƒ…"æŒ‰é’®
            if (startStoryBtn) {
                startStoryBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] ç‚¹å‡»å¼€å§‹å‰§æƒ…æŒ‰é’®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    try {
                        // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å‰§æƒ…
                        if (!window.StorySettings) {
                            alert('å‰§æƒ…è®¾ç½®ç³»ç»ŸæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
                            return;
                        }
                        
                        // è·å–é€‰ä¸­çš„å‰§æƒ…
                        const selectedStory = window.StorySettings.getSelectedStory?.();
                        
                        if (!selectedStory) {
                            alert('è¯·å…ˆåœ¨å‰§æƒ…è®¾ç½®ä¸­é€‰æ‹©ä¸€ä¸ªå‰§æƒ…ï¼');
                            return;
                        }
                        
                        // ç›´æ¥é–‹å§‹åŠ‡æƒ…
                        console.log('[VNé¢æ¿-JCYç‰ˆ] é–‹å§‹åŠ‡æƒ…:', selectedStory.title);
                        
                        // é¡¯ç¤ºloadingç•«é¢
                        if (window.VNFeatures?.showLoadingAnimation) {
                            window.VNFeatures.showLoadingAnimation();
                        }
                        
                        // åˆ‡æ›åˆ°VNä¸»ç•Œé¢
                        showVNMainContainer();
                        
                        // ç›´æ¥èª¿ç”¨é–‹å§‹åŠ‡æƒ…
                        window.StorySettings.startStory(selectedStory);
                    } catch (error) {
                        console.error('[VNé¢æ¿-JCYç‰ˆ] æ‰§è¡Œtriggerå‘½ä»¤æ—¶å‡ºé”™:', error);
                        alert('å¯åŠ¨å‰§æƒ…æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚');
                        
                        if (window.VNFeatures?.hideLoadingAnimation) {
                            window.VNFeatures.hideLoadingAnimation();
                        }
                    }
                });
            }

            // "æŸ¥çœ‹å†å²å‰§æƒ…"æŒ‰é’®
            if (showHistoryBtn) {
                showHistoryBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] ç‚¹å‡»æŸ¥çœ‹å†å²å‰§æƒ…æŒ‰é’®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // ä½¿ç”¨ postMessage è«‹æ±‚çˆ¶çª—å£é¡¯ç¤ºæ­·å²åŠ‡æƒ…æŸ¥çœ‹å™¨
                    try {
                        window.parent.postMessage({
                            type: 'VN_SHOW_HISTORY_VIEWER',
                            source: 'VN_PANEL',
                            timestamp: Date.now()
                        }, '*');
                        console.log('[VNé¢æ¿-JCYç‰ˆ] å·²ç™¼é€æ­·å²åŠ‡æƒ…æŸ¥çœ‹å™¨è«‹æ±‚');
                    } catch (error) {
                        console.error('[VNé¢æ¿-JCYç‰ˆ] ç™¼é€æ­·å²åŠ‡æƒ…æŸ¥çœ‹å™¨è«‹æ±‚æ™‚å‡ºéŒ¯:', error);
                        alert('æ­·å²åŠ‡æƒ…åŠŸèƒ½æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                });
            }

            // "åŠ‡æƒ…è¨­ç½®"æŒ‰é’®
            if (storySettingsBtn) {
                storySettingsBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] ç‚¹å‡»åŠ‡æƒ…è¨­ç½®æŒ‰é’®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // é¡¯ç¤ºåŠ‡æƒ…è¨­ç½®æ¨¡æ…‹çª—å£
                    if (storySettingsModal) {
                        storySettingsModal.classList.add('modal-active');
                        
                        // é‡æ–°è¼‰å…¥åŠ‡æƒ…å’Œè§’è‰²æ•¸æ“š
                        if (window.StorySettings) {
                            window.StorySettings.loadStories();
                            window.StorySettings.loadCharacters();
                        }
                    }
                });
            }

            // "ç´ æè¨­ç½®"æŒ‰é’®
            if (materialSettingsBtn) {
                materialSettingsBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] ç‚¹å‡»ç´ æè¨­ç½®æŒ‰é’®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // é¡¯ç¤ºç´ æè¨­ç½®æ¨¡æ…‹çª—å£
                    if (materialSettingsModal) {
                        materialSettingsModal.classList.add('modal-active');
                        
                        // è¼‰å…¥ç´ æè¨­ç½®
                        console.log('[VNé¢æ¿] å˜—è©¦è¼‰å…¥ç´ æè¨­ç½®');
                        
                        // ç«‹å³è¼‰å…¥è¨­ç½®ï¼Œç„¶å¾Œæ›´æ–°UI
                            loadMaterialSettings();
                        
                        // ç¢ºä¿UIæ­£ç¢ºæ›´æ–°
                        setTimeout(() => {
                            console.log('[VNé¢æ¿] æª¢æŸ¥è¨­ç½®è¼‰å…¥ç‹€æ…‹');
                            window.debugMaterialSettings();
                        }, 200);
                    }
                });
            }

            // åŠ‡æƒ…è¨­ç½®æ¨¡æ…‹çª—å£é—œé–‰äº‹ä»¶
            function closeStorySettingsModal() {
                console.log('[VNé¢æ¿-JCYç‰ˆ] é—œé–‰åŠ‡æƒ…è¨­ç½®çª—å£');
                
                if (window.VNFeatures?.playSound) {
                    window.VNFeatures.playSound('clickSound');
                }
                
                if (storySettingsModal) {
                    storySettingsModal.classList.remove('modal-active');
                }
            }

            // ç¶å®šé—œé–‰æŒ‰éˆ•äº‹ä»¶
            if (closeStorySettings) {
                closeStorySettings.addEventListener('click', closeStorySettingsModal);
            }

            if (cancelStorySettings) {
                cancelStorySettings.addEventListener('click', closeStorySettingsModal);
            }

            if (confirmStorySettings) {
                confirmStorySettings.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] ç¢ºèªåŠ‡æƒ…è¨­ç½®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // TODO: åœ¨é€™è£¡è™•ç†è¨­ç½®ä¿å­˜é‚è¼¯
                    // æš«æ™‚å…ˆé—œé–‰çª—å£
                    closeStorySettingsModal();
                });
            }

            // é»æ“Šæ¨¡æ…‹çª—å£èƒŒæ™¯é—œé–‰
            if (storySettingsModal) {
                storySettingsModal.addEventListener('click', function(e) {
                    if (e.target === storySettingsModal) {
                        closeStorySettingsModal();
                    }
                });
            }

            // ç´ æè¨­ç½®æ¨¡æ…‹çª—å£é—œé–‰äº‹ä»¶
            function closeMaterialSettingsModal() {
                console.log('[VNé¢æ¿-JCYç‰ˆ] é—œé–‰ç´ æè¨­ç½®çª—å£');
                
                if (window.VNFeatures?.playSound) {
                    window.VNFeatures.playSound('clickSound');
                }
                
                if (materialSettingsModal) {
                    materialSettingsModal.classList.remove('modal-active');
                }
            }

            // ç¶å®šç´ æè¨­ç½®é—œé–‰æŒ‰éˆ•äº‹ä»¶
            if (closeMaterialSettings) {
                closeMaterialSettings.addEventListener('click', closeMaterialSettingsModal);
            }

            if (cancelMaterialSettings) {
                cancelMaterialSettings.addEventListener('click', closeMaterialSettingsModal);
            }

            if (saveMaterialSettings) {
                saveMaterialSettings.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] ä¿å­˜ç´ æè¨­ç½®');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // ä¿å­˜ç´ æè¨­ç½®
                    if (window.VNMaterialProcessor?.saveSettings) {
                        window.VNMaterialProcessor.saveSettings();
                    }
                    closeMaterialSettingsModal();
                });
            }

            // é»æ“Šç´ æè¨­ç½®æ¨¡æ…‹çª—å£èƒŒæ™¯é—œé–‰
            if (materialSettingsModal) {
                materialSettingsModal.addEventListener('click', function(e) {
                    if (e.target === materialSettingsModal) {
                        closeMaterialSettingsModal();
                    }
                });
            }

            // VNå•Ÿå‹•ç•Œé¢è¿”å›æŒ‰éˆ•
            if (vnLandingBackBtn) {
                vnLandingBackBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] é»æ“Šå•Ÿå‹•ç•Œé¢è¿”å›æŒ‰éˆ•ï¼Œé—œé–‰VNé¢æ¿');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // ç™¼é€é—œé–‰æ¶ˆæ¯åˆ°JCYä¸»ç³»çµ±
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'VN_CLOSE'
                        }, '*');
                    }
                });
            }

            // "è¿”å›ä¸»é¡µ"æŒ‰é’® - å›åˆ°VNå•Ÿå‹•é é¢
            if (backToLandingBtn) {
                backToLandingBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] ç‚¹å‡»è¿”å›ä¸»é¡µæŒ‰é’®ï¼Œå›åˆ°å•Ÿå‹•é é¢');
                    
                    if (window.VNFeatures?.playSound) {
                        window.VNFeatures.playSound('clickSound');
                    }
                    
                    // ç›´æ¥åˆ‡æ›åˆ°å•Ÿå‹•é é¢
                    showVNLandingContainer();
                    
                    // å¯é¸ï¼šé€šçŸ¥çˆ¶çª—å£å·²å›åˆ°å•Ÿå‹•é é¢
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'VN_BACK_TO_LANDING'
                        }, '*');
                    }
                });
            }

            // æ˜¾ç¤ºVNä¸»å®¹å™¨
            function showVNMainContainer() {
                if (vnLandingContainer) vnLandingContainer.classList.remove('active');
                if (vnMainContainer) vnMainContainer.classList.add('active');
                console.log('[VNé¢æ¿-JCYç‰ˆ] å·²åˆ‡æ¢åˆ°VNä¸»ç•Œé¢');
            }

            // æ˜¾ç¤ºVNå¯åŠ¨å®¹å™¨
            function showVNLandingContainer() {
                if (vnMainContainer) vnMainContainer.classList.remove('active');
                if (vnLandingContainer) vnLandingContainer.classList.add('active');
                console.log('[VNé¢æ¿-JCYç‰ˆ] å·²è¿”å›å¯åŠ¨ç•Œé¢');
            }

            // ç›‘å¬æ¥è‡ªJCYä¸»ç³»ç»Ÿçš„æ¶ˆæ¯
            window.addEventListener('message', function(event) {
                const { type, data, character, storyType } = event.data || {};
                
                if (type === 'VN_DATA') {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°VNæ•¸æ“šï¼Œé–‹å§‹è™•ç†åŠ‡æƒ…');
                    
                    // éš±è—loadingå‹•ç•«
                    if (window.VNFeatures?.hideLoadingAnimation) {
                        window.VNFeatures.hideLoadingAnimation();
                        console.log('[VNé¢æ¿-JCYç‰ˆ] å·²éš±è—loadingå‹•ç•«');
                    }
                    
                    showVNMainContainer();
                    
                    // è™•ç†VNåŠ‡æƒ…æ•¸æ“š
                    if (data) {
                        try {
                            // æª¢æŸ¥dataæ˜¯å¦å·²ç¶“æ˜¯è§£æå¾Œçš„å°è±¡
                            let vnData;
                            if (typeof data === 'object' && data.dialogues) {
                                // å·²ç¶“æ˜¯è§£æå¾Œçš„æ•¸æ“š
                                vnData = data;
                                console.log('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°å·²è§£æçš„VNæ•¸æ“š');
                            } else {
                                // éœ€è¦è§£æçš„åŸå§‹æ•¸æ“š
                                vnData = parseVNData(data);
                                console.log('[VNé¢æ¿-JCYç‰ˆ] è§£æåŸå§‹VNæ•¸æ“š');
                            }
                            
                            // è¨­ç½®VNæ•¸æ“š
                            if (window.VNCore) {
                                window.VNCore.vnData = vnData;
                                window.VNCore.handleVNData({ data: vnData });
                            }
                            
                            console.log('[VNé¢æ¿-JCYç‰ˆ] VNåŠ‡æƒ…å·²é–‹å§‹');
                        } catch (error) {
                            console.error('[VNé¢æ¿-JCYç‰ˆ] è™•ç†VNæ•¸æ“šå¤±æ•—:', error);
                        }
                    }
                }
                
                // è™•ç†ç·šä¸‹åŠ‡æƒ…æ•¸æ“š
                if (type === 'OFFLINE_STORY') {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°ç·šä¸‹åŠ‡æƒ…æ•¸æ“š:', event.data);
                    
                    // é¡¯ç¤ºåŠ‡æƒ…è¨­ç½®ç•Œé¢
                    showStoryEditModal();
                    
                    // è‡ªå‹•å¡«å……è§’è‰²ä¿¡æ¯
                    if (character) {
                        const mainCharacterInput = document.getElementById('mainCharacter');
                        if (mainCharacterInput) {
                            mainCharacterInput.value = character;
                        }
                    }
                    
                    // è‡ªå‹•å¡«å……åŠ‡æƒ…å…§å®¹
                    if (storyType === 'offline_meeting') {
                        const storyContentInput = document.getElementById('storyContent');
                        if (storyContentInput) {
                            storyContentInput.value = `èˆ‡${character}çš„ç·šä¸‹è¦‹é¢åŠ‡æƒ…ã€‚\n\nå ´æ™¯ï¼šå’–å•¡å»³\næ™‚é–“ï¼šä¸‹åˆ\næ°›åœï¼šè¼•é¬†æ„‰å¿«\n\nåŠ‡æƒ…ç™¼å±•ï¼š\n1. åœ¨å’–å•¡å»³ç›¸é‡\n2. èŠå¤©äº’å‹•\n3. æ·±å…¥äº†è§£å°æ–¹\n4. å¯èƒ½çš„æµªæ¼«ç™¼å±•`;
                        }
                    }
                    
                    // è‡ªå‹•å¡«å……èµ·æ‰‹
                    const storyOpeningInput = document.getElementById('storyOpening');
                    if (storyOpeningInput) {
                        storyOpeningInput.value = `ä½ èµ°é€²å’–å•¡å»³ï¼Œçœ‹åˆ°${character}å·²ç¶“åœ¨é‚£è£¡ç­‰è‘—ä½ äº†ã€‚`;
                    }
                }
                
                // è™•ç†ç«‹ç¹ªé…ç½®æ•¸æ“š
                if (type === 'PORTRAIT_CONFIG') {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°ç«‹ç¹ªé…ç½®æ•¸æ“š:', event.data);
                    
                    const { baseUrl, format } = event.data;
                    if (window.VNPortraitProcessor && window.VNPortraitProcessor.setConfig) {
                        window.VNPortraitProcessor.setConfig(baseUrl, format);
                        console.log('[VNé¢æ¿-JCYç‰ˆ] ç«‹ç¹ªé…ç½®å·²æ›´æ–°');
                    }
                }
                
                // è™•ç†VNç«‹ç¹ªé…ç½®æ¶ˆæ¯
                if (type === 'VN_CONFIGURE_PORTRAIT') {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°VNç«‹ç¹ªé…ç½®:', event.data);
                    
                    const { config } = event.data;
                    if (config && window.VNPortraitProcessor && window.VNPortraitProcessor.setConfig) {
                        window.VNPortraitProcessor.setConfig(config.baseUrl, config.format);
                        console.log('[VNé¢æ¿-JCYç‰ˆ] VNç«‹ç¹ªé…ç½®å·²æ›´æ–°:', config);
                    }
                }
                
                // è™•ç†VN AIå›æ‡‰æ¶ˆæ¯
                if (type === 'VN_AI_RESPONSE') {
                    console.log('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°VN AIå›æ‡‰:', event.data);
                    
                    // è§£é™¤loadingç•«é¢
                    if (window.VNFeatures?.hideLoadingAnimation) {
                        window.VNFeatures.hideLoadingAnimation();
                    }
                    
                    const { response } = event.data;
                    if (response) {
                        try {
                            // æª¢æŸ¥responseæ˜¯å¦å·²ç¶“æ˜¯è§£æå¾Œçš„å°è±¡
                            let vnData;
                            if (typeof response === 'object' && response.dialogues) {
                                // å·²ç¶“æ˜¯è§£æå¾Œçš„æ•¸æ“š
                                vnData = response;
                                console.log('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°å·²è§£æçš„VNæ•¸æ“š');
                            } else {
                                // éœ€è¦è§£æçš„åŸå§‹æ•¸æ“š
                                vnData = parseVNData(response);
                                console.log('[VNé¢æ¿-JCYç‰ˆ] è§£æåŸå§‹VNæ•¸æ“š');
                            }
                            
                            // è¨­ç½®VNæ•¸æ“šä¸¦é–‹å§‹åŠ‡æƒ…
                            if (window.VNCore) {
                                window.VNCore.vnData = vnData;
                                // ä½¿ç”¨æ­£ç¢ºçš„å‡½æ•¸å•Ÿå‹•VN
                                if (window.VNCore.handleVNData) {
                                    window.VNCore.handleVNData({ data: vnData });
                                } else if (window.handleMessageEvent) {
                                    window.handleMessageEvent({ data: { data: vnData } });
                                }
                                console.log('[VNé¢æ¿-JCYç‰ˆ] VNåŠ‡æƒ…å·²é–‹å§‹æ’­æ”¾');
                            } else {
                                console.error('[VNé¢æ¿-JCYç‰ˆ] VNCoreæœªæ‰¾åˆ°');
                            }
                        } catch (error) {
                            console.error('[VNé¢æ¿-JCYç‰ˆ] è™•ç†VN AIå›æ‡‰å¤±æ•—:', error);
                            console.error('[VNé¢æ¿-JCYç‰ˆ] åŸå§‹å›æ‡‰å…§å®¹:', response);
                            
                            // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯çµ¦ç”¨æˆ¶
                            const errorMessage = `VNåŠ‡æƒ…å•Ÿå‹•å¤±æ•—ï¼š${error.message}\n\nè«‹æª¢æŸ¥AIå›æ‡‰æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚`;
                            if (window.showCustomAlert) {
                                window.showCustomAlert('VNéŒ¯èª¤', errorMessage);
                            } else {
                                alert(errorMessage);
                            }
                        }
                    } else {
                        console.warn('[VNé¢æ¿-JCYç‰ˆ] æ”¶åˆ°ç©ºçš„AIå›æ‡‰');
                    }
                }
            });

            console.log('[VNé¢æ¿-JCYç‰ˆ] VNä¸»å¯åŠ¨ç•Œé¢æ§åˆ¶é€»è¾‘å·²åˆå§‹åŒ– (JCYç‰ˆï¼ŒåŒ…å«åŠ‡æƒ…è¨­ç½®åŠŸèƒ½)');
            
            // åˆå§‹åŒ–é–‹å§‹åŠ‡æƒ…æŒ‰éˆ•ç‹€æ…‹
            setTimeout(() => {
                if (window.StorySettings?.updateStartStoryButton) {
                    window.StorySettings.updateStartStoryButton();
                }
            }, 1000);
        });
        
        // VNæ•¸æ“šè§£æå‡½æ•¸
        function parseVNData(rawData) {
            try {
                console.log('[VNé¢æ¿-JCYç‰ˆ] é–‹å§‹è§£æVNæ•¸æ“š:', rawData);
                
                // å¦‚æœæ•¸æ“šå·²ç¶“æ˜¯å°è±¡ï¼Œç›´æ¥è¿”å›
                if (typeof rawData === 'object') {
                    return rawData;
                }
                
                // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå˜—è©¦è§£æ
                if (typeof rawData === 'string') {
                    // å˜—è©¦è§£æç‚ºJSON
                    try {
                        return JSON.parse(rawData);
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONï¼Œå˜—è©¦è§£æVNæ ¼å¼
                        return parseVNFormat(rawData);
                    }
                }
                
                throw new Error('ç„¡æ³•è§£æVNæ•¸æ“šæ ¼å¼');
            } catch (error) {
                console.error('[VNé¢æ¿-JCYç‰ˆ] è§£æVNæ•¸æ“šå¤±æ•—:', error);
                // è¿”å›é»˜èªVNæ•¸æ“šçµæ§‹
                return {
                    dialogues: [
                        {
                            type: 'narrator',
                            content: 'åŠ‡æƒ…è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦',
                            timestamp: Date.now()
                        }
                    ],
                    choices: []
                };
            }
        }
        
        // è§£æVNæ ¼å¼æ–‡æœ¬
        function parseVNFormat(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const dialogues = [];
            const choices = [];
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                
                // è§£æè§’è‰²å°è©± [è§’è‰²å|æœè£|è¡¨æƒ…|å°è©±|sound_effect]
                const dialogueMatch = trimmedLine.match(/^\[([^|]+)\|([^|]*)\|([^|]*)\|([^|]*)\|([^|]*)\]$/);
                if (dialogueMatch) {
                    dialogues.push({
                        type: 'dialogue',
                        character: dialogueMatch[1].trim(),
                        costume: dialogueMatch[2].trim(),
                        expression: dialogueMatch[3].trim(),
                        content: dialogueMatch[4].trim(),
                        soundEffect: dialogueMatch[5].trim(),
                        timestamp: Date.now()
                    });
                    continue;
                }
                
                // è§£ææ—ç™½ [Narrator|æè¿°|sound_effect]
                const narratorMatch = trimmedLine.match(/^\[Narrator\|([^|]*)\|([^|]*)\]$/);
                if (narratorMatch) {
                    dialogues.push({
                        type: 'narrator',
                        content: narratorMatch[1].trim(),
                        soundEffect: narratorMatch[2].trim(),
                        timestamp: Date.now()
                    });
                    continue;
                }
                
                // è§£æé¸æ“‡é … [ç·¨è™Ÿè¡¨æƒ… [é¸é …æ–‡å­—] | é¸é …æè¿° | é¸é …çµæœ]
                const choiceMatch = trimmedLine.match(/^\[([^|]+)\s*\[([^\]]+)\]\s*\|\s*([^|]*)\s*\|\s*([^|]*)\]$/);
                if (choiceMatch) {
                    choices.push({
                        emoji: choiceMatch[1].trim(),
                        text: choiceMatch[2].trim(),
                        description: choiceMatch[3].trim(),
                        result: choiceMatch[4].trim(),
                        timestamp: Date.now()
                    });
                    continue;
                }
                
                // å…¶ä»–æ ¼å¼ä½œç‚ºæ™®é€šæ–‡æœ¬è™•ç†
                if (trimmedLine && !trimmedLine.startsWith('[')) {
                    dialogues.push({
                        type: 'text',
                        content: trimmedLine,
                        timestamp: Date.now()
                    });
                }
            }
            
            return {
                dialogues: dialogues,
                choices: choices,
                timestamp: Date.now()
            };
        }

        // ç´ æè¨­ç½®åŠŸèƒ½
        // å…¨å±€è®Šæ•¸
        let portraitBaseUrlInput, portraitFormatInput, testCharacterInput, testPortraitBtn, portraitTestResult;
        let bgmBaseUrlInput, bgmFormatInput, testBgmInput, testBgmBtn, bgmTestResult;
        let soundEffectBaseUrlInput, soundEffectFormatInput, testSoundEffectInput, testSoundEffectBtn, soundEffectTestResult;
        let characterImgBaseUrlInput, characterImgFormatInput;
        let backgroundBaseUrlInput, backgroundFallbackUrlInput, backgroundFormatInput;
        let areaGifBaseUrlInput, areaGifFormatInput;
        let stickerBaseUrlInput, stickerDefaultUrlInput, stickerFormatInput;
        let itemImgBaseUrlInput, itemImgFormatInput;
        let itemTypeBaseUrlInput, itemTypeFormatInput;
        
        // å…¨å±€åˆ‡æ›æ¨™ç±¤ç›¸é—œè®Šæ•¸
        let urlModeBtn, uploadModeBtn;
        let currentSourceMode = 'url'; // é»˜èªç‚ºURLæ¨¡å¼

        // è¼‰å…¥ç´ æè¨­ç½®å‡½æ•¸ï¼ˆå…¨å±€ï¼‰
        function loadMaterialSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
            
            // è¼‰å…¥å…¨å±€åˆ‡æ›æ¨¡å¼
    console.log('[VNé¢æ¿] loadMaterialSettings - åŸå§‹è¨­ç½®:', savedSettings);
    console.log('[VNé¢æ¿] loadMaterialSettings - savedSettings.sourceMode:', savedSettings.sourceMode);
    
    currentSourceMode = savedSettings.sourceMode || 'url'; // é»˜è®¤ä½¿ç”¨URLæ¨¡å¼
    console.log('[VNé¢æ¿] loadMaterialSettings - è¨­ç½®å¾Œçš„ currentSourceMode:', currentSourceMode);
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜è¿‡è®¾ç½®ï¼Œä¿å­˜é»˜è®¤è®¾ç½®
    if (!savedSettings.sourceMode) {
        savedSettings.sourceMode = currentSourceMode;
        localStorage.setItem('vn_material_settings', JSON.stringify(savedSettings));
        console.log('[VNé¢æ¿] loadMaterialSettings - ä¿å­˜é»˜èªè¨­ç½®');
    }
    
                updateSourceModeUI();
    
    // æ›´æ–° VNMaterialProcessor çš„è¨­ç½®
    if (window.VNMaterialProcessor) {
        window.VNMaterialProcessor.getSourceMode = function() {
            // å…ˆæ£€æŸ¥å†…å­˜ä¸­çš„è®¾ç½®
            if (typeof currentSourceMode !== 'undefined') {
                return currentSourceMode;
            }
            
            // å†æ£€æŸ¥ localStorage
            const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
            const mode = savedSettings.sourceMode || 'url';
            
            // æ›´æ–°å†…å­˜ä¸­çš„è®¾ç½®
            if (typeof currentSourceMode !== 'undefined') {
                currentSourceMode = mode;
            }
            
            return mode;
        };
        
        // æ·»åŠ å½“å‰æ¨¡å¼å±æ€§
        window.VNMaterialProcessor.currentSourceMode = currentSourceMode || 'url';
    }

window.debugMaterialSettings = function() {
    const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
    const currentMode = window.VNMaterialProcessor ? window.VNMaterialProcessor.getSourceMode() : 'unknown';
    
    console.log('=== ç´ æè¨­ç½®èª¿è©¦ä¿¡æ¯ ===');
    console.log('localStorage ä¸­çš„è¨­ç½®:', savedSettings);
    console.log('ç•¶å‰å…§å­˜ä¸­çš„æ¨¡å¼ (currentSourceMode):', typeof currentSourceMode !== 'undefined' ? currentSourceMode : 'undefined');
    console.log('VNMaterialProcessor.getSourceMode():', currentMode);
    console.log('VNMaterialProcessor.currentSourceMode:', window.VNMaterialProcessor?.currentSourceMode);
    console.log('ç´ æåœ–ç‰‡ç®¡ç†å™¨:', !!window.materialImageManager);
    
    // æ£€æŸ¥UIçŠ¶æ€
    const urlModeBtn = document.getElementById('urlModeBtn');
    const uploadModeBtn = document.getElementById('uploadModeBtn');
    console.log('URLæ¨¡å¼æŒ‰éˆ•ç‹€æ…‹:', urlModeBtn?.classList.contains('active'));
    console.log('ä¸Šå‚³æ¨¡å¼æŒ‰éˆ•ç‹€æ…‹:', uploadModeBtn?.classList.contains('active'));
    
    // æ£€æŸ¥æ¨¡å¼æ ‡ç­¾
    const modeBadge = document.getElementById('current-mode-badge');
    console.log('æ¨¡å¼æ¨™ç±¤æ–‡å­—:', modeBadge?.textContent);
    
    if (window.materialImageManager) {
        window.materialImageManager.getImagesByCategory('portrait').then(images => {
            console.log('IndexedDB ä¸­çš„ç«‹ç¹ªåœ–ç‰‡:', images.length, 'å¼µ');
            images.forEach(img => {
                console.log('  -', img.name, '(label:', img.label, ', emotion:', img.emotion, ')');
            });
        });
    }
    
    return {
        localStorage: savedSettings,
        currentMode: currentMode,
        hasManager: !!window.materialImageManager,
        urlBtnActive: urlModeBtn?.classList.contains('active'),
        uploadBtnActive: uploadModeBtn?.classList.contains('active'),
        modeBadgeText: modeBadge?.textContent
    };
};

window.switchToUploadMode = function() {
    console.log('[èª¿è©¦] å¼·åˆ¶åˆ‡æ›åˆ°ä¸Šå‚³æ¨¡å¼');
    
    if (typeof switchSourceMode === 'function') {
        switchSourceMode('upload');
    } else {
        // æ‰‹åŠ¨è®¾ç½®
        const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
        savedSettings.sourceMode = 'upload';
        localStorage.setItem('vn_material_settings', JSON.stringify(savedSettings));
        
        if (typeof currentSourceMode !== 'undefined') {
            currentSourceMode = 'upload';
        }
        
        if (window.VNMaterialProcessor) {
            window.VNMaterialProcessor.currentSourceMode = 'upload';
        }
        
        console.log('[èª¿è©¦] å·²æ‰‹å‹•è¨­ç½®ç‚ºä¸Šå‚³æ¨¡å¼');
    }
    
    // åˆ·æ–°UI
    if (typeof updateSourceModeUI === 'function') {
        updateSourceModeUI();
    }
    
    return window.debugMaterialSettings();
};
    
    console.log('[VNé¢æ¿] ç´ æè¨­ç½®å·²è¼‰å…¥ï¼Œç•¶å‰æ¨¡å¼:', currentSourceMode);
    
    // ... å…¶ä»–è®¾ç½®åŠ è½½é€»è¾‘ä¿æŒä¸å˜
            // è¼‰å…¥ç«‹ç¹ªè¨­ç½®
            if (savedSettings.portrait?.baseUrl && portraitBaseUrlInput) {
                portraitBaseUrlInput.value = savedSettings.portrait.baseUrl;
            }
            if (savedSettings.portrait?.format && portraitFormatInput) {
                portraitFormatInput.value = savedSettings.portrait.format;
            }
            
            // è¼‰å…¥BGMè¨­ç½®
            if (savedSettings.bgm?.baseUrl && bgmBaseUrlInput) {
                bgmBaseUrlInput.value = savedSettings.bgm.baseUrl;
            }
            if (savedSettings.bgm?.format && bgmFormatInput) {
                bgmFormatInput.value = savedSettings.bgm.format;
            }
            
            // è¼‰å…¥éŸ³æ•ˆè¨­ç½®
            if (savedSettings.soundEffect?.baseUrl && soundEffectBaseUrlInput) {
                soundEffectBaseUrlInput.value = savedSettings.soundEffect.baseUrl;
            }
            if (savedSettings.soundEffect?.format && soundEffectFormatInput) {
                soundEffectFormatInput.value = savedSettings.soundEffect.format;
            }
            
            // è¼‰å…¥è§’è‰²åœ–ç‰‡è¨­ç½®
            if (savedSettings.characterImg?.baseUrl && characterImgBaseUrlInput) {
                characterImgBaseUrlInput.value = savedSettings.characterImg.baseUrl;
            }
            if (savedSettings.characterImg?.format && characterImgFormatInput) {
                characterImgFormatInput.value = savedSettings.characterImg.format;
            }
            
            // è¼‰å…¥èƒŒæ™¯åœ–ç‰‡è¨­ç½®
            if (savedSettings.background?.baseUrl && backgroundBaseUrlInput) {
                backgroundBaseUrlInput.value = savedSettings.background.baseUrl;
            }
            if (savedSettings.background?.fallbackUrl && backgroundFallbackUrlInput) {
                backgroundFallbackUrlInput.value = savedSettings.background.fallbackUrl;
            }
            if (savedSettings.background?.format && backgroundFormatInput) {
                backgroundFormatInput.value = savedSettings.background.format;
            }
            
            // è¼‰å…¥Area GIFè¨­ç½®
            if (savedSettings.areaGif?.baseUrl && areaGifBaseUrlInput) {
                areaGifBaseUrlInput.value = savedSettings.areaGif.baseUrl;
            }
            if (savedSettings.areaGif?.format && areaGifFormatInput) {
                areaGifFormatInput.value = savedSettings.areaGif.format;
            }
            
            // è¼‰å…¥è²¼åœ–è¨­ç½®
            if (savedSettings.sticker?.baseUrl && stickerBaseUrlInput) {
                stickerBaseUrlInput.value = savedSettings.sticker.baseUrl;
            }
            if (savedSettings.sticker?.defaultUrl && stickerDefaultUrlInput) {
                stickerDefaultUrlInput.value = savedSettings.sticker.defaultUrl;
            }
            if (savedSettings.sticker?.format && stickerFormatInput) {
                stickerFormatInput.value = savedSettings.sticker.format;
            }
            
            // è¼‰å…¥ç‰©å“åœ–ç‰‡è¨­ç½®
            if (savedSettings.itemImg?.baseUrl && itemImgBaseUrlInput) {
                itemImgBaseUrlInput.value = savedSettings.itemImg.baseUrl;
            }
            if (savedSettings.itemImg?.format && itemImgFormatInput) {
                itemImgFormatInput.value = savedSettings.itemImg.format;
            }
            
            // è¼‰å…¥ç‰©å“é¡å‹è¨­ç½®
            if (savedSettings.itemType?.baseUrl && itemTypeBaseUrlInput) {
                itemTypeBaseUrlInput.value = savedSettings.itemType.baseUrl;
            }
            if (savedSettings.itemType?.format && itemTypeFormatInput) {
                itemTypeFormatInput.value = savedSettings.itemType.format;
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            // èª¿è©¦ä¿¡æ¯
            console.log('[VNé¢æ¿] DOMContentLoadedäº‹ä»¶è§¸ç™¼');
            const debugTime = document.getElementById('debug-time');
            if (debugTime) {
                debugTime.textContent = new Date().toLocaleString();
            }
            
            // åˆå§‹åŒ–ç´ æè¨­ç½®å…ƒç´ 
            portraitBaseUrlInput = document.getElementById('portrait-base-url');
            portraitFormatInput = document.getElementById('portrait-format');
            testCharacterInput = document.getElementById('test-character-name');
            testPortraitBtn = document.getElementById('test-portrait-btn');
            portraitTestResult = document.getElementById('portrait-test-result');

            bgmBaseUrlInput = document.getElementById('bgm-base-url');
            bgmFormatInput = document.getElementById('bgm-format');
            testBgmInput = document.getElementById('test-bgm-name');
            testBgmBtn = document.getElementById('test-bgm-btn');
            bgmTestResult = document.getElementById('bgm-test-result');

            soundEffectBaseUrlInput = document.getElementById('sound-effect-base-url');
            soundEffectFormatInput = document.getElementById('sound-effect-format');
            testSoundEffectInput = document.getElementById('test-sound-effect-name');
            testSoundEffectBtn = document.getElementById('test-sound-effect-btn');
            soundEffectTestResult = document.getElementById('sound-effect-test-result');

            characterImgBaseUrlInput = document.getElementById('character-img-base-url');
            characterImgFormatInput = document.getElementById('character-img-format');

            backgroundBaseUrlInput = document.getElementById('background-base-url');
            backgroundFallbackUrlInput = document.getElementById('background-fallback-url');
            backgroundFormatInput = document.getElementById('background-format');

            areaGifBaseUrlInput = document.getElementById('area-gif-base-url');
            areaGifFormatInput = document.getElementById('area-gif-format');

            stickerBaseUrlInput = document.getElementById('sticker-base-url');
            stickerDefaultUrlInput = document.getElementById('sticker-default-url');
            stickerFormatInput = document.getElementById('sticker-format');

            itemImgBaseUrlInput = document.getElementById('item-img-base-url');
            itemImgFormatInput = document.getElementById('item-img-format');

            itemTypeBaseUrlInput = document.getElementById('item-type-base-url');
            itemTypeFormatInput = document.getElementById('item-type-format');

            // æ–°å¢æ¸¬è©¦æŒ‰éˆ•å…ƒç´ 
            testCharacterImgBtn = document.getElementById('test-character-img-btn');
            testCharacterImgNameInput = document.getElementById('test-character-img-name');
            testCharacterImgEmotionInput = document.getElementById('test-character-img-emotion');
            characterImgTestResult = document.getElementById('character-img-test-result');

            testBackgroundBtn = document.getElementById('test-background-btn');
            testBackgroundNameInput = document.getElementById('test-background-name');
            backgroundTestResult = document.getElementById('background-test-result');

            testAreaGifBtn = document.getElementById('test-area-gif-btn');
            testAreaGifNameInput = document.getElementById('test-area-gif-name');
            areaGifTestResult = document.getElementById('area-gif-test-result');

            testStickerBtn = document.getElementById('test-sticker-btn');
            testStickerNameInput = document.getElementById('test-sticker-name');
            stickerTestResult = document.getElementById('sticker-test-result');

            testItemImgBtn = document.getElementById('test-item-img-btn');
            testItemImgNameInput = document.getElementById('test-item-img-name');
            itemImgTestResult = document.getElementById('item-img-test-result');

            testItemTypeBtn = document.getElementById('test-item-type-btn');
            testItemTypeNameInput = document.getElementById('test-item-type-name');
            itemTypeTestResult = document.getElementById('item-type-test-result');

            // åˆå§‹åŒ–å…¨å±€åˆ‡æ›æ¨™ç±¤
            urlModeBtn = document.getElementById('urlModeBtn');
            uploadModeBtn = document.getElementById('uploadModeBtn');
            
            // ç¶å®šå…¨å±€åˆ‡æ›æ¨™ç±¤äº‹ä»¶
            if (urlModeBtn && uploadModeBtn) {
                urlModeBtn.addEventListener('click', () => switchSourceMode('url'));
                uploadModeBtn.addEventListener('click', () => switchSourceMode('upload'));
                
                // ç¶å®šURLå–®å¼µæ¨¡å¼æŒ‰éˆ•äº‹ä»¶
                const urlSingleModeBtn = document.getElementById('urlSingleModeBtn');
                if (urlSingleModeBtn) {
                    urlSingleModeBtn.addEventListener('click', () => switchSourceMode('url-single'));
                }
            }

            // åˆå§‹åŒ–æ™‚è¼‰å…¥ç´ æè¨­ç½®
            if (portraitBaseUrlInput && bgmBaseUrlInput && soundEffectBaseUrlInput) {
                loadMaterialSettings();
                // æ›´æ–°æ¨¡å¼æ¨™ç±¤é¡¯ç¤º
                updateSourceModeUI();
            }

            // åˆå§‹åŒ–ç´ æåœ–ç‰‡ç®¡ç†å™¨
            initializeMaterialImageManager();
            
            // åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
            initializeImageUpload();
            
            // ç‚ºæ‰€æœ‰ç´ æé¡åˆ¥æ·»åŠ ä¸Šå‚³åŠŸèƒ½
            setupAllUploadFunctions();
            
            // ç«‹å³ç¶å®šæ¸¬è©¦æŒ‰éˆ•äº‹ä»¶
            bindTestButtonEvents();
        });
        
        // ç¶å®šæ¸¬è©¦æŒ‰éˆ•äº‹ä»¶çš„å‡½æ•¸
        function bindTestButtonEvents() {
            console.log('[VNé¢æ¿] é–‹å§‹ç¶å®šæ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
            
            // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            console.log('[VNé¢æ¿] æ¸¬è©¦æŒ‰éˆ•å…ƒç´ æª¢æŸ¥:', {
                testPortraitBtn: !!testPortraitBtn,
                testBgmBtn: !!testBgmBtn,
                testSoundEffectBtn: !!testSoundEffectBtn,
                testCharacterImgBtn: !!testCharacterImgBtn,
                testBackgroundBtn: !!testBackgroundBtn,
                testAreaGifBtn: !!testAreaGifBtn,
                testStickerBtn: !!testStickerBtn,
                testItemImgBtn: !!testItemImgBtn,
                testItemTypeBtn: !!testItemTypeBtn
            });
            
            // æ¸¬è©¦ç«‹ç¹ªæŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testPortraitBtn) {
                console.log('[VNé¢æ¿] ç¶å®šç«‹ç¹ªæ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testPortraitBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿] ç«‹ç¹ªæ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const characterName = testCharacterInput.value.trim();
                    if (!characterName) {
                        portraitTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥è§’è‰²åç¨±</div>';
                        return;
                    }

                    // æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å¯è¼‰å…¥
                    portraitTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    try {
                        const portraitUrl = await generatePortraitUrl(characterName);
                        if (!portraitUrl) {
                            portraitTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®ç«‹ç¹ªåŸºç¤URL</div>';
                            return;
                        }
                        
                        const testImage = new Image();
                        testImage.onload = function() {
                            portraitTestResult.innerHTML = `
                                <div>
                                    <div class="success">âœ… ç«‹ç¹ªè¼‰å…¥æˆåŠŸ</div>
                                    <img src="${portraitUrl}" alt="${characterName}ç«‹ç¹ª" style="margin-top: 10px;">
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                        URL: ${portraitUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.onerror = function() {
                            portraitTestResult.innerHTML = `
                                <div class="error">
                                    âŒ ç«‹ç¹ªè¼‰å…¥å¤±æ•—<br>
                                    <div style="margin-top: 8px; font-size: 12px;">
                                        è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                        ${portraitUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.src = portraitUrl;
                    } catch (error) {
                        console.error('[VNé¢æ¿] æ¸¬è©¦ç«‹ç¹ªå¤±æ•—:', error);
                        portraitTestResult.innerHTML = `
                            <div class="error">
                                âŒ æ¸¬è©¦å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    éŒ¯èª¤ï¼š${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            // æ¸¬è©¦BGMæŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testBgmBtn) {
                console.log('[VNé¢æ¿] ç¶å®šBGMæ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testBgmBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿] BGMæ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const bgmName = testBgmInput.value.trim();
                    if (!bgmName) {
                        bgmTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥BGMåç¨±</div>';
                        return;
                    }

                    const bgmUrl = generateBgmUrl(bgmName);
                    if (!bgmUrl) {
                        bgmTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®BGMåŸºç¤URL</div>';
                        return;
                    }

                    // æ¸¬è©¦éŸ³é »æ˜¯å¦å¯è¼‰å…¥
                    bgmTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    const testAudio = new Audio();
                    testAudio.oncanplaythrough = function() {
                        bgmTestResult.innerHTML = `
                            <div>
                                <div class="success">âœ… BGMè¼‰å…¥æˆåŠŸ</div>
                                <audio controls style="margin-top: 10px; width: 100%;">
                                    <source src="${bgmUrl}" type="audio/mpeg">
                                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »æ’­æ”¾
                                </audio>
                                <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                    URL: ${bgmUrl}
                                </div>
                            </div>
                        `;
                    };
                    
                    testAudio.onerror = function() {
                        bgmTestResult.innerHTML = `
                            <div class="error">
                                âŒ BGMè¼‰å…¥å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                    ${bgmUrl}
                                </div>
                            </div>
                        `;
                    };
                    
                    testAudio.src = bgmUrl;
                });
            }

            // æ¸¬è©¦éŸ³æ•ˆæŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testSoundEffectBtn) {
                console.log('[VNé¢æ¿] ç¶å®šéŸ³æ•ˆæ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testSoundEffectBtn.addEventListener('click', function() {
                    console.log('[VNé¢æ¿] éŸ³æ•ˆæ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const soundEffectName = testSoundEffectInput.value.trim();
                    if (!soundEffectName) {
                        soundEffectTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥éŸ³æ•ˆåç¨±</div>';
                        return;
                    }

                    const soundEffectUrl = generateSoundEffectUrl(soundEffectName);
                    if (!soundEffectUrl) {
                        soundEffectTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®éŸ³æ•ˆåŸºç¤URL</div>';
                        return;
                    }

                    // æ¸¬è©¦éŸ³é »æ˜¯å¦å¯è¼‰å…¥
                    soundEffectTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    const testAudio = new Audio();
                    testAudio.oncanplaythrough = function() {
                        soundEffectTestResult.innerHTML = `
                            <div>
                                <div class="success">âœ… éŸ³æ•ˆè¼‰å…¥æˆåŠŸ</div>
                                <audio controls style="margin-top: 10px; width: 100%;">
                                    <source src="${soundEffectUrl}" type="audio/mpeg">
                                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »æ’­æ”¾
                                </audio>
                                <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                    URL: ${soundEffectUrl}
                                </div>
                            </div>
                        `;
                    };
                    
                    testAudio.onerror = function() {
                        soundEffectTestResult.innerHTML = `
                            <div class="error">
                                âŒ éŸ³æ•ˆè¼‰å…¥å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                    ${soundEffectUrl}
                                </div>
                            </div>
                        `;
                    };
                    
                    testAudio.src = soundEffectUrl;
                });
            }

            // æ¸¬è©¦è§’è‰²åœ–ç‰‡æŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testCharacterImgBtn) {
                console.log('[VNé¢æ¿] ç¶å®šè§’è‰²åœ–ç‰‡æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testCharacterImgBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿] è§’è‰²åœ–ç‰‡æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const characterName = testCharacterImgNameInput.value.trim();
                    const emotion = testCharacterImgEmotionInput.value.trim();
                    
                    if (!characterName) {
                        characterImgTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥è§’è‰²åç¨±</div>';
                        return;
                    }

                    // æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å¯è¼‰å…¥
                    characterImgTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    try {
                        const characterImgUrl = generateCharacterImgUrl(characterName, emotion);
                        if (!characterImgUrl) {
                            characterImgTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®è§’è‰²åœ–ç‰‡åŸºç¤URL</div>';
                            return;
                        }
                        
                        const testImage = new Image();
                        testImage.onload = function() {
                            characterImgTestResult.innerHTML = `
                                <div>
                                    <div class="success">âœ… è§’è‰²åœ–ç‰‡è¼‰å…¥æˆåŠŸ</div>
                                    <img src="${characterImgUrl}" alt="${characterName}è§’è‰²åœ–ç‰‡" style="margin-top: 10px; max-width: 200px;">
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                        URL: ${characterImgUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.onerror = function() {
                            characterImgTestResult.innerHTML = `
                                <div class="error">
                                    âŒ è§’è‰²åœ–ç‰‡è¼‰å…¥å¤±æ•—<br>
                                    <div style="margin-top: 8px; font-size: 12px;">
                                        è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                        ${characterImgUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.src = characterImgUrl;
                    } catch (error) {
                        console.error('[VNé¢æ¿] æ¸¬è©¦è§’è‰²åœ–ç‰‡å¤±æ•—:', error);
                        characterImgTestResult.innerHTML = `
                            <div class="error">
                                âŒ æ¸¬è©¦å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    éŒ¯èª¤ï¼š${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            // æ¸¬è©¦èƒŒæ™¯åœ–ç‰‡æŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testBackgroundBtn) {
                console.log('[VNé¢æ¿] ç¶å®šèƒŒæ™¯åœ–ç‰‡æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testBackgroundBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿] èƒŒæ™¯åœ–ç‰‡æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const locationName = testBackgroundNameInput.value.trim();
                    
                    if (!locationName) {
                        backgroundTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥åœ°é»åç¨±</div>';
                        return;
                    }

                    // æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å¯è¼‰å…¥
                    backgroundTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    try {
                        const backgroundUrl = generateBackgroundUrl(locationName);
                        if (!backgroundUrl) {
                            backgroundTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®èƒŒæ™¯åœ–ç‰‡åŸºç¤URL</div>';
                            return;
                        }
                        
                        const testImage = new Image();
                        testImage.onload = function() {
                            backgroundTestResult.innerHTML = `
                                <div>
                                    <div class="success">âœ… èƒŒæ™¯åœ–ç‰‡è¼‰å…¥æˆåŠŸ</div>
                                    <img src="${backgroundUrl}" alt="${locationName}èƒŒæ™¯åœ–ç‰‡" style="margin-top: 10px; max-width: 200px;">
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                        URL: ${backgroundUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.onerror = function() {
                            backgroundTestResult.innerHTML = `
                                <div class="error">
                                    âŒ èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å¤±æ•—<br>
                                    <div style="margin-top: 8px; font-size: 12px;">
                                        è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                        ${backgroundUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.src = backgroundUrl;
                    } catch (error) {
                        console.error('[VNé¢æ¿] æ¸¬è©¦èƒŒæ™¯åœ–ç‰‡å¤±æ•—:', error);
                        backgroundTestResult.innerHTML = `
                            <div class="error">
                                âŒ æ¸¬è©¦å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    éŒ¯èª¤ï¼š${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            // æ¸¬è©¦Area GIFæŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testAreaGifBtn) {
                console.log('[VNé¢æ¿] ç¶å®šArea GIFæ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testAreaGifBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿] Area GIFæ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const areaName = testAreaGifNameInput.value.trim();
                    
                    if (!areaName) {
                        areaGifTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥å€åŸŸåç¨±</div>';
                        return;
                    }

                    // æ¸¬è©¦GIFæ˜¯å¦å¯è¼‰å…¥
                    areaGifTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    try {
                        const areaGifUrl = generateAreaGifUrl(areaName);
                        if (!areaGifUrl) {
                            areaGifTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®Area GIFåŸºç¤URL</div>';
                            return;
                        }
                        
                        const testImage = new Image();
                        testImage.onload = function() {
                            areaGifTestResult.innerHTML = `
                                <div>
                                    <div class="success">âœ… Area GIFè¼‰å…¥æˆåŠŸ</div>
                                    <img src="${areaGifUrl}" alt="${areaName}éå ´å‹•ç•«" style="margin-top: 10px; max-width: 200px;">
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                        URL: ${areaGifUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.onerror = function() {
                            areaGifTestResult.innerHTML = `
                                <div class="error">
                                    âŒ Area GIFè¼‰å…¥å¤±æ•—<br>
                                    <div style="margin-top: 8px; font-size: 12px;">
                                        è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                        ${areaGifUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.src = areaGifUrl;
                    } catch (error) {
                        console.error('[VNé¢æ¿] æ¸¬è©¦Area GIFå¤±æ•—:', error);
                        areaGifTestResult.innerHTML = `
                            <div class="error">
                                âŒ æ¸¬è©¦å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    éŒ¯èª¤ï¼š${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            // æ¸¬è©¦è²¼åœ–æŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testStickerBtn) {
                console.log('[VNé¢æ¿] ç¶å®šè²¼åœ–æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testStickerBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿] è²¼åœ–æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const stickerName = testStickerNameInput.value.trim();
                    
                    if (!stickerName) {
                        stickerTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥è²¼åœ–åç¨±</div>';
                        return;
                    }

                    // æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å¯è¼‰å…¥
                    stickerTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    try {
                        const stickerUrl = generateStickerUrl(stickerName);
                        if (!stickerUrl) {
                            stickerTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®è²¼åœ–åŸºç¤URL</div>';
                            return;
                        }
                        
                        const testImage = new Image();
                        testImage.onload = function() {
                            stickerTestResult.innerHTML = `
                                <div>
                                    <div class="success">âœ… è²¼åœ–è¼‰å…¥æˆåŠŸ</div>
                                    <img src="${stickerUrl}" alt="${stickerName}è²¼åœ–" style="margin-top: 10px; max-width: 200px;">
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                        URL: ${stickerUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.onerror = function() {
                            stickerTestResult.innerHTML = `
                                <div class="error">
                                    âŒ è²¼åœ–è¼‰å…¥å¤±æ•—<br>
                                    <div style="margin-top: 8px; font-size: 12px;">
                                        è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                        ${stickerUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.src = stickerUrl;
                    } catch (error) {
                        console.error('[VNé¢æ¿] æ¸¬è©¦è²¼åœ–å¤±æ•—:', error);
                        stickerTestResult.innerHTML = `
                            <div class="error">
                                âŒ æ¸¬è©¦å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    éŒ¯èª¤ï¼š${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            // æ¸¬è©¦ç‰©å“åœ–ç‰‡æŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testItemImgBtn) {
                console.log('[VNé¢æ¿] ç¶å®šç‰©å“åœ–ç‰‡æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testItemImgBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿] ç‰©å“åœ–ç‰‡æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const itemName = testItemImgNameInput.value.trim();
                    
                    if (!itemName) {
                        itemImgTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥ç‰©å“åç¨±</div>';
                        return;
                    }

                    // æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å¯è¼‰å…¥
                    itemImgTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    try {
                        const itemImgUrl = generateItemImgUrl(itemName);
                        if (!itemImgUrl) {
                            itemImgTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®ç‰©å“åœ–ç‰‡åŸºç¤URL</div>';
                            return;
                        }
                        
                        const testImage = new Image();
                        testImage.onload = function() {
                            itemImgTestResult.innerHTML = `
                                <div>
                                    <div class="success">âœ… ç‰©å“åœ–ç‰‡è¼‰å…¥æˆåŠŸ</div>
                                    <img src="${itemImgUrl}" alt="${itemName}ç‰©å“åœ–ç‰‡" style="margin-top: 10px; max-width: 200px;">
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                        URL: ${itemImgUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.onerror = function() {
                            itemImgTestResult.innerHTML = `
                                <div class="error">
                                    âŒ ç‰©å“åœ–ç‰‡è¼‰å…¥å¤±æ•—<br>
                                    <div style="margin-top: 8px; font-size: 12px;">
                                        è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                        ${itemImgUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.src = itemImgUrl;
                    } catch (error) {
                        console.error('[VNé¢æ¿] æ¸¬è©¦ç‰©å“åœ–ç‰‡å¤±æ•—:', error);
                        itemImgTestResult.innerHTML = `
                            <div class="error">
                                âŒ æ¸¬è©¦å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    éŒ¯èª¤ï¼š${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            // æ¸¬è©¦ç‰©å“é¡å‹æŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (testItemTypeBtn) {
                console.log('[VNé¢æ¿] ç¶å®šç‰©å“é¡å‹æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶');
                testItemTypeBtn.addEventListener('click', async function() {
                    console.log('[VNé¢æ¿] ç‰©å“é¡å‹æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
                    const itemTypeName = testItemTypeNameInput.value.trim();
                    
                    if (!itemTypeName) {
                        itemTypeTestResult.innerHTML = '<div class="error">è«‹è¼¸å…¥ç‰©å“é¡å‹åç¨±</div>';
                        return;
                    }

                    // æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å¯è¼‰å…¥
                    itemTypeTestResult.innerHTML = '<div class="success">æ­£åœ¨æ¸¬è©¦...</div>';
                    
                    try {
                        const itemTypeUrl = generateItemTypeUrl(itemTypeName);
                        if (!itemTypeUrl) {
                            itemTypeTestResult.innerHTML = '<div class="error">è«‹è¨­ç½®ç‰©å“é¡å‹åŸºç¤URL</div>';
                            return;
                        }
                        
                        const testImage = new Image();
                        testImage.onload = function() {
                            itemTypeTestResult.innerHTML = `
                                <div>
                                    <div class="success">âœ… ç‰©å“é¡å‹åœ–ç‰‡è¼‰å…¥æˆåŠŸ</div>
                                    <img src="${itemTypeUrl}" alt="${itemTypeName}é¡å‹åœ–ç‰‡" style="margin-top: 10px; max-width: 200px;">
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-color-light);">
                                        URL: ${itemTypeUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.onerror = function() {
                            itemTypeTestResult.innerHTML = `
                                <div class="error">
                                    âŒ ç‰©å“é¡å‹åœ–ç‰‡è¼‰å…¥å¤±æ•—<br>
                                    <div style="margin-top: 8px; font-size: 12px;">
                                        è«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢ºï¼š<br>
                                        ${itemTypeUrl}
                                    </div>
                                </div>
                            `;
                        };
                        
                        testImage.src = itemTypeUrl;
                    } catch (error) {
                        console.error('[VNé¢æ¿] æ¸¬è©¦ç‰©å“é¡å‹å¤±æ•—:', error);
                        itemTypeTestResult.innerHTML = `
                            <div class="error">
                                âŒ æ¸¬è©¦å¤±æ•—<br>
                                <div style="margin-top: 8px; font-size: 12px;">
                                    éŒ¯èª¤ï¼š${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            console.log('[VNé¢æ¿] æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ç¶å®šå®Œæˆ');
        }
        
        // å…¨å±€åˆ‡æ›æ¨™ç±¤åŠŸèƒ½
        function switchSourceMode(mode) {
            if (currentSourceMode === mode) return;
            
            currentSourceMode = mode;
            updateSourceModeUI();
            
    // ç«‹å³ä¿å­˜è¨­ç½®åˆ° localStorage
            const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
            savedSettings.sourceMode = mode;
            localStorage.setItem('vn_material_settings', JSON.stringify(savedSettings));
            
    let modeText = '';
    if (mode === 'url') modeText = 'URL';
    else if (mode === 'upload') modeText = 'ä¸Šå‚³';
    else if (mode === 'url-single') modeText = 'URLå–®å¼µ';
    
    console.log(`[ç´ æè¨­ç½®] åˆ‡æ›åˆ°${modeText}æ¨¡å¼ï¼Œå·²è‡ªå‹•ä¿å­˜`);
    
    // ç«‹å³æ›´æ–° VNMaterialProcessor çš„è¨­ç½®
    if (window.VNMaterialProcessor) {
        window.VNMaterialProcessor.currentSourceMode = mode;
    }
    
    // é¡¯ç¤ºè¨­ç½®å·²ä¿å­˜çš„æç¤º
    const modeBadge = document.getElementById('current-mode-badge');
    if (modeBadge) {
        const originalText = modeBadge.textContent;
        modeBadge.textContent = `âœ“ ${modeText}æ¨¡å¼å·²ä¿å­˜`;
        modeBadge.style.background = '#28a745';
        
        setTimeout(() => {
            modeBadge.textContent = originalText;
            if (mode === 'url') {
                modeBadge.style.background = '#007bff';
            } else if (mode === 'upload') {
                modeBadge.style.background = '#28a745';
            } else if (mode === 'url-single') {
                modeBadge.style.background = '#ff6b35';
            }
        }, 2000);
    }
} 
        // æ›´æ–°å…¨å±€åˆ‡æ›æ¨™ç±¤UI
        function updateSourceModeUI() {
            console.log('[VNé¢æ¿] updateSourceModeUI è¢«èª¿ç”¨ï¼Œç•¶å‰æ¨¡å¼:', currentSourceMode);
            
            if (!urlModeBtn || !uploadModeBtn) {
                console.warn('[VNé¢æ¿] æŒ‰éˆ•å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³éUIæ›´æ–°');
                return;
            }
            
            // ç²å–URLå–®å¼µæ¨¡å¼æŒ‰éˆ•
            const urlSingleModeBtn = document.getElementById('urlSingleModeBtn');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            urlModeBtn.classList.toggle('active', currentSourceMode === 'url');
            uploadModeBtn.classList.toggle('active', currentSourceMode === 'upload');
            if (urlSingleModeBtn) {
                urlSingleModeBtn.classList.toggle('active', currentSourceMode === 'url-single');
            }
            
            console.log('[VNé¢æ¿] æŒ‰éˆ•ç‹€æ…‹å·²æ›´æ–°:', {
                urlActive: urlModeBtn.classList.contains('active'),
                uploadActive: uploadModeBtn.classList.contains('active'),
                urlSingleActive: urlSingleModeBtn ? urlSingleModeBtn.classList.contains('active') : false
            });
            
            // æ›´æ–°è¨­ç½®å€åŸŸé¡¯ç¤º
            const urlSettings = document.querySelectorAll('.url-mode-settings');
            const uploadSettings = document.querySelectorAll('.upload-mode-settings');
            const urlSingleSettings = document.querySelectorAll('.url-single-mode-settings');
            
            urlSettings.forEach(el => {
                el.style.display = currentSourceMode === 'url' ? 'block' : 'none';
            });
            
            uploadSettings.forEach(el => {
                el.style.display = currentSourceMode === 'upload' ? 'block' : 'none';
            });
            
            urlSingleSettings.forEach(el => {
                el.style.display = currentSourceMode === 'url-single' ? 'block' : 'none';
            });
            
            // æ›´æ–°æ¨¡å¼æ¨™ç±¤
            const modeBadge = document.getElementById('current-mode-badge');
            if (modeBadge) {
                if (currentSourceMode === 'url') {
                    modeBadge.textContent = 'ğŸŒ URLæ¨¡å¼';
                    modeBadge.style.background = '#007bff';
                } else if (currentSourceMode === 'upload') {
                    modeBadge.textContent = 'ğŸ“ ä¸Šå‚³æ¨¡å¼';
                    modeBadge.style.background = '#28a745';
                } else if (currentSourceMode === 'url-single') {
                    modeBadge.textContent = 'ğŸ”— URLå–®å¼µæ¨¡å¼';
                    modeBadge.style.background = '#ff6b35';
                }
            }
        }
        
        // åˆå§‹åŒ–ç´ æåœ–ç‰‡ç®¡ç†å™¨
        function initializeMaterialImageManager() {
            if (!window.materialImageManager) {
                // ä¿®å¤åçš„ç´ æå›¾ç‰‡ç®¡ç†å™¨
                window.materialImageManager = {
    // ä½¿ç”¨ IndexedDB é€²è¡ŒæŒä¹…åŒ–å­˜å„²
    dbName: 'VNMaterialDB',
    dbVersion: 2, // å¢åŠ ç‰ˆæœ¬å·ä»¥è§¦å‘å‡çº§
    storeName: 'images',
    db: null,
    
    // åˆå§‹åŒ– IndexedDB
    async initDB() {
        return new Promise((resolve, reject) => {
            if (this.db) {
                resolve(this.db);
                return;
            }
            
            const request = indexedDB.open(this.dbName, this.dbVersion);
            
            request.onerror = () => {
                console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] IndexedDB æ‰“é–‹å¤±æ•—:', request.error);
                reject(request.error);
            };
            
            request.onsuccess = () => {
                this.db = request.result;
                console.log('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] IndexedDB åˆå§‹åŒ–æˆåŠŸ');
                resolve(this.db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // åˆ é™¤æ—§çš„å¯¹è±¡å­˜å‚¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (db.objectStoreNames.contains(this.storeName)) {
                    db.deleteObjectStore(this.storeName);
                    console.log('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åˆ é™¤æ—§çš„å¯¹è±¡å­˜å‚¨');
                }
                
                // åˆ›å»ºæ–°çš„å¯¹è±¡å­˜å‚¨ï¼Œä½¿ç”¨ id ä½œä¸ºä¸»é”®
                const store = db.createObjectStore(this.storeName, { 
                    keyPath: 'id', 
                    autoIncrement: true 
                });
                
                store.createIndex('category', 'category', { unique: false });
                store.createIndex('name', 'name', { unique: false });
                store.createIndex('label', 'label', { unique: false });
                
                console.log('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å‰µå»ºå°è±¡å­˜å„²:', this.storeName);
            };
        });
    },
                    
                                        // ä¸Šå‚³åœ–ç‰‡ - ä½¿ç”¨ Base64 å­˜å„²ï¼Œä½†ç¢ºä¿å®Œæ•´æ€§
                    async uploadImage(file, category) {
                        try {
                            await this.initDB();
                            
                            return new Promise(async (resolve, reject) => {
                                try {
                                    // å‹ç¼©å›¾ç‰‡
                                    const compressedFile = await this.compressImage(file);
                                    
                                    // è½¬æ¢ä¸º Base64ï¼Œä½†ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
                                    const reader = new FileReader();
                                    reader.onload = async (e) => {
                                        try {
                                            const base64Data = e.target.result;
                                            
                                            // éªŒè¯ Base64 æ•°æ®å®Œæ•´æ€§
                                            if (!base64Data || base64Data.length < 100) {
                                                throw new Error('Base64 æ•¸æ“šä¸å®Œæ•´');
                                            }
                                            
                                            const imageData = {
                                                // id ä¼šç”± autoIncrement è‡ªåŠ¨ç”Ÿæˆï¼Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®
                                                name: file.name,
                                                originalName: file.name,
                                                size: compressedFile.size,
                                                type: compressedFile.type,
                                                category: category || 'portrait',
                                                label: '',
                                                emotion: '',
                                                url: base64Data, // ä½¿ç”¨ Base64 æ•°æ®
                                                timestamp: Date.now()
                                            };
                                            
                                            console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] æº–å‚™ä¿å­˜åœ–ç‰‡: ${file.name}, æ ¼å¼: ${compressedFile.type}, Base64é•·åº¦: ${base64Data.length}`);
                                            
                                            const transaction = this.db.transaction([this.storeName], 'readwrite');
                                            const store = transaction.objectStore(this.storeName);
                                            
                                            // ç­‰å¾…äº‹åŠ¡å®Œæˆ
                                            transaction.oncomplete = () => {
                                                const result = { ...imageData, id: imageData.id };
                                                console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¸Šå‚³å£“ç¸®åœ–ç‰‡åˆ°IndexedDBæˆåŠŸ: ${file.name} (${category}), åŸå§‹å¤§å°: ${(file.size / 1024).toFixed(1)}KB, å£“ç¸®å¾Œ: ${(compressedFile.size / 1024).toFixed(1)}KB, æ ¼å¼: ${compressedFile.type}, Base64é•·åº¦: ${base64Data.length}`);
                                                resolve(result);
                                            };
                                            
                                            transaction.onerror = () => {
                                                console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] äº‹åŠ¡å¤±è´¥:', transaction.error);
                                                reject(transaction.error);
                                            };
                                            
                                            const request = store.add(imageData);
                                            
                                            request.onsuccess = () => {
                                                imageData.id = request.result;
                                            };
                                            
                                            request.onerror = () => {
                                                console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¿å­˜åœ–ç‰‡å¤±æ•—:', request.error);
                                                reject(request.error);
                                            };
                                        } catch (error) {
                                            reject(error);
                                        }
                                    };
                                    
                                    reader.onerror = () => {
                                        reject(new Error('è®€å–æ–‡ä»¶å¤±æ•—'));
                                    };
                                    
                                    reader.readAsDataURL(compressedFile);
                                } catch (error) {
                                    reject(error);
                                }
                            });
                        } catch (error) {
                            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¸Šå‚³åœ–ç‰‡å¤±æ•—:', error);
                            throw error;
                        }
                    },
    
                        // ä¸Šå‚³å¸¶æ¨™ç±¤çš„åœ–ç‰‡ - æ”¯æŒæ–‡ä»¶å’ŒURL
                    async uploadImageWithTag(imageData) {
                        try {
                            await this.initDB();
                            
                            return new Promise(async (resolve, reject) => {
                                try {
                                    // æª¢æŸ¥æ˜¯å¦ç‚ºURLé¡å‹åœ–ç‰‡
                                    if (imageData.type === 'url' && imageData.url) {
                                        // è™•ç†URLé¡å‹åœ–ç‰‡
                                        const enhancedImageData = {
                                            name: imageData.name || `URLåœ–ç‰‡_${Date.now()}`,
                                            originalName: imageData.name || `URLåœ–ç‰‡_${Date.now()}`,
                                            size: 0, // URLåœ–ç‰‡æ²’æœ‰æ–‡ä»¶å¤§å°
                                            type: 'url',
                                            category: imageData.category || 'portrait',
                                            label: imageData.tag || '',
                                            emotion: imageData.emotion || '',
                                            url: imageData.url, // ç›´æ¥ä½¿ç”¨URL
                                            timestamp: imageData.timestamp || Date.now()
                                        };
                                        
                                        console.log('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å‡†å¤‡ä¿å­˜URLå›¾ç‰‡æ•°æ®:', enhancedImageData);
                                        
                                        const transaction = this.db.transaction([this.storeName], 'readwrite');
                                        const store = transaction.objectStore(this.storeName);
                                        
                                        // ç­‰å¾…äº‹åŠ¡å®Œæˆ
                                        transaction.oncomplete = () => {
                                            const result = { ...enhancedImageData, id: enhancedImageData.id };
                                            console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¸Šå‚³URLåœ–ç‰‡åˆ°IndexedDBæˆåŠŸ: ${enhancedImageData.name} (${imageData.category}), ID: ${enhancedImageData.id}`);
                                            resolve(result);
                                        };
                                        
                                        transaction.onerror = () => {
                                            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] äº‹åŠ¡å¤±è´¥:', transaction.error);
                                            reject(transaction.error);
                                        };
                                        
                                        const request = store.add(enhancedImageData);
                                        
                                        request.onsuccess = () => {
                                            enhancedImageData.id = request.result;
                                        };
                                        
                                        request.onerror = () => {
                                            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¿å­˜URLåœ–ç‰‡å¤±æ•—:', request.error);
                                            reject(new Error(`ä¿å­˜å¤±è´¥: ${request.error?.message || 'Unknown error'}`));
                                        };
                                        
                                    } else {
                                        // è™•ç†æ–‡ä»¶é¡å‹åœ–ç‰‡
                                        const compressedFile = await this.compressImage(imageData.file);
                                        
                                        // è½¬æ¢ä¸º Base64ï¼Œä½†ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
                                        const reader = new FileReader();
                                        reader.onload = async (e) => {
                                            try {
                                                const base64Data = e.target.result;
                                                
                                                // éªŒè¯ Base64 æ•°æ®å®Œæ•´æ€§
                                                if (!base64Data || base64Data.length < 100) {
                                                    throw new Error('Base64 æ•¸æ“šä¸å®Œæ•´');
                                                }
                                                
                                                const enhancedImageData = {
                                                    // id ä¼šç”± autoIncrement è‡ªåŠ¨ç”Ÿæˆ
                                                    name: imageData.fileName || imageData.file.name,
                                                    originalName: imageData.file.name,
                                                    size: compressedFile.size,
                                                    type: compressedFile.type,
                                                    category: imageData.category || 'portrait',
                                                    label: imageData.label || '',
                                                    emotion: imageData.emotion || '',
                                                    url: base64Data, // ä½¿ç”¨ Base64 æ•°æ®
                                                    timestamp: imageData.timestamp || Date.now()
                                                };
                                                
                                                console.log('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å‡†å¤‡ä¿å­˜å‹ç¼©åçš„å¸¦æ ‡ç­¾å›¾ç‰‡æ•°æ®:', enhancedImageData);
                                                console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åŸå§‹å¤§å°: ${(imageData.file.size / 1024).toFixed(1)}KB, å£“ç¸®å¾Œ: ${(compressedFile.size / 1024).toFixed(1)}KB, æ ¼å¼: ${compressedFile.type}, Base64é•·åº¦: ${base64Data.length}`);
                                                
                                                const transaction = this.db.transaction([this.storeName], 'readwrite');
                                                const store = transaction.objectStore(this.storeName);
                                                
                                                // ç­‰å¾…äº‹åŠ¡å®Œæˆ
                                                transaction.oncomplete = () => {
                                                    const result = { ...enhancedImageData, id: enhancedImageData.id };
                                                    console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¸Šå‚³å£“ç¸®å¸¶æ¨™ç±¤åœ–ç‰‡åˆ°IndexedDBæˆåŠŸ: ${enhancedImageData.name} (${imageData.category}), ID: ${enhancedImageData.id}`);
                                                    resolve(result);
                                                };
                                                
                                                transaction.onerror = () => {
                                                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] äº‹åŠ¡å¤±è´¥:', transaction.error);
                                                    reject(transaction.error);
                                                };
                                                
                                                const request = store.add(enhancedImageData);
                                                
                                                request.onsuccess = () => {
                                                    enhancedImageData.id = request.result;
                                                };
                                                
                                                request.onerror = () => {
                                                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¿å­˜å¸¶æ¨™ç±¤åœ–ç‰‡å¤±æ•—:', request.error);
                                                    reject(new Error(`ä¿å­˜å¤±è´¥: ${request.error?.message || 'Unknown error'}`));
                                                };
                                            } catch (error) {
                                                console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å¤„ç†å›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                                                reject(error);
                                            }
                                        };
                                        
                                        reader.onerror = () => {
                                            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] è¯»å–æ–‡ä»¶å¤±è´¥');
                                            reject(new Error('è®€å–æ–‡ä»¶å¤±æ•—'));
                                        };
                                        
                                        reader.readAsDataURL(compressedFile);
                                    }
                                } catch (error) {
                                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å‹ç¼©å›¾ç‰‡å¤±è´¥:', error);
                                    reject(error);
                                }
                            });
                        } catch (error) {
                            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä¸Šå‚³å¸¶æ¨™ç±¤åœ–ç‰‡å¤±æ•—:', error);
                            throw error;
                        }
                    },
                    
                                        // ç²å–åˆ†é¡åœ–ç‰‡ - æ”¯æŒ Blob å’Œ URL æ ¼å¼
                    async getImagesByCategory(category, mode = null) {
                        try {
                            await this.initDB();
                            
                            return new Promise((resolve, reject) => {
                                const transaction = this.db.transaction([this.storeName], 'readonly');
                                const store = transaction.objectStore(this.storeName);
                                const index = store.index('category');
                                const request = index.getAll(category);
                                
                                request.onsuccess = () => {
                                    // å› ä¸ºä½¿ç”¨äº† keyPath: 'id'ï¼Œæ‰€ä»¥ id å·²ç»åŒ…å«åœ¨å¯¹è±¡ä¸­
                                    let images = request.result.sort((a, b) => b.timestamp - a.timestamp);
                                    
                                    // æ ¹æ“šæ¨¡å¼éæ¿¾åœ–ç‰‡
                                    if (mode === 'upload') {
                                        // ä¸Šå‚³æ¨¡å¼ï¼šåªè¿”å›Base64æ ¼å¼çš„åœ–ç‰‡
                                        images = images.filter(img => img.type !== 'url');
                                    } else if (mode === 'url-single') {
                                        // URLå–®å¼µæ¨¡å¼ï¼šåªè¿”å›URLæ ¼å¼çš„åœ–ç‰‡
                                        images = images.filter(img => img.type === 'url');
                                    }
                                    // å¦‚æœä¸æŒ‡å®šæ¨¡å¼ï¼Œè¿”å›æ‰€æœ‰åœ–ç‰‡
                                    
                                    console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å¾IndexedDBç²å– ${category} åˆ†é¡åœ–ç‰‡ (æ¨¡å¼: ${mode || 'all'}): ${images.length} å¼µ`);
                                    
                                    // å¤„ç†å›¾ç‰‡æ•°æ®ï¼ŒéªŒè¯ Base64 æ ¼å¼
                                    const processedImages = images.map((img, index) => {
                                        let processedImg = { ...img };
                                        
                                        if (img.url) {
                                            // æ£€æŸ¥å›¾ç‰‡ç±»å‹
                                            if (img.type === 'url') {
                                                // URLç±»å‹å›¾ç‰‡
                                                if (img.url.startsWith('http://') || img.url.startsWith('https://')) {
                                                    console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åœ–ç‰‡ ${index + 1}: ${img.name}, URLé¡å‹: ${img.url.substring(0, 50)}...`);
                                                } else {
                                                    console.warn(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åœ–ç‰‡ ${index + 1}: ${img.name}, URLæ ¼å¼ä¸æ­£ç¢º: ${img.url.substring(0, 50)}...`);
                                                }
                                            } else {
                                                // Base64ç±»å‹å›¾ç‰‡
                                                if (img.url.startsWith('data:image/')) {
                                                    console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åœ–ç‰‡ ${index + 1}: ${img.name}, Base64é•·åº¦: ${img.url.length}, æ ¼å¼: ${img.type}`);
                                                    
                                                    // éªŒè¯æ•°æ®é•¿åº¦
                                                    if (img.url.length < 100) {
                                                        console.error(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åœ–ç‰‡ ${index + 1}: ${img.name}, Base64æ•¸æ“šéçŸ­ï¼Œå¯èƒ½æå£`);
                                                    }
                                                    
                                                    // æ£€æŸ¥ç¯å¢ƒ
                                                    if (window.location.protocol === 'file:') {
                                                        console.warn(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] è­¦å‘Š: ç•¶å‰åœ¨ file:// å”è­°ä¸‹é‹è¡Œï¼Œå¯èƒ½å½±éŸ¿åœ–ç‰‡åŠ è¼‰`);
                                                    }
                                                    
                                                    if (window.location.href.includes('sandbox')) {
                                                        console.warn(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] è­¦å‘Š: ç•¶å‰åœ¨ sandbox ç’°å¢ƒä¸‹é‹è¡Œï¼Œå¯èƒ½å½±éŸ¿åœ–ç‰‡åŠ è¼‰`);
                                                    }
                                                } else {
                                                    console.warn(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åœ–ç‰‡ ${index + 1}: ${img.name}, Base64æ ¼å¼ä¸æ­£ç¢º: ${img.url.substring(0, 50)}...`);
                                                }
                                            }
                                        } else {
                                            console.warn(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åœ–ç‰‡ ${index + 1}: ${img.name}, ç„¡æœ‰æ•ˆæ•¸æ“š`);
                                        }
                                        
                                        return processedImg;
                                    });
                                    
                                    resolve(processedImages);
                                };
                                
                                request.onerror = () => {
                                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ç²å–åœ–ç‰‡å¤±æ•—:', request.error);
                                    reject(request.error);
                                };
                            });
                        } catch (error) {
                            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ç²å–åˆ†é¡åœ–ç‰‡å¤±æ•—:', error);
                            return [];
                        }
                    },
                    
                    // åˆªé™¤åœ–ç‰‡
                    async deleteImage(id) {
        try {
            await this.initDB();
            
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å¾IndexedDBåˆªé™¤åœ–ç‰‡ ID: ${id}`);
                    resolve(true);
                };
                
                request.onerror = () => {
                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åˆªé™¤åœ–ç‰‡å¤±æ•—:', request.error);
                    reject(request.error);
                };
            });
        } catch (error) {
            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åˆªé™¤åœ–ç‰‡å¤±æ•—:', error);
                        return false;
        }
    },
    
    // æ ¹æ“šæ¨™ç±¤æŸ¥æ‰¾åœ–ç‰‡
    async findImageByTag(category, label, emotion = '') {
        try {
            await this.initDB();
            
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const index = store.index('category');
                const request = index.getAll(category);
                
                request.onsuccess = () => {
                    const categoryImages = request.result.filter(img => 
                        img.label === label && 
                        (emotion === '' || img.emotion === emotion)
                    );
                    
                    // è¿”å›æœ€æ–°çš„åŒ¹é…å›¾ç‰‡
                    const matchedImage = categoryImages.sort((a, b) => b.timestamp - a.timestamp)[0] || null;
                    resolve(matchedImage);
                };
                
                request.onerror = () => {
                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] æŸ¥æ‰¾åœ–ç‰‡å¤±æ•—:', request.error);
                    reject(request.error);
                };
            });
        } catch (error) {
            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] æ ¹æ“šæ¨™ç±¤æŸ¥æ‰¾åœ–ç‰‡å¤±æ•—:', error);
            return null;
        }
                    },
                    
                    // é‡‹æ”¾Blob URLï¼ˆç°¡å–®å¯¦ç¾ï¼‰
                    releaseBlobURL(url) {
                        // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æ‡‰è©²é‡‹æ”¾Blob URL
                        console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] é‡‹æ”¾URL: ${url}`);
                    },

                    // åœ–ç‰‡å£“ç¸®æ–¹æ³• - ä¿®å¾©æ ¼å¼åŒ¹é…å•é¡Œ
                    async compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
                        return new Promise((resolve, reject) => {
                            console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] é–‹å§‹å£“ç¸®åœ–ç‰‡: ${(file.size / 1024).toFixed(1)}KB, åŸå§‹æ ¼å¼: ${file.type}`);
                            
                            // æ ¹æ®æ–‡ä»¶åç¡®å®šè¾“å‡ºæ ¼å¼ï¼Œç¡®ä¿ä¸€è‡´æ€§
                            const fileName = file.name.toLowerCase();
                            let outputFormat = 'image/png'; // é»˜è®¤ä½¿ç”¨ PNG ä»¥ä¿æŒé€æ˜
                            
                            // åªæœ‰æ˜ç¡®æ˜¯ JPG æ–‡ä»¶æ‰ä½¿ç”¨ JPEG æ ¼å¼
                            if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg')) {
                                outputFormat = 'image/jpeg';
                            }
                            // PNG å’Œå…¶ä»–æ ¼å¼éƒ½ä½¿ç”¨ PNG ä»¥ä¿æŒé€æ˜
                            
                            // æ ¹æ®æ–‡ä»¶å¤§å°å’Œæ ¼å¼è°ƒæ•´å‹ç¼©å‚æ•°
                            let finalQuality = quality;
                            let finalMaxWidth = maxWidth;
                            let finalMaxHeight = maxHeight;
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸º PNG æ–‡ä»¶
                            const isPNG = fileName.endsWith('.png') || file.type === 'image/png';
                            
                            if (file.size > 2 * 1024 * 1024) { // è¶…è¿‡2MB
                                finalQuality = isPNG ? 0.8 : 0.5; // PNG ä½¿ç”¨æ›´é«˜è´¨é‡
                                finalMaxWidth = 600;
                                finalMaxHeight = 450;
                            } else if (file.size > 1024 * 1024) { // è¶…è¿‡1MB
                                finalQuality = isPNG ? 0.8 : 0.6; // PNG ä½¿ç”¨æ›´é«˜è´¨é‡
                                finalMaxWidth = 700;
                                finalMaxHeight = 525;
                            } else if (file.size > 500 * 1024) { // è¶…è¿‡500KB
                                finalQuality = isPNG ? 0.8 : 0.7; // PNG ä½¿ç”¨æ›´é«˜è´¨é‡
                                finalMaxWidth = 750;
                                finalMaxHeight = 562;
                            } else {
                                // å°æ–‡ä»¶ä½¿ç”¨æ›´é«˜è´¨é‡
                                finalQuality = isPNG ? 0.9 : 0.8;
                            }
                            
                            console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] ä½¿ç”¨å£“ç¸®åƒæ•¸: ${finalMaxWidth}x${finalMaxHeight}, è³ªé‡: ${finalQuality}, è¼¸å‡ºæ ¼å¼: ${outputFormat} (åŸºæ–¼æ–‡ä»¶å: ${file.name})`);
                            
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const img = new Image();
                            
                            img.onload = function() {
                                try {
                                    // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
                                    let { width, height } = this.calculateCompressedSize(img.width, img.height, finalMaxWidth, finalMaxHeight);
                                    
                                    canvas.width = width;
                                    canvas.height = height;
                                    
                                    // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡ - ä¿æŒé€æ˜èƒŒæ™¯
                                    ctx.clearRect(0, 0, width, height); // æ¸…é™¤ä¸ºé€æ˜
                                    ctx.drawImage(img, 0, 0, width, height);
                                    
                                    // è½¬æ¢ä¸ºBlobï¼Œä¿æŒåŸå§‹æ ¼å¼
                                    canvas.toBlob((blob) => {
                                        if (blob) {
                                            console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å£“ç¸®å®Œæˆ: ${img.width}x${img.height} -> ${width}x${height}, ${(file.size / 1024).toFixed(1)}KB -> ${(blob.size / 1024).toFixed(1)}KB`);
                                            console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] Blobè©³æƒ…: å¤§å° ${blob.size}, é¡å‹ ${blob.type}, è¼¸å‡ºæ ¼å¼ ${outputFormat}`);
                                            
                                            // åˆ›å»ºæ–°çš„æ–‡ä»¶å¯¹è±¡ï¼Œä¿æŒåŸå§‹æ ¼å¼
                                            const compressedFile = new File([blob], file.name, {
                                                type: outputFormat,
                                                lastModified: Date.now()
                                            });
                                            
                                            console.log(`[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å£“ç¸®æ–‡ä»¶è©³æƒ…: å¤§å° ${compressedFile.size}, é¡å‹ ${compressedFile.type}, åç¨± ${compressedFile.name}`);
                                            
                                            resolve(compressedFile);
                                        } else {
                                            console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å£“ç¸®å¤±æ•—ï¼Œè¿”å›åŸæ–‡ä»¶');
                                            resolve(file); // å‹ç¼©å¤±è´¥æ—¶è¿”å›åŸæ–‡ä»¶
                                        }
                                    }, outputFormat, finalQuality);
                                    
                                } catch (error) {
                                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å£“ç¸®éç¨‹å‡ºéŒ¯:', error);
                                    resolve(file); // å‡ºé”™æ—¶è¿”å›åŸæ–‡ä»¶
                                }
                            }.bind(this);
                            
                            img.onerror = () => {
                                console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] åœ–ç‰‡åŠ è¼‰å¤±æ•—ï¼Œè¿”å›åŸæ–‡ä»¶');
                                resolve(file); // åŠ è½½å¤±è´¥æ—¶è¿”å›åŸæ–‡ä»¶
                            };
                            
                            // åˆ›å»ºå›¾ç‰‡URL
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                img.src = e.target.result;
                            };
                            reader.onerror = () => {
                                console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] æ–‡ä»¶è®€å–å¤±æ•—ï¼Œè¿”å›åŸæ–‡ä»¶');
                                resolve(file); // è¯»å–å¤±è´¥æ—¶è¿”å›åŸæ–‡ä»¶
                            };
                            reader.readAsDataURL(file);
                        });
                    },

                    // è®¡ç®—å‹ç¼©å°ºå¯¸
                    calculateCompressedSize(originalWidth, originalHeight, maxWidth, maxHeight) {
                        let width = originalWidth;
                        let height = originalHeight;
                        
                        // å¦‚æœå›¾ç‰‡è¿‡å¤§ï¼ŒæŒ‰æ¯”ä¾‹ç¼©æ”¾
                        if (width > maxWidth || height > maxHeight) {
                            const widthRatio = maxWidth / width;
                            const heightRatio = maxHeight / height;
                            const ratio = Math.min(widthRatio, heightRatio);
                            
                            width = Math.floor(width * ratio);
                            height = Math.floor(height * ratio);
                        }
                        
                        return { width, height };
                    }
};  
                console.log('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] å·²åˆå§‹åŒ–');
                
                // åˆå§‹åŒ–æ•°æ®åº“å¹¶é¢„åŠ è½½å›¾ç‰‡
                window.materialImageManager.initDB().then(() => {
                    console.log('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] IndexedDB åˆå§‹åŒ–å®Œæˆ');
                }).catch(error => {
                    console.error('[ç´ æåœ–ç‰‡ç®¡ç†å™¨] IndexedDB åˆå§‹åŒ–å¤±æ•—:', error);
                });
            }
        }

        // ç‚ºæ‰€æœ‰ç´ æé¡åˆ¥è¨­ç½®ä¸Šå‚³åŠŸèƒ½
        function setupAllUploadFunctions() {
            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (window.uploadFunctionsInitialized) {
                console.log('[VNé¢æ¿] ä¸Šä¼ åŠŸèƒ½å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                return;
            }
            window.uploadFunctionsInitialized = true;
            // é è¨­åœ–ç‰‡ä¸Šå‚³
            const portraitUploadBtn = document.getElementById('portrait-upload-btn');
            const portraitFileInput = document.getElementById('portrait-file-input');
            const portraitUploadArea = document.getElementById('portrait-upload-area');
            
            if (portraitUploadBtn && portraitFileInput) {
                portraitUploadBtn.addEventListener('click', () => portraitFileInput.click());
                portraitFileInput.addEventListener('change', (e) => handleImageUpload(e, 'portrait'));
                setupDragAndDrop(portraitUploadArea, portraitFileInput);
            }
            
            // è§’è‰²åœ–ç‰‡ä¸Šå‚³
            const characterImgUploadBtn = document.getElementById('character-img-upload-btn');
            const characterImgFileInput = document.getElementById('character-img-file-input');
            const characterImgUploadArea = document.getElementById('character-img-upload-area');
            
            if (characterImgUploadBtn && characterImgFileInput) {
                characterImgUploadBtn.addEventListener('click', () => characterImgFileInput.click());
                characterImgFileInput.addEventListener('change', (e) => handleImageUpload(e, 'character-img'));
                setupDragAndDrop(characterImgUploadArea, characterImgFileInput);
            }
            
            // èƒŒæ™¯åœ–ç‰‡ä¸Šå‚³
            const backgroundUploadBtn = document.getElementById('background-upload-btn');
            const backgroundFileInput = document.getElementById('background-file-input');
            const backgroundUploadArea = document.getElementById('background-upload-area');
            
            if (backgroundUploadBtn && backgroundFileInput) {
                backgroundUploadBtn.addEventListener('click', () => backgroundFileInput.click());
                backgroundFileInput.addEventListener('change', (e) => handleImageUpload(e, 'background'));
                setupDragAndDrop(backgroundUploadArea, backgroundFileInput);
            }
            
            // è²¼åœ–ä¸Šå‚³
            const stickerUploadBtn = document.getElementById('sticker-upload-btn');
            const stickerFileInput = document.getElementById('sticker-file-input');
            const stickerUploadArea = document.getElementById('sticker-upload-area');
            
            if (stickerUploadBtn && stickerFileInput) {
                stickerUploadBtn.addEventListener('click', () => stickerFileInput.click());
                stickerFileInput.addEventListener('change', (e) => handleImageUpload(e, 'sticker'));
                setupDragAndDrop(stickerUploadArea, stickerFileInput);
            }
            
            // ç‰©å“åœ–ç‰‡ä¸Šå‚³
            const itemImgUploadBtn = document.getElementById('item-img-upload-btn');
            const itemImgFileInput = document.getElementById('item-img-file-input');
            const itemImgUploadArea = document.getElementById('item-img-upload-area');
            
            if (itemImgUploadBtn && itemImgFileInput) {
                itemImgUploadBtn.addEventListener('click', () => itemImgFileInput.click());
                itemImgFileInput.addEventListener('change', (e) => handleImageUpload(e, 'item-img'));
                setupDragAndDrop(itemImgUploadArea, itemImgFileInput);
            }
            
            // ç‰©å“é¡å‹ä¸Šå‚³
            const itemTypeUploadBtn = document.getElementById('item-type-upload-btn');
            const itemTypeFileInput = document.getElementById('item-type-file-input');
            const itemTypeUploadArea = document.getElementById('item-type-upload-area');
            
            if (itemTypeUploadBtn && itemTypeFileInput) {
                itemTypeUploadBtn.addEventListener('click', () => itemTypeFileInput.click());
                itemTypeFileInput.addEventListener('change', (e) => handleImageUpload(e, 'item-type'));
                setupDragAndDrop(itemTypeUploadArea, itemTypeFileInput);
            }
            
            // URLåœ–ç‰‡æ·»åŠ æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            const urlAddButtons = [
                { id: 'portrait-url-add-btn', category: 'portrait' },
                { id: 'character-img-url-add-btn', category: 'character-img' },
                { id: 'background-url-add-btn', category: 'background' },
                { id: 'sticker-url-add-btn', category: 'sticker' },
                { id: 'item-img-url-add-btn', category: 'item-img' },
                { id: 'item-type-url-add-btn', category: 'item-type' }
            ];
            
            urlAddButtons.forEach(({ id, category }) => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', () => handleUrlImageAdd(category));
                }
            });
            
            // è¼‰å…¥å·²ä¸Šå‚³çš„åœ–ç‰‡
            loadUploadedImages();
        }

        // åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½ï¼ˆä¿ç•™å‡½æ•¸ä»¥ç¶­æŒå…¼å®¹æ€§ï¼‰
        function initializeImageUpload() {
            // é€™å€‹å‡½æ•¸ç¾åœ¨ç”± setupAllUploadFunctions è™•ç†
            console.log('[ç´ æè¨­ç½®] åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        }
        
        // è™•ç†åœ–ç‰‡ä¸Šå‚³
        async function handleImageUpload(event, category) {
            console.log(`[VNé¢æ¿] å¼€å§‹å¤„ç†å›¾ç‰‡ä¸Šä¼ : ${category}, æ–‡ä»¶æ•°é‡: ${event.target.files.length}`);
            
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            try {
                for (const file of files) {
                    // é¡¯ç¤ºåœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£
                    if (window.showImageTagModal) {
                        window.showImageTagModal(file, category);
                    } else {
                        // å¦‚æœæ¨™ç±¤æ¨¡æ…‹çª—å£ä¸å¯ç”¨ï¼Œä½¿ç”¨èˆŠçš„æ–¹å¼
                        const tag = await showTagInputDialog(category, file.name);
                        if (tag) {
                            await uploadImageToIndexedDB(file, category, tag);
                        }
                    }
                }
                
                // æ¸…ç©ºæ–‡ä»¶è¼¸å…¥
                event.target.value = '';
                
                console.log(`[ç´ æè¨­ç½®] è™•ç† ${files.length} å¼µåœ–ç‰‡ä¸Šå‚³åˆ° ${category} åˆ†é¡å®Œæˆ`);
                
            } catch (error) {
                console.error('[ç´ æè¨­ç½®] åœ–ç‰‡ä¸Šå‚³å¤±æ•—:', error);
                alert(`åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ${error.message}`);
            }
        }
        
        // ä¸Šå‚³åœ–ç‰‡åˆ°IndexedDB
        async function uploadImageToIndexedDB(file, category) {
            if (!window.materialImageManager) {
                throw new Error('ç´ æåœ–ç‰‡ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }
            
            return await window.materialImageManager.uploadImage(file, category);
        }
        
        // è™•ç†URLåœ–ç‰‡æ·»åŠ 
        async function handleUrlImageAdd(category) {
            const urlInput = document.getElementById(`${category}-url-input`);
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('è«‹è¼¸å…¥åœ–ç‰‡URL');
                return;
            }
            
            // é©—è­‰URLæ ¼å¼
            if (!isValidImageUrl(url)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡URL');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const addBtn = document.getElementById(`${category}-url-add-btn`);
            const originalText = addBtn.textContent;
            addBtn.textContent = 'æ·»åŠ ä¸­...';
            addBtn.disabled = true;
            
            try {
                // é©—è­‰åœ–ç‰‡æ˜¯å¦å¯ä»¥è¼‰å…¥
                await validateImageUrl(url);
                
                // é¡¯ç¤ºåœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£
                if (window.showImageTagModal) {
                    // å‰µå»ºä¸€å€‹æ¨¡æ“¬çš„Fileå°è±¡ï¼Œæ¨™è¨˜ç‚ºURLé¡å‹
                    const fakeFile = {
                        name: `url_image_${Date.now()}.jpg`,
                        type: 'url', // æ¨™è¨˜ç‚ºURLé¡å‹
                        size: 0,
                        url: url
                    };
                    window.showImageTagModal(fakeFile, category);
                } else {
                    // å¦‚æœæ¨™ç±¤æ¨¡æ…‹çª—å£ä¸å¯ç”¨ï¼Œä½¿ç”¨èˆŠçš„æ–¹å¼
                    const tag = await showTagInputDialog(category, `URLåœ–ç‰‡_${Date.now()}`);
                    if (tag) {
                        await addUrlImageToIndexedDB(url, category, tag);
                    }
                }
                
                // æ¸…ç©ºè¼¸å…¥æ¡†
                urlInput.value = '';
                
            } catch (error) {
                console.error('[ç´ æè¨­ç½®] URLåœ–ç‰‡æ·»åŠ å¤±æ•—:', error);
                alert(`URLåœ–ç‰‡æ·»åŠ å¤±æ•—: ${error.message}`);
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                addBtn.textContent = originalText;
                addBtn.disabled = false;
            }
        }
        
        // é©—è­‰åœ–ç‰‡URLæ ¼å¼
        function isValidImageUrl(url) {
            try {
                const urlObj = new URL(url);
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
                const pathname = urlObj.pathname.toLowerCase();
                return imageExtensions.some(ext => pathname.endsWith(ext)) || 
                       url.includes('catbox.moe') || 
                       url.includes('imgur.com') ||
                       url.includes('i.imgur.com');
            } catch {
                return false;
            }
        }
        
        // é©—è­‰åœ–ç‰‡URLæ˜¯å¦å¯ä»¥è¼‰å…¥
        function validateImageUrl(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve();
                img.onerror = () => reject(new Error('ç„¡æ³•è¼‰å…¥åœ–ç‰‡ï¼Œè«‹æª¢æŸ¥URLæ˜¯å¦æ­£ç¢º'));
                img.src = url;
            });
        }
        
        // æ·»åŠ URLåœ–ç‰‡åˆ°IndexedDB
        async function addUrlImageToIndexedDB(url, category, tag) {
            if (!window.materialImageManager) {
                throw new Error('ç´ æåœ–ç‰‡ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }
            
            // å‰µå»ºåœ–ç‰‡æ•¸æ“šå°è±¡
            const imageData = {
                url: url,
                name: `URLåœ–ç‰‡_${Date.now()}`,
                category: category,
                tag: tag,
                type: 'url'
            };
            
            return await window.materialImageManager.uploadImageWithTag(imageData);
        }
        
        // è¼‰å…¥å·²ä¸Šå‚³çš„åœ–ç‰‡
        async function loadUploadedImages() {
            if (!window.materialImageManager) return;
            
            // ç²å–ç•¶å‰æ¨¡å¼
            const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
            const currentMode = savedSettings.sourceMode || 'url';
            
            try {
                if (currentMode === 'upload') {
                    // ä¸Šå‚³æ¨¡å¼ï¼šè¼‰å…¥Base64æ ¼å¼çš„åœ–ç‰‡
                    const portraitImages = await window.materialImageManager.getImagesByCategory('portrait', 'upload');
                    renderImageList('portrait-image-list', portraitImages, 'portrait');
                    
                    const characterImgImages = await window.materialImageManager.getImagesByCategory('character-img', 'upload');
                    renderImageList('character-img-image-list', characterImgImages, 'character-img');
                    
                    const backgroundImages = await window.materialImageManager.getImagesByCategory('background', 'upload');
                    renderImageList('background-image-list', backgroundImages, 'background');
                    
                    const stickerImages = await window.materialImageManager.getImagesByCategory('sticker', 'upload');
                    renderImageList('sticker-image-list', stickerImages, 'sticker');
                    
                    const itemImgImages = await window.materialImageManager.getImagesByCategory('item-img', 'upload');
                    renderImageList('item-img-image-list', itemImgImages, 'item-img');
                    
                    const itemTypeImages = await window.materialImageManager.getImagesByCategory('item-type', 'upload');
                    renderImageList('item-type-image-list', itemTypeImages, 'item-type');
                    
                } else if (currentMode === 'url-single') {
                    // URLå–®å¼µæ¨¡å¼ï¼šè¼‰å…¥URLæ ¼å¼çš„åœ–ç‰‡
                    const portraitImages = await window.materialImageManager.getImagesByCategory('portrait', 'url-single');
                    renderImageList('portrait-url-image-list', portraitImages, 'portrait');
                    
                    const characterImgImages = await window.materialImageManager.getImagesByCategory('character-img', 'url-single');
                    renderImageList('character-img-url-image-list', characterImgImages, 'character-img');
                    
                    const backgroundImages = await window.materialImageManager.getImagesByCategory('background', 'url-single');
                    renderImageList('background-url-image-list', backgroundImages, 'background');
                    
                    const stickerImages = await window.materialImageManager.getImagesByCategory('sticker', 'url-single');
                    renderImageList('sticker-url-image-list', stickerImages, 'sticker');
                    
                    const itemImgImages = await window.materialImageManager.getImagesByCategory('item-img', 'url-single');
                    renderImageList('item-img-url-image-list', itemImgImages, 'item-img');
                    
                    const itemTypeImages = await window.materialImageManager.getImagesByCategory('item-type', 'url-single');
                    renderImageList('item-type-url-image-list', itemTypeImages, 'item-type');
                }
                
            } catch (error) {
                console.error('[ç´ æè¨­ç½®] è¼‰å…¥åœ–ç‰‡å¤±æ•—:', error);
            }
        }
        
        // æ¸²æŸ“åœ–ç‰‡åˆ—è¡¨
        function renderImageList(containerId, images, category) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (images.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-color-muted); padding: 20px;">æš«ç„¡ä¸Šå‚³çš„åœ–ç‰‡</div>';
                return;
            }
            
            container.innerHTML = images.map(image => {
                // æ ¹æ“šåœ–ç‰‡é¡å‹é¡¯ç¤ºä¸åŒçš„ä¿¡æ¯
                const isUrlImage = image.type === 'url';
                const sizeText = isUrlImage ? 'URLåœ–ç‰‡' : `${(image.size / 1024).toFixed(1)} KB`;
                
                return `
                <div class="image-item" data-id="${image.id}">
                    <img src="${image.url}" alt="${image.name}" class="image-preview" onclick="previewImage('${image.url}', '${image.name}')">
                    <div class="image-info">
                        <div class="image-name">${image.name}</div>
                        <div class="image-size">${sizeText}</div>
                    </div>
                    <div class="image-actions">
                        <button class="image-action-btn delete" onclick="deleteImage(${image.id}, '${category}')" title="åˆªé™¤">Ã—</button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // é è¦½åœ–ç‰‡
        function previewImage(url, name) {
            // å‰µå»ºåœ–ç‰‡é è¦½æ¨¡æ…‹çª—å£
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="text-align: center;">
                    <img src="${url}" alt="${name}" style="max-width: 90vw; max-height: 90vh; object-fit: contain;">
                    <div style="color: white; margin-top: 10px; font-size: 14px;">${name}</div>
                </div>
            `;
            
            modal.addEventListener('click', () => {
                document.body.removeChild(modal);
                if (window.materialImageManager) {
                    window.materialImageManager.releaseBlobURL(url);
                }
            });
            
            document.body.appendChild(modal);
        }
        
        // åˆªé™¤åœ–ç‰‡
        async function deleteImage(id, category) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ')) return;
            
            try {
                if (!window.materialImageManager) {
                    throw new Error('ç´ æåœ–ç‰‡ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }
                
                await window.materialImageManager.deleteImage(id);
                await loadUploadedImages();
                
                console.log(`[ç´ æè¨­ç½®] æˆåŠŸåˆªé™¤åœ–ç‰‡ ${id}`);
                
            } catch (error) {
                console.error('[ç´ æè¨­ç½®] åˆªé™¤åœ–ç‰‡å¤±æ•—:', error);
                alert(`åˆªé™¤åœ–ç‰‡å¤±æ•—: ${error.message}`);
            }
        }
        
        // è¨­ç½®æ‹–æ‹½ä¸Šå‚³
        function setupDragAndDrop(uploadArea, fileInput) {
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
                                   }

            // ä¿å­˜ç´ æè¨­ç½®
            function saveMaterialSettings() {
                const settings = {
                    // ä¿å­˜å½“å‰æ¨¡å¼è®¾ç½®
                    sourceMode: currentSourceMode || 'url',
                    portrait: {
                        baseUrl: portraitBaseUrlInput.value.trim(),
                        format: portraitFormatInput.value.trim()
                    },
                    bgm: {
                        baseUrl: bgmBaseUrlInput.value.trim(),
                        format: bgmFormatInput.value.trim()
                    },
                    soundEffect: {
                        baseUrl: soundEffectBaseUrlInput.value.trim(),
                        format: soundEffectFormatInput.value.trim()
                    },
                    characterImg: {
                        baseUrl: characterImgBaseUrlInput.value.trim(),
                        format: characterImgFormatInput.value.trim()
                    },
                    background: {
                        baseUrl: backgroundBaseUrlInput.value.trim(),
                        fallbackUrl: backgroundFallbackUrlInput.value.trim(),
                        format: backgroundFormatInput.value.trim()
                    },
                    areaGif: {
                        baseUrl: areaGifBaseUrlInput.value.trim(),
                        format: areaGifFormatInput.value.trim()
                    },
                    sticker: {
                        baseUrl: stickerBaseUrlInput.value.trim(),
                        defaultUrl: stickerDefaultUrlInput.value.trim(),
                        format: stickerFormatInput.value.trim()
                    },
                    itemImg: {
                        baseUrl: itemImgBaseUrlInput.value.trim(),
                        format: itemImgFormatInput.value.trim()
                    },
                    itemType: {
                        baseUrl: itemTypeBaseUrlInput.value.trim(),
                        format: itemTypeFormatInput.value.trim()
                    },
                    timestamp: Date.now()
                };
                
                localStorage.setItem('vn_material_settings', JSON.stringify(settings));
                console.log('[VNé¢æ¿] ç´ æè¨­ç½®å·²ä¿å­˜:', settings);
                
                // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                if (window.showCustomAlert) {
                    window.showCustomAlert('ä¿å­˜æˆåŠŸ', 'ç´ æè¨­ç½®å·²ä¿å­˜ï¼');
                } else {
                    alert('ç´ æè¨­ç½®å·²ä¿å­˜ï¼');
                }
            }

            // ç”Ÿæˆç«‹ç¹ªURLï¼ˆé è¨­è¨­ç½®ï¼‰
            async function generatePortraitUrl(characterName) {
                // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ä¸Šå‚³æ¨¡å¼
                const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
                const isUploadMode = savedSettings.sourceMode === 'upload';
                
                if ((isUploadMode || currentSourceMode === 'url-single') && window.materialImageManager) {
                    // ä¸Šå‚³æ¨¡å¼æˆ–URLå–®å¼µæ¨¡å¼ï¼šå¾IndexedDBç²å–é è¨­åœ–ç‰‡
                    try {
                        const mode = currentSourceMode === 'url-single' ? 'url-single' : 'upload';
                        const images = await window.materialImageManager.getImagesByCategory('portrait', mode);
                        
                        // æ§‹å»ºæœç´¢æ–‡ä»¶å
                        const cleanCharacterName = characterName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                        const searchFileName = cleanCharacterName;
                        
                        // æŸ¥æ‰¾åŒ¹é…çš„åœ–ç‰‡
                        const matchedImage = images.find(img => {
                            const imgName = img.name.replace(/\.[^/.]+$/, ''); // ç§»é™¤æ–‡ä»¶æ“´å±•å
                            return imgName === searchFileName || imgName.includes(searchFileName);
                        });
                        
                        if (matchedImage) {
                            console.log('[VNMaterialProcessor] å¾IndexedDBæ‰¾åˆ°é è¨­åœ–ç‰‡:', matchedImage.name, 'é¡å‹:', matchedImage.type);
                            return matchedImage.url;
                        } else {
                            console.warn('[VNMaterialProcessor] IndexedDBä¸­æœªæ‰¾åˆ°é è¨­åœ–ç‰‡ï¼Œä½¿ç”¨é è¨­URL:', searchFileName);
                        }
                    } catch (error) {
                        console.error('[VNMaterialProcessor] å¾IndexedDBç²å–é è¨­åœ–ç‰‡å¤±æ•—:', error);
                    }
                }
                
                // URLæ¨¡å¼æˆ–IndexedDBæœªæ‰¾åˆ°ï¼šä½¿ç”¨URLæ§‹å»º
                const baseUrl = portraitBaseUrlInput.value.trim();
                const format = portraitFormatInput.value.trim();
                
                if (!baseUrl || !characterName) {
                    return null;
                }
                
                // æ¸…ç†è§’è‰²åï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanCharacterName = characterName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const portraitUrl = baseUrl + cleanCharacterName + format;
                
                console.log('[VNé¢æ¿] ç”Ÿæˆç«‹ç¹ªURL:', {
                    characterName: characterName,
                    cleanName: cleanCharacterName,
                    url: portraitUrl,
                    mode: isUploadMode ? 'upload' : 'url'
                });
                
                return portraitUrl;
            }

            // ç”ŸæˆBGM URL
            function generateBgmUrl(bgmName) {
                const baseUrl = bgmBaseUrlInput.value.trim();
                const format = bgmFormatInput.value.trim();
                
                if (!baseUrl || !bgmName) {
                    return null;
                }
                
                // æ¸…ç†BGMåç¨±ï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanBgmName = bgmName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const bgmUrl = baseUrl + cleanBgmName + format;
                
                console.log('[VNé¢æ¿] ç”ŸæˆBGM URL:', {
                    bgmName: bgmName,
                    cleanName: cleanBgmName,
                    url: bgmUrl
                });
                
                return bgmUrl;
            }

            // ç”ŸæˆéŸ³æ•ˆURL
            function generateSoundEffectUrl(soundEffectName) {
                const baseUrl = soundEffectBaseUrlInput.value.trim();
                const format = soundEffectFormatInput.value.trim();
                
                if (!baseUrl || !soundEffectName) {
                    return null;
                }
                
                // æ¸…ç†éŸ³æ•ˆåç¨±ï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanSoundEffectName = soundEffectName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const soundEffectUrl = baseUrl + cleanSoundEffectName + format;
                
                console.log('[VNé¢æ¿] ç”ŸæˆéŸ³æ•ˆURL:', {
                    soundEffectName: soundEffectName,
                    cleanName: cleanSoundEffectName,
                    url: soundEffectUrl
                });
                
                return soundEffectUrl;
            }

            // ç”Ÿæˆè§’è‰²åœ–ç‰‡URL
            function generateCharacterImgUrl(characterName, emotion = '') {
                const baseUrl = characterImgBaseUrlInput.value.trim();
                const format = characterImgFormatInput.value.trim();
                
                if (!baseUrl || !characterName) {
                    return null;
                }
                
                // æ¸…ç†è§’è‰²åå’Œè¡¨æƒ…ï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanCharacterName = characterName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const cleanEmotion = emotion.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                
                let characterImgUrl;
                if (emotion && cleanEmotion) {
                    characterImgUrl = baseUrl + cleanCharacterName + '_' + cleanEmotion + format;
                } else {
                    characterImgUrl = baseUrl + cleanCharacterName + format;
                }
                
                console.log('[VNé¢æ¿] ç”Ÿæˆè§’è‰²åœ–ç‰‡URL:', {
                    characterName: characterName,
                    emotion: emotion,
                    cleanName: cleanCharacterName,
                    cleanEmotion: cleanEmotion,
                    url: characterImgUrl
                });
                
                return characterImgUrl;
            }

            // ç”ŸæˆèƒŒæ™¯åœ–ç‰‡URL
            function generateBackgroundUrl(locationName) {
                const baseUrl = backgroundBaseUrlInput.value.trim();
                const format = backgroundFormatInput.value.trim();
                
                if (!baseUrl || !locationName) {
                    return null;
                }
                
                // æ¸…ç†åœ°é»åï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanLocationName = locationName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const backgroundUrl = baseUrl + cleanLocationName + format;
                
                console.log('[VNé¢æ¿] ç”ŸæˆèƒŒæ™¯åœ–ç‰‡URL:', {
                    locationName: locationName,
                    cleanName: cleanLocationName,
                    url: backgroundUrl
                });
                
                return backgroundUrl;
            }

            // ç”ŸæˆArea GIF URL
            function generateAreaGifUrl(areaName) {
                const baseUrl = areaGifBaseUrlInput.value.trim();
                const format = areaGifFormatInput.value.trim();
                
                if (!baseUrl || !areaName) {
                    return null;
                }
                
                // æ¸…ç†å€åŸŸåï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanAreaName = areaName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const areaGifUrl = baseUrl + cleanAreaName + format;
                
                console.log('[VNé¢æ¿] ç”ŸæˆArea GIF URL:', {
                    areaName: areaName,
                    cleanName: cleanAreaName,
                    url: areaGifUrl
                });
                
                return areaGifUrl;
            }

            // ç”Ÿæˆè²¼åœ–URL
            function generateStickerUrl(stickerName) {
                const baseUrl = stickerBaseUrlInput.value.trim();
                const format = stickerFormatInput.value.trim();
                
                if (!baseUrl || !stickerName) {
                    return null;
                }
                
                // æ¸…ç†è²¼åœ–åï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanStickerName = stickerName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const stickerUrl = baseUrl + cleanStickerName + format;
                
                console.log('[VNé¢æ¿] ç”Ÿæˆè²¼åœ–URL:', {
                    stickerName: stickerName,
                    cleanName: cleanStickerName,
                    url: stickerUrl
                });
                
                return stickerUrl;
            }

            // ç”Ÿæˆç‰©å“åœ–ç‰‡URL
            function generateItemImgUrl(itemName) {
                const baseUrl = itemImgBaseUrlInput.value.trim();
                const format = itemImgFormatInput.value.trim();
                
                if (!baseUrl || !itemName) {
                    return null;
                }
                
                // æ¸…ç†ç‰©å“åç¨±ï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanItemName = itemName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const itemImgUrl = baseUrl + cleanItemName + format;
                
                console.log('[VNé¢æ¿] ç”Ÿæˆç‰©å“åœ–ç‰‡URL:', {
                    itemName: itemName,
                    cleanName: cleanItemName,
                    url: itemImgUrl
                });
                
                return itemImgUrl;
            }

            // ç”Ÿæˆç‰©å“é¡å‹URL
            function generateItemTypeUrl(itemTypeName) {
                const baseUrl = itemTypeBaseUrlInput.value.trim();
                const format = itemTypeFormatInput.value.trim();
                
                if (!baseUrl || !itemTypeName) {
                    return null;
                }
                
                // æ¸…ç†ç‰©å“é¡å‹åï¼ˆä¿ç•™ä¸‹åº•ç·šå’Œé€£å­—ç¬¦ï¼Œç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼‰
                const cleanItemTypeName = itemTypeName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const itemTypeUrl = baseUrl + cleanItemTypeName + format;
                
                console.log('[VNé¢æ¿] ç”Ÿæˆç‰©å“é¡å‹URL:', {
                    itemTypeName: itemTypeName,
                    cleanName: cleanItemTypeName,
                    url: itemTypeUrl
                });
                
                return itemTypeUrl;
            }

            // æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶å·²åœ¨ bindTestButtonEvents() å‡½æ•¸ä¸­ç¶å®š

            // æä¾›å…¨å±€å‡½æ•¸ä¾›å…¶ä»–æ¨¡å¡Šä½¿ç”¨
            window.VNMaterialProcessor = {
                // ç²å–ç•¶å‰ä¾†æºæ¨¡å¼
                getSourceMode: function() {
                    const savedSettings = JSON.parse(localStorage.getItem('vn_material_settings') || '{}');
                    return savedSettings.sourceMode || 'url';
                },
                
                // ç«‹ç¹ªç›¸é—œï¼ˆé è¨­è¨­ç½®ï¼‰
                generatePortraitUrl: generatePortraitUrl,
                getPortraitSettings: function() {
                    return {
                        baseUrl: portraitBaseUrlInput.value.trim(),
                        format: portraitFormatInput.value.trim()
                    };
                },
                setPortraitConfig: function(baseUrl, format) {
                    if (baseUrl) portraitBaseUrlInput.value = baseUrl;
                    if (format) portraitFormatInput.value = format;
                },
                
                // BGMç›¸é—œ
                generateBgmUrl: generateBgmUrl,
                getBgmSettings: function() {
                    return {
                        baseUrl: bgmBaseUrlInput.value.trim(),
                        format: bgmFormatInput.value.trim()
                    };
                },
                setBgmConfig: function(baseUrl, format) {
                    if (baseUrl) bgmBaseUrlInput.value = baseUrl;
                    if (format) bgmFormatInput.value = format;
                },
                
                // éŸ³æ•ˆç›¸é—œ
                generateSoundEffectUrl: generateSoundEffectUrl,
                getSoundEffectSettings: function() {
                    return {
                        baseUrl: soundEffectBaseUrlInput.value.trim(),
                        format: soundEffectFormatInput.value.trim(),
                        popupSoundUrl: 'https://nancywang3641.github.io/sound-files/popup.wav' // å½ˆçª—éŸ³æ•ˆURL
                    };
                },
                setSoundEffectConfig: function(baseUrl, format) {
                    if (baseUrl) soundEffectBaseUrlInput.value = baseUrl;
                    if (format) soundEffectFormatInput.value = format;
                },
                
                // è§’è‰²åœ–ç‰‡ç›¸é—œ
                generateCharacterImgUrl: generateCharacterImgUrl,
                getCharacterImgSettings: function() {
                    return {
                        baseUrl: characterImgBaseUrlInput ? characterImgBaseUrlInput.value.trim() : 'https://nancywang3641.github.io/sound-files/char_img/',
                        format: characterImgFormatInput ? characterImgFormatInput.value.trim() : '.png'
                    };
                },
                setCharacterImgConfig: function(baseUrl, format) {
                    if (baseUrl && characterImgBaseUrlInput) characterImgBaseUrlInput.value = baseUrl;
                    if (format && characterImgFormatInput) characterImgFormatInput.value = format;
                },
                
                // èƒŒæ™¯åœ–ç‰‡ç›¸é—œ
                generateBackgroundUrl: generateBackgroundUrl,
                getBackgroundSettings: function() {
                    return {
                        baseUrl: backgroundBaseUrlInput ? backgroundBaseUrlInput.value.trim() : 'http://127.0.0.1:8000/location_img/',
                        fallbackUrl: backgroundFallbackUrlInput ? backgroundFallbackUrlInput.value.trim() : 'https://nancywang3641.github.io/sound-files/location_img/default.jpeg',
                        imageFormat: backgroundFormatInput ? backgroundFormatInput.value.trim() : '.jpeg'
                    };
                },
                setBackgroundConfig: function(baseUrl, fallbackUrl, format) {
                    if (baseUrl && backgroundBaseUrlInput) backgroundBaseUrlInput.value = baseUrl;
                    if (fallbackUrl && backgroundFallbackUrlInput) backgroundFallbackUrlInput.value = fallbackUrl;
                    if (format && backgroundFormatInput) backgroundFormatInput.value = format;
                },
                
                // Area GIFç›¸é—œ
                generateAreaGifUrl: generateAreaGifUrl,
                getAreaGifSettings: function() {
                    return {
                        baseUrl: areaGifBaseUrlInput ? areaGifBaseUrlInput.value.trim() : 'https://nancywang3641.github.io/sound-files/Area_img/',
                        format: areaGifFormatInput ? areaGifFormatInput.value.trim() : '.gif'
                    };
                },
                setAreaGifConfig: function(baseUrl, format) {
                    if (baseUrl && areaGifBaseUrlInput) areaGifBaseUrlInput.value = baseUrl;
                    if (format && areaGifFormatInput) areaGifFormatInput.value = format;
                },
                
                // è²¼åœ–ç›¸é—œ
                generateStickerUrl: generateStickerUrl,
                getStickerSettings: function() {
                    return {
                        baseUrl: stickerBaseUrlInput ? stickerBaseUrlInput.value.trim() : 'https://nancywang3641.github.io/sound-files/sticker/',
                        defaultUrl: stickerDefaultUrlInput ? stickerDefaultUrlInput.value.trim() : 'https://nancywang3641.github.io/sound-files/sticker/default.jpg',
                        format: stickerFormatInput ? stickerFormatInput.value.trim() : '.jpg'
                    };
                },
                setStickerConfig: function(baseUrl, defaultUrl, format) {
                    if (baseUrl && stickerBaseUrlInput) stickerBaseUrlInput.value = baseUrl;
                    if (defaultUrl && stickerDefaultUrlInput) stickerDefaultUrlInput.value = defaultUrl;
                    if (format && stickerFormatInput) stickerFormatInput.value = format;
                },
                
                // ç‰©å“åœ–ç‰‡ç›¸é—œ
                generateItemImgUrl: generateItemImgUrl,
                getItemImgSettings: function() {
                    return {
                        baseUrl: itemImgBaseUrlInput ? itemImgBaseUrlInput.value.trim() : 'https://nancywang3641.github.io/sound-files/item_img/',
                        format: itemImgFormatInput ? itemImgFormatInput.value.trim() : '.png'
                    };
                },
                setItemImgConfig: function(baseUrl, format) {
                    if (baseUrl && itemImgBaseUrlInput) itemImgBaseUrlInput.value = baseUrl;
                    if (format && itemImgFormatInput) itemImgFormatInput.value = format;
                },
                
                // ç‰©å“é¡å‹ç›¸é—œ
                generateItemTypeUrl: generateItemTypeUrl,
                getItemTypeSettings: function() {
                    return {
                        baseUrl: itemTypeBaseUrlInput ? itemTypeBaseUrlInput.value.trim() : 'https://nancywang3641.github.io/sound-files/item_type/',
                        format: itemTypeFormatInput ? itemTypeFormatInput.value.trim() : '.png'
                    };
                },
                setItemTypeConfig: function(baseUrl, format) {
                    if (baseUrl && itemTypeBaseUrlInput) itemTypeBaseUrlInput.value = baseUrl;
                    if (format && itemTypeFormatInput) itemTypeFormatInput.value = format;
                },
                
                // é€šç”¨è¨­ç½®
                saveSettings: saveMaterialSettings
            };

            // ç‚ºäº†å‘å¾Œå…¼å®¹ï¼Œä¿ç•™èˆŠçš„ç«‹ç¹ªè™•ç†å™¨ï¼ˆå¦‚æœé‚„æ²’æœ‰å®šç¾©çš„è©±ï¼‰
            if (!window.VNPortraitProcessor) {
            window.VNPortraitProcessor = {
                generatePortraitUrl: generatePortraitUrl,
                getSettings: function() {
                    return {
                        baseUrl: portraitBaseUrlInput.value.trim(),
                        format: portraitFormatInput.value.trim()
                    };
                },
                setConfig: function(baseUrl, format) {
                    if (baseUrl) portraitBaseUrlInput.value = baseUrl;
                    if (format) portraitFormatInput.value = format;
                }
            };
            }

            // ========== å›¾ç‰‡å‹ç¼©ä¿®å¤ä»£ç  - å¼€å§‹ ==========
// å›¾ç‰‡å‹ç¼©å’Œå¤§å°é™åˆ¶ä¿®å¤

// 1. å›¾ç‰‡å‹ç¼©å·¥å…·å‡½æ•°
function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ–‡ä»¶å¤§å° - é™åˆ¶ä¸º5MB
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            console.warn(`[å›¾ç‰‡å‹ç¼©] æ–‡ä»¶è¿‡å¤§: ${(file.size / 1024 / 1024).toFixed(2)}MBï¼Œå°†è¿›è¡Œå‹ç¼©`);
        }

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = function() {
            try {
                // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
                let { width, height } = calculateCompressedSize(img.width, img.height, maxWidth, maxHeight);
                
                canvas.width = width;
                canvas.height = height;

                // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
                ctx.fillStyle = 'white'; // ç™½è‰²èƒŒæ™¯
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0, width, height);

                // è½¬æ¢ä¸ºBlob
                canvas.toBlob((blob) => {
                    if (blob) {
                        console.log(`[å›¾ç‰‡å‹ç¼©] å‹ç¼©å®Œæˆ: ${img.width}x${img.height} -> ${width}x${height}, ${(file.size / 1024).toFixed(1)}KB -> ${(blob.size / 1024).toFixed(1)}KB`);
                        
                        // åˆ›å»ºæ–°çš„æ–‡ä»¶å¯¹è±¡
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg', // ç»Ÿä¸€è½¬æ¢ä¸ºJPEGæ ¼å¼
                            lastModified: Date.now()
                        });
                        
                        resolve(compressedFile);
                    } else {
                        reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'));
                    }
                }, 'image/jpeg', quality);

            } catch (error) {
                console.error('[å›¾ç‰‡å‹ç¼©] å‹ç¼©è¿‡ç¨‹å‡ºé”™:', error);
                reject(error);
            }
        };

        img.onerror = () => {
            reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        };

        // åˆ›å»ºå›¾ç‰‡URL
        const reader = new FileReader();
        reader.onload = (e) => {
            img.src = e.target.result;
        };
        reader.onerror = () => {
            reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
        };
        reader.readAsDataURL(file);
    });
}

// 2. è®¡ç®—å‹ç¼©å°ºå¯¸
function calculateCompressedSize(originalWidth, originalHeight, maxWidth, maxHeight) {
    let width = originalWidth;
    let height = originalHeight;

    // å¦‚æœå›¾ç‰‡è¿‡å¤§ï¼ŒæŒ‰æ¯”ä¾‹ç¼©æ”¾
    if (width > maxWidth || height > maxHeight) {
        const widthRatio = maxWidth / width;
        const heightRatio = maxHeight / height;
        const ratio = Math.min(widthRatio, heightRatio);

        width = Math.floor(width * ratio);
        height = Math.floor(height * ratio);
    }

    return { width, height };
}

// 3. å¤„ç†è¿›åº¦æŒ‡ç¤ºå™¨
function showImageProcessingIndicator(message) {
    // ç§»é™¤æ—§çš„æŒ‡ç¤ºå™¨
    hideImageProcessingIndicator();
    
    const indicator = document.createElement('div');
    indicator.id = 'image-processing-indicator';
    indicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 10001;
        text-align: center;
        font-size: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `;
    indicator.innerHTML = `
        <div style="margin-bottom: 10px;">${message}</div>
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
    
    document.body.appendChild(indicator);
}

function hideImageProcessingIndicator() {
    const indicator = document.getElementById('image-processing-indicator');
    if (indicator) {
        indicator.parentNode.removeChild(indicator);
    }
}

    console.log('[VNé¢æ¿] å›¾ç‰‡å‹ç¼©ä¿®å¤å·²åŠ è½½');
    
    // æ·»åŠ è°ƒè¯•åŠŸèƒ½
    window.testImageDataIntegrity = async function() {
        console.log('[èª¿è©¦] é–‹å§‹æ¸¬è©¦åœ–ç‰‡æ•¸æ“šå®Œæ•´æ€§');
        
        if (!window.materialImageManager) {
            console.error('[èª¿è©¦] materialImageManager æœªåˆå§‹åŒ–');
            return;
        }
        
        try {
            const images = await window.materialImageManager.getImagesByCategory('portrait');
            console.log(`[èª¿è©¦] æ‰¾åˆ° ${images.length} å¼µåœ–ç‰‡`);
            
            for (let i = 0; i < images.length; i++) {
                const img = images[i];
                console.log(`[èª¿è©¦] æ¸¬è©¦åœ–ç‰‡ ${i + 1}: ${img.name}`);
                console.log(`[èª¿è©¦] åœ–ç‰‡è©³æƒ…:`, {
                    name: img.name,
                    type: img.type,
                    size: img.size,
                    hasBlob: !!img.blob,
                    hasUrl: !!img.url,
                    urlType: img.url ? img.url.split(';')[0] : 'null'
                });
                
                if (img.blob) {
                    console.log(`[èª¿è©¦] Blobè©³æƒ…: å¤§å° ${(img.blob.size / 1024).toFixed(1)}KB, é¡å‹ ${img.blob.type}`);
                }
                
                if (img.url) {
                    // æ£€æŸ¥ URL æ ¼å¼
                    if (img.url.startsWith('blob:')) {
                        console.log(`[èª¿è©¦] åœ–ç‰‡ ${img.name} ä½¿ç”¨ Blob URL`);
                    } else if (img.url.startsWith('data:')) {
                        console.log(`[èª¿è©¦] åœ–ç‰‡ ${img.name} ä½¿ç”¨ Base64 URL`);
                    } else if (img.url.startsWith('http://') || img.url.startsWith('https://')) {
                        console.log(`[èª¿è©¦] åœ–ç‰‡ ${img.name} ä½¿ç”¨ HTTP URL`);
                    } else {
                        console.error(`[èª¿è©¦] åœ–ç‰‡ ${img.name} URLæ ¼å¼ä¸æ­£ç¢º: ${img.url.substring(0, 50)}...`);
                        continue;
                    }
                    
                    // å°è¯•åˆ›å»ºå›¾ç‰‡å¯¹è±¡æµ‹è¯•
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log(`[èª¿è©¦] åœ–ç‰‡ ${img.name} æ•¸æ“šå®Œæ•´ï¼Œå°ºå¯¸: ${this.width}x${this.height}`);
                    };
                    testImg.onerror = function() {
                        console.error(`[èª¿è©¦] åœ–ç‰‡ ${img.name} æ•¸æ“šæå£ï¼Œç„¡æ³•åŠ è¼‰`);
                        console.error(`[èª¿è©¦] åœ–ç‰‡ ${img.name} URL: ${img.url}`);
                    };
                    testImg.src = img.url;
                }
            }
        } catch (error) {
            console.error('[èª¿è©¦] æ¸¬è©¦åœ–ç‰‡æ•¸æ“šå®Œæ•´æ€§å¤±æ•—:', error);
        }
    };
    
    // æ¸…ç†æŸåçš„å›¾ç‰‡æ•°æ®
    window.cleanupCorruptedImages = async function() {
        console.log('[èª¿è©¦] é–‹å§‹æ¸…ç†æå£çš„åœ–ç‰‡æ•¸æ“š');
        
        if (!window.materialImageManager) {
            console.error('[èª¿è©¦] materialImageManager æœªåˆå§‹åŒ–');
            return;
        }
        
        try {
            const images = await window.materialImageManager.getImagesByCategory('portrait');
            console.log(`[èª¿è©¦] æª¢æŸ¥ ${images.length} å¼µåœ–ç‰‡`);
            
            let deletedCount = 0;
            
            for (let i = 0; i < images.length; i++) {
                const img = images[i];
                
                // æ£€æŸ¥å›¾ç‰‡ç±»å‹
                if (img.type === 'url') {
                    // URLç±»å‹å›¾ç‰‡ï¼Œæ£€æŸ¥HTTP URLæ ¼å¼
                    if (!img.url || (!img.url.startsWith('http://') && !img.url.startsWith('https://'))) {
                        console.log(`[èª¿è©¦] åˆªé™¤ç„¡æœ‰æ•ˆHTTP URLçš„åœ–ç‰‡: ${img.name}`);
                        await window.materialImageManager.deleteImage(img.id);
                        deletedCount++;
                        continue;
                    }
                } else {
                    // Base64ç±»å‹å›¾ç‰‡ï¼Œæ£€æŸ¥Base64æ ¼å¼
                    if (!img.url || !img.url.startsWith('data:image/')) {
                        console.log(`[èª¿è©¦] åˆªé™¤ç„¡æœ‰æ•ˆ Base64 æ•¸æ“šçš„åœ–ç‰‡: ${img.name}`);
                        await window.materialImageManager.deleteImage(img.id);
                        deletedCount++;
                        continue;
                    }
                }
                
                // éªŒè¯ Base64 æ•°æ®å®Œæ•´æ€§
                const parts = img.url.split(',');
                if (parts.length !== 2 || parts[1].length < 100) {
                    console.log(`[èª¿è©¦] åˆªé™¤ Base64 æ•¸æ“šä¸å®Œæ•´çš„åœ–ç‰‡: ${img.name}`);
                    await window.materialImageManager.deleteImage(img.id);
                    deletedCount++;
                    continue;
                }
                
                // æµ‹è¯•å›¾ç‰‡æ˜¯å¦å¯ä»¥æ­£å¸¸åŠ è½½
                if (img.url) {
                    const testImg = new Image();
                    const canLoad = await new Promise((resolve) => {
                        testImg.onload = () => resolve(true);
                        testImg.onerror = () => resolve(false);
                        testImg.src = img.url;
                    });
                    
                    if (!canLoad) {
                        console.log(`[èª¿è©¦] åˆªé™¤æå£çš„åœ–ç‰‡: ${img.name}`);
                        await window.materialImageManager.deleteImage(img.id);
                        deletedCount++;
                    }
                }
            }
            
            console.log(`[èª¿è©¦] æ¸…ç†å®Œæˆï¼Œåˆªé™¤äº† ${deletedCount} å¼µæå£çš„åœ–ç‰‡`);
        } catch (error) {
            console.error('[èª¿è©¦] æ¸…ç†æå£åœ–ç‰‡å¤±æ•—:', error);
        }
    };
    
    // æµ‹è¯• Base64 æ•°æ®æœ‰æ•ˆæ€§
    window.testBase64Data = async function() {
        console.log('[èª¿è©¦] é–‹å§‹æ¸¬è©¦ Base64 æ•¸æ“šæœ‰æ•ˆæ€§');
        
        if (!window.materialImageManager) {
            console.error('[èª¿è©¦] materialImageManager æœªåˆå§‹åŒ–');
            return;
        }
        
        try {
            const images = await window.materialImageManager.getImagesByCategory('portrait');
            console.log(`[èª¿è©¦] æ‰¾åˆ° ${images.length} å¼µåœ–ç‰‡`);
            
            for (let i = 0; i < images.length; i++) {
                const img = images[i];
                console.log(`[èª¿è©¦] æ¸¬è©¦åœ–ç‰‡ ${i + 1}: ${img.name}`);
                
                if (img.url && img.url.startsWith('data:image/')) {
                    console.log(`[èª¿è©¦] Base64 è©³æƒ…:`, {
                        length: img.url.length,
                        type: img.type,
                        startsWith: img.url.substring(0, 50),
                        endsWith: img.url.substring(img.url.length - 20)
                    });
                    
                    // éªŒè¯ Base64 æ ¼å¼
                    const parts = img.url.split(',');
                    if (parts.length !== 2) {
                        console.error(`[èª¿è©¦] åœ–ç‰‡ ${img.name} Base64 æ ¼å¼éŒ¯èª¤`);
                        continue;
                    }
                    
                    const header = parts[0];
                    const data = parts[1];
                    
                    console.log(`[èª¿è©¦] Base64 é ­éƒ¨: ${header}`);
                    console.log(`[èª¿è©¦] Base64 æ•¸æ“šé•·åº¦: ${data.length}`);
                    
                    // æ£€æŸ¥ Base64 æ•°æ®æ˜¯å¦å®Œæ•´
                    if (data.length % 4 !== 0) {
                        console.error(`[èª¿è©¦] åœ–ç‰‡ ${img.name} Base64 æ•¸æ“šä¸å®Œæ•´ (é•·åº¦: ${data.length})`);
                    }
                    
                    // æµ‹è¯•å›¾ç‰‡åŠ è½½
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log(`[èª¿è©¦] åœ–ç‰‡ ${img.name} åŠ è¼‰æˆåŠŸï¼Œå°ºå¯¸: ${this.width}x${this.height}`);
                    };
                    testImg.onerror = function() {
                        console.error(`[èª¿è©¦] åœ–ç‰‡ ${img.name} åŠ è¼‰å¤±æ•—`);
                        console.error(`[èª¿è©¦] åœ–ç‰‡ ${img.name} Base64 æ•¸æ“š: ${img.url.substring(0, 100)}...`);
                    };
                    testImg.src = img.url;
                    
                } else {
                    console.warn(`[èª¿è©¦] åœ–ç‰‡ ${img.name} æ²’æœ‰æœ‰æ•ˆçš„ Base64 æ•¸æ“š`);
                }
            }
        } catch (error) {
            console.error('[èª¿è©¦] æ¸¬è©¦ Base64 æ•¸æ“šå¤±æ•—:', error);
        }
    };
    
    // å¿«é€Ÿæµ‹è¯•å½“å‰å›¾ç‰‡
    window.testCurrentImage = function() {
        console.log('[èª¿è©¦] å¿«é€Ÿæ¸¬è©¦ç•¶å‰åœ–ç‰‡');
        
        // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾ç‰‡
        const canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        
        // ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„å›¾æ¡ˆ
        ctx.fillStyle = 'red';
        ctx.fillRect(0, 0, 100, 100);
        ctx.fillStyle = 'white';
        ctx.fillRect(25, 25, 50, 50);
        
        // è½¬æ¢ä¸º Base64
        const testBase64 = canvas.toDataURL('image/png');
        console.log(`[èª¿è©¦] æ¸¬è©¦ Base64 é•·åº¦: ${testBase64.length}`);
        
        // æµ‹è¯•åŠ è½½
        const testImg = new Image();
        testImg.onload = function() {
            console.log(`[èª¿è©¦] æ¸¬è©¦åœ–ç‰‡åŠ è¼‰æˆåŠŸï¼Œå°ºå¯¸: ${this.width}x${this.height}`);
        };
        testImg.onerror = function() {
            console.error(`[èª¿è©¦] æ¸¬è©¦åœ–ç‰‡åŠ è¼‰å¤±æ•—`);
        };
        testImg.src = testBase64;
    };
    
    // ç¯å¢ƒæ£€æµ‹å’Œä¿®å¤
    window.checkEnvironment = function() {
        console.log('[èª¿è©¦] ç’°å¢ƒæª¢æ¸¬é–‹å§‹');
        
        const env = {
            protocol: window.location.protocol,
            hostname: window.location.hostname,
            port: window.location.port,
            href: window.location.href,
            isFile: window.location.protocol === 'file:',
            isLocalhost: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',
            isSandboxed: window.location.href.includes('sandbox'),
            userAgent: navigator.userAgent
        };
        
        console.log('[èª¿è©¦] ç’°å¢ƒä¿¡æ¯:', env);
        
        if (env.isFile) {
            console.warn('[èª¿è©¦] è­¦å‘Š: ç•¶å‰åœ¨ file:// å”è­°ä¸‹é‹è¡Œ');
            console.warn('[èª¿è©¦] å»ºè­°: ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨ (å¦‚ http-server, live-server)');
            console.warn('[èª¿è©¦] å‘½ä»¤: npx http-server æˆ– python -m http.server');
        }
        
        if (env.isSandboxed) {
            console.warn('[èª¿è©¦] è­¦å‘Š: ç•¶å‰åœ¨ sandbox ç’°å¢ƒä¸‹é‹è¡Œ');
            console.warn('[èª¿è©¦] å»ºè­°: æ·»åŠ  allow-same-origin æ¬Šé™');
        }
        
        // æµ‹è¯•å›¾ç‰‡åŠ è½½èƒ½åŠ›
        const testCanvas = document.createElement('canvas');
        testCanvas.width = 10;
        testCanvas.height = 10;
        const testCtx = testCanvas.getContext('2d');
        testCtx.fillStyle = 'black';
        testCtx.fillRect(0, 0, 10, 10);
        
        const testDataUrl = testCanvas.toDataURL('image/png');
        const testImg = new Image();
        
        testImg.onload = function() {
            console.log('[èª¿è©¦] åœ–ç‰‡åŠ è¼‰æ¸¬è©¦: æˆåŠŸ');
        };
        
        testImg.onerror = function() {
            console.error('[èª¿è©¦] åœ–ç‰‡åŠ è¼‰æ¸¬è©¦: å¤±æ•—');
        };
        
        testImg.src = testDataUrl;
        
        return env;
    };
    
    // æµ‹è¯•é€æ˜èƒŒæ™¯å‹ç¼©
    window.testTransparencyCompression = function() {
        console.log('[èª¿è©¦] æ¸¬è©¦é€æ˜èƒŒæ™¯å£“ç¸®');
        
        // åˆ›å»ºä¸€ä¸ªå¸¦é€æ˜èƒŒæ™¯çš„æµ‹è¯•å›¾ç‰‡
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');
        
        // ç»˜åˆ¶ä¸€ä¸ªå¸¦é€æ˜èƒŒæ™¯çš„å›¾æ¡ˆ
        ctx.clearRect(0, 0, 200, 200); // é€æ˜èƒŒæ™¯
        ctx.fillStyle = 'red';
        ctx.fillRect(50, 50, 100, 100); // çº¢è‰²æ–¹å—
        ctx.fillStyle = 'blue';
        ctx.fillRect(75, 75, 50, 50); // è“è‰²æ–¹å—
        
        // æµ‹è¯• PNG å‹ç¼©
        canvas.toBlob((blob) => {
            console.log(`[èª¿è©¦] PNG å£“ç¸®çµæœ: å¤§å° ${(blob.size / 1024).toFixed(1)}KB, é¡å‹ ${blob.type}`);
            
            // è½¬æ¢ä¸º Base64 æµ‹è¯•
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                console.log(`[èª¿è©¦] Base64 é•·åº¦: ${base64.length}`);
                
                // æµ‹è¯•åŠ è½½
                const testImg = new Image();
                testImg.onload = function() {
                    console.log(`[èª¿è©¦] é€æ˜åœ–ç‰‡åŠ è¼‰æˆåŠŸï¼Œå°ºå¯¸: ${this.width}x${this.height}`);
                };
                testImg.onerror = function() {
                    console.error(`[èª¿è©¦] é€æ˜åœ–ç‰‡åŠ è¼‰å¤±æ•—`);
                };
                testImg.src = base64;
            };
            reader.readAsDataURL(blob);
        }, 'image/png', 0.8);
    };
    
    // ========== å›¾ç‰‡å‹ç¼©ä¿®å¤ä»£ç  - ç»“æŸ ==========


            console.log('[VNé¢æ¿] ç´ æè¨­ç½®åŠŸèƒ½å·²åˆå§‹åŒ–');

            // å»¶è¿Ÿåˆå§‹åŒ–åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£ï¼Œç¡®ä¿å˜é‡å·²å£°æ˜
            setTimeout(() => {
                if (typeof initializeImageTagModal === 'function') {
            initializeImageTagModal();
                }
            }, 0);

        // é¡¯ç¤ºåŠ‡æƒ…è¨­ç½®æ¨¡æ…‹æ¡†
        function showStoryEditModal() {
            const modal = document.getElementById('storyEditModal');
            if (modal) {
                modal.classList.add('modal-active');
                console.log('[VNé¢æ¿] é¡¯ç¤ºåŠ‡æƒ…è¨­ç½®æ¨¡æ…‹æ¡†');
            }
        }

        // ======================================================================= 
        //                        å…¨å±€å˜é‡åˆå§‹åŒ– - å›¾ç‰‡ä¸Šä¼ ç›¸å…³
        // =======================================================================

        // ç«‹å³åˆå§‹åŒ–ä¸Šä¼ ç›¸å…³çš„å…¨å±€å˜é‡ï¼Œé¿å…åˆå§‹åŒ–é¡ºåºé—®é¢˜
        (function() {
            'use strict';
    
            // åœ¨ window å¯¹è±¡ä¸Šåˆå§‹åŒ–å˜é‡
            window.currentUploadFile = null;
            window.currentUploadCategory = null;
    
            // ç¡®ä¿å±€éƒ¨å˜é‡ä¹Ÿè¢«å£°æ˜ - ä½¿ç”¨ window å¯¹è±¡é¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
            if (typeof window.currentUploadFile_local === 'undefined') {
                window.currentUploadFile_local = null;
                window.currentUploadCategory_local = null;
            }
    
            console.log('[VNé¢æ¿] å›¾ç‰‡ä¸Šä¼ å…¨å±€å˜é‡å·²åˆå§‹åŒ–');
        })();



        // =======================================================================
        //                            åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£åŠŸèƒ½
        // =======================================================================

        // åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£ç›¸é—œè®Šæ•¸
        let imageTagModal = null;
        let imageTagPreview = null;
        let imageTagFileName = null;
        let imageTagFileSize = null;
        let imageTagCategory = null;
        let imageTagLabel = null;
        let imageTagEmotion = null;
        let emotionTagGroup = null;
        let tagHelpText = null;
        let tagPreviewResult = null;
        let confirmImageTag = null;
        let cancelImageTag = null;
        let closeImageTag = null;

        
        // ç•¶å‰ä¸Šå‚³çš„åœ–ç‰‡æ–‡ä»¶
        window.currentUploadFile = null;
        window.currentUploadCategory = null;

        // å±€éƒ¨å˜é‡å£°æ˜
        let currentUploadFile = null;
        let currentUploadCategory = null;






        // ç«‹å³åˆå§‹åŒ–åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£è®Šæ•¸
        (function() {
            // å˜—è©¦ç«‹å³ç²å–DOMå…ƒç´ 
            const modalElement = document.getElementById('imageTagModal');
            if (modalElement) {
                imageTagModal = modalElement;
                imageTagPreview = document.getElementById('imageTagPreview');
                imageTagFileName = document.getElementById('imageTagFileName');
                imageTagFileSize = document.getElementById('imageTagFileSize');
                imageTagCategory = document.getElementById('imageTagCategory');
                imageTagLabel = document.getElementById('imageTagLabel');
                imageTagEmotion = document.getElementById('imageTagEmotion');
                emotionTagGroup = document.getElementById('emotionTagGroup');
                tagHelpText = document.getElementById('tagHelpText');
                tagPreviewResult = document.getElementById('tagPreviewResult');
                confirmImageTag = document.getElementById('confirmImageTag');
                cancelImageTag = document.getElementById('cancelImageTag');
                closeImageTag = document.getElementById('closeImageTag');
                
                console.log('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£è®Šæ•¸å·²é åˆå§‹åŒ–');
            } else {
                console.warn('[VNé¢æ¿] DOMå…ƒç´ æœªæ‰¾åˆ°ï¼Œå°‡åœ¨DOMContentLoadedå¾Œé‡æ–°åˆå§‹åŒ–');
            }
        })();

        // åˆå§‹åŒ–åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£
        function initializeImageTagModal() {
            // å¦‚æœå·²ç¶“åˆå§‹åŒ–éï¼Œç›´æ¥è¿”å› - ä½¿ç”¨ window å¯¹è±¡é¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
            if (window.imageTagModal && window.imageTagModal._initialized) {
                console.log('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£å·²ç¶“åˆå§‹åŒ–é');
                return;
            }

            // ç²å–DOMå…ƒç´ 
            const modalElement = document.getElementById('imageTagModal');
            if (!modalElement) {
                console.error('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // åˆå§‹åŒ–æ‰€æœ‰è®Šæ•¸ - ä½¿ç”¨ window å¯¹è±¡é¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
            window.imageTagModal = modalElement;
            window.imageTagPreview = document.getElementById('imageTagPreview');
            window.imageTagFileName = document.getElementById('imageTagFileName');
            window.imageTagFileSize = document.getElementById('imageTagFileSize');
            window.imageTagCategory = document.getElementById('imageTagCategory');
            window.imageTagLabel = document.getElementById('imageTagLabel');
            window.imageTagEmotion = document.getElementById('imageTagEmotion');
            window.emotionTagGroup = document.getElementById('emotionTagGroup');
            window.tagHelpText = document.getElementById('tagHelpText');
            window.tagPreviewResult = document.getElementById('tagPreviewResult');
            window.confirmImageTag = document.getElementById('confirmImageTag');
            window.cancelImageTag = document.getElementById('cancelImageTag');
            window.closeImageTag = document.getElementById('closeImageTag');

            // æª¢æŸ¥æ‰€æœ‰å¿…è¦å…ƒç´ æ˜¯å¦å­˜åœ¨ - ä½¿ç”¨ window å¯¹è±¡é¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
            const requiredElements = [
                { name: 'imageTagModal', element: window.imageTagModal },
                { name: 'imageTagPreview', element: window.imageTagPreview },
                { name: 'imageTagFileName', element: window.imageTagFileName },
                { name: 'imageTagFileSize', element: window.imageTagFileSize },
                { name: 'imageTagCategory', element: window.imageTagCategory },
                { name: 'imageTagLabel', element: window.imageTagLabel },
                { name: 'confirmImageTag', element: window.confirmImageTag },
                { name: 'cancelImageTag', element: window.cancelImageTag },
                { name: 'closeImageTag', element: window.closeImageTag }
            ];

            const missingElements = requiredElements.filter(item => !item.element);
            if (missingElements.length > 0) {
                console.error('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£åˆå§‹åŒ–å¤±æ•—ï¼Œç¼ºå°‘å…ƒç´ :', missingElements.map(item => item.name));
                return;
            }

            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            setupImageTagEventListeners();
            
            // æ¨™è¨˜ç‚ºå·²åˆå§‹åŒ– - ä½¿ç”¨ window å¯¹è±¡é¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
            window.imageTagModal._initialized = true;
            
            console.log('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£å·²åˆå§‹åŒ–æˆåŠŸ');
        }

        // è¨­ç½®åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£äº‹ä»¶ç›£è½å™¨
        function setupImageTagEventListeners() {
            // å¦‚æœå·²ç¶“ç¶å®šéäº‹ä»¶ï¼Œå…ˆç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
            if (imageTagModal && imageTagModal._eventsBound) {
                return;
            }

            // é—œé–‰æŒ‰éˆ•äº‹ä»¶
            if (closeImageTag) {
                closeImageTag.removeEventListener('click', closeImageTagModal);
                closeImageTag.addEventListener('click', closeImageTagModal);
            }

            if (cancelImageTag) {
                cancelImageTag.removeEventListener('click', closeImageTagModal);
                cancelImageTag.addEventListener('click', closeImageTagModal);
            }

            // ç¢ºèªæŒ‰éˆ•äº‹ä»¶
            if (confirmImageTag) {
                confirmImageTag.removeEventListener('click', handleImageTagConfirm);
                confirmImageTag.addEventListener('click', handleImageTagConfirm);
            }

            // åˆ†é¡é¸æ“‡äº‹ä»¶ - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
            if (imageTagCategory) {
                imageTagCategory.removeEventListener('change', function() {
                    if (typeof handleCategoryChange === 'function') {
                        handleCategoryChange();
                    }
                });
                imageTagCategory.addEventListener('change', function() {
                    if (typeof handleCategoryChange === 'function') {
                        handleCategoryChange();
                    }
                });
            }

            // æ¨™ç±¤è¼¸å…¥äº‹ä»¶ - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
            if (imageTagLabel) {
                imageTagLabel.removeEventListener('input', function() {
                    if (typeof updateTagPreview === 'function') {
                        updateTagPreview();
                    }
                });
                imageTagLabel.addEventListener('input', function() {
                    if (typeof updateTagPreview === 'function') {
                        updateTagPreview();
                    }
                });
            }

            if (imageTagEmotion) {
                imageTagEmotion.removeEventListener('input', function() {
                    if (typeof updateTagPreview === 'function') {
                        updateTagPreview();
                    }
                });
                imageTagEmotion.addEventListener('input', function() {
                    if (typeof updateTagPreview === 'function') {
                        updateTagPreview();
                    }
                });
            }

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            if (imageTagModal) {
                imageTagModal.removeEventListener('click', imageTagModal._backgroundClickHandler);
                imageTagModal._backgroundClickHandler = function(e) {
                    if (e.target === imageTagModal) {
                        closeImageTagModal();
                    }
                };
                imageTagModal.addEventListener('click', imageTagModal._backgroundClickHandler);
            }

            // ESCéµé—œé–‰
            document.removeEventListener('keydown', document._escapeKeyHandler);
            document._escapeKeyHandler = function(e) {
                if (e.key === 'Escape' && imageTagModal && imageTagModal.classList.contains('modal-active')) {
                    closeImageTagModal();
                }
            };
            document.addEventListener('keydown', document._escapeKeyHandler);

            // æ¨™è¨˜ç‚ºå·²ç¶å®šäº‹ä»¶
            if (imageTagModal) {
                imageTagModal._eventsBound = true;
            }
        }

        // é¡¯ç¤ºåœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£
// æ˜¾ç¤ºå›¾ç‰‡æ ‡ç­¾è¾“å…¥æ¨¡æ€çª—å£
function showImageTagModal(file, category) {
    if (!file) {
        console.error('[VNé¢æ¿] æ— æ³•æ˜¾ç¤ºå›¾ç‰‡æ ‡ç­¾è¾“å…¥æ¨¡æ€çª—å£ï¼šæ–‡ä»¶ä¸ºç©º');
        return;
    }

    // ç›´æ¥åœ¨å‡½æ•°å†…éƒ¨è·å–DOMå…ƒç´ ï¼Œé¿å…å…¨å±€å˜é‡åˆå§‹åŒ–é—®é¢˜
    const modalElement = document.getElementById('imageTagModal');
    const previewElement = document.getElementById('imageTagPreview');
    const fileNameElement = document.getElementById('imageTagFileName');
    const fileSizeElement = document.getElementById('imageTagFileSize');
    const categoryElement = document.getElementById('imageTagCategory');
    const labelElement = document.getElementById('imageTagLabel');
    const emotionElement = document.getElementById('imageTagEmotion');
    const emotionGroupElement = document.getElementById('emotionTagGroup');
    const helpTextElement = document.getElementById('tagHelpText');
    const previewResultElement = document.getElementById('tagPreviewResult');
    const confirmElement = document.getElementById('confirmImageTag');

    if (!modalElement) {
        console.error('[VNé¢æ¿] å›¾ç‰‡æ ‡ç­¾è¾“å…¥æ¨¡æ€çª—å£å…ƒç´ æœªæ‰¾åˆ°');
        
        // å¦‚æœDOMè¿˜æœªåŠ è½½å®Œæˆï¼Œç­‰å¾…åŠ è½½å®Œæˆåé‡è¯•
        if (document.readyState === 'loading') {
            // é˜²æ­¢é‡å¤æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            if (!window.domContentLoadedHandler) {
                window.domContentLoadedHandler = function() {
                setTimeout(() => {
                        if (typeof showImageTagModal === 'function') {
                    showImageTagModal(file, category);
                        }
                }, 200);
                };
                document.addEventListener('DOMContentLoaded', window.domContentLoadedHandler);
            }
            return;
        } else {
            alert('å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
        }
    }

// ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›åç»­å¤„ç†ä½¿ç”¨
window.currentUploadFile = file;
window.currentUploadCategory = category;

// åŒæ—¶ä¹Ÿä¿å­˜åˆ°å±€éƒ¨å˜é‡ä½œä¸ºå¤‡ä»½
try {
    currentUploadFile = file;
    currentUploadCategory = category;
} catch (error) {
    console.debug('[VNé¢æ¿] ä¿å­˜åˆ°å±€éƒ¨å˜é‡æ—¶å‘ç”Ÿé”™è¯¯ï¼ˆå¯å¿½ç•¥ï¼‰:', error.message);
}

    // æª¢æŸ¥æ˜¯å¦ç‚ºURLé¡å‹åœ–ç‰‡
    const isUrlImage = file.type === 'url' || file.url;
    
    if (isUrlImage) {
        // è™•ç†URLé¡å‹åœ–ç‰‡
        if (previewElement) {
            previewElement.src = file.url;
        }
        
        if (fileNameElement) {
            fileNameElement.textContent = file.name || 'URLåœ–ç‰‡';
        }
        
        if (fileSizeElement) {
            fileSizeElement.textContent = 'URLåœ–ç‰‡';
        }
    } else {
        // è™•ç†æ–‡ä»¶é¡å‹åœ–ç‰‡
        // è®¾ç½®å›¾ç‰‡é¢„è§ˆ
        const reader = new FileReader();
        reader.onload = function(e) {
            if (previewElement) {
                previewElement.src = e.target.result;
            }
        };
        reader.readAsDataURL(file);

        // è®¾ç½®æ–‡ä»¶ä¿¡æ¯
        if (fileNameElement) {
            fileNameElement.textContent = file.name;
        }

        if (fileSizeElement) {
            const sizeInKB = (file.size / 1024).toFixed(1);
            fileSizeElement.textContent = `${sizeInKB} KB`;
        }
    }

    // è®¾ç½®åˆ†ç±»
    if (categoryElement) {
        categoryElement.value = category || 'portrait';
        // æ‰‹åŠ¨è§¦å‘åˆ†ç±»å˜æ›´äº‹ä»¶
        handleCategoryChangeLocal(categoryElement.value, emotionGroupElement, helpTextElement);
    }

    // æ¸…ç©ºæ ‡ç­¾è¾“å…¥
    if (labelElement) {
        labelElement.value = '';
    }

    if (emotionElement) {
        emotionElement.value = '';
    }

    // æ›´æ–°é¢„è§ˆ
    updateTagPreviewLocal(categoryElement, labelElement, emotionElement, previewResultElement, confirmElement);

    // è®¾ç½®å±€éƒ¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆè€Œä¸æ˜¯è°ƒç”¨å…¨å±€çš„setupImageTagEventListenersï¼‰
    setupLocalEventListeners(modalElement, confirmElement, categoryElement, labelElement, emotionElement);

    // æ˜¾ç¤ºæ¨¡æ€çª—å£
    modalElement.classList.add('modal-active');

    console.log('[VNé¢æ¿] æ˜¾ç¤ºå›¾ç‰‡æ ‡ç­¾è¾“å…¥æ¨¡æ€çª—å£:', {
        fileName: file.name,
        fileSize: file.size,
        category: category
    });
    
    // é˜²æ­¢é‡å¤æ˜¾ç¤ºæ¨¡æ€çª—å£
    if (window.currentModalFile && window.currentModalFile.name === file.name && window.currentModalFile.size === file.size) {
        console.log('[VNé¢æ¿] æ£€æµ‹åˆ°é‡å¤æ–‡ä»¶ï¼Œè·³è¿‡é‡å¤æ˜¾ç¤º');
        return;
    }
    window.currentModalFile = file;
}

// è®¾ç½®å±€éƒ¨äº‹ä»¶ç›‘å¬å™¨çš„å‡½æ•°
function setupLocalEventListeners(modalElement, confirmElement, categoryElement, labelElement, emotionElement) {
    // å¦‚æœå·²ç»ç»‘å®šè¿‡äº‹ä»¶ï¼Œé¿å…é‡å¤ç»‘å®š
    if (modalElement._localEventsBound) {
        console.log('[VNé¢æ¿] äº‹ä»¶ç›‘å¬å™¨å·²ç»ç»‘å®šè¿‡ï¼Œè·³è¿‡é‡å¤ç»‘å®š');
        return;
    }

    // ç¡®è®¤æŒ‰é’®äº‹ä»¶
    if (confirmElement) {
        const confirmHandler = function() {
            handleImageTagConfirm();
        };
        confirmElement.removeEventListener('click', confirmHandler);
        confirmElement.addEventListener('click', confirmHandler);
    }

    // åˆ†ç±»é€‰æ‹©äº‹ä»¶
    if (categoryElement) {
        const categoryHandler = function() {
            const emotionGroupElement = document.getElementById('emotionTagGroup');
            const helpTextElement = document.getElementById('tagHelpText');
            handleCategoryChangeLocal(categoryElement.value, emotionGroupElement, helpTextElement);
        };
        categoryElement.removeEventListener('change', categoryHandler);
        categoryElement.addEventListener('change', categoryHandler);
    }

    // æ ‡ç­¾è¾“å…¥äº‹ä»¶
    if (labelElement) {
        const labelHandler = function() {
            const previewResultElement = document.getElementById('tagPreviewResult');
            const confirmEl = document.getElementById('confirmImageTag');
            const categoryEl = document.getElementById('imageTagCategory');
            const emotionEl = document.getElementById('imageTagEmotion');
            updateTagPreviewLocal(categoryEl, labelElement, emotionEl, previewResultElement, confirmEl);
        };
        labelElement.removeEventListener('input', labelHandler);
        labelElement.addEventListener('input', labelHandler);
    }

    if (emotionElement) {
        const emotionHandler = function() {
            const previewResultElement = document.getElementById('tagPreviewResult');
            const confirmEl = document.getElementById('confirmImageTag');
            const categoryEl = document.getElementById('imageTagCategory');
            updateTagPreviewLocal(categoryEl, labelElement, emotionElement, previewResultElement, confirmEl);
        };
        emotionElement.removeEventListener('input', emotionHandler);
        emotionElement.addEventListener('input', emotionHandler);
    }

    // å…³é—­æŒ‰é’®äº‹ä»¶
    const closeButtons = document.querySelectorAll('#closeImageTag, #cancelImageTag');
    closeButtons.forEach(button => {
        if (button) {
            const closeHandler = function() {
                closeImageTagModal();
            };
            button.removeEventListener('click', closeHandler);
            button.addEventListener('click', closeHandler);
        }
    });

    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    const backgroundClickHandler = function(e) {
        if (e.target === modalElement) {
            closeImageTagModal();
        }
    };
    modalElement.removeEventListener('click', backgroundClickHandler);
    modalElement.addEventListener('click', backgroundClickHandler);

    // ESCé”®å…³é—­
    const escapeHandler = function(e) {
        if (e.key === 'Escape' && modalElement.classList.contains('modal-active')) {
            closeImageTagModal();
        }
    };
    document.removeEventListener('keydown', escapeHandler);
    document.addEventListener('keydown', escapeHandler);

    // æ ‡è®°ä¸ºå·²ç»‘å®šäº‹ä»¶
    modalElement._localEventsBound = true;
}

// æœ¬åœ°å¤„ç†åˆ†ç±»å˜æ›´çš„å‡½æ•°
function handleCategoryChangeLocal(category, emotionGroupElement, helpTextElement) {
    const isCharacterImg = category === 'character-img';

    // æ˜¾ç¤º/éšè—è¡¨æƒ…è¾“å…¥æ¡†
    if (emotionGroupElement) {
        emotionGroupElement.style.display = isCharacterImg ? 'block' : 'none';
    }

    // æ›´æ–°å¸®åŠ©æ–‡å­—
    if (helpTextElement) {
        const helpTexts = {
            'portrait': 'è¼¸å…¥è§’è‰²åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_presets.png',
            'character-img': 'è¼¸å…¥è§’è‰²åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_è¡¨æƒ….png',
            'background': 'è¼¸å…¥åœ°é»åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šåœ°é»å.jpeg',
            'sticker': 'è¼¸å…¥è²¼åœ–åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè²¼åœ–å.jpg',
            'item-img': 'è¼¸å…¥ç‰©å“åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šç‰©å“å.png',
            'item-type': 'è¼¸å…¥ç‰©å“é¡å‹åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šé¡å‹å.png'
        };
        helpTextElement.textContent = helpTexts[category] || 'è«‹è¼¸å…¥æ¨™ç±¤åç¨±';
    }
}

// æœ¬åœ°æ›´æ–°æ ‡ç­¾é¢„è§ˆçš„å‡½æ•°
function updateTagPreviewLocal(categoryElement, labelElement, emotionElement, previewResultElement, confirmElement) {
    if (!previewResultElement) return;

    const category = categoryElement ? categoryElement.value : '';
    const label = labelElement ? labelElement.value.trim() : '';
    const emotion = emotionElement ? emotionElement.value.trim() : '';

    if (!label) {
        previewResultElement.textContent = 'æœªè¨­ç½®æ¨™ç±¤';
        if (confirmElement) confirmElement.disabled = true;
        return;
    }

    // ç”Ÿæˆé¢„è§ˆæ–‡ä»¶å
    const previewFileName = generatePreviewFileNameLocal(category, label, emotion);
    previewResultElement.textContent = previewFileName;

    // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
    if (confirmElement) confirmElement.disabled = false;
}

// æœ¬åœ°ç”Ÿæˆé¢„è§ˆæ–‡ä»¶åçš„å‡½æ•°
function generatePreviewFileNameLocal(category, label, emotion = '') {
    const cleanLabel = label.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
    const cleanEmotion = emotion.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');

    const fileExtensions = {
        'portrait': '.png',
        'character-img': '.png',
        'background': '.jpeg',
        'sticker': '.jpg',
        'item-img': '.png',
        'item-type': '.png'
    };

    const extension = fileExtensions[category] || '.png';

    switch (category) {
        case 'portrait':
            return `${cleanLabel}_presets${extension}`;
        case 'character-img':
            return cleanEmotion ? `${cleanLabel}_${cleanEmotion}${extension}` : `${cleanLabel}${extension}`;
        case 'background':
        case 'sticker':
        case 'item-img':
        case 'item-type':
            return `${cleanLabel}${extension}`;
        default:
            return `${cleanLabel}${extension}`;
    }
}


// é—œé–‰åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£
function closeImageTagModal() {
    const modalElement = document.getElementById('imageTagModal');
    if (!modalElement) {
        console.warn('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤æ¨¡æ…‹çª—å£å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }

    modalElement.classList.remove('modal-active');
    
    // ä½¿ç”¨ window å¯¹è±¡æ¥å®‰å…¨æ¸…ç©ºå½“å‰æ–‡ä»¶ï¼Œé¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
    try {
        if (typeof window.currentUploadFile !== 'undefined') {
            window.currentUploadFile = null;
        }
        if (typeof window.currentUploadCategory !== 'undefined') {
            window.currentUploadCategory = null;
        }
        
        // ä¹Ÿæ¸…ç©ºå±€éƒ¨å˜é‡ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰
        if (typeof currentUploadFile !== 'undefined') {
            currentUploadFile = null;
        }
        if (typeof currentUploadCategory !== 'undefined') {
            currentUploadCategory = null;
        }
    } catch (error) {
        // å¿½ç•¥å˜é‡è®¿é—®é”™è¯¯ï¼Œåªè®°å½•æ—¥å¿—
        console.debug('[VNé¢æ¿] æ¸…ç©ºä¸Šä¼ æ–‡ä»¶å˜é‡æ—¶å‘ç”Ÿé”™è¯¯ï¼ˆå¯å¿½ç•¥ï¼‰:', error.message);
    }

    // æ¸…ç†å½“å‰æ¨¡æ€çª—å£æ–‡ä»¶æ ‡å¿—
    window.currentModalFile = null;

    console.log('[VNé¢æ¿] é—œé–‰åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£');
}


        // è™•ç†åˆ†é¡è®Šæ›´
        function handleCategoryChange() {
            if (!imageTagCategory || !emotionTagGroup || !tagHelpText) return;

            const category = imageTagCategory.value;
            const isCharacterImg = category === 'character-img';

            // é¡¯ç¤º/éš±è—è¡¨æƒ…è¼¸å…¥æ¡†
            emotionTagGroup.style.display = isCharacterImg ? 'block' : 'none';

            // æ›´æ–°å¹«åŠ©æ–‡å­— - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
            if (typeof updateHelpText === 'function') {
            updateHelpText(category);
            }

            // æ›´æ–°é è¦½ - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
            if (typeof updateTagPreview === 'function') {
            updateTagPreview();
            }
        }

        // æ›´æ–°å¹«åŠ©æ–‡å­—
        function updateHelpText(category) {
            if (!tagHelpText) return;

            const helpTexts = {
                'portrait': 'è¼¸å…¥è§’è‰²åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_presets.png',
                'character-img': 'è¼¸å…¥è§’è‰²åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè§’è‰²å_è¡¨æƒ….png',
                'background': 'è¼¸å…¥åœ°é»åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šåœ°é»å.jpeg',
                'sticker': 'è¼¸å…¥è²¼åœ–åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šè²¼åœ–å.jpg',
                'item-img': 'è¼¸å…¥ç‰©å“åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šç‰©å“å.png',
                'item-type': 'è¼¸å…¥ç‰©å“é¡å‹åç¨±ï¼Œåœ–ç‰‡å°‡å‘½åç‚ºï¼šé¡å‹å.png'
            };

            tagHelpText.textContent = helpTexts[category] || 'è«‹è¼¸å…¥æ¨™ç±¤åç¨±';
        }

        // æ›´æ–°æ¨™ç±¤é è¦½
        function updateTagPreview() {
            if (!tagPreviewResult || !imageTagCategory || !imageTagLabel) return;

            const category = imageTagCategory.value;
            const label = imageTagLabel.value.trim();
            const emotion = imageTagEmotion ? imageTagEmotion.value.trim() : '';

            if (!label) {
                tagPreviewResult.textContent = 'æœªè¨­ç½®æ¨™ç±¤';
                // æ›´æ–°ç¢ºèªæŒ‰éˆ•ç‹€æ…‹ - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
                if (typeof updateConfirmButton === 'function') {
                updateConfirmButton(false);
                }
                return;
            }

            // ç”Ÿæˆé è¦½æ–‡ä»¶å - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
            let previewFileName = '';
            if (typeof generatePreviewFileName === 'function') {
                previewFileName = generatePreviewFileName(category, label, emotion);
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç®€å•çš„æ–‡ä»¶åç”Ÿæˆ
                const cleanLabel = label.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const cleanEmotion = emotion.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
                const extension = category === 'background' ? '.jpeg' : '.png';
                previewFileName = cleanEmotion ? `${cleanLabel}_${cleanEmotion}${extension}` : `${cleanLabel}${extension}`;
            }
            tagPreviewResult.textContent = previewFileName;

            // æ›´æ–°ç¢ºèªæŒ‰éˆ•ç‹€æ…‹ - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
            if (typeof updateConfirmButton === 'function') {
            updateConfirmButton(true);
            }
        }

        // ç”Ÿæˆé¢„è§ˆæ–‡ä»¶åçš„å‡½æ•°
function generatePreviewFileName(category, label, emotion = '') {
    const cleanLabel = label.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
    const cleanEmotion = emotion.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');

    const fileExtensions = {
        'portrait': '.png',
        'character-img': '.png',
        'background': '.jpeg',
        'sticker': '.jpg',
        'item-img': '.png',
        'item-type': '.png'
    };

    const extension = fileExtensions[category] || '.png';

    switch (category) {
        case 'portrait':
            return `${cleanLabel}_presets${extension}`;
        case 'character-img':
            return cleanEmotion ? `${cleanLabel}_${cleanEmotion}${extension}` : `${cleanLabel}${extension}`;
        case 'background':
        case 'sticker':
        case 'item-img':
        case 'item-type':
            return `${cleanLabel}${extension}`;
        default:
            return `${cleanLabel}${extension}`;
    }
}

        // æ›´æ–°ç¢ºèªæŒ‰éˆ•ç‹€æ…‹
        function updateConfirmButton(enabled) {
            if (!confirmImageTag) return;

            confirmImageTag.disabled = !enabled;
        }


// è™•ç†åœ–ç‰‡æ¨™ç±¤ç¢ºèª
async function handleImageTagConfirm() {
    console.log('[VNé¢æ¿] å¼€å§‹å¤„ç†å›¾ç‰‡æ ‡ç­¾ç¡®è®¤');
    
    // é˜²æ­¢é‡å¤æäº¤
    if (window.isProcessingImageTag) {
        console.log('[VNé¢æ¿] æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡é‡å¤æäº¤');
        return;
    }
    window.isProcessingImageTag = true;
    
    try {
        // ä» window å¯¹è±¡è·å–å½“å‰ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯ï¼Œé¿å…å˜é‡åˆå§‹åŒ–é—®é¢˜
        const uploadFile = window.currentUploadFile;
        const uploadCategory = window.currentUploadCategory;
        
        if (!uploadFile) {
            console.error('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤ç¢ºèªå¤±æ•—ï¼šæ²’æœ‰å¯ç”¨çš„ä¸Šå‚³æ–‡ä»¶');
            // é¡¯ç¤ºéŒ¯èª¤æç¤º - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
            if (typeof showImageTagError === 'function') {
            showImageTagError('æ²’æœ‰å¯ç”¨çš„ä¸Šå‚³æ–‡ä»¶');
            } else {
                alert('æ²’æœ‰å¯ç”¨çš„ä¸Šå‚³æ–‡ä»¶');
            }
            return;
        }

        // è·å–å½“å‰çš„æ ‡ç­¾ä¿¡æ¯
        const categoryElement = document.getElementById('imageTagCategory');
        const labelElement = document.getElementById('imageTagLabel');
        const emotionElement = document.getElementById('imageTagEmotion');

        const category = categoryElement ? categoryElement.value : (uploadCategory || 'portrait');
        const label = labelElement ? labelElement.value.trim() : '';
        const emotion = emotionElement ? emotionElement.value.trim() : '';

        if (!label) {
            console.error('[VNé¢æ¿] æ¨™ç±¤ç¢ºèªå¤±æ•—ï¼šæ¨™ç±¤ä¸èƒ½ç‚ºç©º');
            // é¡¯ç¤ºéŒ¯èª¤æç¤º - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
            if (typeof showImageTagError === 'function') {
            showImageTagError('è«‹è¼¸å…¥æ¨™ç±¤åç¨±');
            } else {
                alert('è«‹è¼¸å…¥æ¨™ç±¤åç¨±');
            }
            return;
        }

        // ç”Ÿæˆæœ€çµ‚æ–‡ä»¶å - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
        let fileName = '';
        if (typeof generatePreviewFileName === 'function') {
            fileName = generatePreviewFileName(category, label, emotion);
        } else {
            // å¤‡ç”¨æ–¹æ¡ˆï¼šç®€å•çš„æ–‡ä»¶åç”Ÿæˆ
            const cleanLabel = label.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
            const cleanEmotion = emotion.replace(/[^\u4e00-\u9fa5a-zA-Z0-9_-]/g, '');
            const extension = category === 'background' ? '.jpeg' : '.png';
            fileName = cleanEmotion ? `${cleanLabel}_${cleanEmotion}${extension}` : `${cleanLabel}${extension}`;
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºURLé¡å‹åœ–ç‰‡
        const isUrlImage = uploadFile.type === 'url' || uploadFile.url;
        
        // å‰µå»ºå¸¶æ¨™ç±¤çš„åœ–ç‰‡æ•¸æ“š
        const imageData = isUrlImage ? {
            url: uploadFile.url,
            name: fileName, // ä½¿ç”¨ç”Ÿæˆçš„æ–‡ä»¶åè€Œä¸æ˜¯åŸå§‹åç§°
            category: category,
            tag: label,
            emotion: emotion,
            type: 'url',
            timestamp: Date.now()
        } : {
            file: uploadFile,
            category: category,
            label: label,
            emotion: emotion,
            fileName: fileName,
            timestamp: Date.now()
        };

        console.log('[VNé¢æ¿] æº–å‚™ä¿å­˜åœ–ç‰‡æ•¸æ“š:', imageData);

        // ä¿å­˜åœ–ç‰‡åˆ°ç®¡ç†å™¨
        if (window.materialImageManager) {
            await window.materialImageManager.uploadImageWithTag(imageData);
            console.log('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤ä¿å­˜æˆåŠŸ:', imageData);
        } else {
            console.error('[VNé¢æ¿] åœ–ç‰‡ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            // é¡¯ç¤ºéŒ¯èª¤æç¤º - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
            if (typeof showImageTagError === 'function') {
            showImageTagError('åœ–ç‰‡ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            } else {
                alert('åœ–ç‰‡ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            }
            return;
        }

        // é—œé–‰æ¨¡æ…‹çª—å£ - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
        if (typeof closeImageTagModal === 'function') {
        closeImageTagModal();
        }

        // é¡¯ç¤ºæˆåŠŸæç¤º - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
        if (typeof showImageTagSuccess === 'function') {
        showImageTagSuccess(fileName);
        }

        // åˆ·æ–°åœ–ç‰‡åˆ—è¡¨
        if (window.loadUploadedImages) {
            await window.loadUploadedImages();
        }

        // æ¸…ç©ºå…¨å±€è®Šé‡
        window.currentUploadFile = null;
        window.currentUploadCategory = null;

    } catch (error) {
        console.error('[VNé¢æ¿] åœ–ç‰‡æ¨™ç±¤ä¿å­˜å¤±æ•—:', error);
        // é¡¯ç¤ºéŒ¯èª¤æç¤º - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…å‡½æ•°åˆå§‹åŒ–é—®é¢˜
        if (typeof showImageTagError === 'function') {
        showImageTagError('ä¿å­˜å¤±æ•—ï¼š' + error.message);
        } else {
            alert('ä¿å­˜å¤±æ•—ï¼š' + error.message);
        }
    } finally {
        // é‡ç½®å¤„ç†æ ‡å¿—
        window.isProcessingImageTag = false;
        console.log('[VNé¢æ¿] å›¾ç‰‡æ ‡ç­¾ç¡®è®¤å¤„ç†å®Œæˆ');
    }
}

        // é¡¯ç¤ºæˆåŠŸæç¤º
        function showImageTagSuccess(fileName) {
            if (window.showCustomAlert) {
                window.showCustomAlert('ä¸Šå‚³æˆåŠŸ', `åœ–ç‰‡å·²ä¿å­˜ç‚ºï¼š${fileName}`);
            } else {
                alert(`åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼š${fileName}`);
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤æç¤º
        function showImageTagError(message) {
            if (window.showCustomAlert) {
                window.showCustomAlert('ä¸Šå‚³å¤±æ•—', message);
            } else {
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + message);
            }
        }

        // åˆ·æ–°åœ–ç‰‡åˆ—è¡¨
        function refreshImageList(category) {
            if (window.loadUploadedImages) {
                window.loadUploadedImages();
            }
        }

        // æä¾›å…¨å±€å‡½æ•¸ä¾›å…¶ä»–æ¨¡å¡Šèª¿ç”¨
        window.showImageTagModal = showImageTagModal;
        window.closeImageTagModal = closeImageTagModal;
        window.refreshImageList = refreshImageList;

        // åœ¨DOMåŠ è¼‰å®Œæˆå¾Œç«‹å³åˆå§‹åŒ–åœ–ç‰‡æ¨™ç±¤è¼¸å…¥æ¨¡æ…‹çª—å£
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initializeImageTagModal, 100);
            });
        } else {
            setTimeout(initializeImageTagModal, 100);
        }
    </script>
</body>
</html>